<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ È´òÊî∂ÁõäÈáèÂåñ‰∫§ÊòìÁ≥ªÁªü V12.0 Pro - TushareÁúüÂÆûÊï∞ÊçÆÁâà</title>
    <style>
        /* ÁÆÄÂçïÁöÑÂÖºÂÆπÊÄßÊ†∑Âºè */
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            font-size: 14px;
        }
    </style>
    <script>
        (function () {
            try {
                const raw = localStorage.getItem('quant_ui_state_v1') || localStorage.getItem('quant_theme');
                if (!raw) return;
                if (raw === 'light' || raw === 'dark') {
                    document.documentElement.setAttribute('data-theme', raw);
                    return;
                }
                const state = JSON.parse(raw);
                const theme = state && (state.theme || state.appearance);
                if (theme === 'light' || theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', theme);
                }
            } catch (e) {
            }
        })();
    </script>
    <script>
        function showChartError(message) {
            const chartContainers = document.querySelectorAll('.chart');
            chartContainers.forEach(container => {
                container.innerHTML = '<div class="chart-loading">' + message + '</div>';
            });
        }

        (function loadECharts() {
            const sources = [
                'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js',
                'https://unpkg.com/echarts@5/dist/echarts.min.js',
                'echarts.min.js'
            ];

            function triggerInitCharts() {
                const tryCall = () => {
                    if (typeof window.initCharts === 'function') {
                        window.initCharts();
                        return;
                    }
                    setTimeout(tryCall, 200);
                };
                setTimeout(tryCall, 0);
            }

            function tryLoad(index) {
                if (index >= sources.length) {
                    console.error('‚ùå EChartsÂ∫ìÂä†ËΩΩÂ§±Ë¥•');
                    showChartError('ÂõæË°®Â∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÊèê‰æõ echarts.min.js');
                    return;
                }
                const src = sources[index];
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = () => {
                    console.log('‚úÖ EChartsÂ∫ìÂä†ËΩΩÊàêÂäü:', src);
                    if (typeof window.applyEChartsPerformancePatch === 'function') {
                        try {
                            window.applyEChartsPerformancePatch();
                        } catch (e) {
                        }
                    }
                    triggerInitCharts();
                };
                script.onerror = () => {
                    tryLoad(index + 1);
                };
                document.head.appendChild(script);
            }

            tryLoad(0);
        })();
    </script>
    <script>
        // ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®‰ºòÂåñ (Ëß£ÂÜ≥ [Violation] Added non-passive event listener Ë≠¶Âëä)
        (function() {
            if (typeof EventTarget !== 'undefined') {
                const originalAddEventListener = EventTarget.prototype.addEventListener;
                EventTarget.prototype.addEventListener = function(type, listener, options) {
                    if (type === 'touchstart' || type === 'touchmove') {
                        // ÈªòËÆ§ÂºÄÂêØ passive: true ‰ª•‰ºòÂåñÊÄßËÉΩÂíåÊ∂àÈô§Ë≠¶Âëä
                        if (typeof options === 'boolean') {
                            options = { capture: options, passive: true };
                        } else if (typeof options === 'object') {
                            // Â¶ÇÊûúÊòæÂºèÊåáÂÆö‰∫Ü passive: false (Â¶Ç ECharts ÈúÄË¶ÅÈòªÊ≠¢ÈªòËÆ§ÊªöÂä®)ÔºåÂàôÂ∞äÈáçËØ•ËÆæÁΩÆ
                            if (options.passive === false) {
                                // ‰øùÊåÅÂéüÊ†∑
                            } else {
                                options = { ...options, passive: true };
                            }
                        } else {
                            options = { passive: true };
                        }
                    }
                    return originalAddEventListener.call(this, type, listener, options);
                };
                console.log('‚úÖ ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤‰ºòÂåñ (Passive Mode)');
            }
        })();

        window.applyEChartsPerformancePatch = function () {
            if (typeof echarts === 'undefined') return;
            if (echarts && echarts.__quantPerformancePatched) return;
            try {
                const originalInit = echarts.init;
                echarts.init = function(dom, theme, opts) {
                    const performanceOpts = {
                        devicePixelRatio: Math.min(window.devicePixelRatio || 1, 2),
                        renderer: 'canvas',
                        useDirtyRect: true,
                        ...opts
                    };
                    return originalInit.call(this, dom, theme, performanceOpts);
                };
                echarts.__quantPerformancePatched = true;
            } catch (e) {
            }
        };
        window.applyEChartsPerformancePatch();
    </script>
     <!-- ÁÆÄÂåñÁöÑEChartsÂä†ËΩΩÁõëÊéß -->
    <script>
        // ÁÆÄÂåñÁöÑEChartsÂä†ËΩΩÊ£ÄÊü•
        function checkEChartsLoaded() {
            if (typeof echarts !== 'undefined' && typeof echarts.init === 'function') {
                console.log('‚úÖ EChartsÂ∫ìÂä†ËΩΩÊàêÂäü');
                return true;
            }
            return false;
        }
        
        // Â∞ÜinitChartsÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºå‰æõEChartsÂä†ËΩΩÂÆåÊàêÂêéË∞ÉÁî®
        window.initCharts = function() {
            console.log('üîÑ ÂºÄÂßãÂàùÂßãÂåñÂõæË°®...');
            
            if (typeof echarts === 'undefined' || typeof echarts.init !== 'function') {
                console.error('‚ùå EChartsÂ∫ìÊú™Âä†ËΩΩÊàñÂäüËÉΩ‰∏çÂÆåÊï¥ÔºåÂ∞ÜÂú®1ÁßíÂêéÈáçËØï');
                setTimeout(window.initCharts, 1000);
                return;
            }
            
            setTimeout(() => {
                try {
                    const equityContainer = document.getElementById('equityChart');
                    const radarContainer = document.getElementById('radarChart');
                    const returnDistContainer = document.getElementById('returnDistChart');
                    const klineContainer = document.getElementById('klineChart');
                    const returnCurveContainer = document.getElementById('returnCurveChart');
                    const optimizationContainer = document.getElementById('optimizationChart');
                    const sensitivityContainer = document.getElementById('sensitivityChart');
                    const heatmapContainer = document.getElementById('heatmapChart');
                    
                    console.log(`üìä ÂõæË°®ÂÆπÂô®Ê£ÄÊü•: ÊùÉÁõä=${!!equityContainer}, Èõ∑Ëææ=${!!radarContainer}, Êî∂ÁõäÂàÜÂ∏É=${!!returnDistContainer}, KÁ∫ø=${!!klineContainer}, Êî∂ÁõäÁéáÊõ≤Á∫ø=${!!returnCurveContainer}, ÂèÇÊï∞‰ºòÂåñ=${!!optimizationContainer}, ÊïèÊÑüÊÄß=${!!sensitivityContainer}, ÁÉ≠ÂäõÂõæ=${!!heatmapContainer}`);
                    
                    if (!equityContainer || !radarContainer || !returnDistContainer || !klineContainer || !returnCurveContainer) {
                        console.error('‚ùå ÂõæË°®ÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÂ∞ÜÂú®1ÁßíÂêéÈáçËØï');
                        setTimeout(window.initCharts, 1000);
                        return;
                    }
                    
                    if (!charts) {
                        charts = {};
                    }
                    
                    if (!optimizationCharts) {
                        optimizationCharts = {};
                    }
                    
                    if (!charts.equity) {
                        charts.equity = echarts.init(equityContainer);
                        console.log('‚úÖ ÊùÉÁõäÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    if (!charts.radar) {
                        charts.radar = echarts.init(radarContainer);
                        console.log('‚úÖ Èõ∑ËææÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    if (!charts.returnDist) {
                        charts.returnDist = echarts.init(returnDistContainer);
                        console.log('‚úÖ Êî∂ÁõäÂàÜÂ∏ÉÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    if (!charts.kline) {
                        charts.kline = echarts.init(klineContainer);
                        console.log('‚úÖ KÁ∫øÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    const chipContainer = document.getElementById('chipChart');
                    if (chipContainer && !charts.chip) {
                        charts.chip = echarts.init(chipContainer);
                        console.log('‚úÖ Á≠πÁ†ÅÂàÜÂ∏ÉÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    if (!charts.returnCurve) {
                        charts.returnCurve = echarts.init(returnCurveContainer);
                        console.log('‚úÖ Êî∂ÁõäÁéáÊõ≤Á∫øÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    if (optimizationContainer && !optimizationCharts.optimization) {
                        optimizationCharts.optimization = echarts.init(optimizationContainer);
                        console.log('‚úÖ ÂèÇÊï∞‰ºòÂåñÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    if (sensitivityContainer && !optimizationCharts.sensitivity) {
                        optimizationCharts.sensitivity = echarts.init(sensitivityContainer);
                        console.log('‚úÖ ÊïèÊÑüÊÄßÂàÜÊûêÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    if (heatmapContainer && !optimizationCharts.heatmap) {
                        optimizationCharts.heatmap = echarts.init(heatmapContainer);
                        console.log('‚úÖ ÁÉ≠ÂäõÂõæÂàùÂßãÂåñÊàêÂäü');
                    }
                    
                    echartsLoaded = true;
                    console.log('‚úÖ ÊâÄÊúâÂõæË°®ÂàùÂßãÂåñÂÆåÊàê');
                    
                    window.addEventListener('resize', () => {
                        Object.values(charts).forEach(chart => {
                            if (chart && typeof chart.resize === 'function') {
                                try {
                                    chart.resize();
                                } catch (e) {
                                    console.warn('ÂõæË°®ÈáçÁªòÂ§±Ë¥•:', e);
                                }
                            }
                        });
                        Object.values(optimizationCharts).forEach(chart => {
                            if (chart && typeof chart.resize === 'function') {
                                try {
                                    chart.resize();
                                } catch (e) {
                                    console.warn('‰ºòÂåñÂõæË°®ÈáçÁªòÂ§±Ë¥•:', e);
                                }
                            }
                        });
                    });
                    
                    updateDefaultCharts();
                    console.log('‚úÖ ÈªòËÆ§ÂõæË°®ËÆæÁΩÆÂÆåÊàê');
                } catch (error) {
                    console.error('‚ùå ÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    console.error('üîç ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ:', error.stack);
                    setTimeout(window.initCharts, 2000);
                }
            }, 500);
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #0c1929;
            background: -webkit-linear-gradient(135deg, #0c1929 0%, #1a1a2e 50%, #16213e 100%);
            background: -moz-linear-gradient(135deg, #0c1929 0%, #1a1a2e 50%, #16213e 100%);
            background: -o-linear-gradient(135deg, #0c1929 0%, #1a1a2e 50%, #16213e 100%);
            background: linear-gradient(135deg, #0c1929 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .header {
            background: #667eea;
            background: -webkit-linear-gradient(left, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background: -moz-linear-gradient(left, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background: -o-linear-gradient(left, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .header h1 {
            font-size: 24px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
        }

        .header-info span {
            color: white;
            font-size: 13px;
            padding: 6px 14px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions .appearance-select {
            width: auto;
            min-width: 110px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.35);
            border-radius: 15px;
        }

        .header-actions .appearance-select:focus {
            border-color: rgba(255,255,255,0.65);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.15);
        }

        .header-actions .help-link {
            width: auto;
            margin-top: 0;
            padding: 6px 12px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.35);
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        .header-actions .help-link:hover {
            background: rgba(255,255,255,0.28);
        }

        .data-source {
            background: linear-gradient(135deg, #11998e, #38ef7d) !important;
            font-weight: bold;
        }

        .main-container {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 10px;
            padding: 10px;
            max-width: 1920px;
            margin: 0 auto;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .panel {
            background: linear-gradient(145deg, #1e2a4a 0%, #0f1724 100%);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .panel-title {
            font-size: 15px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-group select option {
            background: #1a1a2e;
            color: #fff;
            padding: 8px 10px;
        }

        .form-group select option:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* ËÇ°Á•®ÊêúÁ¥¢ */
        .stock-search-container {
            position: relative;
        }

        .stock-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e2a4a;
            border: 1px solid #667eea;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .stock-search-results.active {
            display: block;
        }

        .stock-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            display: flex;
            justify-content: space-between;
        }

        .stock-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .stock-item .code {
            color: #667eea;
            font-weight: bold;
        }

        .stock-item .name {
            color: #fff;
        }

        .stock-item .industry {
            color: #888;
            font-size: 11px;
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            -webkit-transition: all 0.2s;
            -moz-transition: all 0.2s;
            -o-transition: all 0.2s;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            -webkit-transform: translateY(-2px);
            -moz-transform: translateY(-2px);
            -ms-transform: translateY(-2px);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 6px;
            margin-top: 8px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn.is-active {
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.22), 0 6px 18px rgba(0,0,0,0.28);
            -webkit-transform: translateY(-1px);
            -moz-transform: translateY(-1px);
            -ms-transform: translateY(-1px);
            transform: translateY(-1px);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ËøûÊé•Áä∂ÊÄÅ */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            background: rgba(46, 213, 115, 0.1);
            border: 1px solid rgba(46, 213, 115, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .connected .status-dot {
            background: #2ed573;
        }

        .disconnected .status-dot {
            background: #ff4757;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Á≠ñÁï•ÈÄâÊã© */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .strategy-card {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.03);
            position: relative;
        }

        .strategy-card:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .strategy-card.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .strategy-card .name {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
        }

        .strategy-card .expected {
            font-size: 13px;
            color: #ff4757;
            margin-top: 3px;
        }

        .strategy-card .checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            border: 2px solid #667eea;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .strategy-card.active .checkbox::after {
            content: '‚úì';
            color: #667eea;
            font-size: 12px;
        }

        /* Á≠ñÁï•ÂèÇÊï∞Ê†∑Âºè */
        .param-group {
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(102,126,234,0.1);
        }

        .param-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(102,126,234,0.2);
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 11px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .param-row:last-child {
            border-bottom: none;
        }

        .param-label {
            color: #aaa;
            font-weight: 500;
            min-width: 80px;
        }

        .param-value {
            color: #fff;
            font-weight: 500;
        }

        /* ÂèÇÊï∞ÊªëÂùóÊ†∑Âºè */
        .param-row input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
            outline: none;
            margin: 0 8px;
        }

        .param-row input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .param-row input[type="range"]::-moz-range-thumb {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* ÂèÇÊï∞ËæìÂÖ•Ê°ÜÊ†∑Âºè */
        .param-row input[type="number"] {
            background: rgba(30,42,74,0.8);
            border: 1px solid rgba(102,126,234,0.3);
            border-radius: 4px;
            color: #fff;
            padding: 4px 8px;
            font-size: 10px;
            text-align: center;
            width: 60px;
        }

        .param-row input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102,126,234,0.2);
        }

        /* Â§çÈÄâÊ°ÜÊ†∑Âºè */
        .param-row input[type="checkbox"] {
            margin-right: 8px;
            -webkit-transform: scale(1.2);
            -moz-transform: scale(1.2);
            -ms-transform: scale(1.2);
            transform: scale(1.2);
        }

        /* ÂèÇÊï∞Êìç‰ΩúÊåâÈíÆ */
        .param-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        .param-actions button {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .param-actions .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #ccc;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .param-actions .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }

        .param-actions .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .param-actions .btn-primary:hover {
            -webkit-transform: translateY(-1px);
            -moz-transform: translateY(-1px);
            -ms-transform: translateY(-1px);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .param-input {
            width: 80px;
            background: rgba(30,42,74,0.8);
            border: 1px solid rgba(102,126,234,0.3);
            border-radius: 4px;
            color: #fff;
            padding: 4px 8px;
            font-size: 11px;
            text-align: right;
        }

        .param-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-apply {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-apply:hover {
            -webkit-transform: translateY(-1px);
            -moz-transform: translateY(-1px);
            -ms-transform: translateY(-1px);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .strategy-description {
            background: rgba(102,126,234,0.05);
            border-left: 3px solid #667eea;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            color: #aaa;
            line-height: 1.5;
        }

        .strategy-description strong {
            color: #667eea;
        }

        /* Êï¥ÂêàÂêéÁöÑÂèÇÊï∞Ê†∑Âºè */
        .condition-group {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(102,126,234,0.08);
            border-radius: 8px;
            border: 1px solid rgba(102,126,234,0.2);
        }

        .condition-title {
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .condition-item {
            margin-bottom: 6px;
            padding: 6px 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }

        .condition-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(102,126,234,0.3);
        }

        .condition-switch {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            gap: 8px;
        }

        .condition-switch input[type="checkbox"] {
            margin-top: 0;
            width: 14px;
            height: 14px;
            accent-color: var(--accent-strong);
            flex-shrink: 0;
        }

        .condition-label {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .condition-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text) !important;
            margin-bottom: 0;
            line-height: 1.3;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .condition-desc {
            font-size: 12px;
            color: var(--text-muted) !important;
            line-height: 1.3;
            margin-top: 0;
            flex: 1;
        }

        .condition-params {
            margin-top: 4px;
            padding-left: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 4px;
        }

        .condition-param-row {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            font-size: 9px;
            gap: 6px;
        }

        .condition-param-label {
            color: var(--text) !important;
            min-width: 50px;
            flex-shrink: 0;
            font-size: 12px;
        }

        .condition-param-input {
            width: 45px;
            padding: 2px 4px;
            font-size: 11px;
            background: var(--input-bg) !important;
            border: 1px solid var(--input-border) !important;
            border-radius: 2px;
            color: var(--text) !important;
            text-align: center;
        }

        .condition-param-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102,126,234,0.2);
        }

        .condition-param-suffix {
            color: var(--text-muted) !important;
            margin-left: 4px;
            font-size: 9px;
        }

        /* ÂçñÂá∫Êù°‰ª∂ÊªëÂùóÊ†∑Âºè */
        .condition-param-slider {
            width: 80px;
            height: 3px;
            border-radius: 2px;
            background: rgba(220,38,38,0.3);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            margin-right: 8px;
        }

        .condition-param-slider::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(220,38,38,0.3);
        }
        
        .condition-param-slider::-moz-range-thumb {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(220,38,38,0.3);
        }

        .condition-param-value {
            font-size: 10px;
            color: #dc2626;
            font-weight: 600;
            min-width: 30px;
            text-align: right;
        }

        .other-params-group {
            margin-top: 15px;
            padding: 12px;
            background: rgba(139,92,246,0.08);
            border-radius: 8px;
            border: 1px solid rgba(139,92,246,0.2);
        }

        .other-params-title {
            font-size: 12px;
            font-weight: bold;
            color: #8b5cf6;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .param-row.other-param {
            margin-bottom: 6px;
            padding: 6px 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .no-params {
            text-align: center;
            color: #666;
            font-size: 11px;
            padding: 20px;
        }

        /* ÂèÇÊï∞ÊªëÂùó */
        .slider-group {
            margin-bottom: 10px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(102, 126, 234, 0.2);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
        }

        /* ÂàáÊç¢ÂºÄÂÖ≥ */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .toggle-label {
            font-size: 12px;
            color: #ccc;
        }

        .toggle {
            position: relative;
            width: 32px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 2px;
            bottom: 2px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle input:checked + .toggle-slider:before {
            -webkit-transform: translateX(16px);
            -moz-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }

        /* ÁªìÊûúÂç°Áâá */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .result-card {
            background: linear-gradient(145deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .result-card .label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .result-card .value {
            font-size: 18px;
            font-weight: bold;
        }

        .positive { color: #ff4757; }
        .negative { color: #2ed573; }
        .neutral { color: #ffa502; }

        /* Ë°®Ê†º */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-size: 12px;
            position: sticky;
            top: 0;
        }

        .comparison-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            font-size: 12px;
        }

        .comparison-table tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .comparison-table tr.best-row {
            background: rgba(255, 215, 0, 0.1);
        }

        .rank-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #8b4513); color: #fff; }
        .rank-other { background: rgba(102, 126, 234, 0.3); color: #fff; }

        /* ÂõæË°® */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .chart-box {
            background: linear-gradient(145deg, #1e2a4a 0%, #0f1724 100%);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .chart-box.full-width {
            grid-column: span 2;
        }

        .chart-title {
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chart {
            width: 100%;
            height: 300px;
        }

        .chart-large {
            height: 500px;
        }

        /* Ê†áÁ≠æÈ°µ */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            margin: 15px 0;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 4px;
            transition: width 0.3s;
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .progress-details {
            margin-top: 10px;
            font-size: 11px;
            color: #888;
            max-height: 100px;
            overflow-y: auto;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            -webkit-animation: spin 1s linear infinite;
            -moz-animation: spin 1s linear infinite;
            -o-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { 
                -webkit-transform: rotate(360deg);
                -moz-transform: rotate(360deg);
                -ms-transform: rotate(360deg);
                transform: rotate(360deg); 
            }
        }

        .loading-text {
            margin-top: 20px;
            color: #667eea;
            font-size: 16px;
        }

        .loading-progress {
            width: 300px;
            margin-top: 20px;
        }

        .loading-progress .progress-bar {
            height: 6px;
        }

        .loading-stats {
            margin-top: 15px;
            text-align: center;
            font-size: 12px;
            color: #888;
        }

        /* Êï∞ÊçÆ‰ø°ÊÅØ */
        .data-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 11px;
            border-left: 3px solid #667eea;
        }

        .data-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .data-info-label {
            color: #888;
        }

        .data-info-value {
            color: #fff;
            font-weight: bold;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 1400px) {
            .result-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .chart-container {
                grid-template-columns: 1fr;
            }
            .chart-box.full-width {
                grid-column: span 1;
            }
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }
/* Â§çÈÄâÊ°ÜÊ†∑ÂºèË¶ÜÁõñ */
#industryDropdown input[type="checkbox"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border: 1px solid #666;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
    background: transparent;
    position: relative;
    flex-shrink: 0;
}

#industryDropdown input[type="checkbox"]:checked {
    background: #667eea;
    border-color: #667eea;
}

#industryDropdown input[type="checkbox"]:checked::after {
    content: '‚úî';
    position: absolute;
    color: white;
    font-size: 10px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#industryDropdown label:hover {
    background: rgba(255,255,255,0.05);
}

html {
    font-size: 14px;
}

html[data-theme="dark"], :root {
    --font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    --font-size-base: 14px;
    --font-size-sm: 12px;
    --font-size-lg: 16px;
    --radius: 10px;

    --app-bg: radial-gradient(1200px circle at 18% 12%, rgba(56, 189, 248, 0.20), transparent 45%),
        radial-gradient(900px circle at 78% 20%, rgba(129, 140, 248, 0.18), transparent 42%),
        radial-gradient(900px circle at 55% 85%, rgba(34, 197, 94, 0.10), transparent 45%),
        linear-gradient(135deg, #070b14 0%, #0a1222 45%, #071029 100%);
    --header-bg: linear-gradient(90deg, #0ea5e9 0%, #2563eb 52%, #7c3aed 100%);
    --surface-1: rgba(6, 11, 20, 0.55);
    --surface-2: rgba(10, 18, 34, 0.82);
    --panel-bg: linear-gradient(145deg, rgba(12, 20, 40, 0.92) 0%, rgba(8, 16, 32, 0.92) 100%);
    --border: rgba(56, 189, 248, 0.18);
    --border-strong: rgba(129, 140, 248, 0.30);
    --text: rgba(255, 255, 255, 0.92);
    --text-muted: rgba(255, 255, 255, 0.65);
    --text-faint: rgba(255, 255, 255, 0.56);
    --accent: #7dd3fc;
    --accent-strong: #38bdf8;
    --hover-bg: rgba(125, 211, 252, 0.08);

    --input-bg: rgba(125, 211, 252, 0.06);
    --input-bg-disabled: rgba(255, 255, 255, 0.03);
    --input-border: rgba(56, 189, 248, 0.24);
    --input-border-focus: rgba(56, 189, 248, 0.75);
    --shadow-focus: 0 0 0 3px rgba(56, 189, 248, 0.22);
}

html[data-theme="light"] {
    --font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    --font-size-base: 14px;
    --font-size-sm: 12px;
    --font-size-lg: 16px;
    --radius: 10px;

    --app-bg: radial-gradient(900px circle at 22% 10%, rgba(14, 165, 233, 0.10), transparent 45%),
        radial-gradient(900px circle at 80% 16%, rgba(99, 102, 241, 0.10), transparent 45%),
        linear-gradient(135deg, #f7fbff 0%, #f0f7ff 50%, #eef3ff 100%);
    --header-bg: linear-gradient(90deg, #0ea5e9 0%, #2563eb 52%, #7c3aed 100%);
    --surface-1: rgba(255, 255, 255, 0.70);
    --surface-2: rgba(255, 255, 255, 0.92);
    --panel-bg: linear-gradient(145deg, rgba(255,255,255,0.94) 0%, rgba(247,250,255,0.94) 100%);
    --border: rgba(15, 23, 42, 0.10);
    --border-strong: rgba(37, 99, 235, 0.16);
    --text: rgba(15, 23, 42, 0.92);
    --text-muted: rgba(15, 23, 42, 0.82);
    --text-faint: rgba(15, 23, 42, 0.66);
    --accent: #2563eb;
    --accent-strong: #0ea5e9;
    --hover-bg: rgba(14, 165, 233, 0.08);

    --input-bg: rgba(14, 165, 233, 0.06);
    --input-bg-disabled: rgba(15, 23, 42, 0.025);
    --input-border: rgba(15, 23, 42, 0.14);
    --input-border-focus: rgba(14, 165, 233, 0.62);
    --shadow-focus: 0 0 0 3px rgba(14, 165, 233, 0.18);
}

html[data-theme="dark"] {
    color-scheme: dark;
}

html[data-theme="light"] {
    color-scheme: light;
}

body {
    font-family: var(--font-family) !important;
    font-size: var(--font-size-base) !important;
    background: var(--app-bg) !important;
    color: var(--text) !important;
}

.data-source {
    color: #fff !important;
}

.form-group input::placeholder,
.form-group textarea::placeholder {
    color: var(--text-faint) !important;
    opacity: 1;
}

.header {
    background: var(--header-bg) !important;
}

.header-info span {
    font-size: var(--font-size-sm);
}

.panel {
    background: var(--panel-bg) !important;
    border: 1px solid var(--border);
    border-radius: var(--radius);
}

.panel-title {
    color: var(--accent) !important;
    border-bottom-color: var(--border-strong) !important;
    font-size: var(--font-size-lg);
}

html[data-theme="dark"] .panel {
    box-shadow: 0 12px 30px rgba(0,0,0,0.35) !important;
}

html[data-theme="light"] .panel {
    box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08) !important;
}

.form-group label {
    color: var(--text-muted) !important;
    font-size: var(--font-size-sm) !important;
}

.form-group input,
.form-group select,
.form-group textarea {
    background: var(--input-bg) !important;
    border-color: var(--input-border) !important;
    color: var(--text) !important;
    border-radius: 8px !important;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    border-color: var(--input-border-focus) !important;
    box-shadow: var(--shadow-focus) !important;
}

.form-group input:disabled,
.form-group select:disabled,
.form-group textarea:disabled {
    background: var(--input-bg-disabled) !important;
    color: var(--text-faint) !important;
}

.multi-select-trigger {
    background: var(--input-bg) !important;
    border-color: var(--input-border) !important;
    color: var(--text-muted) !important;
    border-radius: 8px !important;
}

.multi-select-trigger:hover {
    background: var(--hover-bg) !important;
}

.multi-select-trigger.disabled {
    background: var(--input-bg-disabled) !important;
    color: var(--text-faint) !important;
}

#industryDropdown {
    background: var(--surface-2) !important;
    border-color: var(--border-strong) !important;
}

#industryDropdown label:hover {
    background: var(--hover-bg) !important;
}

#conceptDropdown {
    background: var(--surface-2) !important;
    border-color: var(--border-strong) !important;
}

#conceptDropdown label:hover {
    background: var(--hover-bg) !important;
}

html[data-theme="light"] #industryOptions label,
html[data-theme="light"] #conceptOptions label {
    color: var(--text) !important;
    background: transparent !important;
}

html[data-theme="light"] #industryOptions label:hover,
html[data-theme="light"] #conceptOptions label:hover {
    background: var(--hover-bg) !important;
}

html[data-theme="light"] #industryDropdown [style*="background: #2a2a2a"],
html[data-theme="light"] #industryDropdown [style*="background:#2a2a2a"],
html[data-theme="light"] #conceptDropdown [style*="background: #2a2a2a"],
html[data-theme="light"] #conceptDropdown [style*="background:#2a2a2a"] {
    background: var(--surface-2) !important;
}

html[data-theme="light"] #industryDropdown [style*="background: #1f1f1f"],
html[data-theme="light"] #industryDropdown [style*="background:#1f1f1f"],
html[data-theme="light"] #conceptDropdown [style*="background: #1f1f1f"],
html[data-theme="light"] #conceptDropdown [style*="background:#1f1f1f"] {
    background: var(--input-bg) !important;
}

html[data-theme="light"] #conceptSearchInput {
    background: var(--input-bg) !important;
    border-color: var(--input-border) !important;
    color: var(--text) !important;
}

html[data-theme="light"] #conceptSearchInput::placeholder {
    color: var(--text-faint) !important;
    opacity: 1;
}

.stock-search-results {
    background: var(--surface-2) !important;
    border-color: var(--border-strong) !important;
}

.stock-item:hover {
    background: var(--hover-bg) !important;
}

.appearance-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 0 0 0;
}

.appearance-label {
    color: var(--text-muted);
    font-size: var(--font-size-sm);
}

.appearance-select {
    width: 110px;
    padding: 6px 8px;
    background: var(--input-bg);
    color: var(--text);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    outline: none;
}

.appearance-select option {
    background: var(--surface-2);
    color: var(--text);
}

.appearance-select:focus {
    border-color: var(--input-border-focus);
    box-shadow: var(--shadow-focus);
}

.help-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    margin-top: 10px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text);
    text-decoration: none;
    font-size: var(--font-size-sm);
}

.help-link:hover {
    background: var(--hover-bg);
}

.help-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.55);
    z-index: 9999;
    padding: 0;
}

.help-modal.open {
    display: flex;
}

.help-dialog {
    width: 100vw;
    height: 100vh;
    background: var(--surface-1);
    border: 1px solid var(--border-strong);
    border-radius: 0;
    box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.help-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 12px 14px;
    background: var(--surface-2);
    border-bottom: 1px solid var(--border);
}

.help-title {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.help-title .main {
    color: var(--text);
    font-weight: 700;
    font-size: 14px;
}

.help-title .sub {
    color: var(--text-muted);
    font-size: 12px;
}

.help-body {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 0;
    height: 100%;
    min-height: 0;
}

.help-nav {
    border-right: 1px solid var(--border);
    background: var(--surface-2);
    padding: 10px;
    overflow: auto;
}

.help-nav button {
    width: 100%;
    text-align: left;
    background: transparent;
    border: 1px solid transparent;
    color: var(--text);
    padding: 10px 10px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 12px;
}

.help-nav button:hover {
    background: var(--hover-bg);
}

.help-nav button.active {
    background: rgba(102, 126, 234, 0.18);
    border-color: rgba(102, 126, 234, 0.35);
}

.help-content {
    padding: 14px 16px;
    overflow: auto;
    min-height: 0;
}

.help-section {
    display: none;
}

.help-section.active {
    display: block;
}

.help-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
}

.help-card {
    border: 1px solid var(--border);
    background: var(--surface-1);
    border-radius: 14px;
    padding: 12px;
}

.help-card h3 {
    margin: 0 0 8px 0;
    font-size: 13px;
    color: var(--text);
}

.help-card p, .help-card li {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.55;
}

.help-diagram {
    width: 100%;
    border: 1px dashed rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 10px;
    margin-top: 10px;
}

.help-callout {
    border: 1px solid rgba(102, 126, 234, 0.35);
    background: rgba(102, 126, 234, 0.12);
    border-radius: 12px;
    padding: 10px 12px;
    margin-top: 10px;
}

.help-callout.warn {
    border-color: rgba(255, 165, 2, 0.45);
    background: rgba(255, 165, 2, 0.12);
}

.help-callout.good {
    border-color: rgba(46, 213, 115, 0.45);
    background: rgba(46, 213, 115, 0.12);
}

.help-kbd {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    border-radius: 8px;
    color: var(--text);
    font-size: 11px;
}

.help-badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.06);
    color: var(--text);
}

.help-code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 11px;
    background: rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 10px;
    padding: 10px;
    overflow: auto;
    color: var(--text);
    line-height: 1.5;
    margin-top: 10px;
}

.help-split {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: 12px;
}

.comparison-table th {
    background: var(--header-bg) !important;
}

.comparison-table td {
    border-bottom-color: var(--border) !important;
    color: var(--text) !important;
}

.comparison-table tr:hover {
    background: var(--hover-bg) !important;
}

.result-card .label {
    color: var(--text-muted) !important;
}

.data-info-label {
    color: var(--text-muted) !important;
}

.data-info-value {
    color: var(--text) !important;
}

html[data-theme="light"] [style*="color:#888"],
html[data-theme="light"] [style*="color: #888"],
html[data-theme="light"] [style*="color:#aaa"],
html[data-theme="light"] [style*="color: #aaa"] {
    color: var(--text-muted) !important;
}

html[data-theme="light"] [style*="color:#ccc"],
html[data-theme="light"] [style*="color: #ccc"] {
    color: var(--text) !important;
}

html[data-theme="light"] [style*="color:#e0e0e0"],
html[data-theme="light"] [style*="color: #e0e0e0"],
html[data-theme="light"] [style*="color:#E0E0E0"],
html[data-theme="light"] [style*="color: #E0E0E0"] {
    color: var(--text) !important;
}

html[data-theme="light"] [style*="color:#fff"],
html[data-theme="light"] [style*="color: #fff"],
html[data-theme="light"] [style*="color:white"],
html[data-theme="light"] [style*="color: white"] {
    color: var(--text) !important;
}

html[data-theme="light"] [style*="color:#ddd"],
html[data-theme="light"] [style*="color: #ddd"],
html[data-theme="light"] [style*="color:#eee"],
html[data-theme="light"] [style*="color: #eee"],
html[data-theme="light"] [style*="color:#bbb"],
html[data-theme="light"] [style*="color: #bbb"],
html[data-theme="light"] [style*="color:#999"],
html[data-theme="light"] [style*="color: #999"] {
    color: var(--text-muted) !important;
}

html[data-theme="light"] [style*="color:rgba(255"],
html[data-theme="light"] [style*="color: rgba(255"],
html[data-theme="light"] [style*="color:rgb(255"],
html[data-theme="light"] [style*="color: rgb(255"] {
    color: var(--text) !important;
}

html[data-theme="light"] #strategyParams .param-label,
html[data-theme="light"] #strategyParams .strategy-description,
html[data-theme="light"] #strategyParams .strategy-description strong,
html[data-theme="light"] #strategyParams .condition-name,
html[data-theme="light"] #strategyParams .condition-desc,
html[data-theme="light"] #strategyParams .condition-param-label,
html[data-theme="light"] #strategyParams .param-value,
html[data-theme="light"] #strategyParams .condition-param-suffix {
    color: #111 !important;
}

html[data-theme="light"] #strategyParams .condition-param-input,
html[data-theme="light"] #strategyParams input[type="number"],
html[data-theme="light"] #strategyParams input[type="text"] {
    background: var(--surface-2) !important;
    border-color: var(--input-border) !important;
    color: #111 !important;
}

html[data-theme="light"] #strategyParams input[type="number"]:focus,
html[data-theme="light"] #strategyParams input[type="text"]:focus,
html[data-theme="light"] #strategyParams .condition-param-input:focus {
    border-color: var(--input-border-focus) !important;
    box-shadow: var(--shadow-focus) !important;
    outline: none !important;
}

html[data-theme="light"] .condition-name,
html[data-theme="light"] .condition-desc,
html[data-theme="light"] .condition-param-label,
html[data-theme="light"] .condition-param-suffix,
html[data-theme="light"] .condition-param-value {
    color: #111 !important;
}

html[data-theme="light"] .condition-param-input {
    color: #111 !important;
}

#industryDropdown label {
    color: var(--text) !important;
}

#industrySearchInput {
    background: var(--input-bg) !important;
    border-color: var(--input-border) !important;
    color: var(--text) !important;
}

#industrySearchInput::placeholder {
    color: var(--text-faint) !important;
    opacity: 1;
}

.strategy-card {
    background: var(--surface-1) !important;
    border: 1px solid var(--border) !important;
}

.strategy-card:hover {
    background: var(--hover-bg) !important;
    border-color: var(--border-strong) !important;
}

.strategy-card.active {
    background: var(--hover-bg) !important;
    border-color: var(--accent-strong) !important;
}

.strategy-card .name {
    color: var(--text) !important;
}

.stock-item .name {
    color: var(--text) !important;
}

.stock-item .industry {
    color: var(--text-muted) !important;
}

html {
    accent-color: var(--accent-strong);
}

.toggle-row {
    background: var(--surface-1) !important;
    border: 1px solid var(--border) !important;
}

.toggle-label {
    color: var(--text) !important;
}

html[data-theme="dark"] .toggle-row {
    background: rgba(255, 255, 255, 0.05) !important;
    border-color: rgba(255, 255, 255, 0.14) !important;
}

html[data-theme="dark"] .toggle-slider {
    background: rgba(255, 255, 255, 0.16) !important;
    border: 1px solid rgba(255, 255, 255, 0.16) !important;
}

html[data-theme="dark"] .toggle-slider:before {
    background: rgba(255, 255, 255, 0.92) !important;
    border: 1px solid rgba(0, 0, 0, 0.32) !important;
}

html[data-theme="dark"] .toggle input:checked + .toggle-slider {
    background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 55%, #7c3aed 100%) !important;
    border-color: rgba(255, 255, 255, 0.22) !important;
}

html[data-theme="light"] .toggle-slider {
    background: rgba(15, 23, 42, 0.14) !important;
    border: 1px solid rgba(15, 23, 42, 0.10) !important;
}

html[data-theme="light"] .toggle-slider:before {
    background: var(--surface-2) !important;
    border: 1px solid var(--border) !important;
}

.param-group {
    background: var(--surface-1) !important;
    border-color: var(--border) !important;
}

.param-title {
    color: var(--accent) !important;
    border-bottom-color: var(--border) !important;
}

.param-row {
    border-bottom-color: var(--border) !important;
}

.param-label {
    color: var(--text-muted) !important;
}

.param-value {
    color: var(--text) !important;
}

.param-actions .btn-secondary {
    background: var(--input-bg) !important;
    color: var(--text) !important;
    border: 1px solid var(--input-border) !important;
}

.param-actions .btn-secondary:hover {
    background: var(--hover-bg) !important;
    color: var(--text) !important;
}

.param-input {
    background: var(--input-bg) !important;
    border-color: var(--input-border) !important;
    color: var(--text) !important;
}

.param-input:focus {
    border-color: var(--input-border-focus) !important;
}

.chart-box {
    background: var(--panel-bg) !important;
    border-color: var(--border) !important;
}

.chart-title {
    color: var(--accent) !important;
}

#chipChart {
    background: var(--surface-1) !important;
    border-left-color: var(--border) !important;
}

#kline-header-info {
    color: var(--text-muted) !important;
}
</style>
</head>
<body>
    <div class="header">
        <h1>üöÄ È´òÊî∂ÁõäÈáèÂåñ‰∫§ÊòìÁ≥ªÁªü V12.0 Pro</h1>
        <div class="header-info">
            <span class="data-source">üì° TushareÁúüÂÆûÊï∞ÊçÆ</span>
            <span>ü§ñ Êô∫ËÉΩÂèÇÊï∞‰ºòÂåñ</span>
            <span>ÂºÄÂèëËÄÖÔºöÈõ®‰∏≠</span>
            <span id="currentTime">--</span>
            <div class="header-actions">
                <select id="themeSelect" class="appearance-select">
                    <option value="dark">ÊöóËâ≤</option>
                    <option value="light">‰∫ÆËâ≤</option>
                </select>
                <button class="help-link" type="button" onclick="openHelpModal()">üìñ ‰ΩøÁî®Â∏ÆÂä©</button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="help-modal" onclick="handleHelpModalBackdrop(event)">
        <div class="help-dialog" role="dialog" aria-modal="true" aria-label="‰ΩøÁî®Â∏ÆÂä©">
            <div class="help-header">
                <div class="help-title">
                    <div class="main">‰ΩøÁî®Â∏ÆÂä©ÔºàÂõæÊñáÁâàÔºâ</div>
                    <div class="sub">Êåâ Esc ÂÖ≥Èó≠Ôºõ‰∏ç‰ºöË∑≥ËΩ¨È°µÈù¢ÔºåÂÖ≥Èó≠ÂêéÂõûÂà∞‰Ω†ÂéüÊù•ÁöÑÈ°µÈù¢</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="closeHelpModal()">ËøîÂõû</button>
                </div>
            </div>
            <div class="help-body">
                <div class="help-nav">
                    <button type="button" class="active" data-help-tab="help-overview" onclick="switchHelpTab('help-overview')">1. Âø´ÈÄü‰∏äÊâã</button>
                    <button type="button" data-help-tab="help-data" onclick="switchHelpTab('help-data')">2. Êï∞ÊçÆ‰∏é Token</button>
                    <button type="button" data-help-tab="help-screening" onclick="switchHelpTab('help-screening')">3. Êâ´Êèè‰∏éÁ≠õÈÄâ</button>
                    <button type="button" data-help-tab="help-smart" onclick="switchHelpTab('help-smart')">4. Êô∫ËÉΩÈ™åËØÅ</button>
                    <button type="button" data-help-tab="help-pool" onclick="switchHelpTab('help-pool')">5. ËÇ°Á•®Ê±†</button>
                    <button type="button" data-help-tab="help-kline" onclick="switchHelpTab('help-kline')">6. KÁ∫ø‰∏éÁ≠πÁ†Å</button>
                    <button type="button" data-help-tab="help-faq" onclick="switchHelpTab('help-faq')">7. Â∏∏ËßÅÈóÆÈ¢ò</button>
                </div>
                <div class="help-content">
                    <div id="help-overview" class="help-section active">
                        <div class="help-grid">
                            <div class="help-card">
                                <h3>ÂÆåÊï¥ÊµÅÁ®ãÔºà‰ªé 0 Âà∞ 1 Ë∑ëÈÄöÔºâ</h3>
                                <ol style="margin:0; padding-left:16px;">
                                    <li>Á°ÆËÆ§Â∑¶‰æß‚ÄúËøûÊé•Áä∂ÊÄÅ‚Äù‰∏∫ÂèØÁî®ÔºàÁªøÁÇπÔºâÔºåÂÜçÂºÄÂßãÂÅöÁúüÂÆûÊï∞ÊçÆÂõûÊµã„ÄÇ</li>
                                    <li>ËæìÂÖ•ËÇ°Á•®‰ª£Á†ÅÔºàÊîØÊåÅÊêúÁ¥¢ÔºâÔºåËÆæÁΩÆÊó•ÊúüËåÉÂõ¥ÔºàÂª∫ËÆÆÂÖà 6ÔΩû24 ‰∏™ÊúàÔºâ„ÄÇ</li>
                                    <li>ÁÇπÂáª‚ÄúËé∑ÂèñÊï∞ÊçÆ‚ÄùÔºåÁ≠âÂæÖÂÆåÊàêÂêéËøõÂÖ•‚ÄúËØ¶ÊÉÖÈ°µ‚Äù„ÄÇ</li>
                                    <li>Âú®‚ÄúÁ≠ñÁï•ÈÄâÊã©‚ÄùÂãæÈÄâ‰Ω†Ë¶ÅÂØπÊØîÁöÑÁ≠ñÁï•ÔºåÁÇπÂáª‚ÄúËøêË°åÁ≠ñÁï•ÂØπÊØî‚Äù„ÄÇ</li>
                                    <li>Êü•ÁúãÔºöKÁ∫ø‰π∞ÂçñÁÇπ„ÄÅÁ≠πÁ†ÅÂàÜÂ∏É„ÄÅ‰∫§ÊòìËÆ∞ÂΩï„ÄÅÊî∂ÁõäÁéáÊõ≤Á∫ø„ÄÇ</li>
                                    <li>ËøõÂÖ•‚ÄúÁ≠õÈÄâÈ°µ‚ÄùÊâπÈáèÊâ´ÊèèÔºöÈÄâËåÉÂõ¥/Ë°å‰∏ö/Ê¶ÇÂøµ/Á≠ñÁï• ‚Üí ‚ÄúÂºÄÂßãÁ≠õÈÄâ‚Äù„ÄÇ</li>
                                    <li>ÁªìÊûúÊª°ÊÑèÔºöÁÇπÁ≠õÈÄâÁªìÊûúÈ°∂ÈÉ® <span class="help-badge">‚ûï Âä†ÂÖ•ËÇ°Ê±†</span>ÔºåÂú®‚ÄúËÇ°Á•®Ê±†‚ÄùÁªü‰∏ÄË∑üË∏™„ÄÇ</li>
                                </ol>
                                <div class="help-callout good">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Âø´ÈÄüÊ£ÄÊü•ÔºàÈÅøÂÖç‚ÄúÊâ´‰∏çÂà∞/Ê≤°Êï∞ÊçÆ/ÊÖ¢‚ÄùÔºâ</div>
                                    <ul style="margin:0; padding-left:16px;">
                                        <li>ËøûÊé•Áä∂ÊÄÅÈùûÁªøÔºö‰ºöÈÄÄÂõûÁºìÂ≠ò/Ê®°ÊãüÊï∞ÊçÆÔºåÊ¶ÇÂøµÊàêÂàÜËÇ°‰∏é PE/PB ÂèØËÉΩÊãø‰∏çÂà∞„ÄÇ</li>
                                        <li>Êó•ÊúüÂ§™Áü≠ÔºöÈÉ®ÂàÜÁ≠ñÁï•‰∏éÊåáÊ†áÔºàÂ¶Ç MA/ÂõûÊµãÁ™óÂè£ÔºâÂèØËÉΩ‰∏çÊª°Ë∂≥ÊúÄÂ∞èÈïøÂ∫¶„ÄÇ</li>
                                        <li>È¶ñÊ¨°Êâ´ÊèèÂÖ®Â∏ÇÂú∫ÔºöÂª∫ËÆÆÂÖàÁî®‚ÄúÁÉ≠Èó®ËÇ°/ÊåáÊï∞ÊàêÂàÜ‚ÄùÈ™åËØÅÔºåÂÜçÊâ©Â§ßËåÉÂõ¥„ÄÇ</li>
                                    </ul>
                                </div>
                                <div class="help-diagram">
                                    <svg viewBox="0 0 760 120" width="100%" height="120" xmlns="http://www.w3.org/2000/svg">
                                        <defs>
                                            <linearGradient id="g1" x1="0" x2="1">
                                                <stop offset="0" stop-color="#667eea" stop-opacity="0.8"/>
                                                <stop offset="1" stop-color="#764ba2" stop-opacity="0.8"/>
                                            </linearGradient>
                                        </defs>
                                        <rect x="10" y="20" width="150" height="44" rx="12" fill="url(#g1)"/>
                                        <text x="85" y="48" text-anchor="middle" fill="#fff" font-size="13">Ëé∑ÂèñÊï∞ÊçÆ</text>
                                        <polygon points="170,42 200,32 200,52" fill="#667eea"/>
                                        <rect x="210" y="20" width="160" height="44" rx="12" fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.12)"/>
                                        <text x="290" y="48" text-anchor="middle" fill="#ddd" font-size="13">ËøêË°åÁ≠ñÁï•</text>
                                        <polygon points="380,42 410,32 410,52" fill="#667eea"/>
                                        <rect x="420" y="20" width="160" height="44" rx="12" fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.12)"/>
                                        <text x="500" y="48" text-anchor="middle" fill="#ddd" font-size="13">Á≠õÈÄâÊâ´Êèè</text>
                                        <polygon points="590,42 620,32 620,52" fill="#667eea"/>
                                        <rect x="630" y="20" width="120" height="44" rx="12" fill="rgba(46, 213, 115, 0.16)" stroke="rgba(46, 213, 115, 0.35)"/>
                                        <text x="690" y="48" text-anchor="middle" fill="#dff" font-size="13">Âä†ÂÖ•ËÇ°Ê±†</text>
                                    </svg>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>ÁïåÈù¢Âú∞ÂõæÔºà‰Ω†ËØ•ÁúãÂì™ÈáåÔºâ</h3>
                                <div class="help-split">
                                    <div>
                                        <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Â∑¶‰æßÔºöËæìÂÖ•‰∏éÊéßÂà∂</div>
                                        <ul style="margin:0; padding-left:16px;">
                                            <li>ËÇ°Á•®‰ª£Á†Å/Êó•Êúü/ÂàùÂßãËµÑÈáëÔºöÂÜ≥ÂÆöÊï∞ÊçÆ‰∏éÂõûÊµãÂü∫ÂáÜ„ÄÇ</li>
                                            <li>Á≠ñÁï•ÈÄâÊã©ÔºöÂÜ≥ÂÆöË¶ÅËøêË°åÂì™‰∫õÁ≠ñÁï•ÔºàÂèØÂ§öÈÄâÂØπÊØîÔºâ„ÄÇ</li>
                                            <li>Á≠õÈÄâÈ°µÔºöËåÉÂõ¥ + Ë°å‰∏ö/Ê¶ÇÂøµ + Êô∫ËÉΩÈ™åËØÅÊù°‰ª∂„ÄÇ</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Âè≥‰æßÔºöÁªìÊûú‰∏éËß£Èáä</div>
                                        <ul style="margin:0; padding-left:16px;">
                                            <li>ËØ¶ÊÉÖÈ°µÔºöKÁ∫ø/Á≠πÁ†Å/‰∫§ÊòìËÆ∞ÂΩïÔºàÁúã‰ø°Âè∑‚ÄúÂèëÁîüÂú®Âì™Èáå‚ÄùÔºâ„ÄÇ</li>
                                            <li>Á≠õÈÄâÁªìÊûúÔºöÊâπÈáèÊâ´ÊèèÂêéÁöÑÂÄôÈÄâËÇ°Á•®ÔºàÁúã‚ÄúÊúâ‰ªÄ‰πàÂèØ‰π∞‚ÄùÔºâ„ÄÇ</li>
                                            <li>ËÇ°Á•®Ê±†ÔºöÊåÅÁª≠Ë∑üË∏™ÔºàÁúã‚Äú‰π∞ÂêéË°®Áé∞Â¶Ç‰Ωï‚ÄùÔºâ„ÄÇ</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="help-callout">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">‰∏â‰∏™ÂÖ≥ÈîÆÊìç‰Ωú‰π†ÊÉØ</div>
                                    <ol style="margin:0; padding-left:16px;">
                                        <li>ÂÖàÊääËåÉÂõ¥Áº©Â∞èË∑ëÈÄöÔºàÁÉ≠Èó®/ÊåáÊï∞Ôºâ‚Üí ÂÜçÊâ©Â§ßÂà∞ÂÖ®Â∏ÇÂú∫„ÄÇ</li>
                                        <li>Á≠õÈÄâÁªìÊûúÂÖàÊâπÈáèÂÖ•ËÇ°Ê±† ‚Üí ÂÜçËøõËØ¶ÊÉÖÈÄêÂè™Â§çÁõò„ÄÇ</li>
                                        <li>KÁ∫øÁº©Êîæ„ÄÅË°å‰∏öÊêúÁ¥¢„ÄÅÁ≠õÈÄâÊù°‰ª∂‰ºöÂ∞ΩÈáèËÆ∞‰ΩèÔºå‰∏çÁî®ÂèçÂ§çË∞ÉÊï¥„ÄÇ</li>
                                    </ol>
                                </div>
                                <div class="help-diagram">
                                    <svg viewBox="0 0 760 120" width="100%" height="120" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="10" y="18" width="240" height="84" rx="14" fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.12)"/>
                                        <text x="130" y="42" text-anchor="middle" fill="#ddd" font-size="12">ËØ¶ÊÉÖÈ°µ</text>
                                        <text x="130" y="68" text-anchor="middle" fill="#999" font-size="11">KÁ∫ø + Á≠πÁ†Å + ‰∫§Êòì + Áº©ÊîæËÆ∞ÂøÜ</text>
                                        <rect x="270" y="18" width="240" height="84" rx="14" fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.12)"/>
                                        <text x="390" y="42" text-anchor="middle" fill="#ddd" font-size="12">Á≠õÈÄâÈ°µ</text>
                                        <text x="390" y="68" text-anchor="middle" fill="#999" font-size="11">ËåÉÂõ¥ + Ë°å‰∏ö/Ê¶ÇÂøµ + Êô∫ËÉΩÈ™åËØÅÊù°‰ª∂</text>
                                        <rect x="530" y="18" width="220" height="84" rx="14" fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.12)"/>
                                        <text x="640" y="42" text-anchor="middle" fill="#ddd" font-size="12">ËÇ°Á•®Ê±†</text>
                                        <text x="640" y="68" text-anchor="middle" fill="#999" font-size="11">Ë∑üË∏™ + ÊâπÈáèÊìç‰Ωú + PE/PB</text>
                                    </svg>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>‰∏ÄÊ¨°‚ÄúÊ†áÂáÜÂ§çÁõò‚ÄùÔºàÂª∫ËÆÆ‰Ω†ËøôÊ†∑ÁúãÔºâ</h3>
                                <ol style="margin:0; padding-left:16px;">
                                    <li>ÂÖàÁúã‰∫§ÊòìËÆ∞ÂΩïÔºö‰π∞ÂÖ•/ÂçñÂá∫ÊòØÂê¶Á¨¶ÂêàÁ≠ñÁï•Áõ¥Ëßâ„ÄÇ</li>
                                    <li>ÂÜçÁúã K Á∫øÔºö‰π∞ÁÇπÊòØÂê¶ËøΩÈ´òÔºüÂçñÁÇπÊòØÂê¶Ê≠¢Áõà/Ê≠¢ÊçüËøáÊó©Ôºü</li>
                                    <li>ÂÜçÁúãÁ≠πÁ†ÅÔºöÂΩìÂâçÊòØÂéãÂäõÂå∫ËøòÊòØÊîØÊíëÂå∫ÔºüËé∑Âà©ÊØî‰æãÂÅèÈ´òËøòÊòØÂÅè‰ΩéÔºü</li>
                                    <li>ÊúÄÂêéÁúãÊî∂ÁõäÊõ≤Á∫øÔºöÊòØ‰∏çÊòØÈù†Â∞ëÊï∞Âá†Á¨î‰∫§ÊòìÊíëËµ∑Êù•ÔºàÊ≥¢Âä®Â§ßÔºâÔºü</li>
                                </ol>
                                <div class="help-callout warn">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">ÊèêÈÜí</div>
                                    <p style="margin:0;">ÂõûÊµãÁªìÊûú‰∏çÁ≠â‰∫éÊú™Êù•Êî∂Áõä„ÄÇÂª∫ËÆÆÁî®‚ÄúÁ≠õÈÄâ ‚Üí ÂÖ•Ê±† ‚Üí ËØ¶ÊÉÖÂ§çÁõò ‚Üí ÂÜçÂÖ•ÂÆûÁõòËßÇÂØü‚ÄùÁöÑÊµÅÁ®ãÈôç‰ΩéËØØÂà§„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Â∏∏Áî®Âø´Êç∑‰∫§‰∫í</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>Â∏ÆÂä©ÂºπÁ™óÔºö<span class="help-kbd">Esc</span> ÂÖ≥Èó≠ÔºõÁÇπÂáªÈÅÆÁΩ©‰πüÂèØÂÖ≥Èó≠„ÄÇ</li>
                                    <li>KÁ∫øÔºöÊãñÂä®Áº©ÊîæÊù°Ë∞ÉÊï¥ÂèØËßÜÂå∫ÔºõÁº©Êîæ‰ºöËá™Âä®‰øùÂ≠òÔºå‰∏ãÊ¨°ÂõûÂà∞ËØ¶ÊÉÖÈ°µ‰ºöÊÅ¢Â§ç„ÄÇ</li>
                                    <li>Ë°å‰∏öÔºö‰∏ãÊãâÊ°ÜÊîØÊåÅÊêúÁ¥¢ÂÆö‰ΩçÔºõÊâìÂºÄÂêéËá™Âä®ËÅöÁÑ¶ÂèØÁõ¥Êé•ËæìÂÖ•„ÄÇ</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="help-data" class="help-section">
                        <div class="help-grid">
                            <div class="help-card">
                                <h3>Token Âà∞Â∫ïËß£ÂÜ≥‰ªÄ‰πàÈóÆÈ¢ò</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>ÁúüÂÆûÊó•Á∫øÔºöÁî®‰∫é K Á∫ø„ÄÅÁ≠ñÁï•‰ø°Âè∑„ÄÅÂõûÊµã„ÄÅÊî∂ÁõäÊõ≤Á∫ø„ÄÇ</li>
                                    <li>daily_basicÔºöÁî®‰∫éÊç¢ÊâãÁéá„ÄÅPE/PB Á≠âÂü∫Êú¨Èù¢Â≠óÊÆµÔºàÊùÉÈôê‰∏çË∂≥‰ºö‰∏∫Á©∫Ôºâ„ÄÇ</li>
                                    <li>Ê¶ÇÂøµÁõ∏ÂÖ≥ÔºöÊ¶ÇÂøµÂàóË°® + Ê¶ÇÂøµÊàêÂàÜËÇ°ÔºàÁî®‰∫é‚ÄúÊ¶ÇÂøµÁ≠õÈÄâ‚ÄùÁúüÊ≠£ËøáÊª§ËÇ°Á•®Ôºâ„ÄÇ</li>
                                </ul>
                                <div class="help-callout warn">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Ê≤°Êúâ Token Êó∂‰ºöÂèëÁîü‰ªÄ‰πà</div>
                                    <ul style="margin:0; padding-left:16px;">
                                        <li>Ê¶ÇÂøµÂàóË°®‰∏∫Á©∫ÔºåÊàñÂè™Ââ©Â∞ëÈáèÂÜÖÁΩÆËÇ°Á•®„ÄÇ</li>
                                        <li>Á≠õÈÄâÁªìÊûúÂèØËÉΩÂÅèÂ∞ë/‰∏çÂáÜÁ°ÆÔºåPE/PB ÁªèÂ∏∏ÊòæÁ§∫‰∏∫ <span class="help-badge">--</span>„ÄÇ</li>
                                        <li>Êñ≠ÂºÄÂêéÁ´ØËøûÊé•Êó∂ÔºåÂâçÁ´Ø‰ºö‰ΩøÁî®ÁºìÂ≠ò/Ê®°ÊãüÊï∞ÊçÆ‰øùËØÅÁïåÈù¢ÂèØÁî®„ÄÇ</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Â¶Ç‰ΩïÈÖçÁΩÆ TokenÔºà‰∏§ÁßçÊñπÂºèÔºâ</h3>
                                <p style="margin:0;">ÂêéÁ´ØÂêØÂä®Êó∂‰ºöÊåâ‰ºòÂÖàÁ∫ßËØªÂèñ TokenÔºöÁéØÂ¢ÉÂèòÈáè ‚Üí Êú¨Âú∞Êñá‰ª∂„ÄÇ</p>
                                <div class="help-code">ÊñπÂºè AÔºöÁéØÂ¢ÉÂèòÈáèÔºàÊé®ËçêÔºâ
TUSHARE_TOKEN=‰Ω†ÁöÑtoken

ÊñπÂºè BÔºöÊú¨Âú∞Êñá‰ª∂
Âú®ÂêéÁ´ØÊï∞ÊçÆÁõÆÂΩïÊîæÁΩÆÔºötushare_token.txt
Êñá‰ª∂ÂÜÖÂÆπÔºö‰Ω†ÁöÑtokenÔºàÁ∫ØÊñáÊú¨‰∏ÄË°åÔºâ</div>
                                <div class="help-callout">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">ÈÖçÁΩÆÂêéË¶ÅÂÅö‰ªÄ‰πà</div>
                                    <ul style="margin:0; padding-left:16px;">
                                        <li>ÈáçÂêØÂêéÁ´ØÊúçÂä°ÔºàÂà∑Êñ∞È°µÈù¢ÂêéËøûÊé•Áä∂ÊÄÅ‰ºöÈáçÊñ∞Ê£ÄÊµãÔºâ„ÄÇ</li>
                                        <li>Ê¶ÇÂøµÂàóË°®‰∏éÊ¶ÇÂøµÊàêÂàÜËÇ°‰ºöË¢´ÂêéÁ´ØÁºìÂ≠òÔºàÊèêÂçáÈÄüÂ∫¶Ôºâ„ÄÇ</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Êï∞ÊçÆ‰ªéÂì™ÈáåÊù•ÔºàÂõæÁ§∫Ôºâ</h3>
                                <p style="margin:0;">‰Ω†ÁúãÂà∞ÁöÑÊï∞ÊçÆÂèØËÉΩÊù•Ëá™ÔºöÂêéÁ´ØÁúüÂÆûÊï∞ÊçÆ„ÄÅÂêéÁ´ØÊú¨Âú∞ CSV ÁºìÂ≠ò„ÄÅÊµèËßàÂô®Êú¨Âú∞ÁºìÂ≠ò„ÄÅÊàñÊ®°ÊãüÊï∞ÊçÆ„ÄÇ</p>
                                <div class="help-diagram">
                                    <svg viewBox="0 0 760 150" width="100%" height="150" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="10" y="28" width="210" height="94" rx="14" fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.12)"/>
                                        <text x="115" y="58" text-anchor="middle" fill="#ddd" font-size="12">ÂâçÁ´Ø</text>
                                        <text x="115" y="82" text-anchor="middle" fill="#999" font-size="11">Êú¨Âú∞ÁºìÂ≠ò + UI</text>
                                        <polygon points="230,75 265,55 265,95" fill="#667eea"/>
                                        <rect x="275" y="28" width="220" height="94" rx="14" fill="rgba(102,126,234,0.12)" stroke="rgba(102,126,234,0.35)"/>
                                        <text x="385" y="58" text-anchor="middle" fill="#dfe7ff" font-size="12">ÂêéÁ´Ø</text>
                                        <text x="385" y="82" text-anchor="middle" fill="#b9c6ff" font-size="11">CSV ÁºìÂ≠ò + API</text>
                                        <polygon points="505,75 540,55 540,95" fill="#667eea"/>
                                        <rect x="550" y="28" width="200" height="94" rx="14" fill="rgba(46,213,115,0.12)" stroke="rgba(46,213,115,0.35)"/>
                                        <text x="650" y="58" text-anchor="middle" fill="#dff" font-size="12">Tushare</text>
                                        <text x="650" y="82" text-anchor="middle" fill="#9be7c6" font-size="11">Token/ÊùÉÈôê/È¢ëÊéß</text>
                                        <text x="115" y="140" text-anchor="middle" fill="#888" font-size="10">ÊµèËßàÂô®Á´ØÁºìÂ≠ò‰∏ªË¶ÅÁî®‰∫éÊèêÈÄü</text>
                                        <text x="385" y="140" text-anchor="middle" fill="#888" font-size="10">ÂêéÁ´Ø CSV ÁºìÂ≠ò‰∏ªË¶ÅÁî®‰∫éÊåÅ‰πÖÂåñ</text>
                                    </svg>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Â¶Ç‰ΩïÁ°ÆËÆ§‰Ω†ÂΩìÂâçÂú®Áî®‚ÄúÁúüÂÆûÊï∞ÊçÆ‚Äù</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>Â∑¶‰æß‚ÄúËøûÊé•Áä∂ÊÄÅ‚Äù‰∏∫ÁªøÁÇπ„ÄÇ</li>
                                    <li>Êï∞ÊçÆÊù°Êï∞„ÄÅÊó∂Èó¥ËåÉÂõ¥Ê≠£Â∏∏ÊòæÁ§∫ÔºõÂàáÊç¢ËÇ°Á•®ÂêéËÉΩÊãâÂà∞ÂØπÂ∫îË°åÊÉÖ„ÄÇ</li>
                                    <li>Ê¶ÇÂøµ‰∏ãÊãâÊ°ÜËÉΩÂä†ËΩΩÂá∫Â§ßÈáèÊ¶ÇÂøµÔºà‰∏çÊòØ‚ÄúÊöÇÊó†Ê¶ÇÂøµÊï∞ÊçÆ‚ÄùÔºâ„ÄÇ</li>
                                </ul>
                                <div class="help-callout warn">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Â¶ÇÊûú PE/PB ‰ªçÊòØ --</div>
                                    <ul style="margin:0; padding-left:16px;">
                                        <li>ÂèØËÉΩÊòØ daily_basic ÊùÉÈôê‰∏çË∂≥/È¢ëÊéßÂØºËá¥Â≠óÊÆµ‰∏∫Á©∫„ÄÇ</li>
                                        <li>‰πüÂèØËÉΩÊòØÊµèËßàÂô®ÁºìÂ≠òÈáå‰øùÂ≠òÁöÑÊòØÊóßÊï∞ÊçÆÔºåÂª∫ËÆÆÈáçÊñ∞ÊãâÂèñ‰∏ÄÊ¨°„ÄÇ</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="help-screening" class="help-section">
                        <div class="help-grid">
                            <div class="help-card">
                                <h3>Á≠õÈÄâÁöÑÊú¨Ë¥®ÔºöÂÖà‚ÄúÁº©Â∞èËÇ°Á•®Ê±†‚ÄùÔºåÂÜç‚ÄúË∑ëÁ≠ñÁï•Êâæ‰ø°Âè∑‚Äù</h3>
                                <p style="margin:0;">Á≠õÈÄâ‰∏çÊòØÁõ¥Êé•È¢ÑÊµãÊ∂®Ë∑åÔºåËÄåÊòØÊää‰Ω†‰∏çÂÖ≥ÂøÉ/‰∏çÁ¨¶ÂêàÊù°‰ª∂ÁöÑËÇ°Á•®ÂÖàËøáÊª§ÊéâÔºåÂÜçÂØπÂâ©‰∏ãÁöÑËÇ°Á•®ÈÄêÂè™ËøêË°åÁ≠ñÁï•ÔºåÊâæÂá∫ËøëÊúüÂá∫Áé∞‰π∞ÂÖ•‰ø°Âè∑ÁöÑÊ†áÁöÑ„ÄÇ</p>
                                <div class="help-diagram">
                                    <svg viewBox="0 0 760 150" width="100%" height="150" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="12" y="24" width="220" height="102" rx="14" fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.12)"/>
                                        <text x="122" y="52" text-anchor="middle" fill="#ddd" font-size="12">ÈÄâËåÉÂõ¥</text>
                                        <text x="122" y="76" text-anchor="middle" fill="#999" font-size="11">ÁÉ≠Èó® / ÊåáÊï∞ / ÂÖ®Â∏ÇÂú∫</text>
                                        <text x="122" y="98" text-anchor="middle" fill="#999" font-size="11">ÂæóÂà∞ stockList</text>
                                        <polygon points="242,75 280,55 280,95" fill="#667eea"/>
                                        <rect x="290" y="24" width="220" height="102" rx="14" fill="rgba(102,126,234,0.12)" stroke="rgba(102,126,234,0.35)"/>
                                        <text x="400" y="52" text-anchor="middle" fill="#dfe7ff" font-size="12">Ë°å‰∏ö/Ê¶ÇÂøµËøáÊª§</text>
                                        <text x="400" y="76" text-anchor="middle" fill="#b9c6ff" font-size="11">ÊääÊó†ÂÖ≥ËÇ°Á•®ÂâîÈô§</text>
                                        <text x="400" y="98" text-anchor="middle" fill="#b9c6ff" font-size="11">Ââ©‰∏ãÊõ¥‚ÄúÂπ≤ÂáÄ‚ÄùÁöÑÊ±†Â≠ê</text>
                                        <polygon points="520,75 560,55 560,95" fill="#667eea"/>
                                        <rect x="570" y="24" width="178" height="102" rx="14" fill="rgba(46,213,115,0.12)" stroke="rgba(46,213,115,0.35)"/>
                                        <text x="659" y="52" text-anchor="middle" fill="#dff" font-size="12">ÈÄêÂè™Êâ´Êèè</text>
                                        <text x="659" y="76" text-anchor="middle" fill="#9be7c6" font-size="11">ÊãâÊï∞ÊçÆ ‚Üí Ë∑ëÁ≠ñÁï•</text>
                                        <text x="659" y="98" text-anchor="middle" fill="#9be7c6" font-size="11">ÊâæËøëÊúü‰π∞ÂÖ•‰ø°Âè∑</text>
                                    </svg>
                                </div>
                                <div class="help-callout">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Ë°å‰∏ö‰∏éÊ¶ÇÂøµÊòØ OR ÂÖ≥Á≥ª</div>
                                    <p style="margin:0;">ÂΩì‰Ω†ÂêåÊó∂ÂºÄÂêØ‚ÄúË°å‰∏ö‚ÄùÂíå‚ÄúÊ¶ÇÂøµ‚ÄùÊó∂ÔºåÁ≥ªÁªüÊåâ‚ÄúË°å‰∏öÂëΩ‰∏≠ Êàñ Ê¶ÇÂøµÂëΩ‰∏≠‚Äù‰øùÁïôËÇ°Á•®Ôºà‰∏ç‰ºöË¶ÅÊ±ÇÂêåÊó∂Êª°Ë∂≥Ôºâ„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Ê¶ÇÂøµÁ≠õÈÄâÔºö‰∏∫‰ªÄ‰πà‰πãÂâç‰ºöÊâ´‰∏çÂà∞ÔºàÂ∑≤‰øÆÂ§çÔºâ</h3>
                                <p style="margin:0;">ÊóßÁâàÊòØÁî®‚ÄúÊ¶ÇÂøµÊñáÂ≠ó‚ÄùÂéªÂåπÈÖçËÇ°Á•®ÂêçÁß∞/Ë°å‰∏ö/‰ª£Á†ÅÔºåÂëΩ‰∏≠ÁéáÈùûÂ∏∏‰Ωé„ÄÇÁé∞Âú®Êîπ‰∏∫ÁúüÊ≠£ÁöÑÊ¶ÇÂøµÊàêÂàÜËÇ°ËøáÊª§Ôºö</p>
                                <div class="help-code">Ê¶ÇÂøµÂêçÔºà‰∏ãÊãâÂ§öÈÄâÔºâ
  ‚Üí Êü•Âà∞ concept code
  ‚Üí ËØ∑Ê±ÇÂêéÁ´Ø /api/concept_members
  ‚Üí ËøîÂõûËØ•Ê¶ÇÂøµÁöÑ ts_codesÔºàÊàêÂàÜËÇ°Ôºâ
  ‚Üí stockList Âè™‰øùÁïôËøô‰∫õ ts_code
  ‚Üí ÂÜçÂºÄÂßãÊâ´Êèè</div>
                                <div class="help-callout warn">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Ê≥®ÊÑè</div>
                                    <ul style="margin:0; padding-left:16px;">
                                        <li>Ê¶ÇÂøµÊàêÂàÜËÇ°ÈúÄË¶ÅÂêéÁ´ØËøûÈÄö‰∏îÊúâ TokenÔºàÂê¶Âàô‰ºöÊãø‰∏çÂà∞ ts_codesÔºâ„ÄÇ</li>
                                        <li>Â¶ÇÊûú‰Ω†Áõ¥Êé•Âú®Ê¶ÇÂøµËæìÂÖ•Ê°ÜÊâãÊâìÂÖ≥ÈîÆÂ≠óÔºå‰πüËÉΩÁî®Ôºõ‰ΩÜ‰ºòÂÖàÊé®Ëçê‚Äú‰∏ãÊãâÂ§öÈÄâÊ¶ÇÂøµ‚Äù„ÄÇ</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Ë°å‰∏öÁ≠õÈÄâÔºöÂ¶Ç‰ΩïÁî®ÂæóÂø´</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>ÂºÄÂêØË°å‰∏öÂºÄÂÖ≥ÂêéÔºåÁÇπ‚ÄúÈÄâÊã©Ë°å‰∏ö‚Ä¶‚ÄùÊâìÂºÄ‰∏ãÊãâ„ÄÇ</li>
                                    <li>‰ºöËá™Âä®ËÅöÁÑ¶ÊêúÁ¥¢Ê°ÜÔºåÁõ¥Êé•ËæìÂÖ•Ë°å‰∏öÂÖ≥ÈîÆÂ≠óÂÆö‰Ωç„ÄÇ</li>
                                    <li>Â§öÈÄâÂêé‰ºöÂú®Ëß¶ÂèëÂô®ÊòæÁ§∫‚ÄúÂ∑≤ÈÄâ N ‰∏™Ë°å‰∏ö‚Äù„ÄÇ</li>
                                </ul>
                                <div class="help-callout">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Êé®ËçêÁî®Ê≥ï</div>
                                    <p style="margin:0;">ÂÖàÁî®Ë°å‰∏öÁº©Â∞èËåÉÂõ¥Ôºà‰æãÂ¶Ç‚ÄúÂçäÂØº‰Ωì/ËÆ°ÁÆóÊú∫/Èì∂Ë°å‚ÄùÔºâÔºåÂÜçÁî®Ê¶ÇÂøµÂÅöËøõ‰∏ÄÊ≠•ÁªÜÂàÜÔºà‰æãÂ¶Ç‚ÄúAI/ÂõΩ‰∫ßÊõø‰ª£‚ÄùÔºâ„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Êâ´ÊèèÊÖ¢ÊÄé‰πàÂäûÔºàÂÆûË∑µÂª∫ËÆÆÔºâ</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>ÂÖàÈÄâ‚ÄúÁÉ≠Èó®ËÇ°/ÊåáÊï∞ÊàêÂàÜ‚ÄùÈ™åËØÅÈÖçÁΩÆ‰∏éÊµÅÁ®ã„ÄÇ</li>
                                    <li>Êó•ÊúüÂå∫Èó¥‰∏çË¶ÅËøáÈïøÔºàÂÖà 1 Âπ¥ÂÜÖÔºâÔºåÂáèÂ∞ëÊØèÂè™ËÇ°Á•®ÁöÑÊï∞ÊçÆÈáè„ÄÇ</li>
                                    <li>Á≠ñÁï•‰∏çË¶Å‰∏ÄÊ¨°ÂÖ®ÈÄâÔºàÂÖàÈÄâ 2ÔΩû4 ‰∏™‰ª£Ë°®Á≠ñÁï•Ôºâ„ÄÇ</li>
                                    <li>Á≠õÈÄâÁªìÊûúÂÜçÂÖ•ËÇ°Ê±†ÔºåÂêéÁª≠Â§çÁõòÂè™ÁúãËÇ°Ê±†Âç≥ÂèØ„ÄÇ</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="help-smart" class="help-section">
                        <div class="help-grid">
                            <div class="help-card">
                                <h3>Êô∫ËÉΩÈ™åËØÅÔºöÊää‚ÄúÂ§öÁ≠ñÁï•Âô™Â£∞‚ÄùÂéãÊàê‚ÄúÊØèËÇ°‰∏Ä‰∏™ÊúÄ‰Ω≥‚Äù</h3>
                                <p style="margin:0;">Âêå‰∏ÄÂè™ËÇ°Á•®Âú®‰∏çÂêåÁ≠ñÁï•‰∏ãÂèØËÉΩÂêåÊó∂Âá∫Áé∞‰ø°Âè∑ÔºåÂàóË°®‰ºöÂæà‚ÄúÂêµ‚Äù„ÄÇÊô∫ËÉΩÈ™åËØÅÁöÑÁõÆÊ†áÊòØÔºöÊØèÂè™ËÇ°Á•®Âè™Áïô‰∏Ä‰∏™ÊúÄÂèØ‰ø°ÁöÑÁ≠ñÁï•ÁªìÊûú„ÄÇ</p>
                                <div class="help-callout good">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Â∑≤Êåâ‰Ω†ÁöÑË¶ÅÊ±ÇÔºöÂèñÊ∂àÊó†ÂéÜÂè≤È™åËØÅ</div>
                                    <ul style="margin:0; padding-left:16px;">
                                        <li>ÂéÜÂè≤Á™óÂè£ÂõûÊµã‰∫§ÊòìÊï∞‰∏∫ 0 ÁöÑÁ≠ñÁï•ÔºåÁõ¥Êé•ÂâîÈô§Ôºå‰∏çÂèØËÉΩË¢´ÈÄâ‰∏∫ÊúÄ‰Ω≥„ÄÇ</li>
                                        <li>‰Ω†ËÆæÁΩÆÁöÑ‚ÄúÊúÄ‰ΩéËØÑÂàÜ/Êî∂Áõä/ËÉúÁéá/‰∫§ÊòìÊï∞‚Äù‰ºöËøõ‰∏ÄÊ≠•ËøáÊª§ÊéâÂº±Á≠ñÁï•„ÄÇ</li>
                                    </ul>
                                </div>
                                <div class="help-diagram">
                                    <svg viewBox="0 0 760 140" width="100%" height="140" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="12" y="18" width="330" height="104" rx="14" fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.12)"/>
                                        <text x="177" y="46" text-anchor="middle" fill="#ddd" font-size="12">ÂÄôÈÄâÁ≠ñÁï•</text>
                                        <text x="177" y="70" text-anchor="middle" fill="#999" font-size="11">ËØÑÂàÜ / Êî∂Áõä / ËÉúÁéá / ‰∫§ÊòìÊï∞</text>
                                        <text x="177" y="92" text-anchor="middle" fill="#ffbaba" font-size="11">Êó†ÂéÜÂè≤ ‚Üí ÂâîÈô§</text>
                                        <polygon points="352,70 390,52 390,88" fill="#667eea"/>
                                        <rect x="400" y="18" width="170" height="104" rx="14" fill="rgba(102,126,234,0.12)" stroke="rgba(102,126,234,0.35)"/>
                                        <text x="485" y="54" text-anchor="middle" fill="#dfe7ff" font-size="12">ÊåâÈó®ÊßõËøáÊª§</text>
                                        <text x="485" y="80" text-anchor="middle" fill="#b9c6ff" font-size="11">ÊúÄ‰ΩéËØÑÂàÜ/Êî∂Áõä/ËÉúÁéá/‰∫§ÊòìÊï∞</text>
                                        <polygon points="580,70 620,52 620,88" fill="#667eea"/>
                                        <rect x="630" y="18" width="118" height="104" rx="14" fill="rgba(46,213,115,0.12)" stroke="rgba(46,213,115,0.35)"/>
                                        <text x="689" y="54" text-anchor="middle" fill="#dff" font-size="12">ÈÄâÊúÄ‰Ω≥</text>
                                        <text x="689" y="80" text-anchor="middle" fill="#9be7c6" font-size="11">Êåâ‰ºòÂÖàËßÑÂàô</text>
                                    </svg>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>‚ÄúËøëÊúü‰ø°Âè∑‚ÄùÂíå‚ÄúÂéÜÂè≤È™åËØÅ‚ÄùÊÄé‰πàÂàíÂàÜ</h3>
                                <p style="margin:0;">Êô∫ËÉΩÈ™åËØÅ‰ºöÊääÊï∞ÊçÆÂàáÊàê‰∏§ÊÆµÔºöÂÖàÁ°Æ‰øùËøëÊúüÁúüÁöÑÂá∫‰ø°Âè∑ÔºåÂÜçÁî®Êõ¥Êó©ÁöÑÂéÜÂè≤ÂõûÊµãÊù•È™åËØÅÂèØÈù†ÊÄß„ÄÇ</p>
                                <div class="help-code">ËøëÊúüÁ™óÂè£ÔºàÊúÄËøë N Â§©Ôºâ
‚Üí Áî®‰∫éÂà§Êñ≠ÊòØÂê¶‚ÄúÂÖ•ÈÄâ‚ÄùÔºàÂøÖÈ°ªËøëÊúüÂá∫Áé∞‰π∞ÂÖ•‰ø°Âè∑Ôºâ

ÂéÜÂè≤Á™óÂè£ÔºàÊõ¥Êó©ÁöÑÊï∞ÊçÆÔºâ
‚Üí Áî®‰∫éËÆ°ÁÆóÔºöÂéÜÂè≤Êî∂Áõä% / ËØÑÂàÜ / ËÉúÁéá% / ‰∫§ÊòìÊï∞
‚Üí Êó†‰∫§ÊòìÊï∞Ôºà=0Ôºâ‰ºöË¢´ÂâîÈô§</div>
                                <div class="help-callout">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">‰∏∫‰ªÄ‰πàËøôÊ†∑Êõ¥ÂêàÁêÜ</div>
                                    <p style="margin:0;">Âè™ÁúãÂéÜÂè≤ÂèØËÉΩÈÄâÂá∫‚ÄúÊõæÁªèÊúâÊïà‰ΩÜÊúÄËøëÂ§±Êïà‚ÄùÁöÑÁ≠ñÁï•ÔºõÂè™ÁúãËøëÊúüÂèàÂèØËÉΩÊòØÂÅ∂ÁÑ∂„ÄÇÂàÜÊÆµËÉΩÂêåÊó∂ÂÖºÈ°æ‚ÄúÂΩì‰∏ãÂèëÁîü‚Äù‰∏é‚ÄúÈïøÊúüÁ®≥ÂÆö‚Äù„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Èó®ÊßõÊÄé‰πàËÆæÔºà‰ªéÂÆΩÂà∞‰∏•Ôºâ</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>ÊúÄ‰Ωé‰∫§ÊòìÊï∞ÔºöÂª∫ËÆÆ‰ªé 1 ‚Üí 3 ‚Üí 5 ÈÄêÊ≠•ÊèêÈ´ò„ÄÇ</li>
                                    <li>ÊúÄ‰ΩéÊî∂Áõä%ÔºöÂª∫ËÆÆÂÖà ‚â• 0ÔºåÂÜçÈÄêÊ≠•ÊèêÈ´òÂà∞ 10/20„ÄÇ</li>
                                    <li>ÊúÄ‰ΩéËÉúÁéá%ÔºöÂª∫ËÆÆÂÖà ‚â• 40ÔºåÂÜçÈÄêÊ≠•ÊèêÈ´òÂà∞ 50/55„ÄÇ</li>
                                    <li>ÊúÄ‰ΩéËØÑÂàÜÔºöÂª∫ËÆÆÂÖà ‚â• 40ÔºåÂÜçÈÄêÊ≠•ÊèêÈ´òÂà∞ 60/70„ÄÇ</li>
                                </ul>
                                <div class="help-callout warn">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Â¶ÇÊûú‰Ω†ÂèëÁé∞‚ÄúÂá†‰πéÊ≤°ÊúâÁªìÊûú‚Äù</div>
                                    <p style="margin:0;">‰ºòÂÖàÈôç‰ΩéÈó®ÊßõÔºàÂ∞§ÂÖ∂ÊòØÊúÄ‰Ωé‰∫§ÊòìÊï∞/ÊúÄ‰ΩéËØÑÂàÜÔºâÔºåÊàñÁº©Â∞èÁ≠õÈÄâËåÉÂõ¥ÔºàÁÉ≠Èó®/ÊåáÊï∞ÔºâÔºåÂÖàËÆ©Á≥ªÁªüË∑ëÂá∫ÂèØÁî®ÁªìÊûú„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>ÊéíÂ∫è‰ºòÂÖàÔºàËØÑÂàÜ/Êî∂Áõä/ËÉúÁéáÔºâÊÄé‰πàÂΩ±Âìç‚ÄúÊúÄ‰Ω≥Á≠ñÁï•‚Äù</h3>
                                <p style="margin:0;">ÂΩìÂ§ö‰∏™Á≠ñÁï•ÈÉΩÊª°Ë∂≥Èó®ÊßõÔºå‰ºöÊåâ‰Ω†ÈÄâÊã©ÁöÑ‚ÄúÊéíÂ∫è‰ºòÂÖà‚ÄùÂÜ≥ÂÆöÂÜ†ÂÜõÔºåÂπ∂Áî®ÂÖ∂ÂÆÉÊåáÊ†á‰Ωú‰∏∫Âπ∂ÂàóÊâìÁ†¥Ôºö</p>
                                <div class="help-code">‰ºòÂÖà=ËØÑÂàÜÔºöËØÑÂàÜ ‚Üí Êî∂Áõä ‚Üí ËÉúÁéá
‰ºòÂÖà=Êî∂ÁõäÔºöÊî∂Áõä ‚Üí ËØÑÂàÜ ‚Üí ËÉúÁéá
‰ºòÂÖà=ËÉúÁéáÔºöËÉúÁéá ‚Üí ËØÑÂàÜ ‚Üí Êî∂Áõä</div>
                            </div>
                        </div>
                    </div>

                    <div id="help-pool" class="help-section">
                        <div class="help-grid">
                            <div class="help-card">
                                <h3>ËÇ°Á•®Ê±†ÊòØ‰ªÄ‰πàÔºà‰∏∫‰ªÄ‰πàË¶ÅÁî®ÂÆÉÔºâ</h3>
                                <p style="margin:0;">Á≠õÈÄâÈ°µËß£ÂÜ≥‚Äú‰ªäÂ§©Êúâ‰ªÄ‰πàÊú∫‰ºö‚ÄùÔºåËÇ°Á•®Ê±†Ëß£ÂÜ≥‚ÄúÂÖ•Ê±†ÂêéÊåÅÁª≠Ë∑üË∏™‰∏éÂ§çÁõò‚Äù„ÄÇÂÆÉ‰ºöÊääÂÄôÈÄâËÇ°Á•®ÈïøÊúü‰øùÂ≠òÔºåÈÅøÂÖç‰Ω†ÊØèÊ¨°ÈáçÊñ∞Á≠õÈÄâ„ÄÅÈáçÂ§çÂä≥Âä®„ÄÇ</p>
                                <div class="help-callout good">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">Êé®ËçêÊµÅÁ®ã</div>
                                    <p style="margin:0;">Á≠õÈÄâÁªìÊûú ‚Üí ÊâπÈáèÂä†ÂÖ•ËÇ°Ê±† ‚Üí ËøõÂÖ•ËÇ°Á•®Ê±†ÈÄê‰∏™‚ÄúÊü•Áúã‚ÄùÂ§çÁõò ‚Üí ÂÜçÂÜ≥ÂÆöÊòØÂê¶ÂÖ≥Ê≥®/‰∫§Êòì„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Â¶Ç‰ΩïÊääÁ≠õÈÄâÁªìÊûúÂä†ÂÖ•ËÇ°Ê±†</h3>
                                <ol style="margin:0; padding-left:16px;">
                                    <li>ÂÆåÊàêÁ≠õÈÄâÂêéÔºåÂú®‚ÄúÁ≠õÈÄâÁªìÊûú‚ÄùÊ†áÈ¢òÊ†èÁÇπÂáª <span class="help-badge">‚ûï Âä†ÂÖ•ËÇ°Ê±†</span>„ÄÇ</li>
                                    <li>Á≥ªÁªü‰ºöÊåâ‚ÄúÁ≠ñÁï• + ËÇ°Á•®‰ª£Á†Å‚ÄùÂéªÈáçÂÜôÂÖ•ËÇ°Ê±†ÔºàÂêå‰∏ÄÊù°‰ºöÊõ¥Êñ∞Ôºâ„ÄÇ</li>
                                    <li>ÂàáÂà∞‚ÄúËÇ°Á•®Ê±†‚ÄùTab Êü•ÁúãÂÖ•Ê±†Êï∞Èáè‰∏éÊòéÁªÜ„ÄÇ</li>
                                </ol>
                                <div class="help-callout warn">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">‰∏∫‰ªÄ‰πàÊØèË°å‰∏çÂÜçÊúâ‚ÄúÂä†ÂÖ•ËÇ°Ê±†‚ÄùÊåâÈíÆ</div>
                                    <p style="margin:0;">‰Ω†Ë¶ÅÊ±Ç‚ÄúÁ≠õÈÄâÁªìÊûúÂêéÈù¢ÊØè‰∏™ËÇ°ÁöÑÂä†ÂÖ•ËÇ°Ê±†‰∏çË¶Å‚ÄùÔºåÊâÄ‰ª•Êîπ‰∏∫Áªü‰∏ÄÁî®È°∂ÈÉ®ÊåâÈíÆÊâπÈáèÂÖ•Ê±†ÔºåÊìç‰ΩúÊõ¥Âπ≤ÂáÄ„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>ËÇ°Ê±†Â≠óÊÆµÊÄé‰πàËØª</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>ÂÖ•ÈÄâÊó∂Èó¥/ÂÖ•ÈÄâ‰ª∑Ê†ºÔºöÊù•Ëá™Á≠õÈÄâÂà∞ÁöÑ‰π∞ÂÖ•‰ø°Âè∑„ÄÇ</li>
                                    <li>ÊúÄÊñ∞‰ª∑Ê†º/Ëá≥‰ªäÊî∂ÁõäÔºöÁî®ÊúÄÊñ∞Êî∂Áõò‰ª∑Áõ∏ÂØπÂÖ•ÈÄâ‰ª∑ËÆ°ÁÆó„ÄÇ</li>
                                    <li>Â∏ÇÁõàÁéá/Â∏ÇÂáÄÁéáÔºöÂèñÊúÄËøë‰∏ÄÊ†π K Á∫øÊï∞ÊçÆÈáåÁöÑ PE/PBÔºàÊúâÊï∞ÊçÆÊâçÊòæÁ§∫Ôºâ„ÄÇ</li>
                                </ul>
                            </div>
                            <div class="help-card">
                                <h3>PE/PB ÊòæÁ§∫ -- ÁöÑÂ∏∏ËßÅÂéüÂõ†</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>Tushare daily_basic ÊùÉÈôê‰∏çË∂≥/È¢ëÊéß ‚Üí ÂêéÁ´ØËøîÂõû‰∏∫Á©∫„ÄÇ</li>
                                    <li>ÂΩìÂâç‰ΩøÁî®ÁöÑÊòØÁºìÂ≠ò/Ê®°ÊãüÊï∞ÊçÆ ‚Üí Ê≤°ÊúâÂü∫Êú¨Èù¢Â≠óÊÆµ„ÄÇ</li>
                                    <li>ÊµèËßàÂô®ÁºìÂ≠òÊòØÊóßÊ†ºÂºè ‚Üí Âª∫ËÆÆÈáçÊñ∞ÊãâÂèñ‰∏ÄÊ¨°„ÄÇ</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="help-kline" class="help-section">
                        <div class="help-grid">
                            <div class="help-card">
                                <h3>KÁ∫øÊÄé‰πàÁúãÔºà‰ªé‰∏äÂà∞‰∏ãÔºâ</h3>
                                <ol style="margin:0; padding-left:16px;">
                                    <li>È°∂ÈÉ®‰ø°ÊÅØÊ†èÔºöÊòæÁ§∫ÂΩìÂâçÂçÅÂ≠óÂÖâÊ†áÊâÄÂú®Êó•ÊúüÁöÑÂºÄÈ´ò‰ΩéÊî∂„ÄÅÊ∂®ÂπÖ„ÄÅÊàê‰∫§ÈáèÁ≠â„ÄÇ</li>
                                    <li>KÁ∫ø‰∏ª‰ΩìÔºöÁúãË∂ãÂäø„ÄÅÂÖ≥ÈîÆÊãêÁÇπ„ÄÅ‰π∞ÂçñÁÇπÊòØÂê¶È°∫Âäø„ÄÇ</li>
                                    <li>ÂùáÁ∫øÔºöMA5/10/20/30 Áî®‰∫éËßÇÂØüË∂ãÂäø‰∏éÊîØÊíëÂéãÂäõ„ÄÇ</li>
                                    <li>Â∫ïÈÉ®Êàê‰∫§ÈáèÔºöËæÖÂä©Âà§Êñ≠Á™ÅÁ†¥/ËÉåÁ¶ª/ÈáèËÉΩË°∞Á´≠„ÄÇ</li>
                                </ol>
                                <div class="help-callout">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">‰∏Ä‰∏™ÂÆûÁî®Âà§Êñ≠</div>
                                    <p style="margin:0;">‰π∞ÂÖ•ÁÇπÂ¶ÇÊûúÂêåÊó∂Â§Ñ‰∫éÂéãÂäõÂØÜÈõÜÂå∫‰∏äÊ≤øÔºåÂÆπÊòìÂÜ≤È´òÂõûËêΩÔºõÂ§Ñ‰∫éÊîØÊíëÂØÜÈõÜÂå∫ÈôÑËøëÊõ¥Á®≥ÔºàÈÖçÂêàÊàê‰∫§ÈáèÁ°ÆËÆ§Ôºâ„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Áº©Êîæ/ÊîæÂ§ßÁº©Â∞è‚ÄúÁä∂ÊÄÅ‰ºöËÆ∞‰Ωè‚Äù</h3>
                                <p style="margin:0;">‰Ω†Ë∞ÉÊï¥ K Á∫øÂ∫ïÈÉ®Áº©ÊîæÊù°ÂêéÔºåÁ≥ªÁªü‰ºöËá™Âä®‰øùÂ≠òÂèØËßÜÂå∫Ôºàstart/endÔºâ„ÄÇ‰∏ãÊ¨°ËøõÂÖ•ËØ¶ÊÉÖÈ°µ‰ºöÊÅ¢Â§çÔºå‰∏çÁî®ÊØèÊ¨°ÈáçË∞É„ÄÇ</p>
                                <div class="help-callout good">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">‰ªÄ‰πàÊó∂ÂÄô‰ºö‰øùÂ≠ò</div>
                                    <ul style="margin:0; padding-left:16px;">
                                        <li>ÊãñÂä®Áº©ÊîæÊù°/Áº©ÊîæÊìç‰ΩúÊó∂ÂÆûÊó∂‰øùÂ≠ò„ÄÇ</li>
                                        <li>‰ªéËØ¶ÊÉÖÈ°µÂàáËµ∞Âà∞ÂÖ∂ÂÆÉ Tab Êó∂‰πü‰ºö‰øùÂ≠ò‰∏ÄÊ¨°„ÄÇ</li>
                                    </ul>
                                </div>
                                <div class="help-diagram">
                                    <svg viewBox="0 0 760 120" width="100%" height="120" xmlns="http://www.w3.org/2000/svg">
                                        <rect x="10" y="18" width="740" height="84" rx="14" fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.12)"/>
                                        <rect x="40" y="60" width="680" height="10" rx="5" fill="rgba(255,255,255,0.10)"/>
                                        <rect x="210" y="56" width="260" height="18" rx="9" fill="rgba(102,126,234,0.45)"/>
                                        <circle cx="210" cy="65" r="10" fill="#667eea"/>
                                        <circle cx="470" cy="65" r="10" fill="#667eea"/>
                                        <text x="380" y="44" text-anchor="middle" fill="#ddd" font-size="12">Áº©ÊîæÊù°ÔºàÂèØËßÜÂå∫‰ºö‰øùÂ≠òÔºâ</text>
                                        <text x="380" y="92" text-anchor="middle" fill="#999" font-size="11">‰∏ãÊ¨°ËøõÂÖ•ËØ¶ÊÉÖÈ°µËá™Âä®ÊÅ¢Â§ç</text>
                                    </svg>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Á≠πÁ†ÅÂõæÔºöÂéãÂäõ/ÊîØÊíëÁ∫ø + Âõæ‰æã</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>‰ºöËÆ°ÁÆó‚Äú‰∏äÊñπÊúÄÂ§ßÁ≠πÁ†ÅÂØÜÈõÜ‰ª∑Ê†º‚Äù‰Ωú‰∏∫ÂéãÂäõ‰Ωç„ÄÅ‚Äú‰∏ãÊñπÊúÄÂ§ßÁ≠πÁ†ÅÂØÜÈõÜ‰ª∑Ê†º‚Äù‰Ωú‰∏∫ÊîØÊíë‰Ωç„ÄÇ</li>
                                    <li>Âõæ‰æãÂåÖÂê´ÔºöÂéãÂäõÁ∫ø/ÊîØÊíëÁ∫øÔºåÂèØÁÇπÂáªÊòæÁ§∫/ÈöêËóè„ÄÇ</li>
                                    <li>‰∏ãÊñπ‰ø°ÊÅØÂùó‰ºöÊòæÁ§∫ÔºöÂéãÂäõ‰Ωç/ÊîØÊíë‰Ωç„ÄÅËé∑Âà©ÊØî‰æã„ÄÅÂπ≥ÂùáÊàêÊú¨„ÄÅÈõÜ‰∏≠Â∫¶Á≠â„ÄÇ</li>
                                </ul>
                                <div class="help-callout warn">
                                    <div style="font-size:12px;color:var(--text);font-weight:700;margin-bottom:6px;">ËØªÊ≥ïÊèêÁ§∫</div>
                                    <p style="margin:0;">ÂéãÂäõÁ∫øÈôÑËøëÊõ¥ÂÆπÊòìÂá∫Áé∞ÊäõÂéãÔºåÊîØÊíëÁ∫øÈôÑËøëÊõ¥ÂÆπÊòìÂá∫Áé∞ÊâøÊé•„ÄÇÂª∫ËÆÆÁªìÂêà‚ÄúËøëÊúüÊàê‰∫§ÈáèÊòØÂê¶ÊîæÂ§ß‚ÄùÂà§Êñ≠Á™ÅÁ†¥ÊúâÊïàÊÄß„ÄÇ</p>
                                </div>
                            </div>
                            <div class="help-card">
                                <h3>Â∏∏ËßÅÊìç‰Ωú</h3>
                                <ul style="margin:0; padding-left:16px;">
                                    <li>Èº†Ê†áÁßªÂä®ÔºöÈ°∂ÈÉ®‰ø°ÊÅØÊ†èÈöèÂçÅÂ≠óÂÖâÊ†áÂèòÂåñ„ÄÇ</li>
                                    <li>Èº†Ê†áÁßªÂá∫ÔºöËá™Âä®ÂõûÂà∞ÊúÄÊñ∞‰∏ÄÂ§©Êï∞ÊçÆÊòæÁ§∫„ÄÇ</li>
                                    <li>Áº©ÊîæÊîπÂèòÂèØËßÜÂå∫ÔºöÊõ¥ÂÆπÊòìÁúãÊ∏Ö‰∏ÄÊÆµË°åÊÉÖÁöÑÁªìÊûÑ„ÄÇ</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="help-faq" class="help-section">
                        <div class="help-grid">
                            <div class="help-card">
                                <h3>QÔºöÈÄâÊ¶ÇÂøµÂêé‰∏∫‰ªÄ‰πà‰ª•Ââç‰ºö 0 Âè™Ôºü</h3>
                                <p style="margin:0;">AÔºöÊóßÈÄªËæëÊòØ‚ÄúÊ¶ÇÂøµÊñáÂ≠óÂåÖÂê´ÂåπÈÖç‚ÄùÔºåÂëΩ‰∏≠Áéá‰Ωé„ÄÇÁé∞Âú®ÊòØ‚ÄúÊ¶ÇÂøµ ‚Üí ÊàêÂàÜËÇ° ‚Üí ËøáÊª§ ‚Üí Êâ´Êèè‚ÄùÔºåËÉΩÂæóÂà∞ÁúüÂÆûÊ¶ÇÂøµÊ±†„ÄÇ</p>
                            </div>
                            <div class="help-card">
                                <h3>QÔºöÊ¶ÇÂøµÂ§öÈÄâÊó∂ÊòØÂπ∂ÈõÜËøòÊòØ‰∫§ÈõÜÔºü</h3>
                                <p style="margin:0;">AÔºöÂΩìÂâçÊåâÂπ∂ÈõÜÔºà‰ªª‰∏ÄÊ¶ÇÂøµÁöÑÊàêÂàÜËÇ°ÈÉΩ‰ºöËøõÂÖ•Êâ´ÊèèÔºâ„ÄÇÂ¶ÇÊûú‰Ω†ÈúÄË¶Å‰∫§ÈõÜÔºàÂêåÊó∂Â±û‰∫éÂ§ö‰∏™Ê¶ÇÂøµÔºâÔºåÊàëÂèØ‰ª•Âä†‰∏Ä‰∏™ÂºÄÂÖ≥„ÄÇ</p>
                            </div>
                            <div class="help-card">
                                <h3>QÔºöPE/PB ‰∏∫‰ªÄ‰πàÊòæÁ§∫ --Ôºü</h3>
                                <p style="margin:0;">AÔºöÂ∏∏ËßÅÂéüÂõ†ÊòØ daily_basic ÊùÉÈôê/È¢ëÊéßÂØºËá¥ÂêéÁ´ØÊãø‰∏çÂà∞ÔºåÊàñÂΩìÂâçÂú®Áî®ÁºìÂ≠ò/Ê®°ÊãüÊï∞ÊçÆ„ÄÇÁé∞Âú®ÂâçÁ´ØÂ∑≤ÊîØÊåÅÊää pe/pb ‰øùÂ≠òÂà∞Êú¨Âú∞ÁºìÂ≠òÔºõÂª∫ËÆÆÁ°Æ‰øùÂêéÁ´ØËøûÊé•Ê≠£Â∏∏Âπ∂ÈáçÊñ∞ÊãâÂèñ‰∏ÄÊ¨°Êï∞ÊçÆ„ÄÇ</p>
                            </div>
                            <div class="help-card">
                                <h3>QÔºöÊô∫ËÉΩÈ™åËØÅÊÄé‰πàÁ™ÅÁÑ∂Ê≤°ÊúâÁªìÊûú‰∫ÜÔºü</h3>
                                <p style="margin:0;">AÔºö‰Ω†Ë¶ÅÊ±Ç‚ÄúÂèñÊ∂àÊó†ÂéÜÂè≤‚ÄùÔºåÊâÄ‰ª•Êó†ÂéÜÂè≤‰∫§ÊòìÁöÑÁ≠ñÁï•‰ºöË¢´ÂâîÈô§ÔºõÂ¶ÇÊûúÈó®ÊßõÂÜçËÆæÂæóËøáÈ´òÔºåÂ∞±ÂèØËÉΩ 0 ÁªìÊûú„ÄÇÂª∫ËÆÆÂÖàÊääÊúÄ‰Ωé‰∫§ÊòìÊï∞/ÊúÄ‰ΩéËØÑÂàÜËÆæÂ∞èÔºåÂÜçÈÄêÊ≠•ÊèêÈ´ò„ÄÇ</p>
                            </div>
                            <div class="help-card">
                                <h3>QÔºö‰∏∫‰ªÄ‰πàÊâ´ÊèèÂæàÊÖ¢Ôºü</h3>
                                <p style="margin:0;">AÔºöÊâ´ÊèèÊú¨Ë¥®ÊòØ‚ÄúÂØπÊØèÂè™ËÇ°Á•®ÊãâÊï∞ÊçÆ + Ë∑ëÁ≠ñÁï•‚Äù„ÄÇÂª∫ËÆÆÔºöÂÖàÁî®ÁÉ≠Èó®/ÊåáÊï∞ËåÉÂõ¥„ÄÅÁº©Áü≠Êó•Êúü„ÄÅÂáèÂ∞ëÁ≠ñÁï•Êï∞Èáè„ÄÅÂÜçÈÄêÊ≠•Êâ©Â§ß„ÄÇ</p>
                            </div>
                            <div class="help-card">
                                <h3>QÔºöKÁ∫øÁº©Êîæ‰∏∫‰ªÄ‰πàË¶Å‰øùÂ≠òÔºü</h3>
                                <p style="margin:0;">AÔºöÂ§çÁõòÊó∂‰Ω†ÈÄöÂ∏∏‰ºöÂõ∫ÂÆöÁúãÊüê‰∏ÄÊÆµËµ∞ÂäøÔºåËá™Âä®‰øùÂ≠òÁº©ÊîæËÉΩÈÅøÂÖçÊØèÊ¨°ËøõËØ¶ÊÉÖÈ°µÈÉΩÈáçÊñ∞ÊãñÂä®Áº©ÊîæÊù°„ÄÇ</p>
                            </div>
                            <div class="help-card">
                                <h3>QÔºöËøûÊé•‰∏ç‰∏äÂêéÁ´ØÊÄé‰πàÂäûÔºü</h3>
                                <p style="margin:0;">AÔºöÁ°ÆËÆ§ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®ÔºàÈªòËÆ§ 5000 Á´ØÂè£ÔºâÔºåÂπ∂‰∏îÊµèËßàÂô®Ê≤°ÊúâË¢´Ë∑®Âüü/Èò≤ÁÅ´Â¢ôÈòªÊñ≠„ÄÇËøûÊé•‰∏ç‰∏äÊó∂Á≥ªÁªü‰ºöÂõûÈÄÄÁºìÂ≠ò/Ê®°ÊãüÊï∞ÊçÆ‰ª•‰øùÊåÅÂèØÁî®„ÄÇ</p>
                            </div>
                            <div class="help-card">
                                <h3>QÔºöÊï∞ÊçÆÊù°Êï∞Â§™Â∞ë/ÊåáÊ†á‰∏çÂá∫ÊÄé‰πàÂäûÔºü</h3>
                                <p style="margin:0;">AÔºöÈÉ®ÂàÜÊåáÊ†á‰∏éÁ≠ñÁï•ÈúÄË¶ÅË∂≥Â§üÁöÑÂéÜÂè≤ÈïøÂ∫¶ÔºàÂùáÁ∫ø„ÄÅÂõûÊµãÁ™óÂè£Ôºâ„ÄÇÊääÊó•ÊúüÂå∫Èó¥Êâ©Âà∞ 6ÔΩû24 ‰∏™ÊúàÈÄöÂ∏∏Êõ¥Á®≥„ÄÇ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <!-- ËøûÊé•Áä∂ÊÄÅ -->
            <div class="panel">
                <div class="connection-status" id="connectionStatus">
                    <div class="status-dot"></div>
                    <span id="connectionText">Ê£ÄÊµãÂêéÁ´ØËøûÊé•...</span>
                </div>
                <div class="data-info" id="dataInfo" style="display:none;">
                    <div class="data-info-row">
                        <span class="data-info-label">Êï∞ÊçÆÊù•Ê∫ê</span>
                        <span class="data-info-value">Tushare Pro</span>
                    </div>
                    <div class="data-info-row">
                        <span class="data-info-label">Êï∞ÊçÆÊù°Êï∞</span>
                        <span class="data-info-value" id="dataCount">--</span>
                    </div>
                    <div class="data-info-row">
                        <span class="data-info-label">Êó∂Èó¥ËåÉÂõ¥</span>
                        <span class="data-info-value" id="dataRange">--</span>
                    </div>
                </div>
            </div>

            <!-- ÂõûÊµãËÆæÁΩÆ -->
            <div class="panel">
                <div class="panel-title">üìà ÂõûÊµãËÆæÁΩÆ</div>
                
                <div class="form-row">
                    <div class="form-group stock-search-container">
                        <label>ËÇ°Á•®‰ª£Á†ÅÔºàÊîØÊåÅÊêúÁ¥¢Ôºâ</label>
                        <input type="text" id="stockCode" value="000001.SZ" 
                               placeholder="ËæìÂÖ•‰ª£Á†ÅÊàñÂêçÁß∞ÊêúÁ¥¢" 
                               oninput="searchStock(this.value)">
                        <div class="stock-search-results" id="searchResults"></div>
                    </div>
                    <div class="form-group">
                        <label>ÂàùÂßãËµÑÈáëÔºà‰∏áÂÖÉÔºâ</label>
                        <input type="number" id="initCapital" value="100">
                    </div>
                </div>
                <div id="stockName" style="font-size:12px;color:#667eea;margin:-6px 0 8px 0;"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ÂºÄÂßãÊó•Êúü</label>
                        <input type="date" id="startDate" value="2023-01-01">
                    </div>
                    <div class="form-group">
                        <label>ÁªìÊùüÊó•Êúü</label>
                        <input type="date" id="endDate" value="2024-12-20">
                    </div>
                </div>
            </div>

            <!-- Á≠ñÁï•ÈÄâÊã© -->
            <div class="panel">
                <div class="panel-title">
                    <span>üéØ Á≠ñÁï•ÈÄâÊã©ÔºàÂ§öÈÄâÂØπÊØîÔºâ</span>
                    <span style="margin-left:auto;display:flex;align-items:center;gap:8px;">
                        <button class="btn btn-secondary" style="width:auto;padding:4px 10px;font-size:12px;" onclick="batchSelectStrategies('strategyGrid','all'); event.stopPropagation();">ÂÖ®ÈÄâ</button>
                        <button class="btn btn-secondary" style="width:auto;padding:4px 10px;font-size:12px;" onclick="batchSelectStrategies('strategyGrid','none'); event.stopPropagation();">ÂÖ®‰∏çÈÄâ</button>
                        <button class="btn btn-secondary" style="width:auto;padding:4px 10px;font-size:12px;" onclick="batchSelectStrategies('strategyGrid','invert'); event.stopPropagation();">ÂèçÈÄâ</button>
                    </span>
                </div>
                <div class="strategy-grid" id="strategyGrid">
                    <div class="strategy-card active" data-strategy="deep_fusion">
                        <div class="checkbox"></div>
                        <div class="name">ÔøΩ Ê∑±Â∫¶ËûçÂêà</div>
                        <div class="expected">È¢ÑÊúü60-120%</div>
                    </div>
                    <div class="strategy-card active" data-strategy="volume_breakout">
                        <div class="checkbox"></div>
                        <div class="name">üî• Èáè‰ª∑Á™ÅÁ†¥</div>
                        <div class="expected">È¢ÑÊúü50-100%</div>
                    </div>
                    <div class="strategy-card active" data-strategy="oversold_rebound">
                        <div class="checkbox"></div>
                        <div class="name">üíé Ë∂ÖË∑åÂèçÂºπ</div>
                        <div class="expected">È¢ÑÊúü40-80%</div>
                    </div>
                    <div class="strategy-card active" data-strategy="trend_enhanced">
                        <div class="checkbox"></div>
                        <div class="name">üìà Ë∂ãÂäøÂ¢ûÂº∫</div>
                        <div class="expected">È¢ÑÊúü45-90%</div>
                    </div>
                    <div class="strategy-card active" data-strategy="macd_divergence">
                        <div class="checkbox"></div>
                        <div class="name">ÔøΩ MACDËÉåÁ¶ª</div>
                        <div class="expected">È¢ÑÊúü35-70%</div>
                    </div>
                    <div class="strategy-card active" data-strategy="bollinger_extreme">
                        <div class="checkbox"></div>
                        <div class="name">üéØ Â∏ÉÊûóÊûÅÈôê</div>
                        <div class="expected">È¢ÑÊúü30-60%</div>
                    </div>
                    <div class="strategy-card active" data-strategy="momentum_rotation">
                        <div class="checkbox"></div>
                        <div class="name">‚ö° Âä®ÈáèËΩÆÂä®</div>
                        <div class="expected">È¢ÑÊúü50-100%</div>
                    </div>
                    <div class="strategy-card active" data-strategy="turtle_enhanced">
                        <div class="checkbox"></div>
                        <div class="name">ÔøΩ Êµ∑ÈæüÂ¢ûÂº∫</div>
                        <div class="expected">È¢ÑÊúü40-80%</div>
                    </div>
                </div>
            </div>

            <!-- Á≠ñÁï•ÂèÇÊï∞ -->
            <div class="panel">
                <div class="panel-title">üéØ Á≠ñÁï•ÂèÇÊï∞</div>
                <div class="form-group" style="max-width:200px;margin-bottom:10px;">
                    <select id="paramStrategy" onchange="updateStrategyParams()">
                        <option value="deep_fusion">Ê∑±Â∫¶ËûçÂêà</option>
                        <option value="volume_breakout">ÈáèËÉΩÁ™ÅÁ†¥</option>
                        <option value="oversold_rebound">Ë∂ÖË∑åÂèçÂºπ</option>
                        <option value="trend_enhanced">Ë∂ãÂäøÂ¢ûÂº∫</option>
                        <option value="macd_divergence">MACDËÉåÁ¶ª</option>
                        <option value="bollinger_extreme">Â∏ÉÊûóÊûÅÈôê</option>
                        <option value="momentum_rotation">Âä®ÈáèËΩÆÂä®</option>
                        <option value="turtle_enhanced">Êµ∑ÈæüÂ¢ûÂº∫</option>
                    </select>
                </div>
                <div id="strategyParams" style="padding:10px;">
                    <div class="no-params">ËØ∑ÂÖàÈÄâÊã©Á≠ñÁï•Êü•ÁúãÂèÇÊï∞</div>
                </div>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="panel">
                <div class="panel-title">üéÆ Êìç‰Ωú</div>
                <button class="btn btn-primary" id="runBtn" onclick="runComparison()">
                    ‚ñ∂Ô∏è ËøêË°åÁ≠ñÁï•ÂØπÊØî
                </button>
                <div class="btn-grid" style="margin-top:10px">
                    <button class="btn btn-info" onclick="fetchStockData()">
                        üîÑ Âà∑Êñ∞Êï∞ÊçÆ
                    </button>
                    <button class="btn btn-success" onclick="exportResults()">
                        üì• ÂØºÂá∫Êä•Âëä
                    </button>
                    <button class="btn btn-secondary" onclick="showCacheInfo()" title="Êü•ÁúãÁºìÂ≠ò‰ø°ÊÅØ">
                        üíæ ÁºìÂ≠ò‰ø°ÊÅØ
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllCache()" title="Ê∏ÖÈô§ÊâÄÊúâÁºìÂ≠òÊï∞ÊçÆ">
                        üóëÔ∏è Ê∏ÖÈô§ÁºìÂ≠ò
                    </button>
                    <button class="btn btn-secondary" onclick="exportSettingsBundle()" title="ÂØºÂá∫ÊâÄÊúâÁïåÈù¢ËÆæÁΩÆ‰∏éËÇ°Á•®Ê±†ÔºåË∑®ÊµèËßàÂô®/ÁîµËÑëËøÅÁßª">
                        ‚¨ÜÔ∏è ÂØºÂá∫ËÆæÁΩÆ
                    </button>
                    <button class="btn btn-secondary" onclick="promptImportSettingsBundle()" title="ÂØºÂÖ•ËÆæÁΩÆÊñá‰ª∂ÔºåÊÅ¢Â§çÊâÄÊúâÁïåÈù¢ËÆæÁΩÆ‰∏éËÇ°Á•®Ê±†">
                        ‚¨áÔ∏è ÂØºÂÖ•ËÆæÁΩÆ
                    </button>
                </div>
                <input type="file" id="importSettingsFile" accept="application/json" style="display:none" onchange="handleImportSettingsFile(this.files && this.files[0]); this.value='';">
            </div>
        </div>

        <div class="main-content">
            <!-- Ê†áÁ≠æÈ°µ -->
            <div class="tabs">
                <div class="tab active" data-tab="comparison" onclick="switchTab('comparison')">üìä Á≠ñÁï•ÂØπÊØî</div>
                <div class="tab" data-tab="details" onclick="switchTab('details')">üìà ËØ¶ÁªÜÂàÜÊûê</div>
                <div class="tab" data-tab="optimization" onclick="switchTab('optimization')">üéØ ÂèÇÊï∞‰ºòÂåñ</div>
                <div class="tab" data-tab="screening" onclick="switchTab('screening')">üîç ËÇ°Á•®Á≠õÈÄâ</div>
                <div class="tab" data-tab="pool" onclick="switchTab('pool')">üì¶ ËÇ°Á•®Ê±†</div>
            </div>

            <!-- Á≠ñÁï•ÂØπÊØîÈ°µ -->
            <div class="tab-content active" id="tab-comparison">
                <div class="panel">
                    <div class="panel-title">üèÜ ÊúÄ‰ºòÁ≠ñÁï•ÁªìÊûú</div>
                    <div class="result-grid">
                        <div class="result-card">
                            <div class="label">ÊúÄ‰Ω≥Á≠ñÁï•</div>
                            <div class="value neutral" id="bestStrategy">--</div>
                        </div>
                        <div class="result-card">
                            <div class="label">ÊúÄÈ´òÊî∂ÁõäÁéá</div>
                            <div class="value positive" id="bestReturn">+0.00%</div>
                        </div>
                        <div class="result-card">
                            <div class="label">Âπ¥ÂåñÊî∂Áõä</div>
                            <div class="value positive" id="bestAnnual">+0.00%</div>
                        </div>
                        <div class="result-card">
                            <div class="label">ÊúÄÂ§ßÂõûÊí§</div>
                            <div class="value negative" id="bestDrawdown">-0.00%</div>
                        </div>
                        <div class="result-card">
                            <div class="label">Â§èÊôÆÊØîÁéá</div>
                            <div class="value neutral" id="bestSharpe">0.00</div>
                        </div>
                        <div class="result-card">
                            <div class="label">ËÉúÁéá</div>
                            <div class="value neutral" id="bestWinRate">0.00%</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">üìä Á≠ñÁï•Êî∂ÁõäÂØπÊØîÊéíÂêç</div>
                    <div style="max-height: 350px; overflow-y: auto;">
                        <table class="comparison-table" id="comparisonTable">
                            <thead>
                                <tr>
                                    <th>ÊéíÂêç</th>
                                    <th>Á≠ñÁï•ÂêçÁß∞</th>
                                    <th>ÊÄªÊî∂ÁõäÁéá</th>
                                    <th>Âπ¥ÂåñÊî∂Áõä</th>
                                    <th>ÊúÄÂ§ßÂõûÊí§</th>
                                    <th>Â§èÊôÆÊØîÁéá</th>
                                    <th>Âç°ÁéõÊØîÁéá</th>
                                    <th>ËÉúÁéá</th>
                                    <th>Áõà‰∫èÊØî</th>
                                    <th>‰∫§ÊòìÊ¨°Êï∞</th>
                                    <th>ÁªºÂêàËØÑÂàÜ</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonBody">
                                <tr>
                                    <td colspan="11" style="text-align:center;color:#888;padding:40px;">
                                        ËØ∑ÁÇπÂáª"ËøêË°åÁ≠ñÁï•ÂØπÊØî"ÂºÄÂßãÂàÜÊûê
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-box full-width">
                        <div class="chart-title">üìà Á≠ñÁï•Êî∂ÁõäÊõ≤Á∫øÂØπÊØîÔºàTushareÁúüÂÆûÊï∞ÊçÆÔºâ</div>
                        <div id="equityChart" class="chart chart-large"></div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title">üéØ Á≠ñÁï•ÊÄßËÉΩÈõ∑ËææÂõæ</div>
                        <div id="radarChart" class="chart"></div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title">üìä Êî∂ÁõäÁéáÂàÜÂ∏É</div>
                        <div id="returnDistChart" class="chart"></div>
                    </div>
                </div>
            </div>

            <!-- ËØ¶ÁªÜÂàÜÊûêÈ°µ -->
            <div class="tab-content" id="tab-details">
                <div class="panel">
                    <div class="panel-title">
                        <span>üìà ËØ¶ÁªÜÂàÜÊûê</span>
                        <span style="margin-left:auto;display:flex;align-items:center;gap:8px;">
                            <button class="btn btn-info" style="width:auto;padding:4px 10px;font-size:12px;" onclick="openF10ForCurrentStock()">F10ËµÑÊñô</button>
                        </span>
                    </div>
                    <div class="form-group" style="max-width:200px;margin-bottom:10px;">
                        <select id="detailStrategy" onchange="updateDetailAnalysis()">
                            <option value="deep_fusion">Ê∑±Â∫¶ËûçÂêà</option>
                            <option value="volume_breakout">ÈáèËÉΩÁ™ÅÁ†¥</option>
                            <option value="oversold_rebound">Ë∂ÖË∑åÂèçÂºπ</option>
                            <option value="trend_enhanced">Ë∂ãÂäøÂ¢ûÂº∫</option>
                            <option value="macd_divergence">MACDËÉåÁ¶ª</option>
                            <option value="bollinger_extreme">Â∏ÉÊûóÊûÅÈôê</option>
                            <option value="momentum_rotation">Âä®ÈáèËΩÆÂä®</option>
                            <option value="turtle_enhanced">Êµ∑ÈæüÂ¢ûÂº∫</option>
                        </select>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">üìä ÂõûÊµãÁªìÊûú</div>
                    <div class="result-grid" id="detailResultGrid">
                        <div class="result-card">
                            <div class="label">ÊÄªÊî∂ÁõäÁéá</div>
                            <div class="value" id="detailTotalReturn">--</div>
                        </div>
                        <div class="result-card">
                            <div class="label">Âπ¥ÂåñÊî∂ÁõäÁéá</div>
                            <div class="value" id="detailAnnualReturn">--</div>
                        </div>
                        <div class="result-card">
                            <div class="label">ÊúÄÂ§ßÂõûÊí§</div>
                            <div class="value" id="detailMaxDrawdown">--</div>
                        </div>
                        <div class="result-card">
                            <div class="label">ËÉúÁéá</div>
                            <div class="value" id="detailWinRate">--</div>
                        </div>
                        <div class="result-card">
                            <div class="label">Áõà‰∫èÊØî</div>
                            <div class="value" id="detailProfitLossRatio">--</div>
                        </div>
                        <div class="result-card">
                            <div class="label">‰∫§ÊòìÊ¨°Êï∞</div>
                            <div class="value" id="detailTradeCount">--</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">üìà KÁ∫øÂõæ‰∏é‰π∞ÂçñÁÇπ</div>
                    <div class="kline-wrapper" style="display: flex; height: 580px; width: 100%; position: relative;">
                        <div id="kline-header-info" style="position: absolute; top: 0px; left: 10px; right: 20%; z-index: 100; pointer-events: none; font-size: 14px; line-height: 1.2; color: #ccc;"></div>
                        <div id="klineChart" style="width: 80%; height: 100%;"></div>
                        <div id="chipChart" style="width: 20%; height: 100%; border-left: 1px solid rgba(102, 126, 234, 0.2); background: rgba(0,0,0,0.1);"></div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">üìä Êî∂ÁõäÁéáÊõ≤Á∫ø</div>
                    <div id="returnCurveChart" style="width:100%;height:300px;"></div>
                </div>

                <div class="panel">
                    <div class="panel-title">üìã ‰∫§ÊòìËÆ∞ÂΩï</div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="comparison-table" id="tradeTable">
                            <thead>
                                <tr>
                                    <th>Â∫èÂè∑</th>
                                    <th>Êó•Êúü</th>
                                    <th>Á±ªÂûã</th>
                                    <th>‰ª∑Ê†º</th>
                                    <th>Êï∞Èáè</th>
                                    <th>ÈáëÈ¢ù</th>
                                    <th>‰ªì‰Ωç</th>
                                    <th>Êî∂ÁõäÁéá</th>
                                    <th>ÊåÅ‰ªìÂ§©Êï∞</th>
                                    <th>ÂçñÂá∫ÂéüÂõ†</th>
                                </tr>
                            </thead>
                            <tbody id="tradeBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ËÇ°Á•®Á≠õÈÄâÈ°µ -->
            <div class="tab-content" id="tab-screening">
                <div class="panel">
                    <div class="panel-title">üéØ Á≠õÈÄâÊù°‰ª∂ËÆæÁΩÆ</div>
                    
                    <!-- Á¨¨‰∏ÄË°åÔºöÁ≠õÈÄâËåÉÂõ¥Âíå‰ø°Âè∑Êó∂Èó¥ -->
                    <div class="form-row" style="margin-bottom: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Á≠õÈÄâËåÉÂõ¥</label>
                            <select id="screeningScope" onchange="toggleCustomStockInput()">
                                <option value="hot">ÁÉ≠Èó®ËÇ° (Top 10)</option>
                                <option value="all_a">AËÇ°ÂÖ®ËåÉÂõ¥ (ÊâÄÊúâ‰∏äÂ∏Ç)</option>
                                <option value="sh">Ê≤™Â∏Ç (SH)</option>
                                <option value="sz">Ê∑±Â∏Ç (SZ)</option>
                                <option value="cyb">Âàõ‰∏öÊùø (300/301)</option>
                                <option value="000016.SH">‰∏äËØÅ50 (ÁúüÂÆû)</option>
                                <option value="000300.SH">Ê≤™Ê∑±300 (ÁúüÂÆû)</option>
                                <option value="custom">Ëá™ÈÄâËÇ°</option>
                            </select>
                            <div id="customStockInputGroup" style="display:none; margin-top: 5px;">
                                <input type="text" id="customStockInput" class="form-control" placeholder="‰ª£Á†ÅÈÄóÂè∑ÂàÜÈöî..." style="width: 100%;">
                            </div>
                        </div>
                        
                        <div class="form-group" style="flex: 1;">
                            <label>‰ø°Âè∑Êó∂Èó¥</label>
                            <select id="signalPeriod">
                                <option value="1">ÊúÄËøë1Â§©</option>
                                <option value="3" selected>ÊúÄËøë3Â§©</option>
                                <option value="5">ÊúÄËøë5Â§©</option>
                            </select>
                        </div>
                    </div>

                    <!-- Á¨¨‰∫åË°åÔºöÊô∫ËÉΩÈ™åËØÅ -->
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="display:flex; align-items:center; cursor:pointer; font-size:12px; margin-bottom: 2px; white-space:nowrap; overflow:hidden;">
                            <label class="toggle" style="margin-right: 6px;">
                                <input type="checkbox" id="enableSmartVerification" onchange="toggleSmartVerificationOptions()">
                                <span class="toggle-slider"></span>
                            </label>
                            Êô∫ËÉΩÈ™åËØÅ (‰ªÖ‰ºòÈÄâ)
                            <span style="font-size: 10px; color: #888; margin-left: 8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0;">(‰ªÖÊòæÁ§∫ÂéÜÂè≤ÂõûÊµãÊî∂Áõä>0%ÁöÑ‰ºòË¥®‰ø°Âè∑)</span>
                        </label>
                        <div id="smartVerificationOptions" style="display:block; margin-top: 6px;">
                            <div style="display:flex; gap:8px; flex-wrap:nowrap; white-space:nowrap; align-items:center; overflow-x:auto;">
                                <span style="font-size: 11px; color: #aaa;">Êù°‰ª∂</span>
                                <label style="font-size: 11px; color: #aaa; display:flex; align-items:center; gap:4px; white-space:nowrap; flex:0 0 auto;">
                                    ÊúÄ‰ΩéËØÑÂàÜ
                                    <input id="smartMinScore" type="number" value="0" style="width:60px; padding:4px; border:1px solid #444; border-radius:4px; background:#1f1f1f; color:#ddd;">
                                </label>
                                <label style="font-size: 11px; color: #aaa; display:flex; align-items:center; gap:4px; white-space:nowrap; flex:0 0 auto;">
                                    ÊúÄ‰ΩéÊî∂Áõä%
                                    <input id="smartMinReturn" type="number" value="0" step="0.1" style="width:70px; padding:4px; border:1px solid #444; border-radius:4px; background:#1f1f1f; color:#ddd;">
                                </label>
                                <label style="font-size: 11px; color: #aaa; display:flex; align-items:center; gap:4px; white-space:nowrap; flex:0 0 auto;">
                                    ÊúÄ‰ΩéËÉúÁéá%
                                    <input id="smartMinWinRate" type="number" value="0" step="1" style="width:70px; padding:4px; border:1px solid #444; border-radius:4px; background:#1f1f1f; color:#ddd;">
                                </label>
                                <label style="font-size: 11px; color: #aaa; display:flex; align-items:center; gap:4px; white-space:nowrap; flex:0 0 auto;">
                                    ÊúÄ‰Ωé‰∫§ÊòìÊï∞
                                    <input id="smartMinTrades" type="number" value="0" step="1" style="width:70px; padding:4px; border:1px solid #444; border-radius:4px; background:#1f1f1f; color:#ddd;">
                                </label>
                                <label style="font-size: 11px; color: #aaa; display:flex; align-items:center; gap:4px; white-space:nowrap; flex:0 0 auto;">
                                    ÊéíÂ∫è‰ºòÂÖà
                                    <select id="smartRankBy" style="padding:4px; border:1px solid #444; border-radius:4px; background:#1f1f1f; color:#ddd; font-size:11px; line-height:1;">
                                        <option value="score" selected>ËØÑÂàÜ</option>
                                        <option value="return">Êî∂Áõä</option>
                                        <option value="winrate">ËÉúÁéá</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Á¨¨‰∏âË°åÔºöË°å‰∏öÂíåÊ¶ÇÂøµÁ≠õÈÄâ -->
                    <div class="form-row" style="margin-bottom: 10px;">
                        <div class="form-group" style="flex: 1; display: flex; align-items: center; gap: 8px;">
                            <label class="toggle" style="flex-shrink: 0; margin-right: 0;">
                                <input type="checkbox" id="enableIndustryFilter" onchange="toggleIndustryFilter()">
                                <span class="toggle-slider"></span>
                            </label>
                            <div style="flex: 1; position: relative;" id="industryInputContainer">
                                <input type="text" id="screeningIndustry" class="form-control" placeholder="ÈÄâÊã©Ë°å‰∏ö..." onclick="toggleIndustryDropdown()" style="cursor:pointer;" disabled readonly>
                                <div id="industryDropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; z-index: 1000; padding: 0;">
                                    <div style="position: sticky; top: 0; background: #2a2a2a; padding: 6px; border-bottom: 1px solid #3a3a3a; z-index: 1;">
                                        <input id="industrySearchInput" type="text" placeholder="ÊêúÁ¥¢Ë°å‰∏ö..." oninput="filterIndustryOptions()" style="width: 100%; padding: 6px; border: 1px solid #444; border-radius: 4px; background: #1f1f1f; color: #ddd; font-size: 12px;">
                                    </div>
                                    <div id="industryOptions" style="padding: 5px;">
                                        <div style="padding: 5px; color: #888; font-size: 12px;">Ê≠£Âú®Âä†ËΩΩ...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="flex: 1; display: flex; align-items: center; gap: 8px;">
                            <label class="toggle" style="flex-shrink: 0; margin-right: 0;">
                                <input type="checkbox" id="enableConceptFilter" onchange="toggleConceptFilter()">
                                <span class="toggle-slider"></span>
                            </label>
                            <div style="flex: 1; position: relative;" id="conceptInputContainer">
                                <input type="text" id="screeningConcept" class="form-control" placeholder="ÈÄâÊã©Ê¶ÇÂøµ..." onclick="toggleConceptDropdown()" style="cursor:pointer;" disabled>
                                <div id="conceptDropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; z-index: 1000; padding: 0;">
                                    <div style="position: sticky; top: 0; background: #2a2a2a; padding: 6px; border-bottom: 1px solid #3a3a3a; z-index: 1;">
                                        <input id="conceptSearchInput" type="text" placeholder="ÊêúÁ¥¢Ê¶ÇÂøµ..." oninput="filterConceptOptions()" style="width: 100%; padding: 6px; border: 1px solid #444; border-radius: 4px; background: #1f1f1f; color: #ddd; font-size: 12px;">
                                    </div>
                                    <div id="conceptOptions" style="padding: 5px;">
                                        <div style="padding: 5px; color: #888; font-size: 12px;">Ê≠£Âú®Âä†ËΩΩ...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                            <label style="margin:0;">ÈÄâÊã©Á≠ñÁï• (Â§öÈÄâ)</label>
                            <span style="margin-left:auto;display:flex;align-items:center;gap:8px;">
                                <button class="btn btn-secondary" style="width:auto;padding:4px 10px;font-size:12px;" onclick="batchSelectStrategies('screeningStrategyGrid','all'); event.stopPropagation();">ÂÖ®ÈÄâ</button>
                                <button class="btn btn-secondary" style="width:auto;padding:4px 10px;font-size:12px;" onclick="batchSelectStrategies('screeningStrategyGrid','none'); event.stopPropagation();">ÂÖ®‰∏çÈÄâ</button>
                                <button class="btn btn-secondary" style="width:auto;padding:4px 10px;font-size:12px;" onclick="batchSelectStrategies('screeningStrategyGrid','invert'); event.stopPropagation();">ÂèçÈÄâ</button>
                            </span>
                        </div>
                        <div class="strategy-grid" id="screeningStrategyGrid" style="grid-template-columns: repeat(4, 1fr);">
                            <!-- JSÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                    
                    <div class="btn-group" style="display:flex; gap:8px; align-items:center; flex-wrap:nowrap;">
                        <button class="btn btn-primary" id="btnRunStockScreening" onclick="runStockScreening()">üîç ÂºÄÂßãÁ≠õÈÄâ</button>
                        <button class="btn btn-warning" id="btnPauseResumeScreening" onclick="togglePauseResumeStockScreening()" disabled>‚è∏ ÊöÇÂÅú</button>
                        <button class="btn btn-danger" id="btnStopScreening" onclick="stopStockScreening()" disabled>‚èπ ÂÅúÊ≠¢</button>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-title">
                        <span>üìä Á≠õÈÄâÁªìÊûú</span>
                        <span style="display:flex;align-items:center;gap:10px;margin-left:auto;">
                            <span id="screeningStatus" style="font-size: 12px; color: #888; font-weight: normal;"></span>
                                <button class="btn btn-success" style="width:auto;padding:4px 10px;font-size:12px;" onclick="addScreeningResultsToPool(this)">
                                    ‚ûï Âä†ÂÖ•ËÇ°Ê±†
                                </button>
                            <button class="btn btn-warning" style="width:auto;padding:4px 10px;font-size:12px;" onclick="clearScreeningResults()">
                                üßπ Ê∏ÖÁ©∫ÁªìÊûú
                            </button>
                        </span>
                    </div>
                    
                    <!-- Á≠õÈÄâËøõÂ∫¶ -->
                    <div class="progress-container" id="screeningProgressContainer">
                        <div class="progress-header">
                            <span id="screeningProgressLabel">Êâ´Êèè‰∏≠...</span>
                            <span id="screeningProgressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="screeningProgressFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="comparison-table" id="screeningTable">
                            <thead>
                                <tr>
                                    <th style="width:42px;">
                                        <input type="checkbox" id="screeningSelectAll" onclick="toggleSelectAllScreening(this)">
                                    </th>
                                    <th>ËÇ°Á•®‰ª£Á†Å</th>
                                    <th>ÂêçÁß∞</th>
                                    <th>Ëß¶ÂèëÁ≠ñÁï•</th>
                                    <th>‰ø°Âè∑Êó•Êúü</th>
                                    <th>‰ø°Âè∑Á±ªÂûã</th>
                                    <th onclick="sortScreeningResults('backtestScore')" style="cursor: pointer; user-select: none;">
                                        ÂéÜÂè≤ËØÑÂàÜ <span id="sortIcon_backtestScore" style="font-size: 10px; color: #666;">‚ñ≤‚ñº</span>
                                    </th>
                                    <th onclick="sortScreeningResults('backtestReturn')" style="cursor: pointer; user-select: none;">
                                        ÂéÜÂè≤Êî∂Áõä <span id="sortIcon_backtestReturn" style="font-size: 10px; color: #666;">‚ñ≤‚ñº</span>
                                    </th>
                                    <th onclick="sortScreeningResults('strength')" style="cursor: pointer; user-select: none;">
                                        Âº∫Â∫¶ <span id="sortIcon_strength" style="font-size: 10px; color: #666;">‚ñ≤‚ñº</span>
                                    </th>
                                    <th onclick="sortScreeningResults('price')" style="cursor: pointer; user-select: none;">
                                        Áé∞‰ª∑ <span id="sortIcon_price" style="font-size: 10px; color: #666;">‚ñ≤‚ñº</span>
                                    </th>
                                    <th>Â∏ÇÁõàÁéá</th>
                                    <th>Â∏ÇÂáÄÁéá</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="screeningBody">
                                <tr>
                                    <td colspan="13" style="text-align:center;color:#888;padding:40px;">
                                        ËØ∑ÈÄâÊã©Á≠ñÁï•Âπ∂ÁÇπÂáª"ÂºÄÂßãÁ≠õÈÄâ"
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <script>
            // Á≠õÈÄâÈ°µÈù¢ÁöÑÂàùÂßãÂåñÈÄªËæë
            let screeningInitialized = false;
            let allStockListCache = []; // ÁºìÂ≠òÂÖ®ÈáèËÇ°Á•®ÂàóË°®‰ø°ÊÅØ
            let allConceptListCache = []; // ÁºìÂ≠òÊ¶ÇÂøµÂàóË°®‰ø°ÊÅØ

            async function initScreeningPage() {
                if (screeningInitialized) return;
                
                // ÂàùÂßãÂåñÁ≠õÈÄâÁ≠ñÁï•ÂàóË°®
                const container = document.getElementById('screeningStrategyGrid');
                if (container) {
                    container.innerHTML = ''; // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
                    Object.entries(STRATEGIES).forEach(([key, strategy]) => {
                        const div = document.createElement('div');
                        div.className = 'strategy-card'; // ÈªòËÆ§‰∏çÈÄâ‰∏≠
                        div.dataset.strategy = key;
                        div.innerHTML = `
                            <div class="checkbox"></div>
                            <div class="name">${strategy.icon} ${strategy.name}</div>
                        `;
                        div.onclick = function() {
                            this.classList.toggle('active');
                        };
                        container.appendChild(div);
                    });
                }

                // Âä†ËΩΩË°å‰∏öÂàóË°® (Â§öÈÄâ)
                try {
                    const industryDropdown = document.getElementById('industryDropdown');
                    if (industryDropdown) {
                        // ‰ΩøÁî® fetch API Ë∞ÉÁî®ÂêéÁ´ØËé∑ÂèñÂÖ®ÈáèËÇ°Á•®ÂàóË°®
                        const response = await fetch(`${API_BASE}/stock_list`);
                        const result = await response.json();
                        if (result.success && result.data) {
                            allStockListCache = result.data; // ÁºìÂ≠òÂÖ®ÈáèÊï∞ÊçÆ
                            
                            // ÊèêÂèñË°å‰∏öÂπ∂ÂéªÈáç
                            const industries = new Set();
                            result.data.forEach(s => {
                                if (s.industry && s.industry !== 'null' && s.industry !== 'None') {
                                    industries.add(s.industry);
                                }
                            });
                            
                            // ÊéíÂ∫è
                            const sortedIndustries = Array.from(industries).sort((a, b) => a.localeCompare(b, 'zh-CN'));
                            
                            let html = `
                                <div style="position: sticky; top: 0; background: #2a2a2a; padding: 6px; border-bottom: 1px solid #3a3a3a; z-index: 1;">
                                    <input id="industrySearchInput" type="text" placeholder="ÊêúÁ¥¢Ë°å‰∏ö..." oninput="filterIndustryOptions()" style="width: 100%; padding: 6px; border: 1px solid #444; border-radius: 4px; background: #1f1f1f; color: #ddd; font-size: 12px;">
                                </div>
                                <div id="industryOptions" style="padding: 5px;">
                            `;
                            if (sortedIndustries.length < 30) {
                                html += `<div style="padding: 6px; color: #ffa502; font-size: 12px;">Ë°å‰∏öÂàóË°®ËæÉÂ∞ëÔºåÈÄöÂ∏∏ÊòØÊú™ÈÖçÁΩÆ Tushare Token ÂØºËá¥</div>`;
                            }
                            sortedIndustries.forEach(ind => {
                                html += `
                                    <label style="display: flex; align-items: center; padding: 4px; cursor: pointer; color: #ccc; font-size: 12px; line-height: 1;">
                                        <input type="checkbox" value="${ind}" onchange="updateIndustryTriggerText()" style="margin: 0 6px 0 0; width: 14px; height: 14px; vertical-align: middle;">
                                        <span style="vertical-align: middle;">${ind}</span>
                                    </label>
                                `;
                            });
                            html += `</div>`;
                            industryDropdown.innerHTML = html;
                        }
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩË°å‰∏öÂàóË°®Â§±Ë¥•:', e);
                    const industryDropdown = document.getElementById('industryDropdown');
                    if (industryDropdown) {
                        industryDropdown.innerHTML = `
                            <div style="position: sticky; top: 0; background: #2a2a2a; padding: 6px; border-bottom: 1px solid #3a3a3a; z-index: 1;">
                                <input id="industrySearchInput" type="text" placeholder="ÊêúÁ¥¢Ë°å‰∏ö..." oninput="filterIndustryOptions()" style="width: 100%; padding: 6px; border: 1px solid #444; border-radius: 4px; background: #1f1f1f; color: #ddd; font-size: 12px;">
                            </div>
                            <div id="industryOptions" style="padding: 5px;">
                                <div style="padding:5px;color:#ff4757;">Âä†ËΩΩÂ§±Ë¥•</div>
                            </div>
                        `;
                    }
                }

                // Âä†ËΩΩÊ¶ÇÂøµÂàóË°® (Â§öÈÄâ)
                try {
                    const conceptDropdown = document.getElementById('conceptDropdown');
                    const conceptOptions = document.getElementById('conceptOptions');
                    if (conceptDropdown && conceptOptions) {
                        const response = await fetch(`${API_BASE}/concept_list`);
                        const result = await response.json();
                        if (result.success && Array.isArray(result.data)) {
                            allConceptListCache = result.data;
                            const names = result.data
                                .map(x => (x && x.name) ? String(x.name) : '')
                                .filter(Boolean);
                            let html = '';
                            if (names.length === 0) {
                                html = `<div style="padding: 6px; color: #ffa502; font-size: 12px;">ÊöÇÊó†Ê¶ÇÂøµÊï∞ÊçÆÔºàÈÄöÂ∏∏ÊòØÊú™ÈÖçÁΩÆ Tushare TokenÔºâ</div>`;
                            } else {
                                names.forEach(name => {
                                    html += `
                                        <label style="display: flex; align-items: center; padding: 4px; cursor: pointer; color: #ccc; font-size: 12px; line-height: 1;">
                                            <input type="checkbox" value="${name}" onchange="updateConceptTriggerText()" style="margin: 0 6px 0 0; width: 14px; height: 14px; vertical-align: middle;">
                                            <span style="vertical-align: middle;">${name}</span>
                                        </label>
                                    `;
                                });
                            }
                            conceptOptions.innerHTML = html;
                        }
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩÊ¶ÇÂøµÂàóË°®Â§±Ë¥•:', e);
                    const conceptOptions = document.getElementById('conceptOptions');
                    if (conceptOptions) {
                        conceptOptions.innerHTML = `<div style="padding:5px;color:#ff4757;">Âä†ËΩΩÂ§±Ë¥•</div>`;
                    }
                }

                screeningInitialized = true;
                if (typeof toggleSmartVerificationOptions === 'function') toggleSmartVerificationOptions();
            }
            
            function toggleIndustryDropdown() {
                const enabled = document.getElementById('enableIndustryFilter').checked;
                if (!enabled) return;
                
                const dropdown = document.getElementById('industryDropdown');
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    const searchInput = document.getElementById('industrySearchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                        filterIndustryOptions();
                    }
                    // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
                    document.addEventListener('click', closeIndustryDropdownOnClickOutside);
                } else {
                    dropdown.style.display = 'none';
                    document.removeEventListener('click', closeIndustryDropdownOnClickOutside);
                }
            }

            function filterIndustryOptions() {
                const input = document.getElementById('industrySearchInput');
                const keyword = (input ? input.value : '').trim().toLowerCase();
                const labels = document.querySelectorAll('#industryOptions label');
                let firstVisible = null;
                labels.forEach(label => {
                    const text = (label.textContent || '').trim().toLowerCase();
                    const visible = !keyword || text.includes(keyword);
                    label.style.display = visible ? 'flex' : 'none';
                    if (visible && !firstVisible) firstVisible = label;
                });
                if (firstVisible) {
                    firstVisible.scrollIntoView({ block: 'nearest' });
                }
            }
            
            function closeIndustryDropdownOnClickOutside(e) {
                if (!e.target.closest('#industryInputContainer')) {
                    document.getElementById('industryDropdown').style.display = 'none';
                    document.removeEventListener('click', closeIndustryDropdownOnClickOutside);
                }
            }
            
            function updateIndustryTriggerText() {
                const selected = Array.from(document.querySelectorAll('#industryDropdown input[type="checkbox"]:checked'))
                    .map(cb => cb.value)
                    .filter(Boolean);
                const input = document.getElementById('screeningIndustry');
                if (input) input.value = selected.join(' ');
                if (typeof scheduleSaveUiState === 'function') scheduleSaveUiState();
            }

            function toggleConceptDropdown() {
                const enabled = document.getElementById('enableConceptFilter').checked;
                if (!enabled) return;
                const dropdown = document.getElementById('conceptDropdown');
                if (!dropdown) return;
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    const searchInput = document.getElementById('conceptSearchInput');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                        filterConceptOptions();
                    }
                    document.addEventListener('click', closeConceptDropdownOnClickOutside);
                } else {
                    dropdown.style.display = 'none';
                    document.removeEventListener('click', closeConceptDropdownOnClickOutside);
                }
            }

            function filterConceptOptions() {
                const input = document.getElementById('conceptSearchInput');
                const keyword = (input ? input.value : '').trim().toLowerCase();
                const labels = document.querySelectorAll('#conceptOptions label');
                let firstVisible = null;
                labels.forEach(label => {
                    const text = (label.textContent || '').trim().toLowerCase();
                    const visible = !keyword || text.includes(keyword);
                    label.style.display = visible ? 'flex' : 'none';
                    if (visible && !firstVisible) firstVisible = label;
                });
                if (firstVisible) {
                    firstVisible.scrollIntoView({ block: 'nearest' });
                }
            }

            function closeConceptDropdownOnClickOutside(e) {
                if (!e.target.closest('#conceptInputContainer')) {
                    document.getElementById('conceptDropdown').style.display = 'none';
                    document.removeEventListener('click', closeConceptDropdownOnClickOutside);
                }
            }

            function updateConceptTriggerText() {
                const selected = Array.from(document.querySelectorAll('#conceptDropdown input[type="checkbox"]:checked'))
                    .map(cb => cb.value)
                    .filter(Boolean);
                const input = document.getElementById('screeningConcept');
                if (input) input.value = selected.join(' ');
                if (typeof scheduleSaveUiState === 'function') scheduleSaveUiState();
            }

            function toggleCustomStockInput() {
                const scope = document.getElementById('screeningScope').value;
                const inputGroup = document.getElementById('customStockInputGroup');
                if (scope === 'custom') {
                    inputGroup.style.display = 'block';
                } else {
                    inputGroup.style.display = 'none';
                }
            }

            function formatVal2(v) {
                const n = Number(v);
                if (v === null || v === undefined || v === '' || Number.isNaN(n)) return '--';
                return n.toFixed(2);
            }

            function toggleSelectAllScreening(checkbox) {
                const checked = !!checkbox?.checked;
                document.querySelectorAll('.screening-item-checkbox').forEach(cb => {
                    cb.checked = checked;
                });
            }

            function isStarMarketStock(tsCode, symbol) {
                const s = (symbol || (tsCode || '').split('.')[0] || '').trim();
                return s.startsWith('688') || s.startsWith('689');
            }

            function toggleIndustryFilter() {
                const enabled = document.getElementById('enableIndustryFilter').checked;
                const input = document.getElementById('screeningIndustry');
                if (input) input.disabled = !enabled;
            }

            function toggleConceptFilter() {
                const enabled = document.getElementById('enableConceptFilter').checked;
                const input = document.getElementById('screeningConcept');
                if (input) input.disabled = !enabled;
                if (!enabled) {
                    const dropdown = document.getElementById('conceptDropdown');
                    if (dropdown) dropdown.style.display = 'none';
                }
            }

            function toggleSmartVerificationOptions() {
                const enabled = document.getElementById('enableSmartVerification').checked;
                const box = document.getElementById('smartVerificationOptions');
                if (box) {
                    box.style.display = 'block';
                    box.style.opacity = enabled ? '1' : '0.55';
                }
            }

            let lastActiveTabBeforeHelp = null;
            function openHelpModal() {
                const modal = document.getElementById('helpModal');
                if (!modal) return;
                const active = document.querySelector('.tab.active');
                lastActiveTabBeforeHelp = active && active.dataset ? active.dataset.tab : null;
                modal.classList.add('open');
                switchHelpTab('help-overview');
                document.addEventListener('keydown', onHelpModalKeydown);
            }

            function closeHelpModal() {
                const modal = document.getElementById('helpModal');
                if (!modal) return;
                modal.classList.remove('open');
                document.removeEventListener('keydown', onHelpModalKeydown);
            }

            function onHelpModalKeydown(e) {
                if (e && e.key === 'Escape') {
                    closeHelpModal();
                }
            }

            function handleHelpModalBackdrop(e) {
                const modal = document.getElementById('helpModal');
                if (!modal || !modal.classList.contains('open')) return;
                const dialog = e && e.target ? e.target.closest('.help-dialog') : null;
                if (!dialog) {
                    closeHelpModal();
                }
            }

            function switchHelpTab(tabId) {
                document.querySelectorAll('.help-nav button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset && btn.dataset.helpTab === tabId);
                });
                document.querySelectorAll('.help-section').forEach(sec => {
                    sec.classList.toggle('active', sec.id === tabId);
                });
            }

            // Á≠õÈÄâÁªìÊûúÊéíÂ∫èÈÄªËæë
            let screeningResultsCache = []; // ÁºìÂ≠òÊúÄËøë‰∏ÄÊ¨°ÁöÑÁ≠õÈÄâÁªìÊûú
            let currentSort = { field: null, direction: 'desc' }; // ÂΩìÂâçÊéíÂ∫èÁä∂ÊÄÅ
            let screeningControl = {
                running: false,
                paused: false,
                stopped: false,
                abortController: null
            };

            function updateScreeningControlUi() {
                const btnRun = document.getElementById('btnRunStockScreening');
                const btnPauseResume = document.getElementById('btnPauseResumeScreening');
                const btnStop = document.getElementById('btnStopScreening');
                if (btnRun) btnRun.disabled = screeningControl.running;
                if (btnStop) btnStop.disabled = !screeningControl.running || screeningControl.stopped;
                if (btnPauseResume) {
                    btnPauseResume.disabled = !screeningControl.running || screeningControl.stopped;
                    if (screeningControl.running && screeningControl.paused && !screeningControl.stopped) {
                        btnPauseResume.textContent = '‚ñ∂ ÁªßÁª≠';
                        btnPauseResume.classList.remove('btn-warning');
                        btnPauseResume.classList.add('btn-success');
                    } else {
                        btnPauseResume.textContent = '‚è∏ ÊöÇÂÅú';
                        btnPauseResume.classList.remove('btn-success');
                        btnPauseResume.classList.add('btn-warning');
                    }
                }

                if (btnRun) btnRun.classList.toggle('is-active', screeningControl.running && !screeningControl.stopped);
                if (btnPauseResume) btnPauseResume.classList.toggle('is-active', screeningControl.running && screeningControl.paused && !screeningControl.stopped);
                if (btnStop) btnStop.classList.toggle('is-active', screeningControl.stopped);
            }

            function pauseStockScreening() {
                if (!screeningControl.running || screeningControl.stopped) return;
                screeningControl.paused = true;
                updateScreeningControlUi();
                const progressLabel = document.getElementById('screeningProgressLabel');
                if (progressLabel) progressLabel.textContent = 'Â∑≤ÊöÇÂÅúÔºåÁ≠âÂæÖÁªßÁª≠...';
            }

            function resumeStockScreening() {
                if (!screeningControl.running || screeningControl.stopped) return;
                screeningControl.paused = false;
                updateScreeningControlUi();
            }

            function togglePauseResumeStockScreening() {
                if (!screeningControl.running || screeningControl.stopped) return;
                if (screeningControl.paused) {
                    resumeStockScreening();
                } else {
                    pauseStockScreening();
                }
            }

            function stopStockScreening() {
                if (!screeningControl.running || screeningControl.stopped) return;
                screeningControl.stopped = true;
                screeningControl.paused = false;
                try {
                    if (screeningControl.abortController) {
                        screeningControl.abortController.abort();
                    }
                } catch (e) {
                }
                updateScreeningControlUi();
                const progressLabel = document.getElementById('screeningProgressLabel');
                if (progressLabel) progressLabel.textContent = 'Â∑≤ÂÅúÊ≠¢';
            }

            async function waitIfScreeningPaused() {
                while (screeningControl.running && screeningControl.paused && !screeningControl.stopped) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }

            function makeScreeningKey(code, strategy, date) {
                return `${code}__${strategy}__${date}`;
            }

            async function runStockScreening() {
                if (screeningControl.running) {
                    alert('Á≠õÈÄâÊ≠£Âú®ËøõË°å‰∏≠');
                    return;
                }
                screeningControl = { running: true, paused: false, stopped: false, abortController: null };
                updateScreeningControlUi();
                const scope = document.getElementById('screeningScope').value;
                const period = parseInt(document.getElementById('signalPeriod').value);
                const smartVerification = document.getElementById('enableSmartVerification').checked; // Ëé∑ÂèñÊô∫ËÉΩÈ™åËØÅÂºÄÂÖ≥Áä∂ÊÄÅ
                const initCapital = parseFloat(document.getElementById('initCapital').value) * 10000;
                const smartMinScore = Number(document.getElementById('smartMinScore')?.value ?? 0) || 0;
                const smartMinReturn = Number(document.getElementById('smartMinReturn')?.value ?? 0) || 0;
                const smartMinWinRate = Number(document.getElementById('smartMinWinRate')?.value ?? 0) || 0;
                const smartMinTrades = Number(document.getElementById('smartMinTrades')?.value ?? 0) || 0;
                const smartAllowNoHistory = false;
                const smartRankBy = (document.getElementById('smartRankBy')?.value || 'score').toLowerCase();
                const selectedStrategies = Array.from(document.querySelectorAll('#screeningStrategyGrid .strategy-card.active'))
                    .map(card => card.dataset.strategy);
                
                if (selectedStrategies.length === 0) {
                    alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Á≠ñÁï•');
                    return;
                }

                const progressContainer = document.getElementById('screeningProgressContainer');
                const progressFill = document.getElementById('screeningProgressFill');
                const progressPercent = document.getElementById('screeningProgressPercent');
                const progressLabel = document.getElementById('screeningProgressLabel');
                const screeningBody = document.getElementById('screeningBody');
                const screeningStatus = document.getElementById('screeningStatus');

                progressContainer.classList.add('active');
                screeningBody.innerHTML = '';
                screeningStatus.textContent = 'ÂáÜÂ§áÂºÄÂßã...';
                
                // ÈáçÁΩÆÊéíÂ∫èÂíåÁºìÂ≠ò
                screeningResultsCache = [];
                currentSort = { field: null, direction: 'desc' };
                updateSortIcons();
                
                // Ëé∑ÂèñËÇ°Á•®ÂàóË°®
                let stockList = [];
                progressLabel.textContent = 'Ê≠£Âú®Ëé∑ÂèñËÇ°Á•®ÂàóË°®...';
                
                try {
                    if (scope === 'custom') {
                        const input = document.getElementById('customStockInput').value;
                        if (!input.trim()) {
                            alert('ËØ∑ËæìÂÖ•Ëá™ÈÄâËÇ°‰ª£Á†Å');
                            progressContainer.classList.remove('active');
                            return;
                        }
                        const codes = input.split(/[,Ôºå\s]+/).filter(c => c.trim());
                        stockList = codes.map(code => ({ 
                            ts_code: normalizeTsCode(code.trim()) || code.trim(), 
                            name: code.trim(),
                            symbol: code.split('.')[0] 
                        }));
                    } else if (scope === 'hot') {
                        // ÁÉ≠Èó®ËÇ°ÂàóË°®
                        stockList = [
                            { ts_code: '000001.SZ', name: 'Âπ≥ÂÆâÈì∂Ë°å' },
                            { ts_code: '600519.SH', name: 'Ë¥µÂ∑ûËåÖÂè∞' },
                            { ts_code: '000002.SZ', name: '‰∏áÁßëA' },
                            { ts_code: '600036.SH', name: 'ÊãõÂïÜÈì∂Ë°å' },
                            { ts_code: '601318.SH', name: '‰∏≠ÂõΩÂπ≥ÂÆâ' },
                            { ts_code: '000858.SZ', name: '‰∫îÁ≤ÆÊ∂≤' },
                            { ts_code: '600276.SH', name: 'ÊÅíÁëûÂåªËçØ' },
                            { ts_code: '002594.SZ', name: 'ÊØî‰∫öËø™' },
                            { ts_code: '300059.SZ', name: '‰∏úÊñπË¥¢ÂØå' },
                            { ts_code: '300750.SZ', name: 'ÂÆÅÂæ∑Êó∂‰ª£' }
                        ];
                    } else if (['all_a', 'sh', 'sz', 'cyb'].includes(scope)) {
                        // ‰ΩøÁî®ÂÖ®ÈáèÁºìÂ≠òËøõË°åËøáÊª§
                        if (allStockListCache.length === 0) {
                            // Â∞ùËØïÂÜçÊ¨°Ëé∑Âèñ
                            const response = await fetch(`${API_BASE}/stock_list`);
                            const result = await response.json();
                            if (result.success && result.data) {
                                allStockListCache = result.data;
                            }
                        }
                        
                        if (allStockListCache.length === 0) {
                             throw new Error('Êó†Ê≥ïËé∑ÂèñÂÖ®ÈáèËÇ°Á•®ÂàóË°®ÔºåÊó†Ê≥ïËøõË°åËåÉÂõ¥Á≠õÈÄâ');
                        }

                        stockList = allStockListCache.filter(stock => {
                            const tsCode = stock.ts_code || '';
                            const market = stock.market || '';
                            const symbol = stock.symbol || tsCode.split('.')[0] || '';

                            if (scope === 'all_a') {
                                return !isStarMarketStock(tsCode, symbol);
                            }
                            
                            if (scope === 'sh') {
                                // Ê≤™Â∏Ç: 6ÂºÄÂ§¥
                                return tsCode.endsWith('.SH') || symbol.startsWith('6');
                            }
                            
                            if (scope === 'sz') {
                                // Ê∑±Â∏Ç: 0Êàñ3ÂºÄÂ§¥
                                return tsCode.endsWith('.SZ') || symbol.startsWith('0') || symbol.startsWith('3');
                            }
                            
                            if (scope === 'cyb') {
                                // Âàõ‰∏öÊùø: 3ÂºÄÂ§¥ (ÈÄöÂ∏∏300, 301) Êàñ marketÂåÖÂê´Âàõ‰∏öÊùø
                                return symbol.startsWith('3') || market.includes('Âàõ‰∏öÊùø');
                            }
                            
                            return false;
                        });
                        
                        console.log(`Á≠õÈÄâËåÉÂõ¥ ${scope}: ÂåπÈÖçÂà∞ ${stockList.length} Âè™ËÇ°Á•®`);

                    } else {
                        // ‰ªéÂêéÁ´ØËé∑ÂèñÊåáÊï∞ÊàêÂàÜËÇ°
                        const response = await fetch(`${API_BASE}/index_stocks?index_code=${scope}`);
                        const result = await response.json();
                        if (result.success && result.data) {
                            stockList = result.data;
                        } else {
                            throw new Error('Ëé∑ÂèñÊåáÊï∞ÊàêÂàÜËÇ°Â§±Ë¥•');
                        }
                    }
                } catch (e) {
                    console.error('Ëé∑ÂèñËÇ°Á•®ÂàóË°®Â§±Ë¥•:', e);
                    alert('Ëé∑ÂèñËÇ°Á•®ÂàóË°®Â§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®Ê®°ÊãüÂàóË°®');
                    stockList = [
                        { ts_code: '000001.SZ', name: 'Âπ≥ÂÆâÈì∂Ë°å' },
                        { ts_code: '600519.SH', name: 'Ë¥µÂ∑ûËåÖÂè∞' }
                    ];
                }

                // === Êñ∞Â¢ûÔºöË°å‰∏öÂíåÊ¶ÇÂøµËøáÊª§ (Â§öÈÄâ) ===
                const industryEnabled = document.getElementById('enableIndustryFilter').checked;
                const conceptEnabled = document.getElementById('enableConceptFilter').checked;
                
                // Ëé∑ÂèñÂ§öÈÄâË°å‰∏ö
                let selectedIndustries = [];
                if (industryEnabled) {
                     const checkboxes = document.querySelectorAll('#industryDropdown input[type="checkbox"]:checked');
                     checkboxes.forEach(cb => selectedIndustries.push(cb.value));
                     // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠‰ªª‰ΩïË°å‰∏ö‰ΩÜÂºÄÂêØ‰∫ÜËøáÊª§ÔºåÈªòËÆ§ÂÖ®ÈÄâÊàñÂÖ®‰∏çÈÄâÔºü
                     // ÈÄöÂ∏∏ÈÄªËæëÊòØÔºöÂ¶ÇÊûú‰∏çÈÄâÔºåÂ∞±ÊòØÊ≤°ÈôêÂà∂Ôºõ‰ΩÜËøôÈáåÂºÄÂêØ‰∫ÜËøáÊª§ÔºåÂ∫îËØ•Ëá≥Â∞ëÈÄâ‰∏Ä‰∏™„ÄÇ
                     // ‰∏∫‰∫ÜÊñπ‰æøÔºåÂ¶ÇÊûúÊ≤°ÈÄâÔºåËßÜ‰∏∫ÂÖ®‰∏çÈÄâÔºàËøáÊª§ÊéâÊâÄÊúâÔºâ„ÄÇ
                }
                
                // Ëé∑ÂèñÂ§öÈÄâÊ¶ÇÂøµÔºà‰ºòÂÖàÂèñ‰∏ãÊãâÂ§öÈÄâÔºåÂÖ∂Ê¨°ÂèñËæìÂÖ•Ê°ÜÂÖ≥ÈîÆËØçÔºâ
                let conceptKeywords = [];
                if (conceptEnabled) {
                    const selectedConcepts = Array.from(document.querySelectorAll('#conceptDropdown input[type="checkbox"]:checked'))
                        .map(cb => (cb?.value || '').trim())
                        .filter(Boolean);
                    if (selectedConcepts.length > 0) {
                        conceptKeywords = selectedConcepts.map(x => x.toLowerCase());
                    } else {
                        const conceptInput = (document.getElementById('screeningConcept')?.value || '').trim().toLowerCase();
                        conceptKeywords = conceptInput ? conceptInput.split(/[,Ôºå\s]+/).filter(k => k) : [];
                    }
                }
                let conceptTsCodeSet = null;
                if (conceptEnabled && conceptKeywords.length > 0 && Array.isArray(allConceptListCache) && allConceptListCache.length > 0 && isConnected) {
                    try {
                        const nameToCode = new Map();
                        allConceptListCache.forEach(x => {
                            const name = (x && x.name) ? String(x.name).trim().toLowerCase() : '';
                            const code = (x && x.code) ? String(x.code).trim() : '';
                            if (name && code) nameToCode.set(name, code);
                        });
                        const codes = conceptKeywords.map(k => nameToCode.get(String(k).trim().toLowerCase())).filter(Boolean);
                        if (codes.length > 0) {
                            const resp = await fetch(`${API_BASE}/concept_members?codes=${encodeURIComponent(codes.join(','))}`);
                            const res = await resp.json();
                            if (res && res.success && Array.isArray(res.ts_codes) && res.ts_codes.length > 0) {
                                conceptTsCodeSet = new Set(res.ts_codes.map(x => normalizeTsCode(x)).filter(Boolean));
                            }
                        }
                    } catch (e) {
                        conceptTsCodeSet = null;
                    }
                }

                const industryActive = industryEnabled && selectedIndustries.length > 0;
                const conceptActive = conceptEnabled && conceptKeywords.length > 0;
                const needFilter = industryActive || conceptActive;

                if (needFilter) {
                    // Â¶ÇÊûúÁºìÂ≠ò‰∏∫Á©∫ÔºåÂ∞ùËØïÈáçÊñ∞Ëé∑Âèñ‰∏ÄÊ¨°Ôºà‰∏∫‰∫ÜÁ®≥ÂÅ•ÊÄßÔºåËôΩÁÑ∂initÂ∫îËØ•Â∑≤ÁªèÂÅö‰∫ÜÔºâ
                    if (allStockListCache.length === 0) {
                         console.warn('ÂÖ®ÈáèËÇ°Á•®‰ø°ÊÅØÊú™Âä†ËΩΩÔºåËøáÊª§ÂèØËÉΩ‰∏çÂáÜÁ°Æ');
                    }
                    
                    // Âª∫Á´ãÊò†Â∞Ñ‰ª•‰æøÂø´ÈÄüÊü•Êâæ‰ø°ÊÅØ
                    const stockMap = new Map();
                    allStockListCache.forEach(s => stockMap.set(s.ts_code, s));
                    
                    stockList = stockList.filter(item => {
                        const rawCode = item.ts_code || item.code || item.con_code || item.tsCode;
                        const code = normalizeTsCode(rawCode);
                        const fullInfo = stockMap.get(code) || item; // ‰ºòÂÖàÁî®ÂÖ®Èáè‰ø°ÊÅØÔºåÂåÖÂê´industry
                        
                        const matchIndustry = industryActive
                            ? (fullInfo.industry && selectedIndustries.includes(fullInfo.industry))
                            : false;
                        
                        let matchConcept = false;
                        if (conceptActive) {
                            if (conceptTsCodeSet && conceptTsCodeSet.size > 0) {
                                matchConcept = conceptTsCodeSet.has(code);
                            } else {
                                const name = (fullInfo.name || '').toLowerCase();
                                const ind = (fullInfo.industry || '').toLowerCase();
                                const tsCode = (fullInfo.ts_code || code || '').toLowerCase();
                                matchConcept = conceptKeywords.some(keyword =>
                                    name.includes(keyword) || ind.includes(keyword) || tsCode.includes(keyword)
                                );
                            }
                        }
                        
                        if (industryActive && conceptActive) return matchIndustry || matchConcept;
                        if (industryActive) return matchIndustry;
                        if (conceptActive) return matchConcept;
                        return true;
                    });
                }
                // === ËøáÊª§ÁªìÊùü ===

                let foundCount = 0;
                let filteredCount = 0; // Êñ∞Â¢ûÔºöËÆ∞ÂΩïË¢´Êô∫ËÉΩÈ™åËØÅËøáÊª§ÁöÑÊï∞Èáè
                let invalidCodeCount = 0;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                screeningStatus.textContent = `ËÇ°Á•®ÂàóË°® ${stockList.length} Âè™ÔºåÂºÄÂßãÊâ´Êèè...`;

                for (let i = 0; i < stockList.length; i++) {
                    if (screeningControl.stopped) break;
                    await waitIfScreeningPaused();
                    if (screeningControl.stopped) break;
                    const stock = stockList[i];
                    const rawCode = stock.ts_code || stock.code || stock.con_code || stock.conCode || stock.tsCode || stock.symbol;
                    const code = normalizeTsCode(rawCode);
                    if (!code) {
                        invalidCodeCount++;
                        continue;
                    }
                    if (!stock.name) stock.name = code;
                    
                    progressLabel.textContent = `Ê≠£Âú®Êâ´Êèè: ${stock.name} (${code}) ...`;
                    const progress = ((i + 1) / stockList.length) * 100;
                    progressFill.style.width = progress + '%';
                    progressPercent.textContent = progress.toFixed(0) + '%';
                    
                    try {
                        screeningControl.abortController = new AbortController();
                        let data = await fetchStockDataForOptimization(code, startDate, endDate, screeningControl.abortController.signal);
                        screeningControl.abortController = null;

                        updateStockPoolName(code, stock.name);

                        if (data && data.length >= 61) {
                            const lastDate = parseDateSafe(data[data.length - 1].date);
                            if (!lastDate) {
                                await new Promise(r => setTimeout(r, 10));
                                continue;
                            }

                            const cutoffDate = new Date(lastDate);
                            cutoffDate.setDate(cutoffDate.getDate() - period);

                            if (smartVerification) {
                                let bestCandidate = null;

                                for (const strategy of selectedStrategies) {
                                    const config = {
                                        ...currentConfig,
                                        ...(strategySpecificConfig[strategy] || {})
                                    };

                                    const signals = executeStrategy(data, strategy, config);
                                    if (!signals || signals.length === 0) continue;

                                    const recentSignals = signals.filter(s => {
                                        if (s.type !== 'buy') return false;
                                        const signalDate = parseDateSafe(s.date);
                                        if (!signalDate) return false;
                                        const diffTime = Math.abs(lastDate - signalDate);
                                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                        return diffDays <= period;
                                    });

                                    if (recentSignals.length === 0) continue;

                                    const historyData = data.filter(d => {
                                        const dt = parseDateSafe(d.date);
                                        return dt && dt < cutoffDate;
                                    });

                                    let histReturn = 0;
                                    let histScore = 0;
                                    let histWinRate = 0;
                                    let histTradeCount = 0;

                                    if (historyData.length >= 61) {
                                        const histSignals = executeStrategy(historyData, strategy, config);
                                        const histResult = calculateBacktest(historyData, histSignals, initCapital);
                                        histReturn = histResult.totalReturn || 0;
                                        histScore = histResult.score || 0;
                                        histWinRate = histResult.winRate || 0;
                                        histTradeCount = histResult.tradeCount || 0;
                                    }

                                    const latestRecentSignal = recentSignals.reduce((acc, cur) => {
                                        const a = parseDateSafe(acc.date);
                                        const b = parseDateSafe(cur.date);
                                        if (!a) return cur;
                                        if (!b) return acc;
                                        return b > a ? cur : acc;
                                    }, recentSignals[0]);

                                    const candidate = {
                                        strategy,
                                        recentSignals,
                                        latestSignal: latestRecentSignal,
                                        histReturn,
                                        histScore,
                                        histWinRate,
                                        histTradeCount
                                    };

                                    const hasHistory = candidate.histTradeCount > 0;
                                    if (!hasHistory && !smartAllowNoHistory) continue;
                                    if (candidate.histTradeCount < smartMinTrades) continue;
                                    if (candidate.histScore < smartMinScore) continue;
                                    if (candidate.histReturn < smartMinReturn) continue;
                                    if (candidate.histWinRate < smartMinWinRate) continue;

                                    const better = (cand, best) => {
                                        if (!best) return true;
                                        const candHasHistory = cand.histTradeCount > 0;
                                        const bestHasHistory = best.histTradeCount > 0;
                                        if (candHasHistory && !bestHasHistory) return true;
                                        if (!candHasHistory && bestHasHistory) return false;

                                        if (smartRankBy === 'return') {
                                            if (cand.histReturn !== best.histReturn) return cand.histReturn > best.histReturn;
                                            if (cand.histScore !== best.histScore) return cand.histScore > best.histScore;
                                            return cand.histWinRate > best.histWinRate;
                                        }
                                        if (smartRankBy === 'winrate') {
                                            if (cand.histWinRate !== best.histWinRate) return cand.histWinRate > best.histWinRate;
                                            if (cand.histScore !== best.histScore) return cand.histScore > best.histScore;
                                            return cand.histReturn > best.histReturn;
                                        }
                                        if (cand.histScore !== best.histScore) return cand.histScore > best.histScore;
                                        if (cand.histReturn !== best.histReturn) return cand.histReturn > best.histReturn;
                                        return cand.histWinRate > best.histWinRate;
                                    };

                                    if (better(candidate, bestCandidate)) {
                                        bestCandidate = candidate;
                                    }
                                }

                                if (bestCandidate) {
                                    foundCount++;
                                    const lastBar = data && data.length > 0 ? data[data.length - 1] : {};
                                    const pe = lastBar ? lastBar.pe : null;
                                    const pb = lastBar ? lastBar.pb : null;
                                    const rowKey = makeScreeningKey(code, bestCandidate.strategy, bestCandidate.latestSignal.date);

                                    screeningResultsCache.push({
                                        key: rowKey,
                                        code: code,
                                        name: stock.name,
                                        strategy: bestCandidate.strategy,
                                        date: bestCandidate.latestSignal.date,
                                        type: 'buy',
                                        strength: bestCandidate.latestSignal.strength || 0,
                                        price: bestCandidate.latestSignal.price,
                                        pe: pe,
                                        pb: pb,
                                        backtestScore: bestCandidate.histScore,
                                        backtestWinRate: bestCandidate.histWinRate,
                                        backtestReturn: bestCandidate.histReturn,
                                        backtestTradeCount: bestCandidate.histTradeCount
                                    });

                                    const row = document.createElement('tr');
                                    let strategyHtml = STRATEGIES[bestCandidate.strategy]?.name || bestCandidate.strategy;
                                    if (bestCandidate.histTradeCount > 0) {
                                        const scoreColor = bestCandidate.histScore >= 60 ? '#2ed573' : (bestCandidate.histScore >= 40 ? '#ffa502' : '#ff4757');
                                        strategyHtml += `<div style="font-size:10px;color:${scoreColor}">ÂéÜÂè≤:${bestCandidate.histReturn.toFixed(1)}% ÂàÜ:${bestCandidate.histScore.toFixed(0)} ËÉúÁéá:${bestCandidate.histWinRate.toFixed(0)}%</div>`;
                                    } else {
                                        strategyHtml += `<div style="font-size:10px;color:#00BFFF">Êó†ÂéÜÂè≤‰∫§Êòì</div>`;
                                    }

                                    row.innerHTML = `
                                        <td><input type="checkbox" class="screening-item-checkbox" data-key="${rowKey}"></td>
                                        <td><span style="color:#667eea;font-weight:bold">${code}</span></td>
                                        <td>${stock.name}</td>
                                        <td>${strategyHtml}</td>
                                        <td>${bestCandidate.latestSignal.date}</td>
                                        <td class="positive">‰π∞ÂÖ•</td>
                                        <td>${bestCandidate.histScore ? bestCandidate.histScore.toFixed(1) : '--'}</td>
                                        <td class="${bestCandidate.histReturn >= 0 ? 'positive' : 'negative'}">${bestCandidate.histTradeCount > 0 ? (bestCandidate.histReturn >= 0 ? '+' : '') + bestCandidate.histReturn.toFixed(2) + '%' : '--'}</td>
                                        <td>${bestCandidate.latestSignal.strength ? bestCandidate.latestSignal.strength.toFixed(0) : '--'}</td>
                                        <td>¬•${bestCandidate.latestSignal.price.toFixed(2)}</td>
                                        <td>${formatVal2(pe)}</td>
                                        <td>${formatVal2(pb)}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" style="padding:4px 8px;font-size:12px;"
                                        onclick="viewStock('${code}', '${stock.name}', '${bestCandidate.strategy}')">
                                        Êü•Áúã
                                    </button>
                                        </td>
                                    `;
                                    screeningBody.appendChild(row);
                                }
                            } else {
                                for (const strategy of selectedStrategies) {
                                    const config = {
                                        ...currentConfig,
                                        ...(strategySpecificConfig[strategy] || {})
                                    };

                                    const signals = executeStrategy(data, strategy, config);
                                    const recentSignals = signals.filter(s => {
                                        if (s.type !== 'buy') return false;
                                        const signalDate = parseDateSafe(s.date);
                                        if (!signalDate) return false;
                                        const diffTime = Math.abs(lastDate - signalDate);
                                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                        return diffDays <= period;
                                    });

                                    if (recentSignals.length > 0) {
                                        const lastBar = data && data.length > 0 ? data[data.length - 1] : {};
                                        const pe = lastBar ? lastBar.pe : null;
                                        const pb = lastBar ? lastBar.pb : null;

                                        recentSignals.forEach(signal => {
                                            foundCount++;
                                            const rowKey = makeScreeningKey(code, strategy, signal.date);

                                            screeningResultsCache.push({
                                                key: rowKey,
                                                code: code,
                                                name: stock.name,
                                                strategy: strategy,
                                                date: signal.date,
                                                type: signal.type,
                                                strength: signal.strength || 0,
                                                price: signal.price,
                                                pe: pe,
                                                pb: pb,
                                                backtestScore: null,
                                                backtestReturn: null
                                            });

                                            const row = document.createElement('tr');
                                            const strategyHtml = STRATEGIES[strategy]?.name || strategy;

                                            row.innerHTML = `
                                                <td><input type="checkbox" class="screening-item-checkbox" data-key="${rowKey}"></td>
                                                <td><span style="color:#667eea;font-weight:bold">${code}</span></td>
                                                <td>${stock.name}</td>
                                                <td>${strategyHtml}</td>
                                                <td>${signal.date}</td>
                                                <td class="positive">‰π∞ÂÖ•</td>
                                                <td>--</td>
                                                <td>--</td>
                                                <td>${signal.strength ? signal.strength.toFixed(0) : '--'}</td>
                                                <td>¬•${signal.price.toFixed(2)}</td>
                                                <td>${formatVal2(pe)}</td>
                                                <td>${formatVal2(pb)}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary" style="padding:4px 8px;font-size:12px;"
                                                onclick="viewStock('${code}', '${stock.name}', '${strategy}')">
                                                Êü•Áúã
                                            </button>
                                                </td>
                                            `;
                                            screeningBody.appendChild(row);
                                        });
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        screeningControl.abortController = null;
                        if (screeningControl.stopped) break;
                        if (e && (e.name === 'AbortError' || String(e).includes('AbortError'))) {
                            break;
                        }
                        console.error('Êâ´ÊèèÂ§±Ë¥•:', code, e);
                    }
                    
                    // Á®çÂæÆÂª∂Êó∂ÔºåÈÅøÂÖçÂç°È°ø
                    await new Promise(r => setTimeout(r, 10));
                }

                screeningControl.running = false;
                screeningControl.paused = false;
                screeningControl.abortController = null;
                updateScreeningControlUi();

                progressLabel.textContent = screeningControl.stopped ? 'Â∑≤ÂÅúÊ≠¢' : 'Êâ´ÊèèÂÆåÊàê';
                const invalidText = invalidCodeCount > 0 ? `ÔºåÊó†Êïà‰ª£Á†Å ${invalidCodeCount} Âè™` : '';
                const filteredText = filteredCount > 0 ? `ÔºåÊô∫ËÉΩËøáÊª§ ${filteredCount} ‰∏™` : '';
                const unitText = smartVerification ? 'Âè™ËÇ°Á•®' : '‰∏™‰ø°Âè∑';
                screeningStatus.textContent = `${screeningControl.stopped ? 'Â∑≤ÂÅúÊ≠¢Ôºö' : ''}ÂÖ±ÂèëÁé∞ ${foundCount} ${unitText}${filteredText}ÔºàËÇ°Á•®Ê±† ${stockList.length} Âè™${invalidText}Ôºâ`;
                
                if (foundCount === 0) {
                    screeningBody.innerHTML = '<tr><td colspan="13" style="text-align:center;color:#888;padding:40px;">Êú™ÂèëÁé∞Á¨¶ÂêàÊù°‰ª∂ÁöÑÁªìÊûú</td></tr>';
                }
                
                if (screeningResultsCache.length > 0) {
                    if (smartVerification) {
                        currentSort = { field: 'backtestScore', direction: 'desc' };
                    }
                    updateSortIcons();
                    renderSortedResults();
                }

                updatePoolStatus();
                if (isPoolTabActive()) {
                    updateStockPoolView();
                }
                
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                }, 3000);

                screeningControl.stopped = false;
            }

            function sortScreeningResults(field) {
                if (screeningResultsCache.length === 0) return;
                
                // ÂàáÊç¢ÊéíÂ∫èÊñπÂêë
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'desc'; // ÈªòËÆ§ÈôçÂ∫è
                }
                
                updateSortIcons();
                renderSortedResults();
            }
            
            function updateSortIcons() {
                // ÈáçÁΩÆÊâÄÊúâÂõæÊ†á
                document.getElementById('sortIcon_strength').textContent = '‚ñ≤‚ñº';
                document.getElementById('sortIcon_strength').style.color = 'rgba(255,255,255,0.4)';
                document.getElementById('sortIcon_price').textContent = '‚ñ≤‚ñº';
                document.getElementById('sortIcon_price').style.color = 'rgba(255,255,255,0.4)';
                document.getElementById('sortIcon_backtestScore').textContent = '‚ñ≤‚ñº';
                document.getElementById('sortIcon_backtestScore').style.color = 'rgba(255,255,255,0.4)';
                document.getElementById('sortIcon_backtestReturn').textContent = '‚ñ≤‚ñº';
                document.getElementById('sortIcon_backtestReturn').style.color = 'rgba(255,255,255,0.4)';
                
                // Êõ¥Êñ∞ÂΩìÂâçÊéíÂ∫èÂ≠óÊÆµÁöÑÂõæÊ†á
                if (currentSort.field) {
                    const icon = document.getElementById(`sortIcon_${currentSort.field}`);
                    if (icon) {
                        icon.textContent = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                        icon.style.color = '#ffd700';
                        icon.style.fontWeight = 'bold';
                    }
                }
            }
            
            function renderSortedResults() {
                const screeningBody = document.getElementById('screeningBody');
                screeningBody.innerHTML = '';
                
                // ÊéíÂ∫èÊï∞ÊçÆ
                const sortedData = [...screeningResultsCache].sort((a, b) => {
                    const valA = Number(a[currentSort.field] ?? 0);
                    const valB = Number(b[currentSort.field] ?? 0);
                    
                    if (currentSort.direction === 'asc') {
                        return valA - valB;
                    } else {
                        return valB - valA;
                    }
                });
                
                // Ê∏≤Êüì
                sortedData.forEach(item => {
                    const row = document.createElement('tr');
                    const scoreText = item.backtestScore !== undefined && item.backtestScore !== null ? item.backtestScore.toFixed(1) : '--';
                    const returnText = item.backtestReturn !== undefined && item.backtestReturn !== null ? (item.backtestReturn >= 0 ? '+' : '') + item.backtestReturn.toFixed(2) + '%' : '--';
                    let strategyHtml = STRATEGIES[item.strategy]?.name || item.strategy;
                    const tradeCount = Number(item.backtestTradeCount ?? 0) || 0;
                    const backtestScore = Number(item.backtestScore ?? 0) || 0;
                    const backtestReturn = Number(item.backtestReturn ?? 0) || 0;
                    const backtestWinRate = Number(item.backtestWinRate ?? 0) || 0;
                    if (tradeCount > 0) {
                        const scoreColor = backtestScore >= 60 ? '#2ed573' : (backtestScore >= 40 ? '#ffa502' : '#ff4757');
                        const sign = backtestReturn >= 0 ? '+' : '';
                        strategyHtml += `<div style="font-size:10px;color:${scoreColor}">ÂéÜÂè≤:${sign}${backtestReturn.toFixed(1)}% ÂàÜ:${backtestScore.toFixed(0)} ËÉúÁéá:${backtestWinRate.toFixed(0)}%</div>`;
                    } else if (item.backtestTradeCount !== undefined && item.backtestTradeCount !== null) {
                        strategyHtml += `<div style="font-size:10px;color:#00BFFF">Êó†ÂéÜÂè≤‰∫§Êòì</div>`;
                    }
                    row.innerHTML = `
                        <td><input type="checkbox" class="screening-item-checkbox" data-key="${item.key || makeScreeningKey(item.code, item.strategy, item.date)}"></td>
                        <td><span style="color:#667eea;font-weight:bold">${item.code}</span></td>
                        <td>${item.name}</td>
                        <td>${strategyHtml}</td>
                        <td>${item.date}</td>
                        <td class="positive">‰π∞ÂÖ•</td>
                        <td>${scoreText}</td>
                        <td class="${(item.backtestReturn ?? 0) >= 0 ? 'positive' : 'negative'}">${returnText}</td>
                        <td>${item.strength ? item.strength.toFixed(0) : '--'}</td>
                        <td>¬•${item.price.toFixed(2)}</td>
                        <td>${formatVal2(item.pe)}</td>
                        <td>${formatVal2(item.pb)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" style="padding:4px 8px;font-size:12px;"
                                onclick="viewStock('${item.code}', '${item.name}', '${item.strategy}')">
                                Êü•Áúã
                            </button>
                        </td>
                    `;
                    screeningBody.appendChild(row);
                });
            }

            function clearScreeningResults() {
                screeningResultsCache = [];
                currentSort = { field: null, direction: 'desc' };
                updateSortIcons();
                const screeningBody = document.getElementById('screeningBody');
                if (screeningBody) {
                    screeningBody.innerHTML = `
                        <tr>
                            <td colspan="13" style="text-align:center;color:#888;padding:40px;">
                                ËØ∑ÈÄâÊã©Á≠ñÁï•Âπ∂ÁÇπÂáª"ÂºÄÂßãÁ≠õÈÄâ"
                            </td>
                        </tr>
                    `;
                }
                const selectAll = document.getElementById('screeningSelectAll');
                if (selectAll) selectAll.checked = false;
                const screeningStatus = document.getElementById('screeningStatus');
                if (screeningStatus) {
                    screeningStatus.textContent = '';
                }
                const progressContainer = document.getElementById('screeningProgressContainer');
                if (progressContainer) {
                    progressContainer.classList.remove('active');
                }
            }

            async function addScreeningResultsToPool(btn) {
                if (!screeningResultsCache || screeningResultsCache.length === 0) {
                    alert('ÂΩìÂâçÊ≤°ÊúâÁ≠õÈÄâÁªìÊûú');
                    return;
                }

                const selectedKeys = Array.from(document.querySelectorAll('.screening-item-checkbox:checked'))
                    .map(cb => cb.dataset.key)
                    .filter(Boolean);
                if (selectedKeys.length === 0) {
                    alert('ËØ∑ÂÖàÂãæÈÄâË¶ÅÂä†ÂÖ•ËÇ°Ê±†ÁöÑÁªìÊûú');
                    return;
                }

                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                if (!startDate || !endDate) {
                    alert('Êó•ÊúüËåÉÂõ¥‰∏∫Á©∫ÔºåÊó†Ê≥ïÂä†ÂÖ•ËÇ°Ê±†');
                    return;
                }

                const originalText = btn ? btn.textContent : '';
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Âä†ÂÖ•‰∏≠...';
                }

                let added = 0;
                let noData = 0;
                const seen = new Set();

                for (const key of selectedKeys) {
                    const item = screeningResultsCache.find(x => (x.key || makeScreeningKey(x.code, x.strategy, x.date)) === key);
                    if (!item) continue;
                    const code = item.code;
                    const strategy = item.strategy;
                    if (!code || !strategy) continue;
                    const poolKey = `${strategy}_${code}`;
                    if (seen.has(poolKey)) continue;
                    seen.add(poolKey);

                    let data = loadStockDataFromCache(code, startDate, endDate);
                    if (!data || data.length === 0) {
                        try {
                            data = await fetchStockDataForOptimization(code, startDate, endDate);
                        } catch (e) {
                            data = null;
                        }
                    }

                    if (!data || data.length === 0) {
                        noData++;
                        continue;
                    }

                    const signal = {
                        type: 'buy',
                        date: item.date,
                        price: item.price,
                        strength: item.strength || 0
                    };

                    checkAndAddToPool(strategy, [signal], {
                        tsCode: code,
                        name: item.name || code,
                        data: data,
                        source: 'screening_manual'
                    });
                    added++;
                }

                if (btn) {
                    btn.disabled = false;
                    btn.textContent = originalText.trim() || '‚ûï Âä†ÂÖ•ËÇ°Ê±†';
                }

                const screeningStatus = document.getElementById('screeningStatus');
                if (screeningStatus) {
                    screeningStatus.textContent = `Â∑≤Âä†ÂÖ•ËÇ°Ê±† ${added} Âè™${noData > 0 ? `Ôºà${noData} Âè™Áº∫Â∞ëÊï∞ÊçÆÔºâ` : ''}`;
                }
            }

            async function viewStock(code, name, strategy) {
                document.getElementById('stockCode').value = code;
                document.getElementById('stockName').textContent = name;
                if (typeof scheduleSaveUiState === 'function') scheduleSaveUiState();
                
                // Â¶ÇÊûúÊåáÂÆö‰∫ÜÁ≠ñÁï•ÔºåÂàôÈÄâ‰∏≠ËØ•Á≠ñÁï•
                if (strategy && strategy !== 'manual') {
                    // 1. Á°Æ‰øùÂú®Á≠ñÁï•ÈÄâÊã©Èù¢Êùø‰∏≠Ë¢´ÈÄâ‰∏≠Ôºà‰ª•‰æørunComparisonËÉΩËøêË°åÂÆÉÔºâ
                    const card = document.querySelector(`.strategy-card[data-strategy="${strategy}"]`);
                    if (card && !card.classList.contains('active')) {
                        card.classList.add('active');
                    }
                }

                // ÂàáÊç¢Âà∞ËØ¶ÁªÜÂàÜÊûêÈ°µ
                switchTab('details');
                // Ëá™Âä®Âà∑Êñ∞Êï∞ÊçÆ
                await fetchStockData();
                // Ëá™Âä®ËøêË°åÁ≠ñÁï•ÂØπÊØîÔºåÁ°Æ‰øùÊúâÁªìÊûúÂèØ‰æõÊòæÁ§∫
                await runComparison();
                
                // 2. Âú®ËØ¶ÁªÜÂàÜÊûê‰∏ãÊãâÊ°Ü‰∏≠ÈÄâ‰∏≠ÂÆÉ (ÂøÖÈ°ªÂú®runComparison‰πãÂêéÔºåÂõ†‰∏∫ÂÆÉ‰ºöÈáçÁΩÆ‰∏ãÊãâÊ°Ü)
                if (strategy && strategy !== 'manual') {
                    const detailSelect = document.getElementById('detailStrategy');
                    if (detailSelect) {
                        // Â∞ùËØïÈÄâ‰∏≠ËØ•Á≠ñÁï•
                        // Â¶ÇÊûúÁ≠ñÁï•ËøêË°åÂ§±Ë¥•ÔºåÂèØËÉΩ‰∏çÂú®ÈÄâÈ°π‰∏≠Ôºå‰ΩÜËøôÈÄöÂ∏∏‰∏ç‰ºöÂèëÁîü
                        detailSelect.value = strategy;
                    }
                }

                // Êï∞ÊçÆÊõ¥Êñ∞ÂêéÊâãÂä®Âà∑Êñ∞ÂõæË°®
                updateDetailAnalysis();
            }
            </script>


            <div class="tab-content" id="tab-optimization">
                <div class="panel">
                    <div class="panel-title">üéØ ÂèÇÊï∞‰ºòÂåñÊéßÂà∂</div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>‰ºòÂåñËØ¥Êòé</label>
                        <div style="color: #aaa; font-size: 12px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                            ÂèØÈÄâ‰ºòÂåñÂèÇÊï∞ËåÉÂõ¥ÔºåÂØπÊâÄÊúâÁ≠ñÁï•ËøõË°åÁΩëÊ†ºÊêúÁ¥¢ÔºåÊâæÂà∞ÊúÄ‰ºòÂèÇÊï∞ÁªÑÂêà
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>ÈÄâÊã©Ë¶ÅÂèÇ‰∏é‰ºòÂåñÁöÑÂèÇÊï∞</label>
                        <div style="display:flex; gap:12px; flex-wrap:nowrap; white-space:nowrap; align-items:center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow-x:auto;">
                            <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#ccc; cursor:pointer;">
                                <input type="checkbox" id="optEnableTakeProfit" checked>
                                Ê≠¢Áõà
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#ccc; cursor:pointer;">
                                <input type="checkbox" id="optEnableStopLoss" checked>
                                Ê≠¢Êçü
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#ccc; cursor:pointer;">
                                <input type="checkbox" id="optEnableVolumeMulti" checked>
                                ÈáèËÉΩÂÄçÊï∞
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#ccc; cursor:pointer;">
                                <input type="checkbox" id="optEnableDynamicTpCallback" checked>
                                ÁßªÂä®Ê≠¢ÁõàÂõûÊí§
                            </label>
                        </div>
                    </div>
                    
                    <!-- ËøõÂ∫¶ (Â∑≤ÁßªÂä®Âà∞Ê≠§Â§Ñ) -->
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-header">
                            <span id="progressLabel">Â§ÑÁêÜ‰∏≠...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-details" id="progressDetails"></div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" id="btnRunOptimization" onclick="runOptimization()">üöÄ ËøêË°åÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ</button>
                        <button class="btn btn-warning" id="btnAutoOptimize" onclick="console.log('ÊåâÈíÆË¢´ÁÇπÂáª'); runAutoBatchOptimization();">ü§ñ Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñ</button>
                        <button class="btn btn-success" onclick="applyAllOptimizedParams()">‚úÖ Â∫îÁî®‰ºòÂåñÂèÇÊï∞</button>
                        <button class="btn btn-info" onclick="exportOptimizationResults()">üìä ÂØºÂá∫‰ºòÂåñÁªìÊûú</button>
                    </div>
                    <div style="margin-top:10px;padding:10px;background:rgba(102,126,234,0.1);border-radius:6px;font-size:13px;color:#888;">
                        <div>üí° <strong>‰∏§Áßç‰ºòÂåñÊñπÂºèÔºö</strong></div>
                        <div>‚Ä¢ <strong>ÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ</strong>ÔºöÈíàÂØπÂΩìÂâçÈÄâ‰∏≠ÁöÑËÇ°Á•®Ôºå‰ºòÂåñÊâÄÊúâÁ≠ñÁï•ÂèÇÊï∞</div>
                        <div>‚Ä¢ <strong>Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñ</strong>ÔºöËá™Âä®ÈÄâÊã©30‰∏™Ë°å‰∏öÁöÑ‰ª£Ë°®ÊÄßËÇ°Á•®ÔºàÁ∫¶50Âè™ÔºâÔºåÂª∫Á´ãÂÆåÊï¥ÁöÑË∑®Ë°å‰∏öÂèÇÊï∞‰ΩìÁ≥ªÔºàÊé®ËçêÈ¶ñÊ¨°‰ΩøÁî®Ôºâ</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">üìä ‰ºòÂåñÂâçÂêéÂØπÊØîÊ¶ÇËßà</div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="comparison-table" id="optimizationSummaryTable">
                            <thead>
                                <tr>
                                    <th>Á≠ñÁï•ÂêçÁß∞</th>
                                    <th>‰ºòÂåñÂâçÊî∂ÁõäÁéá</th>
                                    <th>‰ºòÂåñÂêéÊî∂ÁõäÁéá</th>
                                    <th>Êî∂ÁõäÁéáÊèêÂçá</th>
                                    <th>‰ºòÂåñÂâçÂ§èÊôÆ</th>
                                    <th>‰ºòÂåñÂêéÂ§èÊôÆ</th>
                                    <th>Â§èÊôÆÊèêÂçá</th>
                                    <th>ÊúÄ‰ºòÊ≠¢Áõà</th>
                                    <th>ÊúÄ‰ºòÊ≠¢Êçü</th>
                                    <th>ÊúÄ‰ºòÈáèËÉΩ</th>
                                    <th>ÁßªÂä®Ê≠¢ÁõàÂõûÊí§</th>
                                    <th>ÁªºÂêàËØÑÂàÜ</th>
                                </tr>
                            </thead>
                            <tbody id="optimizationSummaryBody">
                                <tr>
                                    <td colspan="12" style="text-align:center;color:#888;padding:40px;">
                                        ËØ∑ÁÇπÂáª"ËøêË°åÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ"ÂºÄÂßãÂàÜÊûê
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-box full-width">
                        <div class="chart-title">üìà ‰ºòÂåñÂâçÂêéÊî∂ÁõäÁéáÂØπÊØî</div>
                        <div id="optimizationChart" class="chart chart-large"></div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title">üéØ ‰ºòÂåñÂâçÂêéÂ§èÊôÆÊØîÁéáÂØπÊØî</div>
                        <div id="sensitivityChart" class="chart"></div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title">üìä ÂèÇÊï∞‰ºòÂåñÊïàÊûúÁÉ≠ÂäõÂõæ</div>
                        <div id="heatmapChart" class="chart"></div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">üìã ÂêÑÁ≠ñÁï•‰ºòÂåñËØ¶ÁªÜÁªìÊûú</div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="comparison-table" id="optimizationTable">
                            <thead>
                                <tr>
                                    <th>Á≠ñÁï•</th>
                                    <th>ÊúÄ‰ºòÊ≠¢Áõà</th>
                                    <th>ÊúÄ‰ºòÊ≠¢Êçü</th>
                                    <th>ÊúÄ‰ºòÈáèËÉΩ</th>
                                    <th>ÁßªÂä®Ê≠¢ÁõàÂõûÊí§</th>
                                    <th>‰ºòÂåñÂâçÊî∂ÁõäÁéá</th>
                                    <th>‰ºòÂåñÂêéÊî∂ÁõäÁéá</th>
                                    <th>Êî∂ÁõäÁéáÊèêÂçá</th>
                                    <th>‰ºòÂåñÂâçÂ§èÊôÆ</th>
                                    <th>‰ºòÂåñÂêéÂ§èÊôÆ</th>
                                    <th>Â§èÊôÆÊèêÂçá</th>
                                    <th>ÁªºÂêàËØÑÂàÜ</th>
                                </tr>
                            </thead>
                            <tbody id="optimizationBody">
                                <tr>
                                    <td colspan="12" style="text-align:center;color:#888;padding:40px;">
                                        ËØ∑ÁÇπÂáª"ËøêË°åÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ"ÂºÄÂßãÂàÜÊûê
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-pool">
                <div class="panel">
                    <div class="panel-title">
                        <span>üì¶ ËÇ°Á•®Ê±†ÔºàÂ∑≤ÂèñÂà∞Êï∞ÊçÆÔºâ</span>
                        <span id="poolStatus" style="font-size: 12px; color: #888; font-weight: normal; margin-left: 10px;"></span>
                    </div>

                    <div class="form-row" style="margin-bottom: 10px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; max-width: 300px;">
                            <input type="text" id="poolFilter" class="form-control" placeholder="ËæìÂÖ•‰ª£Á†ÅÊàñÂêçÁß∞..." oninput="updateStockPoolView()">
                        </div>
                        <div class="form-group" style="flex: 0 0 auto; margin-left: auto;">
                            <label>&nbsp;</label>
                            <div class="btn-group" style="display:flex; gap:8px;">
                                <button class="btn btn-info" id="btnRefreshPool" onclick="refreshStockPoolNow()">üîÑ Âà∑Êñ∞Êî∂Áõä</button>
                                <button class="btn btn-danger" onclick="deleteSelectedStocks()">üóëÔ∏è Âà†Èô§ÈÄâ‰∏≠</button>
                                <button class="btn btn-warning" onclick="clearStockPool()">üßπ Ê∏ÖÁ©∫ËÇ°Ê±†</button>
                            </div>
                        </div>
                    </div>

                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="comparison-table" id="poolTable">
                            <thead>
                                <tr>
                                    <th>ËÇ°Á•®‰ª£Á†Å</th>
                                    <th>ÂêçÁß∞</th>
                                    <th>Êù•Ê∫ê</th>
                                    <th>Êï∞ÊçÆÈáè</th>
                                    <th>Êó•ÊúüËåÉÂõ¥</th>
                                    <th>Êõ¥Êñ∞Êó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="poolBody">
                                <tr>
                                    <td colspan="7" style="text-align:center;color:#888;padding:40px;">ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑ÂÖàËøõË°åÁ≠õÈÄâÊàñËé∑ÂèñÊï∞ÊçÆ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Âä†ËΩΩÂä®Áîª -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Ê≠£Âú®Ëé∑ÂèñTushareÊï∞ÊçÆ...</div>
        <div class="loading-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="loadingProgress" style="width: 0%"></div>
            </div>
        </div>
        <div class="loading-stats" id="loadingStats"></div>
    </div>

    <script>
        // ===================== ÈÖçÁΩÆ =====================
        const API_BASE = (() => {
            // Vercel ÈÉ®ÁΩ≤ÁéØÂ¢ÉÂà§Êñ≠
            const hostname = (typeof location !== 'undefined' ? location.hostname : '').toLowerCase();
            const isVercel = hostname.endsWith('.vercel.app');
            
            if (isVercel) {
                return '/api';
            }
            
            const fallback = 'http://localhost:5000/api';
            try {
                if (typeof location === 'undefined') return fallback;

                const protocol = location.protocol;
                const hostname = (location.hostname || '').toLowerCase();
                const isHttp = protocol === 'http:' || protocol === 'https:';
                const isLocalHost = hostname === 'localhost' || hostname === '127.0.0.1';

                if (!isHttp) return fallback;

                if (isLocalHost) {
                    if (location.port === '5000') return `${location.protocol}//${location.host}/api`;
                    return `${location.protocol}//${hostname}:5000/api`;
                }

                return `${location.origin}/api`;
            } catch (e) {
            }
            return fallback;
        })();
        
        // ===================== ÂÖ®Â±ÄÂèòÈáè =====================
        let charts = {};
        let stockData = [];
        let strategyResults = {};
        let optimizationResults = {}; // ÊòéÁ°ÆÂÆö‰πâÂÖ®Â±ÄÂèòÈáè
        let isConnected = false;
        let searchTimeout = null;
        let echartsLoaded = false;

        let stockPool = new Map();
        let lastRenderedPoolCodes = [];

        let lastDataRangeWarnKey = null;

        const STOCK_POOL_KEY = 'quant_stock_pool';
        const STOCK_POOL_LAST_REFRESH_KEY = 'quant_stock_pool_last_refresh_date';
        let stockPoolRefreshing = false;
        
        // Êï∞ÊçÆÊåÅ‰πÖÂåñÁõ∏ÂÖ≥ÂèòÈáè
        const DATA_CACHE_KEY = 'quant_stock_data_cache';
        const CACHE_EXPIRY_DAYS = 7; // ÁºìÂ≠òËøáÊúüÂ§©Êï∞
        const UI_STATE_KEY = 'quant_ui_state_v1';
        const KLINE_ZOOM_STATE_KEY = 'quant_kline_zoom_state_v1';
        let uiStateSaveTimer = null;
        let pendingUiState = null;
        let uiStateRestoring = false;
        const LOCAL_STATE_DEBOUNCE_MS = 250;
        const localStatePersistTimers = {};
        let currentStockInfo = {
            tsCode: '',
            startDate: '',
            endDate: ''
        };

        async function fetchLocalStateKey(key) {
            if (!key) return null;
            try {
                const resp = await fetch(`${API_BASE}/local_state?key=${encodeURIComponent(key)}`, { credentials: 'omit' });
                if (!resp.ok) return null;
                const json = await resp.json();
                if (!json || !json.success) return null;
                return json.value;
            } catch (e) {
                return null;
            }
        }

        function schedulePersistLocalStateKey(key, value) {
            if (!key) return;
            if (localStatePersistTimers[key]) clearTimeout(localStatePersistTimers[key]);
            localStatePersistTimers[key] = setTimeout(() => {
                persistLocalStateKeyBestEffort(key, value);
            }, LOCAL_STATE_DEBOUNCE_MS);
        }

        function persistLocalStateKeyBestEffort(key, value) {
            if (!key) return;
            try {
                const payload = JSON.stringify({ key, value });
                const url = `${API_BASE}/local_state`;
                const isFileOrigin = (typeof location !== 'undefined' && location && location.protocol === 'file:') || (typeof location !== 'undefined' && location && location.origin === 'null');
                if (!isFileOrigin && typeof navigator !== 'undefined' && navigator && typeof navigator.sendBeacon === 'function') {
                    try {
                        const blob = new Blob([payload], { type: 'application/json' });
                        const ok = navigator.sendBeacon(url, blob);
                        if (ok) return;
                    } catch (e) {
                    }
                }
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload,
                    keepalive: true,
                    credentials: 'omit'
                }).catch(() => {});
            } catch (e) {
            }
        }

        async function persistLocalStateKey(key, value, options = {}) {
            if (!key) return false;
            try {
                const resp = await fetch(`${API_BASE}/local_state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, value }),
                    keepalive: !!options.keepalive,
                    credentials: 'omit'
                });
                if (!resp.ok) return false;
                const json = await resp.json();
                return !!json?.success;
            } catch (e) {
                return false;
            }
        }

        function flushLocalStatePersistence() {
            try {
                if (typeof saveUiState === 'function') saveUiState();
                if (typeof persistStockPool === 'function') persistStockPool();
            } catch (e) {
            }
            const keys = [UI_STATE_KEY, KLINE_ZOOM_STATE_KEY, STOCK_POOL_KEY, 'quant_last_session', 'strategyConfig', 'optimizationResults'];
            keys.forEach(key => {
                try {
                    const raw = localStorage.getItem(key);
                    if (raw === null) return;
                    const value = raw ? JSON.parse(raw) : null;
                    persistLocalStateKeyBestEffort(key, value);
                } catch (e) {
                }
            });
        }

        let localStateHydrateInProgress = false;
        let localStateHydrateDone = false;
        let connectionRetryCount = 0;
        let appHydrationPromise = null;

        async function hydrateLocalStorageFromBackend(options = {}) {
            const force = !!options.force;
            const keys = [UI_STATE_KEY, KLINE_ZOOM_STATE_KEY, STOCK_POOL_KEY, 'quant_last_session', 'strategyConfig', 'optimizationResults'];
            for (const key of keys) {
                try {
                    const existing = localStorage.getItem(key);
                    if (!force) {
                        if (existing !== null && existing !== '' && existing !== 'null' && existing !== 'undefined') continue;
                    }
                    const value = await fetchLocalStateKey(key);
                    if (value === null || value === undefined) continue;
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                }
            }
        }

        async function hydrateAndRestoreAll(options = {}) {
            if (localStateHydrateInProgress) return;
            localStateHydrateInProgress = true;
            try {
                await hydrateLocalStorageFromBackend(options);
            } finally {
                localStateHydrateInProgress = false;
            }

            try { restoreUiState(); } catch (e) {}
            try { restoreStockPool(); } catch (e) {}

            try {
                const active = getActiveTabName();
                if (active === 'screening') {
                    await Promise.resolve(initScreeningPage());
                    const latest = loadUiStateFromStorage() || pendingUiState;
                    applyUiStateToScreening(latest);
                    if (uiStateRestoring) uiStateRestoring = false;
                }
            } catch (e) {
            }

            localStateHydrateDone = true;
        }

        function loadUiStateFromStorage() {
            try {
                return JSON.parse(localStorage.getItem(UI_STATE_KEY) || 'null');
            } catch (e) {
                return null;
            }
        }

        function loadKlineZoomState() {
            try {
                const raw = localStorage.getItem(KLINE_ZOOM_STATE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                const start = Number(parsed?.start);
                const end = Number(parsed?.end);
                if (!Number.isFinite(start) || !Number.isFinite(end)) return null;
                if (start < 0 || end > 100 || start >= end) return null;
                return { start, end };
            } catch (e) {
                return null;
            }
        }

        function persistKlineZoomStateFromChart() {
            try {
                if (!charts || !charts.kline || typeof charts.kline.getOption !== 'function') return;
                const option = charts.kline.getOption();
                const dz = option?.dataZoom?.[1] || option?.dataZoom?.[0];
                if (!dz) return;
                const start = Number(dz.start);
                const end = Number(dz.end);
                if (!Number.isFinite(start) || !Number.isFinite(end)) return;
                if (start < 0 || end > 100 || start >= end) return;
                const v = { start, end };
                localStorage.setItem(KLINE_ZOOM_STATE_KEY, JSON.stringify(v));
                persistLocalStateKeyBestEffort(KLINE_ZOOM_STATE_KEY, v);
            } catch (e) {}
        }
        let currentConfig = {
            takeProfit: 0.15,
            stopLoss: 0.08,
            volumeMulti: 1.5,
            buyCooldown: 1,
            useMa5Sell: true,
            useDynamicTP: true,
            useAdaptPosition: true,
            // ÂçñÂá∫Êù°‰ª∂ÂºÄÂÖ≥
            useStopLoss: true,
                useTakeProfit: true,
                useMacdDeathCross: true,
                useRsiOverbought: true,
                useHoldTimeout: true,
                holdTimeoutDays: 30,
            // ‰π∞ÂÖ•Êù°‰ª∂ÂºÄÂÖ≥ - ÈªòËÆ§ÂºÄÂêØÊâÄÊúâÊù°‰ª∂
            useMa5AboveMa20: true,
            usePriceAboveMa5: true,
            useMacdRising: true,
            useRsiBelow35: true,
            useRsiBelow25: true,
            useVolumeAboveMa: true,
            usePriceBelowBoll: true,
            useNearLow: true,
            useVolumeUp: true,
            useRsiOversold: true,
            useBullishCandle: true,
            useGoldenCross: true,
            useMacdPositive: true,
            useBreakHigh: true,
            useVolumeConfirm: true,
            useTouchLowerBoll: true,
            useMomentumFactor: true,
            useValueFactor: true,
            useQualityFactor: true
        };
        let strategySpecificConfig = {
            deep_fusion: {},
            volume_breakout: {},
            oversold_rebound: {},
            trend_enhanced: {},
            macd_divergence: {},
            bollinger_extreme: {},
            momentum_rotation: {},
            turtle_enhanced: {}
        };

        const STRATEGIES = {
            deep_fusion: { name: 'üß† Ê∑±Â∫¶ËûçÂêà', icon: 'ü§ñ', color: '#8b5cf6', expectedReturn: '60-120%' },
            volume_breakout: { name: 'üî• Èáè‰ª∑Á™ÅÁ†¥', icon: '‚ö°', color: '#f43f5e', expectedReturn: '50-100%' },
            oversold_rebound: { name: 'üíé Ë∂ÖË∑åÂèçÂºπ', icon: 'üìà', color: '#22c55e', expectedReturn: '40-80%' },
            trend_enhanced: { name: 'üìà Ë∂ãÂäøÂ¢ûÂº∫', icon: 'üî•', color: '#3b82f6', expectedReturn: '45-90%' },
            macd_divergence: { name: 'üìä MACDËÉåÁ¶ª', icon: 'üéØ', color: '#f59e0b', expectedReturn: '35-70%' },
            bollinger_extreme: { name: 'üéØ Â∏ÉÊûóÊûÅÈôê', icon: 'üìä', color: '#ec4899', expectedReturn: '30-60%' },
            momentum_rotation: { name: '‚ö° Âä®ÈáèËΩÆÂä®', icon: '‚ö°', color: '#06b6d4', expectedReturn: '50-100%' },
            turtle_enhanced: { name: 'üê¢ Êµ∑ÈæüÂ¢ûÂº∫', icon: 'üê¢', color: '#84cc16', expectedReturn: '40-80%' }
        };

        // ===================== ÂàùÂßãÂåñ =====================
        document.addEventListener('DOMContentLoaded', function() {
            loadStrategyConfig();
            initEventListeners();
            initUiStatePersistence();
            updateTime();
            setInterval(updateTime, 1000);
            setDefaultDates();
            appHydrationPromise = hydrateAndRestoreAll().finally(() => {
                checkConnection();
                updatePoolStatus();
                scheduleStockPoolAutoRefresh();
                setTimeout(() => {
                    restoreLastSessionData();
                }, 1000);
            });
            
            // ÂõæË°®ÂàùÂßãÂåñÂ∞ÜÂú®EChartsÂä†ËΩΩÂÆåÊàêÂêéËá™Âä®Ëß¶Âèë
        });

        function loadStrategyConfig() {
            try {
                const savedConfig = localStorage.getItem('strategyConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    // ÂÖºÂÆπÊóßÁâàÊú¨ÁöÑÊï∞ÊçÆÁªìÊûÑ
                    if (config.strategySpecificConfig) {
                        currentConfig = { ...currentConfig, ...config };
                        strategySpecificConfig = { ...strategySpecificConfig, ...config.strategySpecificConfig };
                    } else {
                        currentConfig = { ...currentConfig, ...config };
                    }
                    console.log('‚úÖ Â∑≤Âä†ËΩΩ‰øùÂ≠òÁöÑÁ≠ñÁï•ÈÖçÁΩÆ:', currentConfig);
                    console.log('‚úÖ Â∑≤Âä†ËΩΩÁöÑÁ≠ñÁï•ÁâπÂÆöÂèÇÊï∞:', strategySpecificConfig);
                }

                // Âä†ËΩΩ‰ºòÂåñÁªìÊûú
                const savedOptimizationResults = localStorage.getItem('optimizationResults');
                if (savedOptimizationResults) {
                    optimizationResults = JSON.parse(savedOptimizationResults);
                    console.log('‚úÖ Â∑≤Âä†ËΩΩ‰øùÂ≠òÁöÑ‰ºòÂåñÁªìÊûú:', optimizationResults);
                }
                
                // Âà∑Êñ∞ÁïåÈù¢ÂèÇÊï∞ÊòæÁ§∫
                setTimeout(updateStrategyParams, 100);
            } catch (error) {
                console.warn('‚ö†Ô∏è Âä†ËΩΩÁ≠ñÁï•ÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // initChartsÂáΩÊï∞Â∑≤Âú®Â§¥ÈÉ®ÂÆö‰πâÔºåÊ≠§Â§Ñ‰∏çÂÜçÈáçÂ§çÂÆö‰πâ

        function initEventListeners() {
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.addEventListener('click', () => {
                    card.classList.toggle('active');
                });
            });

            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÊêúÁ¥¢ÁªìÊûú
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.stock-search-container')) {
                    document.getElementById('searchResults').classList.remove('active');
                }
            });

            document.addEventListener('keydown', (e) => {
                if (!e || e.key !== 'F10') return;
                if (document.getElementById('helpModal')?.classList.contains('open')) return;
                const active = document.querySelector('.tab.active');
                const tabName = active && active.dataset ? active.dataset.tab : null;
                if (tabName !== 'details') return;
                e.preventDefault();
                openF10ForCurrentStock();
            });
        }

        function initUiStatePersistence() {
            const watchedIds = new Set([
                'stockCode', 'initCapital', 'startDate', 'endDate',
                'paramStrategy', 'detailStrategy',
                'screeningScope', 'signalPeriod', 'customStockInput',
                'enableSmartVerification', 'enableIndustryFilter', 'enableConceptFilter',
                'smartMinScore', 'smartMinReturn', 'smartMinWinRate', 'smartMinTrades', 'smartRankBy',
                'screeningIndustry', 'screeningConcept', 'poolFilter', 'themeSelect',
                'optEnableTakeProfit', 'optEnableStopLoss', 'optEnableVolumeMulti', 'optEnableDynamicTpCallback'
            ]);

            document.addEventListener('input', (e) => {
                const id = e.target && e.target.id;
                if (id && watchedIds.has(id)) scheduleSaveUiState();
            });

            document.addEventListener('change', (e) => {
                const id = e.target && e.target.id;
                if (id && watchedIds.has(id)) scheduleSaveUiState();
                if (id === 'themeSelect') {
                    applyTheme(e.target.value);
                }
                if (e.target && e.target.matches && e.target.matches('#industryDropdown input[type="checkbox"]')) scheduleSaveUiState();
                if (e.target && e.target.matches && e.target.matches('#conceptDropdown input[type="checkbox"]')) scheduleSaveUiState();
            });

            document.addEventListener('click', (e) => {
                if (e.target && e.target.closest) {
                    const card = e.target.closest('#strategyGrid .strategy-card, #screeningStrategyGrid .strategy-card');
                    if (card) scheduleSaveUiState();
                    const tab = e.target.closest('.tab');
                    if (tab) scheduleSaveUiState();
                }
            });

            window.addEventListener('beforeunload', () => {
                flushLocalStatePersistence();
            });

            window.addEventListener('pagehide', () => {
                flushLocalStatePersistence();
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    flushLocalStatePersistence();
                }
            });

            const themeEl = document.getElementById('themeSelect');
            const theme = document.documentElement.getAttribute('data-theme') || 'dark';
            if (themeEl && (theme === 'light' || theme === 'dark')) {
                themeEl.value = theme;
            }
        }

        function scheduleSaveUiState() {
            if (uiStateRestoring) return;
            if (uiStateSaveTimer) clearTimeout(uiStateSaveTimer);
            uiStateSaveTimer = setTimeout(() => {
                saveUiState();
            }, 200);
        }

        function getActiveTabName() {
            const active = document.querySelector('.tab.active');
            return active && active.dataset ? active.dataset.tab : 'comparison';
        }

        function getActiveStrategies(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            return Array.from(container.querySelectorAll('.strategy-card.active'))
                .map(el => el.dataset && el.dataset.strategy)
                .filter(Boolean);
        }

        function batchSelectStrategies(containerId, action) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const cards = Array.from(container.querySelectorAll('.strategy-card'));
            if (cards.length === 0) return;
            if (action === 'all') {
                cards.forEach(c => c.classList.add('active'));
            } else if (action === 'none') {
                cards.forEach(c => c.classList.remove('active'));
            } else if (action === 'invert') {
                cards.forEach(c => c.classList.toggle('active'));
            }
            scheduleSaveUiState();
        }

        function getSelectedIndustries() {
            return Array.from(document.querySelectorAll('#industryDropdown input[type="checkbox"]:checked'))
                .map(cb => cb.value)
                .filter(Boolean);
        }

        function applyTheme(theme) {
            const t = theme === 'light' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t);
            try {
                localStorage.setItem('quant_theme', t);
            } catch (e) {
            }
            const el = document.getElementById('themeSelect');
            if (el && el.value !== t) el.value = t;
            scheduleSaveUiState();
        }

        function saveUiState() {
            try {
                const state = {
                    theme: document.documentElement.getAttribute('data-theme') || 'dark',
                    activeTab: getActiveTabName(),
                    stockCode: document.getElementById('stockCode')?.value || '',
                    stockName: document.getElementById('stockName')?.textContent || '',
                    initCapital: document.getElementById('initCapital')?.value || '',
                    startDate: document.getElementById('startDate')?.value || '',
                    endDate: document.getElementById('endDate')?.value || '',
                    paramStrategy: document.getElementById('paramStrategy')?.value || '',
                    detailStrategy: document.getElementById('detailStrategy')?.value || '',
                    comparisonStrategies: getActiveStrategies('strategyGrid'),
                    screeningStrategies: getActiveStrategies('screeningStrategyGrid'),
                    screeningScope: document.getElementById('screeningScope')?.value || '',
                    signalPeriod: document.getElementById('signalPeriod')?.value || '',
                    customStockInput: document.getElementById('customStockInput')?.value || '',
                    enableSmartVerification: !!document.getElementById('enableSmartVerification')?.checked,
                    smartMinScore: document.getElementById('smartMinScore')?.value ?? '',
                    smartMinReturn: document.getElementById('smartMinReturn')?.value ?? '',
                    smartMinWinRate: document.getElementById('smartMinWinRate')?.value ?? '',
                    smartMinTrades: document.getElementById('smartMinTrades')?.value ?? '',
                    smartRankBy: document.getElementById('smartRankBy')?.value ?? '',
                    enableIndustryFilter: !!document.getElementById('enableIndustryFilter')?.checked,
                    enableConceptFilter: !!document.getElementById('enableConceptFilter')?.checked,
                    screeningIndustry: document.getElementById('screeningIndustry')?.value || '',
                    screeningConcept: document.getElementById('screeningConcept')?.value || '',
                    selectedIndustries: getSelectedIndustries(),
                    poolFilter: document.getElementById('poolFilter')?.value || '',
                    optEnableTakeProfit: !!document.getElementById('optEnableTakeProfit')?.checked,
                    optEnableStopLoss: !!document.getElementById('optEnableStopLoss')?.checked,
                    optEnableVolumeMulti: !!document.getElementById('optEnableVolumeMulti')?.checked,
                    optEnableDynamicTpCallback: !!document.getElementById('optEnableDynamicTpCallback')?.checked
                };
                pendingUiState = state;
                localStorage.setItem(UI_STATE_KEY, JSON.stringify(state));
                persistLocalStateKeyBestEffort(UI_STATE_KEY, state);
            } catch (e) {
                console.warn('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•:', e);
            }
        }

        function restoreUiState() {
            const state = loadUiStateFromStorage();
            if (!state) return;
            uiStateRestoring = true;

            const theme = state.theme || (() => {
                try { return localStorage.getItem('quant_theme'); } catch (e) { return null; }
            })();
            if (theme === 'light' || theme === 'dark') {
                document.documentElement.setAttribute('data-theme', theme);
            }
            const themeEl = document.getElementById('themeSelect');
            if (themeEl && (theme === 'light' || theme === 'dark')) {
                themeEl.value = theme;
            }

            const stockCodeEl = document.getElementById('stockCode');
            if (stockCodeEl && state.stockCode) stockCodeEl.value = state.stockCode;
            const stockNameEl = document.getElementById('stockName');
            if (stockNameEl && state.stockName) stockNameEl.textContent = state.stockName;
            const initCapitalEl = document.getElementById('initCapital');
            if (initCapitalEl && state.initCapital !== undefined) initCapitalEl.value = state.initCapital;
            const startDateEl = document.getElementById('startDate');
            if (startDateEl && state.startDate) startDateEl.value = state.startDate;
            const endDateEl = document.getElementById('endDate');
            if (endDateEl && state.endDate) endDateEl.value = state.endDate;

            const paramStrategyEl = document.getElementById('paramStrategy');
            if (paramStrategyEl && state.paramStrategy) {
                paramStrategyEl.value = state.paramStrategy;
                if (typeof updateStrategyParams === 'function') updateStrategyParams();
            }

            const detailStrategyEl = document.getElementById('detailStrategy');
            if (detailStrategyEl && state.detailStrategy) {
                detailStrategyEl.value = state.detailStrategy;
            }

            if (Array.isArray(state.comparisonStrategies)) {
                document.querySelectorAll('#strategyGrid .strategy-card').forEach(card => {
                    const key = card.dataset && card.dataset.strategy;
                    if (!key) return;
                    if (state.comparisonStrategies.includes(key)) card.classList.add('active');
                    else card.classList.remove('active');
                });
            }

            pendingUiState = state;

            if (state.activeTab) {
                try {
                    switchTab(state.activeTab);
                } catch (e) {
                }
            }

            if (state.activeTab === 'pool') {
                const poolFilterEl = document.getElementById('poolFilter');
                if (poolFilterEl && state.poolFilter !== undefined) poolFilterEl.value = state.poolFilter;
                if (typeof updateStockPoolView === 'function') updateStockPoolView();
            }

            const optEnableTakeProfitEl = document.getElementById('optEnableTakeProfit');
            if (optEnableTakeProfitEl && state.optEnableTakeProfit !== undefined) optEnableTakeProfitEl.checked = !!state.optEnableTakeProfit;
            const optEnableStopLossEl = document.getElementById('optEnableStopLoss');
            if (optEnableStopLossEl && state.optEnableStopLoss !== undefined) optEnableStopLossEl.checked = !!state.optEnableStopLoss;
            const optEnableVolumeMultiEl = document.getElementById('optEnableVolumeMulti');
            if (optEnableVolumeMultiEl && state.optEnableVolumeMulti !== undefined) optEnableVolumeMultiEl.checked = !!state.optEnableVolumeMulti;
            const optEnableDynamicTpCallbackEl = document.getElementById('optEnableDynamicTpCallback');
            if (optEnableDynamicTpCallbackEl && state.optEnableDynamicTpCallback !== undefined) optEnableDynamicTpCallbackEl.checked = !!state.optEnableDynamicTpCallback;

            if (state.activeTab !== 'screening') {
                uiStateRestoring = false;
            }
        }

        function applyUiStateToScreening(state) {
            if (!state) return;
            const scopeEl = document.getElementById('screeningScope');
            if (scopeEl && state.screeningScope) scopeEl.value = state.screeningScope;
            if (typeof toggleCustomStockInput === 'function') toggleCustomStockInput();

            const signalEl = document.getElementById('signalPeriod');
            if (signalEl && state.signalPeriod) signalEl.value = state.signalPeriod;

            const customEl = document.getElementById('customStockInput');
            if (customEl && state.customStockInput !== undefined) customEl.value = state.customStockInput;

            const smartEl = document.getElementById('enableSmartVerification');
            if (smartEl && state.enableSmartVerification !== undefined) smartEl.checked = !!state.enableSmartVerification;
            if (typeof toggleSmartVerificationOptions === 'function') toggleSmartVerificationOptions();
            const smartMinScoreEl = document.getElementById('smartMinScore');
            if (smartMinScoreEl && state.smartMinScore !== undefined) smartMinScoreEl.value = state.smartMinScore;
            const smartMinReturnEl = document.getElementById('smartMinReturn');
            if (smartMinReturnEl && state.smartMinReturn !== undefined) smartMinReturnEl.value = state.smartMinReturn;
            const smartMinWinRateEl = document.getElementById('smartMinWinRate');
            if (smartMinWinRateEl && state.smartMinWinRate !== undefined) smartMinWinRateEl.value = state.smartMinWinRate;
            const smartMinTradesEl = document.getElementById('smartMinTrades');
            if (smartMinTradesEl && state.smartMinTrades !== undefined) smartMinTradesEl.value = state.smartMinTrades;
            const smartRankByEl = document.getElementById('smartRankBy');
            if (smartRankByEl && state.smartRankBy) smartRankByEl.value = state.smartRankBy;

            const indEl = document.getElementById('enableIndustryFilter');
            if (indEl && state.enableIndustryFilter !== undefined) {
                indEl.checked = !!state.enableIndustryFilter;
                if (typeof toggleIndustryFilter === 'function') toggleIndustryFilter();
            }

            const conceptEl = document.getElementById('enableConceptFilter');
            if (conceptEl && state.enableConceptFilter !== undefined) {
                conceptEl.checked = !!state.enableConceptFilter;
                if (typeof toggleConceptFilter === 'function') toggleConceptFilter();
            }

            const industryInputEl = document.getElementById('screeningIndustry');
            if (industryInputEl && state.screeningIndustry !== undefined) industryInputEl.value = state.screeningIndustry;
            try {
                const rawInd = (state.screeningIndustry || '').trim();
                const indTokens = rawInd ? rawInd.split(/[,Ôºå\s]+/).filter(Boolean).map(s => s.toLowerCase()) : [];
                document.querySelectorAll('#industryDropdown input[type="checkbox"]').forEach(cb => {
                    cb.checked = indTokens.includes(String(cb.value || '').toLowerCase());
                });
                if (typeof updateIndustryTriggerText === 'function') updateIndustryTriggerText();
            } catch (e) {
            }

            const conceptInputEl = document.getElementById('screeningConcept');
            if (conceptInputEl && state.screeningConcept !== undefined) conceptInputEl.value = state.screeningConcept;
            try {
                const raw = (state.screeningConcept || '').trim();
                const tokens = raw ? raw.split(/[,Ôºå\s]+/).filter(Boolean).map(s => s.toLowerCase()) : [];
                document.querySelectorAll('#conceptDropdown input[type="checkbox"]').forEach(cb => {
                    cb.checked = tokens.includes(String(cb.value || '').toLowerCase());
                });
                if (typeof updateConceptTriggerText === 'function') updateConceptTriggerText();
            } catch (e) {
            }

            if (Array.isArray(state.screeningStrategies)) {
                document.querySelectorAll('#screeningStrategyGrid .strategy-card').forEach(card => {
                    const key = card.dataset && card.dataset.strategy;
                    if (!key) return;
                    if (state.screeningStrategies.includes(key)) card.classList.add('active');
                    else card.classList.remove('active');
                });
            }

            if (Array.isArray(state.selectedIndustries)) {
                document.querySelectorAll('#industryDropdown input[type="checkbox"]').forEach(cb => {
                    cb.checked = state.selectedIndustries.includes(cb.value);
                });
                if (typeof updateIndustryTriggerText === 'function') updateIndustryTriggerText();
            }
        }

        function updateDefaultCharts() {
            // ÊòæÁ§∫Á©∫ÁôΩÁöÑÂõæË°®ÂÜÖÂÆπ
            if (charts.equity) {
                charts.equity.setOption({
                    backgroundColor: 'transparent',
                    xAxis: { show: false },
                    yAxis: { show: false },
                    series: []
                });
            }
            
            if (charts.radar) {
                charts.radar.setOption({
                    backgroundColor: 'transparent',
                    radar: { indicator: [] },
                    series: []
                });
            }
            
            if (charts.returnDist) {
                charts.returnDist.setOption({
                    backgroundColor: 'transparent',
                    xAxis: { show: false },
                    yAxis: { show: false },
                    series: []
                });
            }
            
            if (charts.kline) {
                charts.kline.setOption({
                    backgroundColor: 'transparent',
                    xAxis: { show: false },
                    yAxis: { show: false },
                    series: []
                });
            }
            
            if (charts.returnCurve) {
                charts.returnCurve.setOption({
                    backgroundColor: 'transparent',
                    xAxis: { show: false },
                    yAxis: { show: false },
                    series: []
                });
            }
        }

        function setDefaultDates() {
            const today = new Date();
            const lastYear = new Date(today);
            lastYear.setFullYear(lastYear.getFullYear() - 1);
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = lastYear.toISOString().split('T')[0];
        }

        function updateTime() {
            document.getElementById('currentTime').textContent = 'üìÖ ' + new Date().toLocaleString('zh-CN');
        }

        function switchTab(tabName) {
            if (!uiStateRestoring) {
                try { saveUiState(); } catch (e) {}
            }
            const currentActive = document.querySelector('.tab.active');
            const currentTabName = currentActive && currentActive.dataset ? currentActive.dataset.tab : '';
            if (currentTabName === 'details' && tabName !== 'details') {
                persistKlineZoomStateFromChart();
            }
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            try {
                const latestState = loadUiStateFromStorage() || pendingUiState;
                if (latestState) {
                    if (tabName === 'comparison' && Array.isArray(latestState.comparisonStrategies)) {
                        document.querySelectorAll('#strategyGrid .strategy-card').forEach(card => {
                            const key = card.dataset && card.dataset.strategy;
                            if (!key) return;
                            if (latestState.comparisonStrategies.includes(key)) card.classList.add('active');
                            else card.classList.remove('active');
                        });
                    }

                    if (tabName === 'details') {
                        const detailStrategyEl = document.getElementById('detailStrategy');
                        if (detailStrategyEl && latestState.detailStrategy) {
                            detailStrategyEl.value = latestState.detailStrategy;
                        }
                    }

                    if (tabName === 'optimization') {
                        const optEnableTakeProfitEl = document.getElementById('optEnableTakeProfit');
                        if (optEnableTakeProfitEl && latestState.optEnableTakeProfit !== undefined) optEnableTakeProfitEl.checked = !!latestState.optEnableTakeProfit;
                        const optEnableStopLossEl = document.getElementById('optEnableStopLoss');
                        if (optEnableStopLossEl && latestState.optEnableStopLoss !== undefined) optEnableStopLossEl.checked = !!latestState.optEnableStopLoss;
                        const optEnableVolumeMultiEl = document.getElementById('optEnableVolumeMulti');
                        if (optEnableVolumeMultiEl && latestState.optEnableVolumeMulti !== undefined) optEnableVolumeMultiEl.checked = !!latestState.optEnableVolumeMulti;
                        const optEnableDynamicTpCallbackEl = document.getElementById('optEnableDynamicTpCallback');
                        if (optEnableDynamicTpCallbackEl && latestState.optEnableDynamicTpCallback !== undefined) optEnableDynamicTpCallbackEl.checked = !!latestState.optEnableDynamicTpCallback;
                    }
                }
            } catch (e) {
            }
            
            if (tabName === 'screening') {
                const hydration = appHydrationPromise ? appHydrationPromise.catch(() => {}) : Promise.resolve();
                Promise.resolve(hydration).then(() => Promise.resolve(initScreeningPage())).then(() => {
                    const latest = loadUiStateFromStorage() || pendingUiState;
                    applyUiStateToScreening(latest);
                    if (uiStateRestoring) uiStateRestoring = false;
                });
            }
            
            setTimeout(() => {
                Object.values(charts).forEach(chart => chart && chart.resize());
                // optimizationCharts ÂèØËÉΩÊú™ÂÆö‰πâÔºåÊ∑ªÂä†Ê£ÄÊü•
                if (typeof optimizationCharts !== 'undefined') {
                    Object.values(optimizationCharts).forEach(chart => chart && chart.resize());
                }
            }, 100);
            
            if (tabName === 'details') {
                setTimeout(() => {
                    updateDetailAnalysis();
                }, 200);
            }

            if (tabName === 'pool') {
                setTimeout(() => {
                    updateStockPoolView();
                }, 50);
            }
        }

        function isPoolTabActive() {
            const active = document.querySelector('.tab.active');
            return active && active.dataset && active.dataset.tab === 'pool';
        }

        function formatPoolTime(value) {
            if (!value) return '--';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return '--';
            return d.toLocaleString('zh-CN');
        }

        function addToStockPool(entry) {
            // Legacy function replaced by strategy-based pool logic
            // Keeping empty to prevent errors from old calls if any remain
        }

        function checkAndAddToPool(strategyKey, signals, context = null) {
            if (!context || context.source !== 'screening_manual') {
                return;
            }
            // console.log('üîç checkAndAddToPool:', strategyKey, context?.tsCode);
            const targetCode = context ? context.tsCode : currentStockInfo.tsCode;
            const targetData = context ? context.data : stockData;
            const targetName = context ? context.name : (document.getElementById('stockName')?.textContent || targetCode);

            if (!targetData || targetData.length === 0 || !targetCode) {
                console.warn('‚ö†Ô∏è checkAndAddToPool: Êï∞ÊçÆ‰∏çÂÆåÊï¥', { targetCode, dataLen: targetData?.length });
                return;
            }
            
            // Êü•ÊâæÊúÄÂêé‰∏Ä‰∏™‰π∞ÂÖ•‰ø°Âè∑
            let lastBuySignal = null;
            
            // ÁÆÄÂåñÈÄªËæëÔºöÂè™Ë¶ÅÊúâ‰π∞ÂÖ•‰ø°Âè∑ÔºåÂ∞±Â∞ùËØïÊ∑ªÂä†Âà∞Ê±†Â≠êÔºàÁâπÂà´ÊòØÂØπ‰∫éÁ≠õÈÄâÁªìÊûúÔºâ
            // Êàë‰ª¨ÂÄíÂ∫èÊü•ÊâæÊúÄËøëÁöÑ‰∏Ä‰∏™‰π∞ÂÖ•‰ø°Âè∑
            for (let i = signals.length - 1; i >= 0; i--) {
                if (signals[i].type === 'buy') {
                    lastBuySignal = signals[i];
                    break;
                }
            }
            
            const poolKey = `${strategyKey}_${targetCode}`;
            
            if (lastBuySignal) {
                // ËÆ°ÁÆóËá≥‰ªäÊî∂Áõä
                const currentPrice = targetData[targetData.length - 1].close;
                const entryPrice = lastBuySignal.price;
                const returnPct = ((currentPrice - entryPrice) / entryPrice) * 100;
                const latest = targetData[targetData.length - 1] || {};
                const pe = latest.pe !== undefined && latest.pe !== null ? Number(latest.pe) : null;
                const pb = latest.pb !== undefined && latest.pb !== null ? Number(latest.pb) : null;
                
                const entry = {
                    key: poolKey,
                    strategy: strategyKey,
                    strategyName: STRATEGIES[strategyKey]?.name || strategyKey,
                    tsCode: targetCode,
                    name: targetName,
                    entryTime: lastBuySignal.date,
                    entryPrice: entryPrice,
                    currentPrice: currentPrice,
                    returnPct: returnPct,
                    pe: Number.isFinite(pe) ? pe : null,
                    pb: Number.isFinite(pb) ? pb : null,
                    updatedAt: new Date().toISOString(),
                    source: (context && context.source) ? context.source : 'screening'
                };
                
                stockPool.set(poolKey, entry);
                console.log('‚úÖ Â∑≤Âä†ÂÖ•ËÇ°Ê±†:', poolKey, entry);
                
                persistStockPool();
                updatePoolStatus();
                if (isPoolTabActive()) {
                    updateStockPoolView();
                }
            } else {
                console.log('‚ÑπÔ∏è Êú™ÊâæÂà∞‰π∞ÂÖ•‰ø°Âè∑ÔºåË∑≥ËøáÊ∑ªÂä†:', poolKey);
            }
        }

        function updatePoolStatus() {
            const el = document.getElementById('poolStatus');
            if (!el) return;
            el.textContent = `ÂÖ± ${stockPool.size} Âè™`;
        }

        function updateStockPoolName(tsCode, name) {
            if (!tsCode || !name) return;
            let updated = false;
            for (const [key, entry] of stockPool.entries()) {
                if (entry.tsCode === tsCode) {
                    if (entry.name === tsCode || !entry.name) {
                        entry.name = name;
                        updated = true;
                    }
                }
            }
            if (updated) {
                persistStockPool();
            }
        }

        function persistStockPool() {
            try {
                const list = Array.from(stockPool.values());
                localStorage.setItem(STOCK_POOL_KEY, JSON.stringify(list));
                persistLocalStateKeyBestEffort(STOCK_POOL_KEY, list);
            } catch (e) {
                console.error('ËÇ°Á•®Ê±†ÁºìÂ≠òÂ§±Ë¥•:', e);
            }
        }

        function restoreStockPool() {
            try {
                const raw = localStorage.getItem(STOCK_POOL_KEY);
                const hasSavedPoolKey = raw !== null;
                stockPool = new Map();
                if (raw) {
                    const list = JSON.parse(raw);
                    if (Array.isArray(list)) {
                        list.forEach(item => {
                            if (!item || !item.tsCode) return;
                            // ‰ºòÂÖà‰ΩøÁî®‰øùÂ≠òÁöÑkeyÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®tsCode
                            // Á°Æ‰øùkey‰∏écheckAndAddToPoolÁîüÊàêÁöÑkey‰∏ÄËá¥
                            const mapKey = item.key || item.tsCode;
                            // Á°Æ‰øùÂØπË±°‰∏≠‰πüÊúâkeyÂ±ûÊÄß
                            item.key = mapKey;
                            stockPool.set(mapKey, item);
                        });
                    }
                }

                if (!hasSavedPoolKey && stockPool.size === 0) {
                    return;
                }
            } catch (e) {
                console.error('ËÇ°Á•®Ê±†ÊÅ¢Â§çÂ§±Ë¥•:', e);
            }
        }

        function scheduleStockPoolAutoRefresh() {
            setTimeout(() => {
                autoRefreshStockPoolIfNeeded();
            }, 2200);
            setInterval(() => {
                autoRefreshStockPoolIfNeeded();
            }, 30 * 60 * 1000);
        }

        async function autoRefreshStockPoolIfNeeded() {
            try {
                if (stockPoolRefreshing) return;
                if (!stockPool || stockPool.size === 0) return;
                const today = getLocalDateString();
                const last = localStorage.getItem(STOCK_POOL_LAST_REFRESH_KEY) || '';
                if (last === today) return;
                if (!isConnected) return;
                const ok = await refreshStockPoolNow({ auto: true });
                if (ok) localStorage.setItem(STOCK_POOL_LAST_REFRESH_KEY, today);
            } catch (e) {
            }
        }

        async function refreshStockPoolNow(options = {}) {
            const auto = !!options.auto;
            if (stockPoolRefreshing) return false;
            if (!stockPool || stockPool.size === 0) {
                if (!auto) showNotification('ËÇ°Á•®Ê±†‰∏∫Á©∫ÔºåÊó†ÈúÄÂà∑Êñ∞', 'warning');
                return false;
            }
            if (!isConnected) {
                if (!auto) showNotification('ÂêéÁ´ØÊú™ËøûÊé•ÔºåÊó†Ê≥ïÂà∑Êñ∞ËÇ°Á•®Ê±†', 'warning');
                return false;
            }

            const btn = document.getElementById('btnRefreshPool');
            const originalText = btn ? btn.textContent : '';
            stockPoolRefreshing = true;
            if (btn) {
                btn.disabled = true;
                btn.classList.add('is-active');
            }

            const entries = Array.from(stockPool.values());
            const total = entries.length;
            const endDate = getLocalDateString();
            const startDate = addDaysToDateString(endDate, -45) || endDate;

            let updated = 0;
            for (let i = 0; i < total; i++) {
                const item = entries[i];
                const tsCode = item && item.tsCode ? normalizeTsCode(item.tsCode) : null;
                if (!tsCode) continue;
                if (btn) btn.textContent = `Âà∑Êñ∞‰∏≠ ${i + 1}/${total}`;
                try {
                    const response = await fetch(
                        `${API_BASE}/stock_data?ts_code=${encodeURIComponent(tsCode)}&start_date=${startDate}&end_date=${endDate}`
                    );
                    const result = await response.json();
                    if (!result || !result.success || !Array.isArray(result.data) || result.data.length === 0) {
                        continue;
                    }
                    const prepared = prepareStockData(result.data);
                    if (!prepared || prepared.length === 0) continue;
                    const latest = prepared[prepared.length - 1] || {};
                    const latestPrice = Number(latest.close);
                    if (!Number.isFinite(latestPrice)) continue;
                    item.currentPrice = latestPrice;
                    if (Number.isFinite(Number(item.entryPrice)) && Number(item.entryPrice) > 0) {
                        item.returnPct = ((latestPrice - Number(item.entryPrice)) / Number(item.entryPrice)) * 100;
                    }
                    if (latest.pe !== undefined && latest.pe !== null) item.pe = latest.pe;
                    if (latest.pb !== undefined && latest.pb !== null) item.pb = latest.pb;
                    item.updatedAt = new Date().toISOString();
                    updated++;
                } catch (e) {
                }
                await new Promise(r => setTimeout(r, 30));
            }

            persistStockPool();
            if (isPoolTabActive()) updateStockPoolView();
            updatePoolStatus();

            if (btn) {
                btn.disabled = false;
                btn.classList.remove('is-active');
                btn.textContent = originalText || 'üîÑ Âà∑Êñ∞Êî∂Áõä';
            }
            stockPoolRefreshing = false;

            if (!auto) showNotification(`‚úÖ Â∑≤Âà∑Êñ∞ ${updated}/${total} Âè™ËÇ°Á•®`, 'success');
            return true;
        }

        function getFilteredStockPoolEntries() {
            const filterValue = (document.getElementById('poolFilter')?.value || '').trim();
            const q = filterValue.toLowerCase();
            const list = Array.from(stockPool.values())
                .filter(item => {
                    // console.log('Checking item:', item);
                    // ÈªòËÆ§ÊòæÁ§∫ÊâÄÊúâÊù•Ê∫êÁöÑËÇ°Á•®ÔºåÂåÖÊã¨ mock
                    if (!q) return true;
                    return String(item.tsCode || '').toLowerCase().includes(q) || String(item.name || '').toLowerCase().includes(q);
                })
                .sort((a, b) => String(a.tsCode).localeCompare(String(b.tsCode)));
            return list;
        }

        function updateStockPoolView() {
            updatePoolStatus();
            const tbody = document.getElementById('poolBody');
            if (!tbody) return;

            const entries = getFilteredStockPoolEntries();
            lastRenderedPoolCodes = entries.map(e => e.tsCode);
            const globalStartDate = document.getElementById('startDate')?.value;
            const globalEndDate = document.getElementById('endDate')?.value;
            let poolUpdated = false;
            if (globalStartDate && globalEndDate) {
                entries.forEach(item => {
                    const cached = loadStockDataFromCache(item.tsCode, globalStartDate, globalEndDate);
                    if (!cached || cached.length === 0) return;
                    const latest = cached[cached.length - 1] || {};

                    const latestPrice = Number(latest.close);
                    if (Number.isFinite(latestPrice) && item.currentPrice !== latestPrice) {
                        item.currentPrice = latestPrice;
                        if (Number.isFinite(Number(item.entryPrice)) && Number(item.entryPrice) > 0) {
                            item.returnPct = ((latestPrice - Number(item.entryPrice)) / Number(item.entryPrice)) * 100;
                        }
                        item.updatedAt = new Date().toISOString();
                        poolUpdated = true;
                    }

                    if (latest.pe !== null && latest.pe !== undefined && item.pe !== latest.pe) {
                        item.pe = latest.pe;
                        poolUpdated = true;
                    }
                    if (latest.pb !== null && latest.pb !== undefined && item.pb !== latest.pb) {
                        item.pb = latest.pb;
                        poolUpdated = true;
                    }
                });
            }
            if (poolUpdated) {
                persistStockPool();
            }

            // Êõ¥Êñ∞Ë°®Â§¥ÔºàÂ¶ÇÊûúÈúÄË¶ÅÂä®ÊÄÅÊõ¥ÊîπÔºâ
            const thead = document.querySelector('#poolTable thead tr');
            if (thead) {
                thead.innerHTML = `
                    <th style="width: 40px;"><input type="checkbox" id="selectAllPool" onchange="toggleSelectAllPool(this)"></th>
                    <th>Á≠ñÁï•ÂêçÁß∞</th>
                    <th>ËÇ°Á•®‰ª£Á†Å</th>
                    <th>ËÇ°Á•®ÂêçÁß∞</th>
                    <th>Â∏ÇÁõàÁéá</th>
                    <th>Â∏ÇÂáÄÁéá</th>
                    <th>ÂÖ•ÈÄâÊó∂Èó¥</th>
                    <th>ÂÖ•ÈÄâ‰ª∑Ê†º</th>
                    <th>ÊúÄÊñ∞‰ª∑Ê†º</th>
                    <th>Ëá≥‰ªäÊî∂Áõä</th>
                    <th>Êìç‰Ωú</th>
                `;
            }

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#888;padding:40px;">ÊöÇÊó†Á≠õÈÄâÁªìÊûú</td></tr>';
                return;
            }

            // ÊåâÁ≠ñÁï•ÂíåÊó∂Èó¥ÊéíÂ∫è
            entries.sort((a, b) => {
                const strategyA = a.strategy || '';
                const strategyB = b.strategy || '';
                if (strategyA !== strategyB) return strategyA.localeCompare(strategyB);
                return new Date(b.entryTime) - new Date(a.entryTime);
            });

            tbody.innerHTML = entries.map(item => {
                const returnPct = item.returnPct !== undefined && item.returnPct !== null ? item.returnPct : 0;
                const returnClass = returnPct >= 0 ? 'positive' : 'negative';
                const returnText = (returnPct >= 0 ? '+' : '') + returnPct.toFixed(2) + '%';
                // Ensure key is not undefined in the attribute
                const itemKey = item.key || '';
                const peText = item.pe !== undefined && item.pe !== null && Number.isFinite(Number(item.pe)) ? Number(item.pe).toFixed(2) : '--';
                const pbText = item.pb !== undefined && item.pb !== null && Number.isFinite(Number(item.pb)) ? Number(item.pb).toFixed(2) : '--';
                
                return `
                    <tr>
                        <td><input type="checkbox" class="pool-item-checkbox" data-key="${itemKey}" value="${item.tsCode}"></td>
                        <td>${item.strategyName}</td>
                        <td><span style="color:#667eea;font-weight:bold">${item.tsCode}</span></td>
                        <td>${item.name}</td>
                        <td>${peText}</td>
                        <td>${pbText}</td>
                        <td>${item.entryTime}</td>
                        <td>¬•${(item.entryPrice || 0).toFixed(2)}</td>
                        <td>¬•${(item.currentPrice || 0).toFixed(2)}</td>
                        <td class="${returnClass}">${returnText}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" style="padding:4px 8px;font-size:12px;" onclick="viewStock('${item.tsCode}', '${item.name}', '${item.strategy}')">Êü•Áúã</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function addCustomStockToPool() {
            alert('ËÇ°Á•®Ê±†‰ªÖÂÖÅËÆ∏‰ªé‚ÄúÁ≠õÈÄâÁªìÊûú‚ÄùÂãæÈÄâÂêéÂä†ÂÖ•');
            return;
        }

        function toggleSelectAllPool(source) {
            const checkboxes = document.querySelectorAll('.pool-item-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function deleteSelectedStocks() {
            const checkboxes = document.querySelectorAll('.pool-item-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËÇ°Á•®');
                return;
            }

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${checkboxes.length} Âè™ËÇ°Á•®ÂêóÔºü`)) {
                return;
            }

            let deletedCount = 0;
            checkboxes.forEach(cb => {
                const attrKey = cb.getAttribute('data-key');
                // Use data-key if valid, otherwise fallback to value (tsCode)
                const key = (attrKey && attrKey !== 'undefined' && attrKey !== 'null') ? attrKey : cb.value;
                
                let targetKey = key;
                if (!stockPool.has(key)) {
                    // Try to find a matching key in the pool
                    for (const poolKey of stockPool.keys()) {
                        if (poolKey.endsWith('_' + key) || poolKey === key) {
                            targetKey = poolKey;
                            break;
                        }
                    }
                }

                if (targetKey && stockPool.has(targetKey)) {
                    stockPool.delete(targetKey);
                    deletedCount++;
                } else {
                    console.warn('‚ö†Ô∏è Âà†Èô§Â§±Ë¥•ÔºåÊú™ÊâæÂà∞Key:', key, 'Available Keys:', Array.from(stockPool.keys()));
                }
            });

            // Âº∫Âà∂‰øùÂ≠òÂíåÊõ¥Êñ∞ËßÜÂõæ
            persistStockPool();
            
            // Ê∏ÖÈô§ÂÖ®ÈÄâÊ°ÜÁä∂ÊÄÅ
            const selectAll = document.getElementById('selectAllPool');
            if (selectAll) selectAll.checked = false;
            
            updateStockPoolView();
            alert(`Â∑≤Âà†Èô§ ${deletedCount} Âè™ËÇ°Á•®`);
        }

        function clearStockPool() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Êï¥‰∏™ËÇ°Ê±†ÂêóÔºü')) return;
            stockPool = new Map();
            lastRenderedPoolCodes = [];
            persistStockPool();
            const selectAll = document.getElementById('selectAllPool');
            if (selectAll) selectAll.checked = false;
            updateStockPoolView();
            updatePoolStatus();
            alert('ËÇ°Ê±†Â∑≤Ê∏ÖÁ©∫');
        }

        /* 
        function clearStockPool() {
            // ... deprecated ...
        }
        */



        // ===================== APIËøûÊé• =====================
        async function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            try {
                const response = await fetch(`${API_BASE}/stock_data?ts_code=000001.SZ&start_date=2024-01-01&end_date=2024-01-10`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const wasConnected = isConnected;
                    isConnected = true;
                    connectionRetryCount = 0;
                    statusEl.className = 'connection-status connected';
                    textEl.textContent = '‚úÖ TushareÂêéÁ´ØÂ∑≤ËøûÊé•';
                    document.getElementById('dataInfo').style.display = 'block';
                    autoRefreshStockPoolIfNeeded();
                    if (!wasConnected || !localStateHydrateDone) {
                        hydrateAndRestoreAll().finally(() => {
                            flushLocalStatePersistence();
                        });
                    }
                } else {
                    throw new Error('ËøûÊé•Â§±Ë¥•');
                }
            } catch (error) {
                isConnected = false;
                statusEl.className = 'connection-status disconnected';
                textEl.textContent = '‚ö†Ô∏è ÂêéÁ´ØÊú™ËøûÊé•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ';
                console.log('ÂêéÁ´ØÊú™ËøûÊé•ÔºåÂ∞Ü‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ');
                if (connectionRetryCount < 10) {
                    connectionRetryCount += 1;
                    setTimeout(() => {
                        try { checkConnection(); } catch (e) {}
                    }, 1500);
                }
            }
        }

        // ===================== ËÇ°Á•®ÊêúÁ¥¢ =====================
        async function searchStock(keyword) {
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (keyword.length < 2) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                if (isConnected) {
                    try {
                        const response = await fetch(`${API_BASE}/stock_list?keyword=${encodeURIComponent(keyword)}`);
                        const data = await response.json();
                        
                        if (data.success && data.data.length > 0) {
                            displaySearchResults(data.data);
                        }
                    } catch (error) {
                        console.error('ÊêúÁ¥¢Â§±Ë¥•:', error);
                    }
                } else {
                    // Ê®°ÊãüÊêúÁ¥¢ÁªìÊûú
                    const mockResults = [
                        { ts_code: '000001.SZ', name: 'Âπ≥ÂÆâÈì∂Ë°å', industry: 'Èì∂Ë°å' },
                        { ts_code: '600519.SH', name: 'Ë¥µÂ∑ûËåÖÂè∞', industry: 'ÁôΩÈÖí' },
                        { ts_code: '000002.SZ', name: '‰∏áÁßëA', industry: 'ÊàøÂú∞‰∫ß' }
                    ].filter(s => 
                        s.ts_code.includes(keyword.toUpperCase()) || 
                        s.name.includes(keyword)
                    );
                    displaySearchResults(mockResults);
                }
            }, 300);
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.classList.remove('active');
                return;
            }
            
            container.innerHTML = results.map(stock => `
                <div class="stock-item" onclick="selectStock('${stock.ts_code}', '${stock.name}')">
                    <div>
                        <span class="code">${stock.ts_code}</span>
                        <span class="name">${stock.name}</span>
                    </div>
                    <span class="industry">${stock.industry || ''}</span>
                </div>
            `).join('');
            
            container.classList.add('active');
        }

        function selectStock(code, name) {
            document.getElementById('stockCode').value = code;
            document.getElementById('stockName').textContent = name;
            document.getElementById('searchResults').classList.remove('active');
            if (typeof scheduleSaveUiState === 'function') scheduleSaveUiState();
        }

        // ===================== Ëé∑ÂèñÊï∞ÊçÆ =====================
        async function fetchStockData() {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            
            loading.classList.add('active');
            loadingText.textContent = 'Ê≠£Âú®Ê£ÄÊü•Êú¨Âú∞ÁºìÂ≠ò...';
            document.getElementById('loadingProgress').style.width = '10%';
            
            const tsCodeInput = document.getElementById('stockCode');
            const tsCodeRaw = tsCodeInput.value;
            const tsCode = normalizeTsCode(tsCodeRaw) || tsCodeRaw;
            tsCodeInput.value = tsCode;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Êõ¥Êñ∞ÂΩìÂâçËÇ°Á•®‰ø°ÊÅØ
            currentStockInfo = { tsCode, startDate, endDate };
            
            try {
                // 1. È¶ñÂÖàÂ∞ùËØï‰ªéÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆ
                const cachedData = loadStockDataFromCache(tsCode, startDate, endDate);
                if (cachedData) {
                    loadingText.textContent = '‰ªéÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆ...';
                    document.getElementById('loadingProgress').style.width = '50%';
                    
                    stockData = cachedData;
                    updateDataInfo();

                    addToStockPool({
                        tsCode,
                        name: document.getElementById('stockName')?.textContent || tsCode,
                        startDate,
                        endDate,
                        dataCount: stockData.length,
                        source: 'cache'
                    });
                    
                    document.getElementById('loadingProgress').style.width = '100%';
                    await sleep(300);
                    loading.classList.remove('active');
                    
                    console.log('‚úÖ ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÔºåË∑≥ËøáÁΩëÁªúËØ∑Ê±Ç');
                    return true;
                }
                
                // 2. ÁºìÂ≠ò‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØïÂ§çÁî®Ë¶ÜÁõñËåÉÂõ¥ÁºìÂ≠ò
                loadingText.textContent = 'Ê≠£Âú®Ëé∑ÂèñTushareÊï∞ÊçÆ...';
                document.getElementById('loadingProgress').style.width = '30%';
                
                if (isConnected) {
                    const covering = loadBestCachedDataCoveringRange(tsCode, startDate, endDate);
                    if (covering && covering.data && covering.data.length > 0) {
                        stockData = covering.data;
                        console.log(`üìä Â§çÁî®Ë¶ÜÁõñÁºìÂ≠òÊï∞ÊçÆ: ${stockData.length} Êù°`);
                        updateDataInfo();
                        saveStockDataToCache(tsCode, startDate, endDate, stockData);
                        cleanupShorterCacheRanges(tsCode, startDate, endDate);
                        saveCurrentSession();
                        addToStockPool({
                            tsCode,
                            name: document.getElementById('stockName')?.textContent || tsCode,
                            startDate,
                            endDate,
                            dataCount: stockData.length,
                            source: 'cache'
                        });
                        document.getElementById('loadingProgress').style.width = '100%';
                        await sleep(200);
                        loading.classList.remove('active');
                        return true;
                    }

                    const tailBase = loadBestCachedDataForTailExtension(tsCode, startDate, endDate);
                    if (tailBase && tailBase.data && tailBase.data.length > 0) {
                        const baseEnd = tailBase.meta?.endDate;
                        const incStart = addDaysToDateString(baseEnd, 1);
                        if (incStart && incStart <= endDate) {
                            const incResponse = await fetch(
                                `${API_BASE}/stock_data?ts_code=${tsCode}&start_date=${incStart}&end_date=${endDate}`
                            );
                            const incResult = await incResponse.json();
                            if (incResult.success && incResult.data && incResult.data.length > 0) {
                                const incPrepared = prepareStockData(incResult.data);
                                stockData = mergeAndPrepareStockData(tailBase.data, incPrepared);
                                console.log(`üìä Â¢ûÈáèË°•ÈΩêÊï∞ÊçÆ: ${tailBase.data.length} + ${incPrepared.length} => ${stockData.length}`);
                                updateDataInfo();
                                saveStockDataToCache(tsCode, startDate, endDate, stockData);
                                cleanupShorterCacheRanges(tsCode, startDate, endDate);
                                saveCurrentSession();
                                addToStockPool({
                                    tsCode,
                                    name: document.getElementById('stockName')?.textContent || tsCode,
                                    startDate,
                                    endDate,
                                    dataCount: stockData.length,
                                    source: 'api_incremental'
                                });
                                document.getElementById('loadingProgress').style.width = '100%';
                                await sleep(200);
                                loading.classList.remove('active');
                                return true;
                            }
                        }
                    }

                    const response = await fetch(
                        `${API_BASE}/stock_data?ts_code=${tsCode}&start_date=${startDate}&end_date=${endDate}`
                    );
                    const result = await response.json();
                    
                    if (result.success) {
                        stockData = prepareStockData(result.data);
                        console.log(`üìä ‰ªéAPIËé∑ÂèñÂà∞ ${stockData.length} Êù°Êï∞ÊçÆ`);
                        updateDataInfo();

                        addToStockPool({
                            tsCode,
                            name: document.getElementById('stockName')?.textContent || tsCode,
                            startDate,
                            endDate,
                            dataCount: stockData.length,
                            source: 'api'
                        });
                        
                        // ‰øùÂ≠òÂà∞ÁºìÂ≠ò
                        saveStockDataToCache(tsCode, startDate, endDate, stockData);
                        cleanupShorterCacheRanges(tsCode, startDate, endDate);
                        
                        // ‰øùÂ≠òÂΩìÂâç‰ºöËØù‰ø°ÊÅØ
                        saveCurrentSession();
                    } else {
                        console.error(`‚ùå APIÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•: ${result.message}`);
                        throw new Error(result.message || 'Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•');
                    }
                } else {
                    // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                    console.log('üîÑ ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ');
                    stockData = generateMockData(startDate, endDate);
                    console.log(`üìä ÁîüÊàê‰∫Ü ${stockData.length} Êù°Ê®°ÊãüÊï∞ÊçÆ`);

                    addToStockPool({
                        tsCode,
                        name: document.getElementById('stockName')?.textContent || tsCode,
                        startDate,
                        endDate,
                        dataCount: stockData.length,
                        source: 'mock'
                    });
                }
                
                document.getElementById('loadingProgress').style.width = '100%';
                await sleep(300);
                loading.classList.remove('active');
                
                return true;
            } catch (error) {
                console.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•:', error);
                loadingText.textContent = 'Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ...';
                stockData = generateMockData(startDate, endDate);

                addToStockPool({
                    tsCode,
                    name: document.getElementById('stockName')?.textContent || tsCode,
                    startDate,
                    endDate,
                    dataCount: stockData.length,
                    source: 'mock'
                });
                await sleep(500);
                loading.classList.remove('active');
                return true;
            }
        }
        
        async function fetchStockDataForOptimization(tsCode, startDate, endDate, abortSignal = undefined) {
            try {
                tsCode = normalizeTsCode(tsCode) || tsCode;
                const cachedData = loadStockDataFromCache(tsCode, startDate, endDate);
                if (cachedData && cachedData.length > 0) {
                    console.log(`üì¶ ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ: ${cachedData.length} Êù°`);
                    addToStockPool({ tsCode, name: tsCode, startDate, endDate, dataCount: cachedData.length, source: 'cache' });
                    return cachedData;
                }
                
                if (isConnected) {
                    const covering = loadBestCachedDataCoveringRange(tsCode, startDate, endDate);
                    if (covering && covering.data && covering.data.length > 0) {
                        console.log(`üìä Â§çÁî®Ë¶ÜÁõñÁºìÂ≠òÊï∞ÊçÆ: ${covering.data.length} Êù°`);
                        saveStockDataToCache(tsCode, startDate, endDate, covering.data);
                        cleanupShorterCacheRanges(tsCode, startDate, endDate);
                        addToStockPool({ tsCode, name: tsCode, startDate, endDate, dataCount: covering.data.length, source: 'cache' });
                        return covering.data;
                    }

                    const tailBase = loadBestCachedDataForTailExtension(tsCode, startDate, endDate);
                    if (tailBase && tailBase.data && tailBase.data.length > 0) {
                        const baseEnd = tailBase.meta?.endDate;
                        const incStart = addDaysToDateString(baseEnd, 1);
                        if (incStart && incStart <= endDate) {
                            const incResponse = await fetch(
                                `${API_BASE}/stock_data?ts_code=${tsCode}&start_date=${incStart}&end_date=${endDate}`,
                                abortSignal ? { signal: abortSignal } : undefined
                            );
                            const incResult = await incResponse.json();
                            if (incResult.success && incResult.data && incResult.data.length > 0) {
                                const incPrepared = prepareStockData(incResult.data);
                                const mergedPrepared = mergeAndPrepareStockData(tailBase.data, incPrepared);
                                console.log(`üìä Â¢ûÈáèË°•ÈΩêÊï∞ÊçÆ: ${tailBase.data.length} + ${incPrepared.length} => ${mergedPrepared.length}`);
                                saveStockDataToCache(tsCode, startDate, endDate, mergedPrepared);
                                cleanupShorterCacheRanges(tsCode, startDate, endDate);
                                addToStockPool({ tsCode, name: tsCode, startDate, endDate, dataCount: mergedPrepared.length, source: 'api_incremental' });
                                return mergedPrepared;
                            }
                        }
                    }

                    const response = await fetch(
                        `${API_BASE}/stock_data?ts_code=${tsCode}&start_date=${startDate}&end_date=${endDate}`,
                        abortSignal ? { signal: abortSignal } : undefined
                    );
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.length > 0) {
                        const prepared = prepareStockData(result.data);
                        console.log(`üìä ‰ªéAPIËé∑ÂèñÂà∞ ${prepared.length} Êù°Êï∞ÊçÆ`);
                        saveStockDataToCache(tsCode, startDate, endDate, prepared);
                        cleanupShorterCacheRanges(tsCode, startDate, endDate);
                        addToStockPool({ tsCode, name: tsCode, startDate, endDate, dataCount: prepared.length, source: 'api' });
                        return prepared;
                    }
                }
                
                console.log('üîÑ ÁîüÊàêÊ®°ÊãüÊï∞ÊçÆÁî®‰∫é‰ºòÂåñ');
                const mockData = generateMockData(startDate, endDate);
                addToStockPool({ tsCode, name: tsCode, startDate, endDate, dataCount: mockData.length, source: 'mock' });
                return mockData;
            } catch (error) {
                console.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ:', error);
                const mockData = generateMockData(startDate, endDate);
                addToStockPool({ tsCode, name: tsCode, startDate, endDate, dataCount: mockData.length, source: 'mock' });
                return mockData;
            }
        }

        // ===================== Êï∞ÊçÆÊåÅ‰πÖÂåñÂäüËÉΩ =====================
        
        function saveStockDataToCache(tsCode, startDate, endDate, data) {
            try {
                const cacheKey = `${tsCode}_${startDate}_${endDate}`;
                const compactData = compactStockDataForCache(data);
                const cacheData = {
                    data: compactData,
                    meta: {
                        tsCode: tsCode,
                        startDate: startDate,
                        endDate: endDate,
                        cachedAt: new Date().toISOString(),
                        dataCount: data.length
                    }
                };
                
                // Ëé∑ÂèñÁé∞ÊúâÁºìÂ≠ò
                const existingCache = JSON.parse(localStorage.getItem(DATA_CACHE_KEY) || '{}');
                
                // Êõ¥Êñ∞ÁºìÂ≠ò
                existingCache[cacheKey] = cacheData;
                
                // Ê∏ÖÁêÜËøáÊúüÁºìÂ≠òÔºàË∂ÖËøá7Â§©Ôºâ
                const now = new Date();
                Object.keys(existingCache).forEach(key => {
                    const cachedAt = new Date(existingCache[key].meta.cachedAt);
                    if ((now - cachedAt) / (1000 * 60 * 60 * 24) > CACHE_EXPIRY_DAYS) {
                        delete existingCache[key];
                    }
                });
                
                const ok = trySetCacheWithEviction(existingCache, cacheKey);
                if (ok) {
                    console.log(`‚úÖ Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞ÁºìÂ≠ò: ${cacheKey}, Êï∞ÊçÆÊù°Êï∞: ${data.length}`);
                } else {
                    delete existingCache[cacheKey];
                    try {
                        localStorage.setItem(DATA_CACHE_KEY, JSON.stringify(existingCache));
                    } catch (_) {
                    }
                    console.warn(`‚ö†Ô∏è ÁºìÂ≠òÁ©∫Èó¥‰∏çË∂≥ÔºåÂ∑≤Ë∑≥ËøáÁºìÂ≠ò: ${cacheKey}`);
                }
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠òÊï∞ÊçÆÂà∞ÁºìÂ≠òÂ§±Ë¥•:', error);
            }
        }
        
        function loadStockDataFromCache(tsCode, startDate, endDate) {
            try {
                const cacheKey = `${tsCode}_${startDate}_${endDate}`;
                const cache = JSON.parse(localStorage.getItem(DATA_CACHE_KEY) || '{}');
                
                if (cache[cacheKey]) {
                    const cachedData = cache[cacheKey];
                    const cachedAt = new Date(cachedData.meta.cachedAt);
                    const now = new Date();
                    
                    // Ê£ÄÊü•ÁºìÂ≠òÊòØÂê¶ËøáÊúü
                    if ((now - cachedAt) / (1000 * 60 * 60 * 24) <= CACHE_EXPIRY_DAYS) {
                        if (isPreparedStockData(cachedData.data)) {
                            console.log(`‚úÖ ‰ªéÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆ: ${cacheKey}, Êï∞ÊçÆÊù°Êï∞: ${cachedData.data.length}`);
                            return cachedData.data;
                        }
                        const prepared = prepareStockData(cachedData.data);
                        if (prepared.length > 0) {
                            console.log(`‚úÖ ‰ªéÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆ: ${cacheKey}, Êï∞ÊçÆÊù°Êï∞: ${prepared.length}`);
                            return prepared;
                        }
                        console.log(`‚úÖ ‰ªéÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆ: ${cacheKey}, Êï∞ÊçÆÊù°Êï∞: ${Array.isArray(cachedData.data) ? cachedData.data.length : '--'}`);
                        return Array.isArray(cachedData.data) ? cachedData.data : null;
                    } else {
                        console.log(`‚ö†Ô∏è ÁºìÂ≠òÂ∑≤ËøáÊúü: ${cacheKey}`);
                        // Âà†Èô§ËøáÊúüÁºìÂ≠ò
                        delete cache[cacheKey];
                        localStorage.setItem(DATA_CACHE_KEY, JSON.stringify(cache));
                    }
                }
            } catch (error) {
                console.error('‚ùå ‰ªéÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
            return null;
        }
        
        function getCachedStockDataList() {
            try {
                const cache = JSON.parse(localStorage.getItem(DATA_CACHE_KEY) || '{}');
                const now = new Date();
                const validCache = {};
                
                // ËøáÊª§ÊúâÊïàÁºìÂ≠ò
                Object.keys(cache).forEach(key => {
                    const cachedAt = new Date(cache[key].meta.cachedAt);
                    if ((now - cachedAt) / (1000 * 60 * 60 * 24) <= CACHE_EXPIRY_DAYS) {
                        validCache[key] = cache[key];
                    }
                });
                
                return Object.values(validCache).map(item => item.meta);
            } catch (error) {
                console.error('‚ùå Ëé∑ÂèñÁºìÂ≠òÂàóË°®Â§±Ë¥•:', error);
                return [];
            }
        }
        
        function clearExpiredCache() {
            try {
                const cache = JSON.parse(localStorage.getItem(DATA_CACHE_KEY) || '{}');
                const now = new Date();
                let clearedCount = 0;
                
                Object.keys(cache).forEach(key => {
                    const cachedAt = new Date(cache[key].meta.cachedAt);
                    if ((now - cachedAt) / (1000 * 60 * 60 * 24) > CACHE_EXPIRY_DAYS) {
                        delete cache[key];
                        clearedCount++;
                    }
                });
                
                localStorage.setItem(DATA_CACHE_KEY, JSON.stringify(cache));
                
                if (clearedCount > 0) {
                    console.log(`üóëÔ∏è Â∑≤Ê∏ÖÁêÜ ${clearedCount} ‰∏™ËøáÊúüÁºìÂ≠ò`);
                }
            } catch (error) {
                console.error('‚ùå Ê∏ÖÁêÜËøáÊúüÁºìÂ≠òÂ§±Ë¥•:', error);
            }
        }
        
        function restoreLastSessionData() {
            try {
                // Ëé∑Âèñ‰∏äÊ¨°‰ºöËØùÁöÑÊï∞ÊçÆ‰ø°ÊÅØ
                const lastSession = JSON.parse(localStorage.getItem('quant_last_session') || '{}');
                
                if (lastSession.tsCode && lastSession.startDate && lastSession.endDate) {
                    console.log('üîç Ê£ÄÊµãÂà∞‰∏äÊ¨°‰ºöËØùÊï∞ÊçÆÔºåÂ∞ùËØïÊÅ¢Â§ç...');
                    
                    const stockCodeEl = document.getElementById('stockCode');
                    const startDateEl = document.getElementById('startDate');
                    const endDateEl = document.getElementById('endDate');
                    const currentTs = stockCodeEl?.value || '';
                    const currentStart = startDateEl?.value || '';
                    const currentEnd = endDateEl?.value || '';

                    if (currentTs && currentStart && currentEnd) {
                        if (currentTs !== lastSession.tsCode || currentStart !== lastSession.startDate || currentEnd !== lastSession.endDate) {
                            return;
                        }
                    } else {
                        if (stockCodeEl && !currentTs) stockCodeEl.value = lastSession.tsCode;
                        if (startDateEl && !currentStart) startDateEl.value = lastSession.startDate;
                        if (endDateEl && !currentEnd) endDateEl.value = lastSession.endDate;
                        if (typeof scheduleSaveUiState === 'function') scheduleSaveUiState();
                    }
                    
                    // Â∞ùËØï‰ªéÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆ
                    const cachedData = loadStockDataFromCache(lastSession.tsCode, lastSession.startDate, lastSession.endDate);
                    if (cachedData) {
                        stockData = cachedData;
                        updateDataInfo();
                        console.log('‚úÖ ÊàêÂäüÊÅ¢Â§ç‰∏äÊ¨°‰ºöËØùÊï∞ÊçÆ');
                        
                        // Êõ¥Êñ∞ÂΩìÂâçËÇ°Á•®‰ø°ÊÅØ
                        currentStockInfo = {
                            tsCode: lastSession.tsCode,
                            startDate: lastSession.startDate,
                            endDate: lastSession.endDate
                        };
                        
                        // Á≠âÂæÖEChartsÂä†ËΩΩÂÆåÊàêÂêéÂÜçÊõ¥Êñ∞ÂõæË°®
                        const waitForECharts = setInterval(() => {
                            if (echartsLoaded) {
                                clearInterval(waitForECharts);
                                updateCharts();
                            }
                        }, 100);
                    } else {
                        console.log('‚ö†Ô∏è ÁºìÂ≠òÊï∞ÊçÆÂ∑≤ËøáÊúüÔºåÈúÄË¶ÅÈáçÊñ∞Ëé∑Âèñ');
                    }
                }
            } catch (error) {
                console.error('‚ùå ÊÅ¢Â§ç‰∏äÊ¨°‰ºöËØùÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }
        
        function saveCurrentSession() {
            try {
                if (currentStockInfo.tsCode && currentStockInfo.startDate && currentStockInfo.endDate) {
                    const sessionData = {
                        tsCode: currentStockInfo.tsCode,
                        startDate: currentStockInfo.startDate,
                        endDate: currentStockInfo.endDate,
                        savedAt: new Date().toISOString()
                    };
                    
                    localStorage.setItem('quant_last_session', JSON.stringify(sessionData));
                    persistLocalStateKeyBestEffort('quant_last_session', sessionData);
                    console.log('üíæ ÂΩìÂâç‰ºöËØùÂ∑≤‰øùÂ≠ò');
                }
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠ò‰ºöËØùÂ§±Ë¥•:', error);
            }
        }
        
        function clearAllCache() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁºìÂ≠òÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜ„ÄÇ')) {
                localStorage.removeItem(DATA_CACHE_KEY);
                localStorage.removeItem('quant_last_session');
                localStorage.removeItem(STOCK_POOL_KEY);
                persistLocalStateKeyBestEffort('quant_last_session', null);
                persistLocalStateKeyBestEffort(STOCK_POOL_KEY, []);
                stockPool = new Map();
                lastRenderedPoolCodes = [];
                console.log('üóëÔ∏è ÊâÄÊúâÁºìÂ≠òÊï∞ÊçÆÂ∑≤Ê∏ÖÈô§');
                alert('ÁºìÂ≠òÊï∞ÊçÆÂ∑≤Ê∏ÖÈô§Ôºå‰∏ãÊ¨°Â∞ÜÈáçÊñ∞‰∏ãËΩΩÊï∞ÊçÆ„ÄÇ');
            }
        }
        
        function showCacheInfo() {
            const cacheList = getCachedStockDataList();
            const cacheSize = JSON.stringify(localStorage.getItem(DATA_CACHE_KEY) || '{}').length;
            
            let info = `üìä ÁºìÂ≠ò‰ø°ÊÅØ\n`;
            info += `ÁºìÂ≠òÊï∞Èáè: ${cacheList.length} ‰∏™\n`;
            info += `ÁºìÂ≠òÂ§ßÂ∞è: ${(cacheSize / 1024).toFixed(2)} KB\n\n`;
            
            if (cacheList.length > 0) {
                info += `Â∑≤ÁºìÂ≠òÁöÑÊï∞ÊçÆ:\n`;
                cacheList.forEach((item, index) => {
                    const cachedAt = new Date(item.cachedAt).toLocaleDateString('zh-CN');
                    info += `${index + 1}. ${item.tsCode} (${item.startDate}~${item.endDate}) - ${cachedAt}\n`;
                });
            } else {
                info += 'ÊöÇÊó†ÁºìÂ≠òÊï∞ÊçÆ';
            }
            
            alert(info);
        }

        function buildSettingsBundle() {
            const keys = [
                UI_STATE_KEY,
                KLINE_ZOOM_STATE_KEY,
                STOCK_POOL_KEY,
                'quant_last_session',
                'strategyConfig',
                'optimizationResults'
            ];
            const values = {};
            keys.forEach(k => {
                try {
                    const raw = localStorage.getItem(k);
                    if (!raw) return;
                    values[k] = JSON.parse(raw);
                } catch (e) {
                }
            });
            return {
                version: 1,
                savedAt: new Date().toISOString(),
                values
            };
        }

        function exportSettingsBundle() {
            try {
                saveUiState();
                persistStockPool();
            } catch (e) {
            }
            const bundle = buildSettingsBundle();
            const content = JSON.stringify(bundle, null, 2);
            const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const stamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.href = url;
            a.download = `quant_settings_${stamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            if (typeof showNotification === 'function') showNotification('‚úÖ ËÆæÁΩÆÂ∑≤ÂØºÂá∫', 'success');
        }

        function promptImportSettingsBundle() {
            const input = document.getElementById('importSettingsFile');
            if (input) input.click();
        }

        async function handleImportSettingsFile(file) {
            if (!file) return;
            let text = '';
            try {
                text = await file.text();
            } catch (e) {
                alert('ËØªÂèñÊñá‰ª∂Â§±Ë¥•');
                return;
            }
            let parsed = null;
            try {
                parsed = JSON.parse(text);
            } catch (e) {
                alert('Êñá‰ª∂‰∏çÊòØÊúâÊïà JSON');
                return;
            }
            const values = parsed && parsed.values && typeof parsed.values === 'object' ? parsed.values : null;
            if (!values) {
                alert('ËÆæÁΩÆÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºàÁº∫Â∞ë valuesÔºâ');
                return;
            }

            const allowed = new Set([UI_STATE_KEY, KLINE_ZOOM_STATE_KEY, STOCK_POOL_KEY, 'quant_last_session', 'strategyConfig', 'optimizationResults']);
            for (const [k, v] of Object.entries(values)) {
                if (!allowed.has(k)) continue;
                try {
                    localStorage.setItem(k, JSON.stringify(v));
                } catch (e) {
                }
                try {
                    await persistLocalStateKey(k, v);
                } catch (e) {
                }
            }

            if (typeof showNotification === 'function') showNotification('‚úÖ ËÆæÁΩÆÂ∑≤ÂØºÂÖ•ÔºåÊ≠£Âú®Âà∑Êñ∞È°µÈù¢...', 'success');
            setTimeout(() => {
                try { location.reload(); } catch (e) {}
            }, 200);
        }
        
        function updateDataInfo() {
            if (stockData.length > 0) {
                document.getElementById('dataCount').textContent = stockData.length + 'Êù°';
                document.getElementById('dataRange').textContent = 
                    stockData[0].date + ' ~ ' + stockData[stockData.length - 1].date;

                try {
                    const reqStart = currentStockInfo?.startDate;
                    const reqEnd = currentStockInfo?.endDate;
                    const reqCode = currentStockInfo?.tsCode;
                    if (reqStart && reqEnd && reqCode) {
                        const key = `${reqCode}_${reqStart}_${reqEnd}_${stockData.length}`;
                        if (lastDataRangeWarnKey !== key) {
                            const startD = parseDateSafe(reqStart);
                            const endD = parseDateSafe(reqEnd);
                            const actualStart = stockData[0]?.date;
                            const actualEnd = stockData[stockData.length - 1]?.date;
                            const actualStartD = parseDateSafe(actualStart);
                            const actualEndD = parseDateSafe(actualEnd);
                            if (startD && endD && actualStartD && actualEndD) {
                                const reqDays = Math.ceil((endD - startD) / (1000 * 60 * 60 * 24));
                                const actualDays = Math.ceil((actualEndD - actualStartD) / (1000 * 60 * 60 * 24));
                                if (reqDays >= 300 && stockData.length < 120) {
                                    lastDataRangeWarnKey = key;
                                    const thresholdD = parseDateSafe(addDaysToDateString(reqStart, 7));
                                    const reason = thresholdD && actualStartD > thresholdD ? 'ËØ•ËÇ°Á•®ÂèØËÉΩÊòØ‰∏ÄÂπ¥ÂÜÖÊñ∞‰∏äÂ∏Ç/ÈïøÊúüÂÅúÁâåÔºåÊï∞ÊçÆÊ∫êÂè™ËÉΩËøîÂõûÂÆûÈôÖÊúâ‰∫§ÊòìÁöÑÂå∫Èó¥„ÄÇ' : 'Êï∞ÊçÆÊ∫êËøîÂõûÁöÑ‰∫§ÊòìÊó•Êï∞ÈáèÂÅèÂ∞ëÔºåÂèØËÉΩÊòØÂÅúÁâå/ÈÄÄÂ∏Ç/‰ª£Á†Å‰∏çÂåπÈÖç„ÄÇ';
                                    showNotification(`‚ö†Ô∏è ËØ∑Ê±Ç1Âπ¥Âå∫Èó¥‰ΩÜ‰ªÖËøîÂõû ${stockData.length} Êù°ÔºàÂÆûÈôÖ ${actualStart}~${actualEnd}Ôºâ„ÄÇ${reason}`, 'warning');
                                }
                            }
                        }
                    }
                } catch (_) {
                }
            }
        }

        function normalizeDateString(value) {
            if (value === null || value === undefined) return null;
            const s = String(value).trim();
            if (!s) return null;
            if (/^\d{8}$/.test(s)) return `${s.slice(0, 4)}-${s.slice(4, 6)}-${s.slice(6, 8)}`;
            if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0, 10);
            const d = new Date(s);
            if (Number.isNaN(d.getTime())) return null;
            return d.toISOString().slice(0, 10);
        }

        function parseDateSafe(value) {
            const normalized = normalizeDateString(value);
            if (!normalized) return null;
            const d = new Date(normalized);
            if (Number.isNaN(d.getTime())) return null;
            return d;
        }

        function getLocalDateString(value = null) {
            const d = value instanceof Date ? value : new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function toNumber(value, fallback = null) {
            if (value === null || value === undefined || value === '') return fallback;
            const n = Number(value);
            return Number.isFinite(n) ? n : fallback;
        }

        function normalizeTsCode(value) {
            if (value === null || value === undefined) return null;
            const s = String(value).trim().toUpperCase();
            if (!s) return null;
            if (s.includes('.')) return s;
            if (/^\d{6}$/.test(s)) {
                if (s.startsWith('6')) return `${s}.SH`;
                return `${s}.SZ`;
            }
            return s;
        }

        function getEastmoneyF10Url(tsCodeRaw) {
            const tsCode = normalizeTsCode(tsCodeRaw);
            if (!tsCode) return null;
            const parts = tsCode.split('.');
            const symbol = parts[0] || '';
            const suffix = (parts[1] || '').toUpperCase();
            let prefix = 'SZ';
            if (suffix === 'SH') prefix = 'SH';
            else if (suffix === 'BJ') prefix = 'BJ';
            else if (suffix === 'SZ') prefix = 'SZ';
            else if (symbol.startsWith('6') || symbol.startsWith('9')) prefix = 'SH';
            else if (symbol.startsWith('8') || symbol.startsWith('4')) prefix = 'BJ';
            else prefix = 'SZ';
            return `https://emweb.securities.eastmoney.com/PC_HSF10/CompanySurvey/Index?type=web&code=${prefix}${symbol}`;
        }

        function openF10ForCurrentStock() {
            const tsCodeRaw = document.getElementById('stockCode')?.value || '';
            const url = getEastmoneyF10Url(tsCodeRaw) || `https://so.eastmoney.com/web/s?keyword=${encodeURIComponent(tsCodeRaw)}`;
            try {
                window.open(url, '_blank', 'noopener,noreferrer');
            } catch (e) {
                location.href = url;
            }
        }

        function isPreparedStockData(data) {
            if (!Array.isArray(data) || data.length === 0) return false;
            const last = data[data.length - 1];
            if (!last || typeof last !== 'object') return false;
            if (typeof last.date !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(last.date)) return false;
            if (typeof last.open !== 'number' || typeof last.high !== 'number' || typeof last.low !== 'number' || typeof last.close !== 'number') return false;
            return last.ma5 != null || last.ma20 != null || last.rsi != null || last.macd != null || last.bollDown != null;
        }

        function addDaysToDateString(dateStr, days) {
            const d = parseDateSafe(dateStr);
            if (!d) return null;
            d.setDate(d.getDate() + days);
            return d.toISOString().slice(0, 10);
        }

        function mergeAndPrepareStockData(baseData, extraData) {
            const merged = [...(Array.isArray(baseData) ? baseData : []), ...(Array.isArray(extraData) ? extraData : [])];
            const byDate = new Map();
            merged.forEach(item => {
                if (!item || !item.date) return;
                const date = normalizeDateString(item.date);
                if (!date) return;
                byDate.set(date, item);
            });
            const list = Array.from(byDate.values())
                .map(item => ({
                    date: normalizeDateString(item.date),
                    open: toNumber(item.open ?? item.open_price),
                    high: toNumber(item.high ?? item.high_price),
                    low: toNumber(item.low ?? item.low_price),
                    close: toNumber(item.close ?? item.close_price),
                    volume: toNumber(item.volume ?? item.vol ?? item.volumn ?? item.amount_vol, 0),
                    turnover: toNumber(item.turnover ?? item.turnover_rate ?? item.turnoverRate, null),
                    pctChange: toNumber(item.pctChange ?? item.pct_chg ?? item.pctChg, 0)
                }))
                .filter(item => item.date && item.open !== null && item.high !== null && item.low !== null && item.close !== null)
                .sort((a, b) => a.date.localeCompare(b.date));
            if (list.length === 0) return [];
            return calculateIndicators(list);
        }

        function cleanupShorterCacheRanges(tsCode, startDate, keepEndDate) {
            try {
                const cache = JSON.parse(localStorage.getItem(DATA_CACHE_KEY) || '{}');
                const prefix = `${tsCode}_${startDate}_`;
                let changed = false;
                Object.keys(cache).forEach(key => {
                    if (!key.startsWith(prefix)) return;
                    const meta = cache[key]?.meta;
                    if (!meta || meta.tsCode !== tsCode || meta.startDate !== startDate) return;
                    if (meta.endDate && meta.endDate !== keepEndDate && meta.endDate < keepEndDate) {
                        delete cache[key];
                        changed = true;
                    }
                });
                if (changed) {
                    localStorage.setItem(DATA_CACHE_KEY, JSON.stringify(cache));
                }
            } catch (e) {
                console.error('Ê∏ÖÁêÜÊóßÁºìÂ≠òÂ§±Ë¥•:', e);
            }
        }

        function loadBestCachedDataCoveringRange(tsCode, startDate, endDate) {
            try {
                const cache = JSON.parse(localStorage.getItem(DATA_CACHE_KEY) || '{}');
                const now = new Date();
                let bestKey = null;
                let bestMeta = null;
                Object.keys(cache).forEach(key => {
                    const item = cache[key];
                    const meta = item?.meta;
                    if (!meta || meta.tsCode !== tsCode) return;
                    if (meta.startDate !== startDate) return;
                    if (!meta.endDate || meta.endDate < endDate) return;
                    const cachedAt = new Date(meta.cachedAt);
                    if ((now - cachedAt) / (1000 * 60 * 60 * 24) > CACHE_EXPIRY_DAYS) return;
                    if (!bestMeta || meta.endDate < bestMeta.endDate) {
                        bestKey = key;
                        bestMeta = meta;
                    }
                });
                if (!bestKey) return null;
                const item = cache[bestKey];
                const prepared = prepareStockData(item.data);
                if (prepared.length === 0) return null;
                const sliced = prepared.filter(d => d.date >= startDate && d.date <= endDate);
                return {
                    meta: bestMeta,
                    data: sliced
                };
            } catch (e) {
                console.error('Êü•ÊâæË¶ÜÁõñÁºìÂ≠òÂ§±Ë¥•:', e);
                return null;
            }
        }

        function loadBestCachedDataForTailExtension(tsCode, startDate, endDate) {
            try {
                const cache = JSON.parse(localStorage.getItem(DATA_CACHE_KEY) || '{}');
                const now = new Date();
                let bestKey = null;
                let bestMeta = null;
                Object.keys(cache).forEach(key => {
                    const item = cache[key];
                    const meta = item?.meta;
                    if (!meta || meta.tsCode !== tsCode) return;
                    if (meta.startDate !== startDate) return;
                    if (!meta.endDate || meta.endDate >= endDate) return;
                    const cachedAt = new Date(meta.cachedAt);
                    if ((now - cachedAt) / (1000 * 60 * 60 * 24) > CACHE_EXPIRY_DAYS) return;
                    if (!bestMeta || meta.endDate > bestMeta.endDate) {
                        bestKey = key;
                        bestMeta = meta;
                    }
                });
                if (!bestKey) return null;
                const item = cache[bestKey];
                const prepared = prepareStockData(item.data);
                if (prepared.length === 0) return null;
                return {
                    meta: bestMeta,
                    data: prepared
                };
            } catch (e) {
                console.error('Êü•ÊâæÂ¢ûÈáèÁºìÂ≠òÂ§±Ë¥•:', e);
                return null;
            }
        }

        function prepareStockData(rawData) {
            rawData = expandStockDataFromCache(rawData);
            if (!Array.isArray(rawData) || rawData.length === 0) return [];
            const prepared = rawData
                .map(item => {
                    const date = normalizeDateString(item.date ?? item.trade_date ?? item.tradeDate ?? item.datetime);
                    if (!date) return null;
                    const open = toNumber(item.open ?? item.open_price);
                    const high = toNumber(item.high ?? item.high_price);
                    const low = toNumber(item.low ?? item.low_price);
                    const close = toNumber(item.close ?? item.close_price);
                    const volume = toNumber(item.volume ?? item.vol ?? item.volumn ?? item.amount_vol, 0);
                    if (open === null || high === null || low === null || close === null) return null;
                    return {
                        date,
                        open,
                        high,
                        low,
                        close,
                        volume,
                        turnover: toNumber(item.turnover ?? item.turnover_rate ?? item.turnoverRate, null),
                        pctChange: toNumber(item.pctChange ?? item.pct_chg ?? item.pctChg, 0),
                        pe: toNumber(item.pe ?? item.pe_ttm ?? item.peTtm, null),
                        pb: toNumber(item.pb, null)
                    };
                })
                .filter(Boolean)
                .sort((a, b) => a.date.localeCompare(b.date));

            if (prepared.length === 0) return [];
            return calculateIndicators(prepared);
        }

        function compactStockDataForCache(data) {
            if (!Array.isArray(data) || data.length === 0) {
                return { format: 'compact_v1', rows: [] };
            }
            const rows = data
                .map(d => {
                    const date = normalizeDateString(d?.date);
                    if (!date) return null;
                    return [
                        date,
                        toNumber(d.open),
                        toNumber(d.high),
                        toNumber(d.low),
                        toNumber(d.close),
                        toNumber(d.volume, 0),
                        toNumber(d.turnover, null),
                        toNumber(d.pctChange, 0),
                        toNumber(d.pe, null),
                        toNumber(d.pb, null)
                    ];
                })
                .filter(Boolean);
            return { format: 'compact_v1', rows };
        }

        function expandStockDataFromCache(payload) {
            if (!payload || typeof payload !== 'object') return payload;
            if (payload.format !== 'compact_v1' || !Array.isArray(payload.rows)) return payload;
            return payload.rows
                .map(r => {
                    if (!Array.isArray(r) || r.length < 5) return null;
                    return {
                        date: normalizeDateString(r[0]),
                        open: toNumber(r[1]),
                        high: toNumber(r[2]),
                        low: toNumber(r[3]),
                        close: toNumber(r[4]),
                        volume: toNumber(r[5], 0),
                        turnover: toNumber(r[6], null),
                        pctChange: toNumber(r[7], 0),
                        pe: r.length > 8 ? toNumber(r[8], null) : null,
                        pb: r.length > 9 ? toNumber(r[9], null) : null
                    };
                })
                .filter(Boolean);
        }

        function trySetCacheWithEviction(existingCache, cacheKeyToKeep) {
            try {
                localStorage.setItem(DATA_CACHE_KEY, JSON.stringify(existingCache));
                return true;
            } catch (e) {
                if (!(e && (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED'))) {
                    throw e;
                }

                const keysByOldest = Object.keys(existingCache)
                    .filter(k => k !== cacheKeyToKeep)
                    .sort((a, b) => {
                        const ta = new Date(existingCache[a]?.meta?.cachedAt || 0).getTime();
                        const tb = new Date(existingCache[b]?.meta?.cachedAt || 0).getTime();
                        return ta - tb;
                    });

                for (const k of keysByOldest) {
                    delete existingCache[k];
                    try {
                        localStorage.setItem(DATA_CACHE_KEY, JSON.stringify(existingCache));
                        return true;
                    } catch (e2) {
                        if (!(e2 && (e2.name === 'QuotaExceededError' || e2.name === 'NS_ERROR_DOM_QUOTA_REACHED'))) {
                            throw e2;
                        }
                    }
                }

                return false;
            }
        }

        // ===================== Ê®°ÊãüÊï∞ÊçÆÁîüÊàê =====================
        function generateMockData(startDate, endDate) {
            const data = [];
            let currentDate = new Date(startDate);
            const end = new Date(endDate);
            
            let basePrice = 10 + Math.random() * 15;
            let trend = 0;
            let volatility = 0.02;
            let basePe = 8 + Math.random() * 25;
            let basePb = 0.8 + Math.random() * 4;
            
            while (currentDate <= end) {
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    if (Math.random() < 0.05) {
                        trend = (Math.random() - 0.5) * 0.015;
                        volatility = 0.015 + Math.random() * 0.025;
                    }
                    
                    const dailyReturn = trend + (Math.random() - 0.5) * volatility;
                    const open = basePrice * (1 + (Math.random() - 0.5) * 0.01);
                    const close = basePrice * (1 + dailyReturn);
                    const high = Math.max(open, close) * (1 + Math.random() * 0.015);
                    const low = Math.min(open, close) * (1 - Math.random() * 0.015);
                    
                    const baseVolume = 50000000 + Math.random() * 80000000;
                    const volumeMultiplier = 1 + Math.abs(dailyReturn) * 20 + (Math.random() - 0.5) * 0.5;
                    const volume = baseVolume * volumeMultiplier;
                    
                    data.push({
                        date: currentDate.toISOString().split('T')[0],
                        open: Math.max(0.01, open),
                        high: Math.max(0.01, high),
                        low: Math.max(0.01, low),
                        close: Math.max(0.01, close),
                        volume: Math.round(volume),
                        turnover: 2 + Math.random() * 6,
                        pctChange: dailyReturn * 100,
                        pe: Math.max(1, basePe * (1 + (Math.random() - 0.5) * 0.08)),
                        pb: Math.max(0.2, basePb * (1 + (Math.random() - 0.5) * 0.08))
                    });
                    
                    basePrice = close;
                    basePe = basePe * (1 + (Math.random() - 0.5) * 0.02);
                    basePb = basePb * (1 + (Math.random() - 0.5) * 0.02);
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // ËÆ°ÁÆóÊäÄÊúØÊåáÊ†á
            return calculateIndicators(data);
        }

        function calculateIndicators(data) {
            const n = data.length;
            
            // MA
            [5, 10, 20, 30, 60].forEach(period => {
                for (let i = period - 1; i < n; i++) {
                    let sum = 0;
                    for (let j = i - period + 1; j <= i; j++) sum += data[j].close;
                    data[i][`ma${period}`] = sum / period;
                }
            });
            
            // Êàê‰∫§ÈáèMA
            [5, 10, 20].forEach(period => {
                for (let i = period - 1; i < n; i++) {
                    let sum = 0;
                    for (let j = i - period + 1; j <= i; j++) sum += data[j].volume;
                    data[i][`volMa${period}`] = sum / period;
                }
            });
            
            // RSI
            for (let i = 14; i < n; i++) {
                let gains = 0, losses = 0;
                for (let j = i - 13; j <= i; j++) {
                    const change = data[j].close - data[j - 1].close;
                    if (change > 0) gains += change;
                    else losses -= change;
                }
                const rs = gains / (losses || 0.0001);
                data[i].rsi = 100 - (100 / (1 + rs));
            }
            
            // MACD
            let ema12 = data[0].close, ema26 = data[0].close;
            for (let i = 0; i < n; i++) {
                ema12 = ema12 * 0.846 + data[i].close * 0.154;
                ema26 = ema26 * 0.926 + data[i].close * 0.074;
                data[i].dif = ema12 - ema26;
            }
            let dea = data[0].dif || 0;
            for (let i = 0; i < n; i++) {
                dea = dea * 0.8 + (data[i].dif || 0) * 0.2;
                data[i].dea = dea;
                data[i].macd = (data[i].dif - dea) * 2;
            }
            
            // Â∏ÉÊûóÂ∏¶
            for (let i = 19; i < n; i++) {
                let sum = 0;
                for (let j = i - 19; j <= i; j++) sum += data[j].close;
                const ma = sum / 20;
                let variance = 0;
                for (let j = i - 19; j <= i; j++) variance += Math.pow(data[j].close - ma, 2);
                const std = Math.sqrt(variance / 20);
                data[i].bollMid = ma;
                data[i].bollUp = ma + 2 * std;
                data[i].bollDown = ma - 2 * std;
            }
            
            // NÊó•ÊúÄÈ´òÊúÄ‰Ωé
            [10, 20].forEach(period => {
                for (let i = period; i < n; i++) {
                    let highest = 0, lowest = Infinity;
                    for (let j = i - period; j < i; j++) {
                        highest = Math.max(highest, data[j].high);
                        lowest = Math.min(lowest, data[j].low);
                    }
                    data[i][`high${period}`] = highest;
                    data[i][`low${period}`] = lowest;
                }
            });
            
            // ATR (Average True Range)
            for (let i = 1; i < n; i++) {
                const tr1 = data[i].high - data[i].low;
                const tr2 = Math.abs(data[i].high - data[i-1].close);
                const tr3 = Math.abs(data[i].low - data[i-1].close);
                data[i].tr = Math.max(tr1, tr2, tr3);
            }
            
            // 14Êó•ATR
            for (let i = 14; i < n; i++) {
                let sum = 0;
                for (let j = i - 13; j <= i; j++) {
                    sum += data[j].tr;
                }
                data[i].atr = sum / 14;
            }
            
            return data;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ===================== ËøêË°åÁ≠ñÁï•ÂØπÊØî =====================
        async function runComparison() {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const loadingProgress = document.getElementById('loadingProgress');
            const loadingStats = document.getElementById('loadingStats');
            
            loading.classList.add('active');
            
            const selectedStrategies = Array.from(document.querySelectorAll('.strategy-card.active'))
                .map(card => card.dataset.strategy);
            
            if (selectedStrategies.length === 0) {
                alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Á≠ñÁï•');
                loading.classList.remove('active');
                return;
            }
            
            const tsCode = document.getElementById('stockCode').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const initCapital = parseFloat(document.getElementById('initCapital').value) * 10000;
            
            const config = {
                ...currentConfig
            };
            
            try {
                // Êú¨Âú∞ËÆ°ÁÆó
                loadingText.textContent = 'Ê≠£Âú®Ëé∑ÂèñÊï∞ÊçÆ...';
                loadingProgress.style.width = '10%';
                
                // Âº∫Âà∂‰ªé LocalStorage ÈáçÊñ∞Âä†ËΩΩÊúÄÊñ∞ÈÖçÁΩÆÔºåÈò≤Ê≠¢ÂÜÖÂ≠òÁä∂ÊÄÅ‰∏ç‰∏ÄËá¥
                if (localStorage.getItem('strategyConfig')) {
                    try {
                        const savedConfig = JSON.parse(localStorage.getItem('strategyConfig'));
                        if (savedConfig.strategySpecificConfig) {
                            strategySpecificConfig = { ...strategySpecificConfig, ...savedConfig.strategySpecificConfig };
                            console.log('‚úÖ [ÂõûÊµãÂâç] Â∑≤Âº∫Âà∂‰ªéÂ≠òÂÇ®ÂêåÊ≠•ÊúÄÊñ∞Á≠ñÁï•ÂèÇÊï∞:', strategySpecificConfig);
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è ÂêåÊ≠•Á≠ñÁï•ÈÖçÁΩÆÂ§±Ë¥•:', e);
                    }
                }

                if (stockData.length === 0) {
                    await fetchStockData();
                }
                
                if (stockData.length === 0) {
                    throw new Error('Êó†Ê≥ïËé∑ÂèñÊï∞ÊçÆ');
                }
                
                strategyResults = {};
                let firstStrategyError = null;
                
                for (let i = 0; i < selectedStrategies.length; i++) {
                    const strategy = selectedStrategies[i];
                    loadingText.textContent = `Ê≠£Âú®ÂõûÊµã: ${STRATEGIES[strategy]?.name || strategy}...`;
                    loadingProgress.style.width = `${10 + (i + 1) / selectedStrategies.length * 80}%`;
                    loadingStats.textContent = `Á≠ñÁï• ${i + 1} / ${selectedStrategies.length}`;
                    
                    await sleep(100);
                    
                    try {
                        // ‰∏∫ÊØè‰∏™Á≠ñÁï•ÊûÑÂª∫Áã¨Á´ãÁöÑÈÖçÁΩÆÔºà‰∏é runOptimization ‰øùÊåÅ‰∏ÄËá¥Ôºâ
                        // Âº∫Âà∂ÈáçÊñ∞‰ªéÂÖ®Â±ÄÂØπË±°Ëé∑ÂèñÊúÄÊñ∞ÈÖçÁΩÆÔºåÈò≤Ê≠¢Èó≠ÂåÖÁºìÂ≠òÊóßÂÄº
                        const currentSpecificConfig = strategySpecificConfig[strategy] || {};
                        console.log(`üîç [${strategy}] ÂÆûÊó∂Ëé∑ÂèñÁöÑÁâπÂÆöÈÖçÁΩÆ:`, JSON.stringify(currentSpecificConfig));

                        const strategyConfig = {
                            ...currentConfig,
                            ...currentSpecificConfig
                        };
                        
                        console.log(`üîÑ ÂºÄÂßãÊâßË°åÁ≠ñÁï•: ${strategy}`);
                        console.log(`üìä ËÇ°Á•®Êï∞ÊçÆÈáè: ${stockData.length}`);
                        console.log(`‚öôÔ∏è ‰º†ÂÖ•ÈÖçÁΩÆÂèÇÊï∞:`, strategyConfig);
                        console.log(`üéØ Á≠ñÁï• ${strategy} ÁöÑÂèÇÊï∞:`, strategySpecificConfig[strategy]);
                        
                        const signals = executeStrategy(stockData, strategy, strategyConfig);
                        console.log(`üìà ÁîüÊàê‰ø°Âè∑Êï∞Èáè: ${signals.length}`);
                        
                        const result = calculateBacktest(stockData, signals, initCapital);
                        console.log(`üí∞ ÂõûÊµãÁªìÊûú:`, result);
                        
                        strategyResults[strategy] = {
                            ...result,
                            signals,
                            name: STRATEGIES[strategy]?.name || strategy,
                            icon: STRATEGIES[strategy]?.icon || 'üìä'
                        };
                        
                        console.log(`‚úÖ Á≠ñÁï• ${strategy} ÂõûÊµãÊàêÂäü`);
                    } catch (strategyError) {
                        console.error(`‚ùå Á≠ñÁï• ${strategy} ÂõûÊµãÂ§±Ë¥•:`, strategyError);
                        console.error(`üîç ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ:`, strategyError.stack);
                        if (!firstStrategyError) firstStrategyError = strategyError;
                        // ÁªßÁª≠ÊâßË°åÂÖ∂‰ªñÁ≠ñÁï•
                    }
                }
                
                loadingText.textContent = 'Ê≠£Âú®ÁîüÊàêÂàÜÊûêÊä•Âëä...';
                loadingProgress.style.width = '95%';
                await sleep(200);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊàêÂäüÁöÑÁ≠ñÁï•ÁªìÊûú
                if (Object.keys(strategyResults).length === 0) {
                    const msg = firstStrategyError?.message ? `ÊâÄÊúâÁ≠ñÁï•ÂõûÊµãÈÉΩÂ§±Ë¥•Ôºö${firstStrategyError.message}` : 'ÊâÄÊúâÁ≠ñÁï•ÂõûÊµãÈÉΩÂ§±Ë¥•‰∫ÜÔºåËØ∑Ê£ÄÊü•Á≠ñÁï•ÈÖçÁΩÆ';
                    throw new Error(msg);
                }
                
                // Êõ¥Êñ∞ÁïåÈù¢
                updateComparisonTable();
                updateCharts();
                updateBestResult();
                updateStrategyDropdowns();
                updateDataInfo();
                
                loadingProgress.style.width = '100%';
                await sleep(200);
                
            } catch (error) {
                console.error('ÂõûÊµãÂ§±Ë¥•:', error);
                alert('ÂõûÊµãÂ§±Ë¥•: ' + error.message);
            }
            
            loading.classList.remove('active');
        }

        // ===================== Á≠ñÁï•ÊâßË°å =====================
        function executeStrategy(data, strategyName, config) {
            // Ê£ÄÊü•Êï∞ÊçÆÊúâÊïàÊÄß
            if (!data || data.length === 0) {
                throw new Error('ËÇ°Á•®Êï∞ÊçÆ‰∏∫Á©∫');
            }
            
            const signals = [];
            let position = 0;
            let entryPrice = 0;
            let entryIndex = 0;
            let highestSinceEntry = 0;
            let lastSellIndex = -999; // ËÆ∞ÂΩï‰∏ä‰∏ÄÊ¨°ÂçñÂá∫ÁöÑÁ¥¢Âºï
            
            // Á°Æ‰øùÈÖçÁΩÆÂØπË±°Â≠òÂú®
            if (!config) {
                config = {};
            }
            
            // Áõ¥Êé•‰ΩøÁî®‰º†ÂÖ•ÁöÑÈÖçÁΩÆÔºàrunComparison Âíå runOptimization Â∑≤ÁªèÂêàÂπ∂‰∫ÜÊâÄÊúâÈÖçÁΩÆÔºâ
            const fullConfig = config;

            if (typeof fullConfig.takeProfit === 'number' && fullConfig.takeProfit > 1) fullConfig.takeProfit = fullConfig.takeProfit / 100;
            if (typeof fullConfig.stopLoss === 'number' && fullConfig.stopLoss > 1) fullConfig.stopLoss = fullConfig.stopLoss / 100;

            console.log(`üîß [${strategyName}] ÊâßË°åÈÖçÁΩÆ:`, JSON.stringify(fullConfig));
            // console.log(`üîß Á≠ñÁï•ÁâπÂÆöÈÖçÁΩÆÂØπË±°:`, strategySpecificConfig);
            
            if (data.length < 2) {
                throw new Error('Êï∞ÊçÆÈáè‰∏çË∂≥');
            }

            const warmup = Math.min(60, data.length - 1);

            for (let i = warmup; i < data.length; i++) {
                // ‰ΩøÁî®ÊµÖÊã∑Ë¥ùÈÅøÂÖç‰øÆÊîπÂéüÂßãÊï∞ÊçÆ (stockData)ÔºåÁ°Æ‰øùÂ§öÊ¨°ÂõûÊµãÁªìÊûú‰∏ÄËá¥
                const d = { ...data[i] };
                const prev = { ...data[i - 1] };
                
                // Ê£ÄÊü•Êï∞ÊçÆÂÆåÊï¥ÊÄß
                if (!d || !prev || !d.close || !d.high || !d.low || !d.volume) {
                    continue;
                }
                
                // Â¶ÇÊûúÁº∫Â∞ëÊäÄÊúØÊåáÊ†áÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº (‰øÆÊîπÂâØÊú¨ËÄåÈùûÂéüÊï∞ÊçÆ)
                if (!d.ma20) d.ma20 = d.close;
                if (!d.rsi) d.rsi = 50;
                if (!d.macd) d.macd = 0;
                if (!d.boll_upper) d.boll_upper = d.close;
                if (!d.boll_lower) d.boll_lower = d.close;
                
                let buySignal = false;
                let sellSignal = false;
                let signalStrength = 50;
                let sellReason = '';
                
                // Á≠ñÁï•ÈÄªËæë
                const buyCooldown = fullConfig.buyCooldown !== undefined ? fullConfig.buyCooldown : 1;
                const inCooldown = (i - lastSellIndex) <= buyCooldown;
                
                if (!inCooldown) switch(strategyName) {
                    case 'deep_fusion':
                        let mlScore = 0;
                        const maWeight = fullConfig.maWeight || 20;
                        const priceWeight = fullConfig.priceWeight || 15;
                        const macdWeight = fullConfig.macdWeight || 20;
                        const rsi35Weight = fullConfig.rsi35Weight || 15;
                        const rsi25Weight = fullConfig.rsi25Weight || 10;
                        const volumeWeight = fullConfig.volumeWeight || 15;
                        const bollWeight = fullConfig.bollWeight || 15;
                        const mlScoreThreshold = fullConfig.mlScoreThreshold || 60;
                        
                        if (fullConfig.useMa5AboveMa20 !== false && d.ma5 && d.ma5 > d.ma20) mlScore += maWeight;
                        if (fullConfig.usePriceAboveMa5 !== false && d.ma5 && d.close > d.ma5) mlScore += priceWeight;
                        if (fullConfig.useMacdRising !== false && d.macd && prev.macd && d.macd > 0 && d.macd > prev.macd) mlScore += macdWeight;
                        if (fullConfig.useRsiBelow35 !== false && d.rsi && d.rsi < 35) mlScore += rsi35Weight;
                        if (fullConfig.useRsiBelow25 !== false && d.rsi && d.rsi < 25) mlScore += rsi25Weight;
                        if (fullConfig.useVolumeAboveMa !== false && d.volume && d.volMa5 && d.volume > d.volMa5 * (fullConfig.volumeMulti || 1.5)) mlScore += volumeWeight;
                        if (fullConfig.usePriceBelowBoll !== false && d.bollDown && d.close < d.bollDown) mlScore += bollWeight;
                        
                        signalStrength = mlScore;
                        if (position === 0 && mlScore >= mlScoreThreshold) buySignal = true;
                        break;
                        
                    case 'volume_breakout':
                        if (position === 0) {
                            const nearLowRatio = fullConfig.nearLowRatio || 1.02;
                            const rsiThreshold = fullConfig.rsiThreshold || 30;
                            const volumeMulti = fullConfig.volumeMulti || 1.5;
                            
                            let conditionCount = 0;
                            let satisfiedCount = 0;
                            
                            if (fullConfig.useNearLow !== false) {
                                conditionCount++;
                                if (d.low10 && d.low <= d.low10 * nearLowRatio) satisfiedCount++;
                            }
                            
                            if (fullConfig.useVolumeUp !== false) {
                                conditionCount++;
                                if (d.volMa5 && d.volume > d.volMa5 * volumeMulti) satisfiedCount++;
                            }
                            
                            if (fullConfig.useRsiOversold !== false) {
                                conditionCount++;
                                if (d.rsi < rsiThreshold) satisfiedCount++;
                            }
                            
                            const bonusPoints = (fullConfig.useBullishCandle !== false && d.close > d.open) ? 10 : 0;
                            
                            if (conditionCount > 0 && satisfiedCount >= conditionCount - (bonusPoints > 0 ? 1 : 0)) {
                                buySignal = true;
                                signalStrength = 70 + bonusPoints;
                            }
                        }
                        break;
                        
                    case 'trend_enhanced':
                        if (position === 0) {
                            const trendPeriod = fullConfig.trendPeriod || 20;
                            const macdThreshold = fullConfig.macdThreshold || 0;
                            const goldenCrossBonus = fullConfig.goldenCrossBonus || 10;
                            
                            let conditionCount = 0;
                            let satisfiedCount = 0;
                            
                            if (fullConfig.useMa5AboveMa20 !== false) {
                                conditionCount++;
                                if (d.ma5 && d.ma20 && d.ma5 > d.ma20) satisfiedCount++;
                            }
                            
                            if (fullConfig.usePriceAboveMa5 !== false) {
                                conditionCount++;
                                if (d.ma5 && d.close > d.ma5) satisfiedCount++;
                            }
                            
                            if (fullConfig.useMacdPositive !== false) {
                                conditionCount++;
                                if (d.macd && d.macd > macdThreshold) satisfiedCount++;
                            }
                            
                            const goldenCross = fullConfig.useGoldenCross !== false && 
                                               prev.ma5 && prev.ma20 && d.ma5 && d.ma20 &&
                                               prev.ma5 <= prev.ma20 && d.ma5 > d.ma20;
                            
                            if (conditionCount > 0 && satisfiedCount >= conditionCount && (conditionCount === satisfiedCount || goldenCross)) {
                                buySignal = true;
                                signalStrength = 75 + (goldenCross ? goldenCrossBonus : 0);
                            }
                        }
                        break;
                        
                    case 'bollinger_extreme':
                        if (position === 0) {
                            const breakoutPeriod = fullConfig.breakoutPeriod || 20;
                            const volumeMulti = fullConfig.volumeMulti || 2;
                            const defaultStrength = fullConfig.signalStrength || 80;
                            
                            let conditionCount = 0;
                            let satisfiedCount = 0;
                            
                            if (fullConfig.useBreakHigh !== false) {
                                conditionCount++;
                                if (d.high20 && d.close > d.high20) satisfiedCount++;
                            }
                            
                            if (fullConfig.useVolumeConfirm !== false) {
                                conditionCount++;
                                if (d.volMa5 && d.volume > d.volMa5 * volumeMulti) satisfiedCount++;
                            }
                            
                            if (conditionCount > 0 && satisfiedCount >= conditionCount) {
                                buySignal = true;
                                signalStrength = defaultStrength;
                            }
                        }
                        break;
                        
                    case 'oversold_rebound':
                        if (position === 0) {
                            const rsiThreshold = fullConfig.rsiThreshold || 25;
                            const bollingerOffset = fullConfig.bollingerOffset || 0;
                            signalStrength = fullConfig.signalStrength || 70;
                            
                            let conditionCount = 0;
                            let satisfiedCount = 0;
                            
                            if (fullConfig.useTouchLowerBoll !== false) {
                                conditionCount++;
                                if (d.bollDown && d.close < (d.bollDown * (1 + bollingerOffset))) satisfiedCount++;
                            }
                            
                            if (fullConfig.useRsiOversold !== false) {
                                conditionCount++;
                                if (d.rsi < rsiThreshold) satisfiedCount++;
                            }
                            
                            if (conditionCount > 0 && satisfiedCount >= conditionCount) {
                                buySignal = true;
                                signalStrength = signalStrength;
                            }
                        }
                        break;
                        
                    case 'macd_divergence':
                        if (position === 0 && i >= 80) {
                            const dataPeriod = fullConfig.dataPeriod || 80;
                            const momentumWeight = fullConfig.momentumWeight || 0.3;
                            const valueWeight = fullConfig.valueWeight || 0.3;
                            const qualityWeight = fullConfig.qualityWeight || 0.4;
                            const buyThreshold = fullConfig.buyThreshold || 65;
                            
                            if (i >= dataPeriod) {
                                let totalScore = 0;
                                let totalWeight = 0;
                                
                                if (fullConfig.useMomentumFactor !== false) {
                                    const momentum = (d.close - data[i - 20].close) / data[i - 20].close;
                                    const momentumScore = Math.min(100, Math.max(0, (momentum + 0.1) * 500));
                                    totalScore += momentumScore * momentumWeight;
                                    totalWeight += momentumWeight;
                                }
                                
                                if (fullConfig.useValueFactor !== false) {
                                    const valueRatio = d.ma60 ? d.close / d.ma60 : 1;
                                    const valueScore = valueRatio < 0.95 ? 80 : valueRatio < 1 ? 60 : 40;
                                    totalScore += valueScore * valueWeight;
                                    totalWeight += valueWeight;
                                }
                                
                                if (fullConfig.useQualityFactor !== false) {
                                    const qualityScore = d.atr ? Math.min(100, 100 - (d.atr / d.close) * 1000) : 50;
                                    totalScore += qualityScore * qualityWeight;
                                    totalWeight += qualityWeight;
                                }
                                
                                if (totalWeight > 0) {
                                    signalStrength = totalScore / totalWeight;
                                    if (signalStrength >= buyThreshold) buySignal = true;
                                }
                            }
                        }
                        break;
                        
                    case 'momentum_rotation':
                        if (position === 0) {
                            const momentumPeriod = fullConfig.momentumPeriod || 20;
                            const momentumThreshold = fullConfig.momentumThreshold || 0.02;
                            const volumeMulti = fullConfig.volumeMulti || 1.5;
                            
                            if (i >= momentumPeriod) {
                                const momentum = (d.close - data[i - momentumPeriod].close) / data[i - momentumPeriod].close;
                                const volumeCondition = d.volume > d.volMa5 * volumeMulti;
                                
                                if (momentum > momentumThreshold && volumeCondition) {
                                    signalStrength = Math.min(100, momentum * 100 + 50);
                                    buySignal = true;
                                }
                            }
                        }
                        break;
                        
                    case 'turtle_enhanced':
                        if (position === 0) {
                            const entryPeriod = fullConfig.entryPeriod || 20;
                            const exitPeriod = fullConfig.exitPeriod || 10;
                            const atrMultiplier = fullConfig.atrMultiplier || 2.0;
                            
                            if (i >= entryPeriod && d.high20) {
                                const atr = d.atr || Math.abs(d.high - d.low) * 0.5;
                                const entryPrice = d.high20;
                                const stopPrice = d.close - atr * atrMultiplier;
                                
                                if (d.close >= entryPrice) {
                                    signalStrength = 70;
                                    buySignal = true;
                                }
                            }
                        }
                        break;
                }
                
                // ÂçñÂá∫ÈÄªËæë
                if (position > 0) {
                    highestSinceEntry = Math.max(highestSinceEntry, d.high);
                    const holdDays = i - entryIndex;
                    const profit = (d.close - entryPrice) / entryPrice;
                    
                    if (fullConfig.useStopLoss !== false && profit <= -fullConfig.stopLoss) {
                        sellSignal = true;
                        sellReason = 'Ê≠¢Êçü';
                    } else if (fullConfig.useTakeProfit !== false && profit >= fullConfig.takeProfit) {
                        sellSignal = true;
                        sellReason = 'Ê≠¢Áõà';
                    } else if (fullConfig.useMa5Sell !== false && d.ma5 && d.close < d.ma5 && profit > 0.02) {
                        sellSignal = true;
                        sellReason = 'Ë∑åÁ†¥MA5';
                    } else if (fullConfig.useDynamicTP !== false) {
                        // Âä®ÊÄÅÊ≠¢ÁõàÂèÇÊï∞
                        const dtpThreshold = fullConfig.dynamicTpThreshold !== undefined ? fullConfig.dynamicTpThreshold : 0.08;
                        const dtpCallback = fullConfig.dynamicTpCallback !== undefined ? fullConfig.dynamicTpCallback : 0.03;
                        const dtpVariation = fullConfig.dynamicTpVariation !== undefined ? fullConfig.dynamicTpVariation : 0.15;
                        
                        if (profit > dtpThreshold) {
                            const trail = highestSinceEntry * (1 - dtpCallback - profit * dtpVariation);
                            if (d.close < trail) {
                                sellSignal = true;
                                sellReason = 'ÁßªÂä®Ê≠¢Áõà';
                            }
                        }
                    } else if (fullConfig.useMacdDeathCross !== false && d.macd && prev.macd && d.macd < 0 && prev.macd > 0 && profit > 0) {
                        sellSignal = true;
                        sellReason = 'MACDÊ≠ªÂèâ';
                    } else if (fullConfig.useRsiOverbought !== false && d.rsi && d.rsi > 80 && profit > 0.05) {
                        sellSignal = true;
                        sellReason = 'RSIË∂Ö‰π∞';
                    } else if (fullConfig.useHoldTimeout !== false && holdDays > 30 && profit < 0.05) {
                        sellSignal = true;
                        sellReason = 'ÊåÅ‰ªìË∂ÖÊó∂';
                    }
                }
                
                // ËÆ∞ÂΩï‰ø°Âè∑
                if (buySignal && position === 0) {
                    position = fullConfig.useAdaptPosition ? 0.3 + (signalStrength / 100) * 0.7 : 1;
                    entryPrice = d.close;
                    entryIndex = i;
                    highestSinceEntry = d.high;
                    
                    signals.push({
                        index: i,
                        date: d.date,
                        type: 'buy',
                        price: d.close,
                        position: position,
                        strength: signalStrength
                    });
                }
                
                if (sellSignal && position > 0) {
                    signals.push({
                        index: i,
                        date: d.date,
                        type: 'sell',
                        price: d.close,
                        position: position,
                        profit: ((d.close - entryPrice) / entryPrice) * 100,
                        holdDays: i - entryIndex,
                        reason: sellReason,
                        strength: signalStrength
                    });
                    position = 0;
                    lastSellIndex = i; // Êõ¥Êñ∞ÂçñÂá∫Á¥¢Âºï
                }
            }
            
            return signals;
        }

        // ===================== ÂõûÊµãËÆ°ÁÆó =====================
        function calculateBacktest(data, signals, initCapital) {
            if (!data || data.length === 0) {
                return {
                    initCapital,
                    finalCapital: initCapital,
                    totalReturn: 0,
                    annualReturn: 0,
                    maxDrawdown: 0,
                    sharpe: 0,
                    calmar: 0,
                    winRate: 0,
                    profitRatio: 0,
                    avgHoldDays: 0,
                    wins: 0,
                    losses: 0,
                    trades: [],
                    equity: [initCapital],
                    score: 0,
                    tradeCount: 0
                };
            }
            
            let capital = initCapital;
            let shares = 0;
            let position = 0;
            const equity = [initCapital];
            
            let wins = 0, losses = 0;
            let totalProfit = 0, totalLoss = 0;
            let holdDaysSum = 0;
            const trades = [];
            
            const signalMap = {};
            signals.forEach(s => {
                if (s.index >= 0 && s.index < data.length) {
                    signalMap[s.index] = s;
                }
            });
            
            for (let i = 0; i < data.length; i++) {
                const signal = signalMap[i];
                
                if (signal) {
                    if (signal.type === 'buy') {
                        const amount = capital * signal.position * 0.998;
                        shares = Math.floor(amount / signal.price / 100) * 100;
                        capital -= shares * signal.price * 1.001;
                        position = signal.position;
                        trades.push({ ...signal, shares, amount: shares * signal.price });
                    } else {
                        const sellAmount = shares * signal.price * 0.998;
                        capital += sellAmount;
                        
                        if (signal.profit > 0) {
                            wins++;
                            totalProfit += signal.profit;
                        } else {
                            losses++;
                            totalLoss += Math.abs(signal.profit);
                        }
                        holdDaysSum += signal.holdDays || 0;
                        trades.push({ ...signal, shares, amount: sellAmount });
                        shares = 0;
                        position = 0;
                    }
                }
                
                const currentValue = capital + shares * data[i].close;
                equity.push(currentValue);
            }
            
            const finalEquity = capital + shares * data[data.length - 1].close;
            const totalReturn = ((finalEquity - initCapital) / initCapital) * 100;
            const days = data.length;
            const annualReturn = days > 0 ? (Math.pow(1 + totalReturn / 100, 252 / days) - 1) * 100 : 0;
            
            // ÊúÄÂ§ßÂõûÊí§
            let maxDrawdown = 0, peak = equity[0];
            for (let e of equity) {
                peak = Math.max(peak, e);
                const drawdown = peak > 0 ? (peak - e) / peak * 100 : 0;
                maxDrawdown = Math.max(maxDrawdown, drawdown);
            }
            
            // Â§èÊôÆÊØîÁéá
            const returns = [];
            for (let i = 1; i < equity.length; i++) {
                if (equity[i-1] > 0) {
                    returns.push((equity[i] - equity[i-1]) / equity[i-1]);
                }
            }
            const avgReturn = returns.length > 0 ? returns.reduce((a, b) => a + b, 0) / returns.length : 0;
            const stdReturn = returns.length > 0 ? 
                Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / returns.length) : 0;
            const sharpe = stdReturn > 0 ? (avgReturn * 252 - 0.03) / (stdReturn * Math.sqrt(252)) : 0;
            
            const winRate = (wins + losses) > 0 ? (wins / (wins + losses)) * 100 : 0;
            const profitRatio = totalLoss > 0 ? totalProfit / totalLoss : (totalProfit > 0 ? 10 : 0);
            const calmar = maxDrawdown > 0 ? annualReturn / maxDrawdown : 0;
            const avgHoldDays = holdDaysSum / (wins + losses) > 0 ? holdDaysSum / (wins + losses) : 0;
            
            // ÁªºÂêàËØÑÂàÜ
            const score = (
                Math.min(totalReturn / 2, 30) +
                Math.min(sharpe * 10, 25) +
                Math.max(0, 25 - maxDrawdown) +
                Math.min(winRate / 4, 20)
            );
            
            return {
                initCapital,
                finalCapital: finalEquity,
                totalReturn,
                annualReturn,
                maxDrawdown,
                sharpe,
                calmar,
                winRate,
                profitRatio,
                avgHoldDays,
                wins,
                losses,
                trades,
                equity,
                score,
                tradeCount: wins + losses
            };
        }

        // ===================== Êõ¥Êñ∞ÁïåÈù¢ =====================
        function updateComparisonTable() {
            const tbody = document.getElementById('comparisonBody');
            const sorted = Object.entries(strategyResults).sort((a, b) => b[1].score - a[1].score);
            
            tbody.innerHTML = sorted.map(([key, r], idx) => {
                const rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : 'rank-other';
                const rowClass = idx === 0 ? 'best-row' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td><span class="rank-badge ${rankClass}">${idx + 1}</span></td>
                        <td style="text-align:left">${r.icon} ${r.name}</td>
                        <td class="${r.totalReturn >= 0 ? 'positive' : 'negative'}">${r.totalReturn >= 0 ? '+' : ''}${r.totalReturn.toFixed(2)}%</td>
                        <td class="${r.annualReturn >= 0 ? 'positive' : 'negative'}">${r.annualReturn >= 0 ? '+' : ''}${r.annualReturn.toFixed(2)}%</td>
                        <td class="negative">-${r.maxDrawdown.toFixed(2)}%</td>
                        <td class="neutral">${r.sharpe.toFixed(2)}</td>
                        <td class="neutral">${r.calmar.toFixed(2)}</td>
                        <td>${r.winRate.toFixed(1)}%</td>
                        <td>${r.profitRatio.toFixed(2)}</td>
                        <td>${r.tradeCount}</td>
                        <td class="positive" style="font-weight:bold">${r.score.toFixed(1)}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateBestResult() {
            const sorted = Object.entries(strategyResults).sort((a, b) => b[1].score - a[1].score);
            if (sorted.length === 0) return;
            
            const [key, best] = sorted[0];
            
            document.getElementById('bestStrategy').textContent = best.name;
            document.getElementById('bestReturn').textContent = (best.totalReturn >= 0 ? '+' : '') + best.totalReturn.toFixed(2) + '%';
            document.getElementById('bestAnnual').textContent = (best.annualReturn >= 0 ? '+' : '') + best.annualReturn.toFixed(2) + '%';
            document.getElementById('bestDrawdown').textContent = '-' + best.maxDrawdown.toFixed(2) + '%';
            document.getElementById('bestSharpe').textContent = best.sharpe.toFixed(2);
            document.getElementById('bestWinRate').textContent = best.winRate.toFixed(1) + '%';
        }

        function updateStrategyDropdowns() {
            const strategies = Object.keys(strategyResults);
            const options = strategies.map(s => 
                `<option value="${s}">${STRATEGIES[s]?.name || s}</option>`
            ).join('');
            
            const paramStrategy = document.getElementById('paramStrategy');
            const detailStrategy = document.getElementById('detailStrategy');
            const prevParam = paramStrategy ? paramStrategy.value : '';
            const prevDetail = detailStrategy ? detailStrategy.value : '';
            
            if (paramStrategy) {
                paramStrategy.innerHTML = options;
                if (prevParam && strategies.includes(prevParam)) {
                    paramStrategy.value = prevParam;
                }
            }
            if (detailStrategy) {
                detailStrategy.innerHTML = options;
                if (prevDetail && strategies.includes(prevDetail)) {
                    detailStrategy.value = prevDetail;
                }
            }
            
            updateStrategyConfig();
            if (typeof scheduleSaveUiState === 'function') scheduleSaveUiState();
        }

        function updateStrategyConfig() {
            updateStrategyParams();
        }

        function updateStrategyParams() {
            const key = document.getElementById('paramStrategy').value;
            if (!key) {
                document.getElementById('strategyParams').innerHTML = '<div class="no-params">ËØ∑ÂÖàÈÄâÊã©Á≠ñÁï•Êü•ÁúãÂèÇÊï∞</div>';
                return;
            }
            updateStrategyParamsWithKey(key);
        }

        function updateStrategyParamsWithKey(key) {
            console.log(`üöÄ Ê∏≤ÊüìÁ≠ñÁï• [${key}] ÂèÇÊï∞Èù¢Êùø, ÈÖçÁΩÆÊ∫ê:`, strategySpecificConfig[key]);
            const strategyInfo = STRATEGIES[key] || {};
            
            // Ëé∑ÂèñÂΩìÂâçÁ≠ñÁï•ÁöÑÁâπÂÆöÂèÇÊï∞
            // Á°Æ‰øùËøôÊòØ‰∏Ä‰∏™Êñ∞ÂØπË±°ÔºåÈÅøÂÖçÂºïÁî®ÈóÆÈ¢ò
            const currentStrategyParams = JSON.parse(JSON.stringify(strategySpecificConfig[key] || {}));
            
            // ÂêàÂπ∂ÈÄöÁî®ÈÖçÁΩÆÂíåÁ≠ñÁï•ÁâπÂÆöÂèÇÊï∞ÔºåÁî®‰∫éÊòæÁ§∫
            // Á≠ñÁï•ÁâπÂÆöÂèÇÊï∞‰ºòÂÖàÁ∫ßÈ´ò‰∫éÈÄöÁî®ÈÖçÁΩÆ
            const displayConfig = {
                ...currentConfig,
                ...currentStrategyParams
            };
            
            let html = '';
            
            // Á≠ñÁï•ËØ¥Êòé
            html += `<div class="strategy-description">
                <strong>Á≠ñÁï•ËØ¥ÊòéÔºö</strong>${getStrategyDescription(key)}
            </div>`;
            
            // Á≠ñÁï•ÂèÇÊï∞ÁªÑ - ÂåÖÂê´‰π∞ÂÖ•Êù°‰ª∂ÂíåÂèÇÊï∞
            const specificParams = getStrategySpecificParams(key);
            const buyConditions = getStrategyBuyConditions(key);
            
            if ((specificParams && Object.keys(specificParams).length > 0) || (buyConditions && buyConditions.length > 0)) {
                html += `<div class="param-group">
                    <div class="param-title">
                        <span>üéØ Á≠ñÁï•ÂèÇÊï∞ÈÖçÁΩÆ</span>
                    </div>`;
                
                // 1. ÊòæÁ§∫‰π∞ÂÖ•Êù°‰ª∂ÂºÄÂÖ≥ÔºàÂ∏¶ÂèÇÊï∞Ôºâ
                if (buyConditions && buyConditions.length > 0) {
                    html += `<div class="condition-group">
                        <div class="condition-title">üìà ‰π∞ÂÖ•Êù°‰ª∂</div>`;
                    
                    buyConditions.forEach(condition => {
                        const isChecked = displayConfig[condition.key] !== undefined ? displayConfig[condition.key] : condition.default;
                        html += `<div class="condition-item">
                            <div class="condition-switch">
                                <input type="checkbox" 
                                       id="${condition.key}" 
                                       ${isChecked ? 'checked' : ''}
                                       onchange="updateParam('${condition.key}', this.checked)">
                                <div class="condition-label">
                                    <span class="condition-name">${condition.label}</span>
                                    <span class="condition-desc">${condition.desc}</span>
                                </div>
                            </div>`;
                        
                        // Â¶ÇÊûúËØ•Êù°‰ª∂ÊúâÂØπÂ∫îÁöÑÂèÇÊï∞ÔºåÊòæÁ§∫Âú®ÂºÄÂÖ≥‰∏ãÊñπ
                        const relatedParams = getRelatedParams(key, condition.key);
                        if (relatedParams.length > 0) {
                            html += `<div class="condition-params">`;
                            relatedParams.forEach(paramConfig => {
                                const paramName = paramConfig.name;
                                const paramKey = paramConfig.key;
                                html += `<div class="condition-param-row">
                                    <span class="condition-param-label">${paramName}</span>
                                    <input type="${paramConfig.type || 'number'}" 
                                           class="condition-param-input"
                                           id="param_${paramKey}" 
                                           value="${displayConfig[paramKey] || paramConfig.default}" 
                                           min="${paramConfig.min || 0}"
                                           max="${paramConfig.max || 100}"
                                           step="${paramConfig.step || 1}"
                                           oninput="updateParam('${paramKey}', parseFloat(this.value)); document.getElementById('${paramKey}_val_suffix').textContent = this.value + '${paramConfig.suffix || ''}'">
                                    <span class="condition-param-suffix" id="${paramKey}_val_suffix">${displayConfig[paramKey] || paramConfig.default}${paramConfig.suffix || ''}</span>
                                </div>`;
                            });
                            html += `</div>`;
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                }
                
                // 2. ÊòæÁ§∫ÂçñÂá∫Êù°‰ª∂ÔºàÈÄöÁî® + ÂèØÈÄâÔºâ- ÁßªÂä®Âà∞ËøôÈáåÔºå‰Ωú‰∏∫Á≠ñÁï•ÈÖçÁΩÆÁöÑ‰∏ÄÈÉ®ÂàÜ
                const sellConditions = getStrategySellConditions();
                if (sellConditions && sellConditions.length > 0) {
                    html += `<div class="condition-group" style="background: rgba(220,38,38,0.05); border: 1px solid rgba(220,38,38,0.1);">
                        <div class="condition-title" style="color: #ef4444;">üìâ ÂçñÂá∫Êù°‰ª∂</div>`;
                    
                    sellConditions.forEach(condition => {
                        const isChecked = displayConfig[condition.key] !== undefined ? displayConfig[condition.key] : condition.default;
                        html += `<div class="condition-item">
                            <div class="condition-switch">
                                <input type="checkbox" 
                                       id="${condition.key}" 
                                       ${isChecked ? 'checked' : ''}
                                       onchange="updateParam('${condition.key}', this.checked)">
                                <div class="condition-label">
                                    <span class="condition-name">${condition.label}</span>
                                    <span class="condition-desc">${condition.desc}</span>
                                </div>
                            </div>`;
                        
                        // Â¶ÇÊûúËØ•ÂçñÂá∫Êù°‰ª∂ÊúâÂØπÂ∫îÁöÑÂèÇÊï∞ÔºåÊòæÁ§∫Âú®ÂºÄÂÖ≥‰∏ãÊñπ
                        const relatedSellParams = getRelatedSellParams(condition.key);
                        if (relatedSellParams.length > 0) {
                            html += `<div class="condition-params">`;
                            relatedSellParams.forEach(paramConfig => {
                                const paramName = paramConfig.name;
                                const paramKey = paramConfig.key;
                                
                                if (paramConfig.slider) {
                                    // ÊªëÂùóÊ†∑Âºè
                                    const rawValue = displayConfig[paramKey] !== undefined ? displayConfig[paramKey] : undefined;
                                    const currentValue = rawValue !== undefined ? (rawValue > 1 ? rawValue : rawValue * 100) : paramConfig.default;
                                    const stepValue = paramConfig.step !== undefined ? paramConfig.step : 1;
                                    html += `<div class="condition-param-row">
                                        <span class="condition-param-label">${paramName}</span>
                                        <input type="range" 
                                               class="condition-param-slider"
                                               min="${paramConfig.min}" 
                                               max="${paramConfig.max}" 
                                               step="${stepValue}"
                                               value="${currentValue}"
                                               oninput="updateParam('${paramKey}', parseFloat(this.value) / 100); document.getElementById('${paramKey}_val').textContent = parseFloat(this.value).toFixed(1) + '${paramConfig.suffix}'">
                                        <span class="condition-param-value" id="${paramKey}_val">${parseFloat(currentValue).toFixed(1)}${paramConfig.suffix}</span>
                                    </div>`;
                                } else {
                                    // ËæìÂÖ•Ê°ÜÊ†∑Âºè
                                    const currentValue = displayConfig[paramKey] !== undefined ? displayConfig[paramKey] : paramConfig.default;
                                    html += `<div class="condition-param-row">
                                        <span class="condition-param-label">${paramName}</span>
                                        <input type="${paramConfig.type || 'number'}" 
                                               class="condition-param-input"
                                               id="param_${paramKey}" 
                                               value="${currentValue}" 
                                               min="${paramConfig.min || 0}"
                                               max="${paramConfig.max || 100}"
                                               step="${paramConfig.step || 1}"
                                               oninput="updateParam('${paramKey}', parseFloat(this.value)); document.getElementById('${paramKey}_val').textContent = parseFloat(this.value).toFixed(1) + '${paramConfig.suffix}'">
                                        <span class="condition-param-suffix" id="${paramKey}_val">${parseFloat(currentValue).toFixed(1)}${paramConfig.suffix}</span>
                                    </div>`;
                                }
                            });
                            html += `</div>`;
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                }

                // Êñ∞Â¢ûÔºö‰∫§ÊòìÈôêÂà∂ÂèÇÊï∞ (‰π∞ÂÖ•ÂÜ∑Âç¥)
                html += `<div class="condition-group" style="background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.1);">
                    <div class="condition-title" style="color: #f59e0b;">üõ°Ô∏è ‰∫§ÊòìÈôêÂà∂</div>
                    <div class="param-row" style="padding: 5px 0;">
                        <span class="param-label" style="flex:1">‰π∞ÂÖ•ÂÜ∑Âç¥Êúü</span>
                        <input type="range" 
                               min="0" 
                               max="10" 
                               step="1"
                               value="${displayConfig.buyCooldown !== undefined ? displayConfig.buyCooldown : 1}"
                               oninput="updateParam('buyCooldown', parseInt(this.value)); document.getElementById('buyCooldown_display').textContent = this.value + 'Â§©'">
                        <span id="buyCooldown_display" style="width: 40px; text-align: right; color: #fff;">${displayConfig.buyCooldown !== undefined ? displayConfig.buyCooldown : 1}Â§©</span>
                    </div>
                    <div style="font-size: 11px; color: #888; margin-top: 4px;">
                        ÂçñÂá∫ÂêéNÂ§©ÂÜÖÁ¶ÅÊ≠¢ÂºÄ‰ªìÔºåÈò≤Ê≠¢‰ø°Âè∑ÂèçÂ§çË∑≥Âä®Ôºà0Ë°®Á§∫Êó†ÈôêÂà∂Ôºâ„ÄÇ
                    </div>
                </div>`;

                // 3. ÊòæÁ§∫ÂÖ∂‰ªñÁ≠ñÁï•ÁâπÂÆöÂèÇÊï∞ÔºàÊú™Ë¢´‰π∞ÂÖ•/ÂçñÂá∫Êù°‰ª∂ÂåÖÂê´ÁöÑÔºâ
                const remainingParams = getRemainingParams(key, specificParams, buyConditions);
                if (remainingParams.length > 0) {
                    html += `<div class="other-params-group">
                        <div class="other-params-title">‚öôÔ∏è ÂÖ∂‰ªñÂèÇÊï∞</div>`;
                    
                    remainingParams.forEach(paramConfig => {
                        const paramKey = paramConfig.key;
                        const suffix = paramConfig.suffix || '';
                        
                        const rawValue = displayConfig[paramKey] !== undefined ? displayConfig[paramKey] : paramConfig.default;
                        const stepValue = paramConfig.step || 1;
                        const formatted = (typeof rawValue === 'number' && stepValue !== 1) ? rawValue.toFixed(1) : rawValue;
                        
                        html += `<div class="param-row other-param">
                            <span class="param-label">${paramConfig.name}</span>
                            <input type="${paramConfig.type || 'number'}" 
                                   id="param_${paramKey}" 
                                   value="${rawValue}" 
                                   min="${paramConfig.min || 0}"
                                   max="${paramConfig.max || 100}"
                                   step="${stepValue}"
                                   oninput="updateParam('${paramKey}', parseFloat(this.value)); document.getElementById('${paramKey}_other_val').textContent = this.value + '${suffix}'"
                                   style="width:80px;">
                            <span id="${paramKey}_other_val">${formatted}${suffix}</span>
                        </div>`;
                    });
                    
                    html += `</div>`;
                }
                
                html += '</div>';
            }
            
            // ÂèÇÊï∞Êìç‰ΩúÊåâÈíÆ
            let hasOptimizationResult = false;
            if (typeof optimizationResults !== 'undefined' && optimizationResults && optimizationResults[key]) {
                hasOptimizationResult = true;
            } else {
                 // ÂÜçÊ¨°Â∞ùËØï‰ªéÊú¨Âú∞Â≠òÂÇ®ËØªÂèñÔºåÈò≤Ê≠¢ÂÜÖÂ≠òÊú™ÂêåÊ≠•
                 try {
                     const savedResults = localStorage.getItem('optimizationResults');
                     if (savedResults) {
                         const parsed = JSON.parse(savedResults);
                         if (parsed && parsed[key]) {
                             hasOptimizationResult = true;
                             // È°∫‰æøÂêåÊ≠•ÂõûÂÜÖÂ≠ò
                             optimizationResults = parsed;
                         }
                     }
                 } catch(e) {}
            }
            console.log(`üîç Á≠ñÁï• [${key}] ÊòØÂê¶Êúâ‰ºòÂåñÁªìÊûú:`, hasOptimizationResult);
            
            html += `<div class="param-actions">
                ${hasOptimizationResult ? `<button onclick="applyAllOptimizedParams('${key}')" class="btn btn-success" style="padding:4px 8px;font-size:14px;margin-right:5px;">‚úÖ ‰ºòÂåñÊõ¥Êñ∞</button>` : ''}
                <button onclick="resetStrategyParams()" class="btn btn-primary" style="padding:4px 8px;font-size:14px;">ÈáçÁΩÆÂèÇÊï∞</button>
                <button onclick="saveStrategyParams()" class="btn btn-primary" style="padding:4px 8px;font-size:14px;">‰øùÂ≠òÈÖçÁΩÆ</button>
            </div>`;
            
            document.getElementById('strategyParams').innerHTML = html;
        }

        function persistStrategyConfig() {
            try {
                const fullConfig = {
                    ...currentConfig,
                    strategySpecificConfig: strategySpecificConfig
                };
                localStorage.setItem('strategyConfig', JSON.stringify(fullConfig));
                persistLocalStateKeyBestEffort('strategyConfig', fullConfig);
            } catch (e) {
                console.warn('‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•:', e);
            }
        }

        function applyOptimizedParams(strategyKey) {
            const result = optimizationResults?.[strategyKey];
            if (!result || !result.bestParams) {
                alert('ËØ•Á≠ñÁï•ÊöÇÊó†‰ºòÂåñÁªìÊûúÔºåËØ∑ÂÖàËøêË°åÂèÇÊï∞‰ºòÂåñ');
                return false;
            }

            const bestParams = result.bestParams;
            if (!strategySpecificConfig[strategyKey]) {
                strategySpecificConfig[strategyKey] = {};
            }

            if (bestParams.takeProfit !== undefined) strategySpecificConfig[strategyKey].takeProfit = bestParams.takeProfit;
            if (bestParams.stopLoss !== undefined) strategySpecificConfig[strategyKey].stopLoss = bestParams.stopLoss;
            if (bestParams.volumeMulti !== undefined) strategySpecificConfig[strategyKey].volumeMulti = bestParams.volumeMulti;
            if (bestParams.dynamicTpCallback !== undefined) strategySpecificConfig[strategyKey].dynamicTpCallback = bestParams.dynamicTpCallback;
            return true;
        }

        function applyAllOptimizedParams(focusStrategyKey) {
            if (!optimizationResults || Object.keys(optimizationResults).length === 0) {
                alert('ÊöÇÊó†‰ºòÂåñÁªìÊûúÔºåËØ∑ÂÖàËøêË°åÂèÇÊï∞‰ºòÂåñ');
                return;
            }

            let applied = 0;
            Object.keys(optimizationResults).forEach(key => {
                const ok = applyOptimizedParams(key);
                if (ok) applied++;
            });

            persistStrategyConfig();

            const currentStrategyVal = document.getElementById('paramStrategy')?.value;
            const keyToRefresh = focusStrategyKey || currentStrategyVal;
            if (keyToRefresh) {
                updateStrategyParamsWithKey(keyToRefresh);
            } else {
                updateStrategyParams();
            }

            // ÈáçÊñ∞ËÆ°ÁÆóÊâÄÊúâÂ∫îÁî®‰∫Ü‰ºòÂåñÁöÑÁ≠ñÁï•
            if (stockData && stockData.length > 0) {
                Object.keys(optimizationResults).forEach(key => {
                    recalcStrategy(key);
                });
            }

            showNotification(`Â∑≤Â∫îÁî® ${applied} ‰∏™Á≠ñÁï•ÁöÑ‰ºòÂåñÂèÇÊï∞`, 'success');
        }

        function getStrategyDescription(strategyKey) {
            const descriptions = {
                'deep_fusion': 'Ê∑±Â∫¶ËûçÂêàÁ≠ñÁï•ÁªìÂêàÂ§ö‰∏™ÊäÄÊúØÊåáÊ†áÔºåÂåÖÊã¨ÂùáÁ∫ø„ÄÅMACD„ÄÅRSI„ÄÅÂ∏ÉÊûóÂ∏¶ÂíåÊàê‰∫§ÈáèÂàÜÊûêÔºåÈÄöËøáÂ§öÁª¥Â∫¶‰ø°Âè∑ËûçÂêàÊèêÈ´ò‰π∞ÂÖ•ÊàêÂäüÁéá„ÄÇ',
                'volume_breakout': 'Èáè‰ª∑Á™ÅÁ†¥Á≠ñÁï•ÂÖ≥Ê≥®Êàê‰∫§ÈáèÂíå‰ª∑Ê†ºÁöÑÂêåÊó∂Á™ÅÁ†¥ÔºåÂΩìÊàê‰∫§ÈáèÊîæÂ§ß‰∏î‰ª∑Ê†ºÁ™ÅÁ†¥ÂÖ≥ÈîÆ‰ΩçÁΩÆÊó∂‰∫ßÁîü‰π∞ÂÖ•‰ø°Âè∑„ÄÇ',
                'oversold_rebound': 'Ë∂ÖË∑åÂèçÂºπÁ≠ñÁï•Âú®‰ª∑Ê†ºËøáÂ∫¶‰∏ãË∑åÊó∂ÂØªÊâæÂèçÂºπÊú∫‰ºöÔºåÁªìÂêàRSIË∂ÖÂçñÂíåÂ∏ÉÊûóÂ∏¶‰∏ãËΩ®ÊîØÊíëËøõË°å‰π∞ÂÖ•„ÄÇ',
                'trend_enhanced': 'Ë∂ãÂäøÂ¢ûÂº∫Á≠ñÁï•Âü∫‰∫éÂùáÁ∫øÁ≥ªÁªüÂíåË∂ãÂäøÊåáÊ†áÔºåÂú®‰∏äÂçáË∂ãÂäøÁ°ÆÁ´ãÊó∂Ë∑üÈöèË∂ãÂäøÔºåÂú®Ë∂ãÂäøÂèçËΩ¨Êó∂ÂèäÊó∂ÈÄÄÂá∫„ÄÇ',
                'macd_divergence': 'MACDËÉåÁ¶ªÁ≠ñÁï•Âà©Áî®‰ª∑Ê†º‰∏éMACDÊåáÊ†áÁöÑËÉåÁ¶ªÁé∞Ë±°ÔºåÂú®Â∫ïÈÉ®ËÉåÁ¶ªÊó∂‰π∞ÂÖ•ÔºåÈ°∂ÈÉ®ËÉåÁ¶ªÊó∂ÂçñÂá∫„ÄÇ',
                'bollinger_extreme': 'Â∏ÉÊûóÊûÅÈôêÁ≠ñÁï•Âú®‰ª∑Ê†ºËß¶ÂèäÂ∏ÉÊûóÂ∏¶‰∏ä‰∏ãËΩ®Êó∂ÂØªÊâæÂèçËΩ¨Êú∫‰ºöÔºåÁªìÂêàÊàê‰∫§ÈáèÁ°ÆËÆ§‰ø°Âè∑Âº∫Â∫¶„ÄÇ',
                'momentum_rotation': 'Âä®ÈáèËΩÆÂä®Á≠ñÁï•Âü∫‰∫é‰ª∑Ê†ºÂä®ÈáèÂíåÂ∏ÇÂú∫ËΩÆÂä®ËßÑÂæãÔºåÊçïÊçâÁü≠Êúü‰ª∑Ê†ºÊ≥¢Âä®Â∏¶Êù•ÁöÑ‰∫§ÊòìÊú∫‰ºö„ÄÇ',
                'turtle_enhanced': 'Êµ∑ÈæüÂ¢ûÂº∫Á≠ñÁï•Âü∫‰∫éÁªèÂÖ∏ÁöÑÊµ∑Èæü‰∫§ÊòìÊ≥ïÂàôÔºåÁªìÂêàÁé∞‰ª£ÊäÄÊúØÊåáÊ†á‰ºòÂåñÂÖ•Âú∫ÂíåÂá∫Âú∫Êó∂Êú∫„ÄÇ'
            };
            return descriptions[strategyKey] || 'ËØ•Á≠ñÁï•Âü∫‰∫éÊäÄÊúØÊåáÊ†áËøõË°å‰π∞ÂçñÂÜ≥Á≠ñÔºåÈÄöËøáÂèÇÊï∞‰ºòÂåñÂÆûÁé∞Êî∂ÁõäÊúÄÂ§ßÂåñ„ÄÇ';
        }

        function getStrategyBuyParams(strategyKey) {
            const params = {
                'deep_fusion': {
                    'MA5>MA20': 'Êù°‰ª∂',
                    '‰ª∑Ê†º>MA5': 'Êù°‰ª∂',
                    'MACD>0‰∏î‰∏äÂçá': 'Êù°‰ª∂',
                    'RSI<35': 'Êù°‰ª∂',
                    'RSI<25': 'Âä†ÂàÜÈ°π',
                    'Êàê‰∫§Èáè>ÂùáÈáè*ÂÄçÊï∞': 'Êù°‰ª∂',
                    '‰ª∑Ê†º<Â∏ÉÊûó‰∏ãËΩ®': 'Âä†ÂàÜÈ°π',
                    'ÁªºÂêàËØÑÂàÜ‚â•60': '‰π∞ÂÖ•'
                },
                'volume_breakout': {
                    'Êé•Ëøë10Êó•‰ΩéÁÇπ': 'Êù°‰ª∂',
                    'Êàê‰∫§ÈáèÊîæÂ§ß': 'Êù°‰ª∂',
                    'RSIË∂ÖÂçñ': 'Êù°‰ª∂',
                    'Èò≥Á∫ø': 'Âä†ÂàÜÈ°π'
                },
                'oversold_rebound': {
                    'Ëß¶ÂèäÂ∏ÉÊûó‰∏ãËΩ®': 'Êù°‰ª∂',
                    'RSI<25': 'Êù°‰ª∂'
                },
                'trend_enhanced': {
                    'MA5>MA20': 'Êù°‰ª∂',
                    '‰ª∑Ê†º>MA5': 'Êù°‰ª∂',
                    'ÈáëÂèâ': 'Âä†ÂàÜÈ°π',
                    'MACD>0': 'Êù°‰ª∂'
                },
                'macd_divergence': {
                    'Âä®ÈáèËØÑÂàÜ': 'Âä®ÊÄÅ',
                    '‰º∞ÂÄºËØÑÂàÜ': 'Âä®ÊÄÅ',
                    'Ë¥®ÈáèËØÑÂàÜ': 'Âõ∫ÂÆö',
                    'ÁªºÂêàËØÑÂàÜ‚â•65': '‰π∞ÂÖ•'
                },
                'bollinger_extreme': {
                    'Á™ÅÁ†¥20Êó•È´òÁÇπ': 'Êù°‰ª∂',
                    'Êàê‰∫§Èáè>2ÂÄçÂùáÈáè': 'Êù°‰ª∂'
                },
                'momentum_rotation': {
                    'Êé•Ëøë10Êó•‰ΩéÁÇπ': 'Êù°‰ª∂',
                    'Êàê‰∫§ÈáèÊîæÂ§ß': 'Êù°‰ª∂',
                    'RSIË∂ÖÂçñ': 'Êù°‰ª∂',
                    'Èò≥Á∫ø': 'Âä†ÂàÜÈ°π'
                },
                'turtle_enhanced': {
                    'MA5>MA20': 'Êù°‰ª∂',
                    '‰ª∑Ê†º>MA5': 'Êù°‰ª∂',
                    'ÈáëÂèâ': 'Âä†ÂàÜÈ°π',
                    'MACD>0': 'Êù°‰ª∂'
                }
            };
            return params[strategyKey];
        }

        function getStrategySellParams(strategyKey) {
            return {
                'Ê≠¢Êçü': 'ÈÄöÁî®',
                'Ê≠¢Áõà': 'ÈÄöÁî®',
                'Ë∑åÁ†¥MA5': 'ÂèØÈÄâ',
                'ÁßªÂä®Ê≠¢Áõà': 'ÂèØÈÄâ',
                'MACDÊ≠ªÂèâ': 'ÈÄöÁî®',
                'RSIË∂Ö‰π∞': 'ÈÄöÁî®',
                'ÊåÅ‰ªìË∂ÖÊó∂': 'ÈÄöÁî®'
            };
        }

        function getStrategyBuyConditions(strategyKey) {
            const conditions = {
                'deep_fusion': [
                    { key: 'useMa5AboveMa20', label: 'MA5>MA20', desc: '5Êó•ÂùáÁ∫øÈ´ò‰∫é20Êó•ÂùáÁ∫ø', default: true },
                    { key: 'usePriceAboveMa5', label: '‰ª∑Ê†º>MA5', desc: 'Êî∂Áõò‰ª∑È´ò‰∫é5Êó•ÂùáÁ∫ø', default: true },
                    { key: 'useMacdRising', label: 'MACD>0‰∏î‰∏äÂçá', desc: 'MACD‰∏∫Ê≠£‰∏îÂëà‰∏äÂçáË∂ãÂäø', default: true },
                    { key: 'useRsiBelow35', label: 'RSI<35', desc: 'RSI‰Ωé‰∫é35Ë∂ÖÂçñÂå∫Âüü', default: true },
                    { key: 'useRsiBelow25', label: 'RSI<25Âä†ÂàÜ', desc: 'RSI‰Ωé‰∫é25‰∏•ÈáçË∂ÖÂçñÂä†ÂàÜ', default: true },
                    { key: 'useVolumeAboveMa', label: 'Êàê‰∫§Èáè>ÂùáÈáè', desc: 'Êàê‰∫§ÈáèÈ´ò‰∫é5Êó•ÂùáÈáè', default: true },
                    { key: 'usePriceBelowBoll', label: '‰ª∑Ê†º<Â∏ÉÊûó‰∏ãËΩ®', desc: '‰ª∑Ê†º‰Ωé‰∫éÂ∏ÉÊûóÂ∏¶‰∏ãËΩ®', default: true }
                ],
                'momentum_reversal': [
                    { key: 'useNearLow', label: 'Êé•Ëøë10Êó•‰ΩéÁÇπ', desc: '‰ª∑Ê†ºÊé•Ëøë10Êó•‰ΩéÁÇπ', default: true },
                    { key: 'useVolumeUp', label: 'Êàê‰∫§ÈáèÊîæÂ§ß', desc: 'Êàê‰∫§ÈáèÈ´ò‰∫é5Êó•ÂùáÈáè', default: true },
                    { key: 'useRsiOversold', label: 'RSIË∂ÖÂçñ', desc: 'RSI‰Ωé‰∫éËÆæÂÆöÈòàÂÄº', default: true },
                    { key: 'useBullishCandle', label: 'Èò≥Á∫øÂä†ÂàÜ', desc: 'Êî∂Áõò‰ª∑È´ò‰∫éÂºÄÁõò‰ª∑', default: true }
                ],
                'trend_follow': [
                    { key: 'useMa5AboveMa20', label: 'MA5>MA20', desc: '5Êó•ÂùáÁ∫øÈ´ò‰∫é20Êó•ÂùáÁ∫ø', default: true },
                    { key: 'usePriceAboveMa5', label: '‰ª∑Ê†º>MA5', desc: 'Êî∂Áõò‰ª∑È´ò‰∫é5Êó•ÂùáÁ∫ø', default: true },
                    { key: 'useGoldenCross', label: 'ÈáëÂèâÂä†ÂàÜ', desc: '5Êó•ÂùáÁ∫ø‰∏äÁ©ø20Êó•ÂùáÁ∫ø', default: true },
                    { key: 'useMacdPositive', label: 'MACD>0', desc: 'MACD‰∏∫Ê≠£', default: true }
                ],
                'breakout': [
                    { key: 'useBreakHigh', label: 'Á™ÅÁ†¥20Êó•È´òÁÇπ', desc: 'Êî∂Áõò‰ª∑Á™ÅÁ†¥20Êó•ÊúÄÈ´òÁÇπ', default: true },
                    { key: 'useVolumeConfirm', label: 'Êàê‰∫§ÈáèÁ°ÆËÆ§', desc: 'Êàê‰∫§ÈáèÈ´ò‰∫é5Êó•ÂùáÈáè', default: true }
                ],
                'mean_reversion': [
                    { key: 'useTouchLowerBoll', label: 'Ëß¶ÂèäÂ∏ÉÊûó‰∏ãËΩ®', desc: '‰ª∑Ê†ºËß¶ÂèäÂ∏ÉÊûóÂ∏¶‰∏ãËΩ®', default: true },
                    { key: 'useRsiOversold', label: 'RSIË∂ÖÂçñ', desc: 'RSI‰Ωé‰∫éËÆæÂÆöÈòàÂÄº', default: true }
                ],
                'multi_factor': [
                    { key: 'useMomentumFactor', label: 'Âä®ÈáèÂõ†Â≠ê', desc: 'Âü∫‰∫é‰ª∑Ê†ºÂä®ÈáèËØÑÂàÜ', default: true },
                    { key: 'useValueFactor', label: '‰ª∑ÂÄºÂõ†Â≠ê', desc: 'Âü∫‰∫é‰ª∑Ê†ºÁõ∏ÂØπÂùáÁ∫ø‰ΩçÁΩÆ', default: true },
                    { key: 'useQualityFactor', label: 'Ë¥®ÈáèÂõ†Â≠ê', desc: 'Âü∫‰∫éÊ≥¢Âä®ÁéáËØÑÂàÜ', default: true }
                ]
            };
            return conditions[strategyKey] || [];
        }

        function getStrategySellConditions() {
            return [
                { key: 'useStopLoss', label: 'Ê≠¢Êçü', desc: '‰∫èÊçüËææÂà∞ËÆæÂÆöÊØî‰æãÊó∂ÂçñÂá∫', default: true },
                { key: 'useTakeProfit', label: 'Ê≠¢Áõà', desc: 'ÁõàÂà©ËææÂà∞ËÆæÂÆöÊØî‰æãÊó∂ÂçñÂá∫', default: true },
                { key: 'useMa5Sell', label: 'Ë∑åÁ†¥MA5', desc: '‰ª∑Ê†ºË∑åÁ†¥5Êó•ÂùáÁ∫ø‰∏îÁõàÂà©>2%Êó∂ÂçñÂá∫', default: true },
                { key: 'useDynamicTP', label: 'Âä®ÊÄÅÊ≠¢Áõà', desc: 'ÁõàÂà©>8%Êó∂ÂêØÁî®ÁßªÂä®Ê≠¢Áõà', default: true },
                { key: 'useMacdDeathCross', label: 'MACDÊ≠ªÂèâ', desc: 'MACDÁî±Ê≠£ËΩ¨Ë¥ü‰∏îÁõàÂà©>0Êó∂ÂçñÂá∫', default: true },
                { key: 'useRsiOverbought', label: 'RSIË∂Ö‰π∞', desc: 'RSI>80‰∏îÁõàÂà©>5%Êó∂ÂçñÂá∫', default: true },
                { key: 'useHoldTimeout', label: 'ÊåÅ‰ªìË∂ÖÊó∂', desc: 'ÊåÅ‰ªì>30Â§©‰∏îÁõàÂà©<5%Êó∂ÂçñÂá∫', default: true }
            ];
        }

        function getRelatedSellParams(conditionKey) {
            const conditionSellParamMap = {
                'useStopLoss': [{ name: 'Ê≠¢ÊçüÊØî‰æã', key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 }],
                'useTakeProfit': [{ name: 'Ê≠¢ÁõàÊØî‰æã', key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 }],
                'useMa5Sell': [], // Êó†È¢ùÂ§ñÂèÇÊï∞
                'useDynamicTP': [
                    { name: 'ÂêØÂä®Êî∂Áõä', key: 'dynamicTpThreshold', type: 'range', min: 5, max: 50, default: 8, suffix: '%', slider: true, step: 1 },
                    { name: 'ÂõûÊí§ÈòàÂÄº', key: 'dynamicTpCallback', type: 'range', min: 1, max: 20, default: 3, suffix: '%', slider: true, step: 0.5 },
                    { name: 'ÂèòÂä®Á≥ªÊï∞', key: 'dynamicTpVariation', type: 'range', min: 0, max: 50, default: 15, suffix: '', slider: true, step: 1 }
                ],
                'useMacdDeathCross': [], // Êó†È¢ùÂ§ñÂèÇÊï∞
                'useRsiOverbought': [], // ÂèÇÊï∞Âõ∫ÂÆö(RSI>80)
                'useHoldTimeout': [{ name: 'Ë∂ÖÊó∂Â§©Êï∞', key: 'holdTimeoutDays', type: 'number', min: 10, max: 90, default: 30, suffix: 'Â§©' }]
            };
            
            return conditionSellParamMap[conditionKey] || [];
        }

        function getRelatedParams(strategyKey, conditionKey) {
            const conditionParamMap = {
                'deep_fusion': {
                    'useMa5AboveMa20': [{ name: 'MA5>MA20ÊùÉÈáç', key: 'maWeight', type: 'number', min: 5, max: 50, default: 20, suffix: 'ÂàÜ' }],
                    'usePriceAboveMa5': [{ name: '‰ª∑Ê†º>MA5ÊùÉÈáç', key: 'priceWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' }],
                    'useMacdRising': [{ name: 'MACD>0ÊùÉÈáç', key: 'macdWeight', type: 'number', min: 5, max: 50, default: 20, suffix: 'ÂàÜ' }],
                    'useRsiBelow35': [{ name: 'RSI<35ÊùÉÈáç', key: 'rsi35Weight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' }],
                    'useRsiBelow25': [{ name: 'RSI<25ÊùÉÈáç', key: 'rsi25Weight', type: 'number', min: 0, max: 20, default: 10, suffix: 'ÂàÜ' }],
                    'useVolumeAboveMa': [{ name: 'Êàê‰∫§ÈáèÊùÉÈáç', key: 'volumeWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' }],
                    'usePriceBelowBoll': [{ name: 'Â∏ÉÊûó‰∏ãËΩ®ÊùÉÈáç', key: 'bollWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' }]
                },
                'momentum_reversal': {
                    'useNearLow': [{ name: 'Êé•Ëøë‰ΩéÁÇπÊØî‰æã', key: 'nearLowRatio', type: 'number', min: 1.0, max: 1.2, step: 0.01, default: 1.02, suffix: 'ÂÄç' }],
                    'useVolumeUp': [{ name: 'Êàê‰∫§ÈáèÂÄçÊï∞', key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' }],
                    'useRsiOversold': [{ name: 'RSIË∂ÖÂçñÈòàÂÄº', key: 'rsiThreshold', type: 'number', min: 10, max: 50, default: 30, suffix: '' }]
                },
                'trend_follow': {
                    'useMa5AboveMa20': [{ name: 'Ë∂ãÂäøÁ°ÆËÆ§Âë®Êúü', key: 'trendPeriod', type: 'number', min: 10, max: 60, default: 20, suffix: 'Â§©' }],
                    'useMacdPositive': [{ name: 'MACDÊ≠£ÈòàÂÄº', key: 'macdThreshold', type: 'number', min: 0, max: 1, step: 0.1, default: 0, suffix: '' }],
                    'useGoldenCross': [{ name: 'ÈáëÂèâÂä†ÂàÜ', key: 'goldenCrossBonus', type: 'number', min: 0, max: 20, default: 10, suffix: 'ÂàÜ' }]
                },
                'breakout': {
                    'useBreakHigh': [{ name: 'Á™ÅÁ†¥Âë®Êúü', key: 'breakoutPeriod', type: 'number', min: 10, max: 60, default: 20, suffix: 'Â§©' }],
                    'useVolumeConfirm': [{ name: 'Êàê‰∫§ÈáèÂÄçÊï∞', key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 2.0, suffix: 'x' }],
                    'useBreakHigh': [{ name: '‰ø°Âè∑Âº∫Â∫¶', key: 'signalStrength', type: 'number', min: 50, max: 100, default: 80, suffix: 'ÂàÜ' }]
                },
                'mean_reversion': {
                    'useTouchLowerBoll': [{ name: 'Â∏ÉÊûó‰∏ãËΩ®ÂÅèÁßª', key: 'bollingerOffset', type: 'number', min: -0.1, max: 0.1, step: 0.01, default: 0, suffix: '%' }],
                    'useRsiOversold': [{ name: 'RSIË∂ÖÂçñÈòàÂÄº', key: 'rsiThreshold', type: 'number', min: 10, max: 50, default: 25, suffix: '' }],
                    'useTouchLowerBoll': [{ name: '‰ø°Âè∑Âº∫Â∫¶', key: 'signalStrength', type: 'number', min: 50, max: 100, default: 70, suffix: 'ÂàÜ' }]
                },
                'multi_factor': {
                    'useMomentumFactor': [{ name: 'Âä®ÈáèÊùÉÈáç', key: 'momentumWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.3, suffix: '' }],
                    'useValueFactor': [{ name: '‰ª∑ÂÄºÊùÉÈáç', key: 'valueWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.3, suffix: '' }],
                    'useQualityFactor': [{ name: 'Ë¥®ÈáèÊùÉÈáç', key: 'qualityWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.4, suffix: '' }]
                }
            };
            
            return conditionParamMap[strategyKey]?.[conditionKey] || [];
        }

        function getRemainingParams(strategyKey, specificParams, buyConditions) {
            // Ëé∑ÂèñÊú™Ë¢´‰π∞ÂÖ•Êù°‰ª∂ÂåÖÂê´ÁöÑÂèÇÊï∞
            const remaining = [];
            
            // Ëé∑ÂèñÊâÄÊúâ‰π∞ÂÖ•Êù°‰ª∂Áõ∏ÂÖ≥ÁöÑÂèÇÊï∞ÈîÆ
            const relatedParamKeys = new Set();
            buyConditions.forEach(condition => {
                const relatedParams = getRelatedParams(strategyKey, condition.key);
                relatedParams.forEach(param => relatedParamKeys.add(param.key));
            });
            
            // Ëé∑ÂèñÊâÄÊúâÂçñÂá∫Êù°‰ª∂Áõ∏ÂÖ≥ÁöÑÂèÇÊï∞ÈîÆ (Êñ∞Â¢û: Èò≤Ê≠¢Ê≠¢ÁõàÊ≠¢ÊçüÂú®"ÂÖ∂‰ªñÂèÇÊï∞"‰∏≠ÈáçÂ§çÂá∫Áé∞)
            const sellConditions = getStrategySellConditions();
            sellConditions.forEach(condition => {
                const relatedSellParams = getRelatedSellParams(condition.key);
                relatedSellParams.forEach(param => relatedParamKeys.add(param.key));
            });
            
            // ÊâæÂá∫Êú™Ë¢´ÂåÖÂê´ÁöÑÂèÇÊï∞
            Object.entries(specificParams).forEach(([paramName, paramConfig]) => {
                if (!relatedParamKeys.has(paramConfig.key)) {
                    remaining.push({
                        name: paramName,
                        ...paramConfig
                    });
                }
            });
            
            return remaining;
        }

        function getStrategySpecificParams(strategyKey) {
            const params = {
                'deep_fusion': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    '‰π∞ÂÖ•ËØÑÂàÜÈòàÂÄº': { key: 'mlScoreThreshold', type: 'number', min: 40, max: 100, default: 60, suffix: 'ÂàÜ' },
                    'MA5>MA20ÊùÉÈáç': { key: 'maWeight', type: 'number', min: 5, max: 50, default: 20, suffix: 'ÂàÜ' },
                    '‰ª∑Ê†º>MA5ÊùÉÈáç': { key: 'priceWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' },
                    'MACD>0ÊùÉÈáç': { key: 'macdWeight', type: 'number', min: 5, max: 50, default: 20, suffix: 'ÂàÜ' },
                    'RSI<35ÊùÉÈáç': { key: 'rsi35Weight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' },
                    'RSI<25ÊùÉÈáç': { key: 'rsi25Weight', type: 'number', min: 0, max: 20, default: 10, suffix: 'ÂàÜ' },
                    'Êàê‰∫§ÈáèÊùÉÈáç': { key: 'volumeWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' },
                    'Â∏ÉÊûó‰∏ãËΩ®ÊùÉÈáç': { key: 'bollWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' }
                },
                'volume_breakout': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'Êé•Ëøë‰ΩéÁÇπÊØî‰æã': { key: 'nearLowRatio', type: 'number', min: 1.0, max: 1.2, step: 0.01, default: 1.02, suffix: 'ÂÄç' },
                    'RSIË∂ÖÂçñÈòàÂÄº': { key: 'rsiThreshold', type: 'number', min: 10, max: 50, default: 30, suffix: '' }
                },
                'oversold_rebound': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'RSIË∂ÖÂçñÈòàÂÄº': { key: 'rsiThreshold', type: 'number', min: 10, max: 50, default: 25, suffix: '' },
                    'Â∏ÉÊûó‰∏ãËΩ®ÂÅèÁßª': { key: 'bollingerOffset', type: 'number', min: -0.1, max: 0.1, step: 0.01, default: 0, suffix: '%' },
                    '‰ø°Âè∑Âº∫Â∫¶': { key: 'signalStrength', type: 'number', min: 50, max: 100, default: 70, suffix: 'ÂàÜ' }
                },
                'trend_enhanced': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'Ë∂ãÂäøÁ°ÆËÆ§Âë®Êúü': { key: 'trendPeriod', type: 'number', min: 10, max: 60, default: 20, suffix: 'Â§©' },
                    'MACDÊ≠£ÈòàÂÄº': { key: 'macdThreshold', type: 'number', min: 0, max: 1, step: 0.1, default: 0, suffix: '' },
                    'ÈáëÂèâÂä†ÂàÜ': { key: 'goldenCrossBonus', type: 'number', min: 0, max: 20, default: 10, suffix: 'ÂàÜ' }
                },
                'macd_divergence': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'Âä®ÈáèÊùÉÈáç': { key: 'momentumWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.3, suffix: '' },
                    '‰ª∑ÂÄºÊùÉÈáç': { key: 'valueWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.3, suffix: '' },
                    'Ë¥®ÈáèÊùÉÈáç': { key: 'qualityWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.4, suffix: '' },
                    '‰π∞ÂÖ•ÈòàÂÄº': { key: 'buyThreshold', type: 'number', min: 40, max: 100, default: 65, suffix: 'ÂàÜ' },
                    'Êï∞ÊçÆÂë®Êúü': { key: 'dataPeriod', type: 'number', min: 20, max: 120, default: 80, suffix: 'Â§©' }
                },
                'bollinger_extreme': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 2.0, suffix: 'x' },
                    'Á™ÅÁ†¥Âë®Êúü': { key: 'breakoutPeriod', type: 'number', min: 10, max: 60, default: 20, suffix: 'Â§©' },
                    '‰ø°Âè∑Âº∫Â∫¶': { key: 'signalStrength', type: 'number', min: 50, max: 100, default: 80, suffix: 'ÂàÜ' }
                },
                'momentum_rotation': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'Êé•Ëøë‰ΩéÁÇπÊØî‰æã': { key: 'nearLowRatio', type: 'number', min: 1.0, max: 1.2, step: 0.01, default: 1.02, suffix: 'ÂÄç' },
                    'RSIË∂ÖÂçñÈòàÂÄº': { key: 'rsiThreshold', type: 'number', min: 10, max: 50, default: 30, suffix: '' }
                },
                'turtle_enhanced': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'Ë∂ãÂäøÁ°ÆËÆ§Âë®Êúü': { key: 'trendPeriod', type: 'number', min: 10, max: 60, default: 20, suffix: 'Â§©' },
                    'MACDÊ≠£ÈòàÂÄº': { key: 'macdThreshold', type: 'number', min: 0, max: 1, step: 0.1, default: 0, suffix: '' },
                    'ÈáëÂèâÂä†ÂàÜ': { key: 'goldenCrossBonus', type: 'number', min: 0, max: 20, default: 10, suffix: 'ÂàÜ' }
                },
                'ml_ensemble': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    '‰π∞ÂÖ•ËØÑÂàÜÈòàÂÄº': { key: 'mlScoreThreshold', type: 'number', min: 40, max: 100, default: 60, suffix: 'ÂàÜ' },
                    'MA5>MA20ÊùÉÈáç': { key: 'maWeight', type: 'number', min: 5, max: 50, default: 20, suffix: 'ÂàÜ' },
                    '‰ª∑Ê†º>MA5ÊùÉÈáç': { key: 'priceWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' },
                    'MACD>0ÊùÉÈáç': { key: 'macdWeight', type: 'number', min: 5, max: 50, default: 20, suffix: 'ÂàÜ' },
                    'RSI<35ÊùÉÈáç': { key: 'rsi35Weight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' },
                    'RSI<25ÊùÉÈáç': { key: 'rsi25Weight', type: 'number', min: 0, max: 20, default: 10, suffix: 'ÂàÜ' },
                    'Êàê‰∫§ÈáèÊùÉÈáç': { key: 'volumeWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' },
                    'Â∏ÉÊûó‰∏ãËΩ®ÊùÉÈáç': { key: 'bollWeight', type: 'number', min: 5, max: 30, default: 15, suffix: 'ÂàÜ' }
                },
                'momentum_reversal': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'Êé•Ëøë‰ΩéÁÇπÊØî‰æã': { key: 'nearLowRatio', type: 'number', min: 1.0, max: 1.2, step: 0.01, default: 1.02, suffix: 'ÂÄç' },
                    'RSIË∂ÖÂçñÈòàÂÄº': { key: 'rsiThreshold', type: 'number', min: 10, max: 50, default: 30, suffix: '' }
                },
                'mean_reversion': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'RSIË∂ÖÂçñÈòàÂÄº': { key: 'rsiThreshold', type: 'number', min: 10, max: 50, default: 25, suffix: '' },
                    'Â∏ÉÊûó‰∏ãËΩ®ÂÅèÁßª': { key: 'bollingerOffset', type: 'number', min: -0.1, max: 0.1, step: 0.01, default: 0, suffix: '%' },
                    '‰ø°Âè∑Âº∫Â∫¶': { key: 'signalStrength', type: 'number', min: 50, max: 100, default: 70, suffix: 'ÂàÜ' }
                },
                'trend_follow': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'Ë∂ãÂäøÁ°ÆËÆ§Âë®Êúü': { key: 'trendPeriod', type: 'number', min: 10, max: 60, default: 20, suffix: 'Â§©' },
                    'MACDÊ≠£ÈòàÂÄº': { key: 'macdThreshold', type: 'number', min: 0, max: 1, step: 0.1, default: 0, suffix: '' },
                    'ÈáëÂèâÂä†ÂàÜ': { key: 'goldenCrossBonus', type: 'number', min: 0, max: 20, default: 10, suffix: 'ÂàÜ' }
                },
                'breakout': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 2.0, suffix: 'x' },
                    'Á™ÅÁ†¥Âë®Êúü': { key: 'breakoutPeriod', type: 'number', min: 10, max: 60, default: 20, suffix: 'Â§©' },
                    '‰ø°Âè∑Âº∫Â∫¶': { key: 'signalStrength', type: 'number', min: 50, max: 100, default: 80, suffix: 'ÂàÜ' }
                },
                'multi_factor': {
                    'Ê≠¢ÁõàÊØî‰æã': { key: 'takeProfit', type: 'range', min: 5, max: 100, default: 15, suffix: '%', slider: true, step: 0.1 },
                    'Ê≠¢ÊçüÊØî‰æã': { key: 'stopLoss', type: 'range', min: 1, max: 25, default: 8, suffix: '%', slider: true, step: 0.1 },
                    'ÊîæÈáèÂÄçÊï∞': { key: 'volumeMulti', type: 'number', min: 1.0, max: 5.0, step: 0.1, default: 1.5, suffix: 'x' },
                    'Âä®ÈáèÊùÉÈáç': { key: 'momentumWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.3, suffix: '' },
                    '‰ª∑ÂÄºÊùÉÈáç': { key: 'valueWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.3, suffix: '' },
                    'Ë¥®ÈáèÊùÉÈáç': { key: 'qualityWeight', type: 'number', min: 0.1, max: 1.0, step: 0.1, default: 0.4, suffix: '' },
                    '‰π∞ÂÖ•ÈòàÂÄº': { key: 'buyThreshold', type: 'number', min: 40, max: 100, default: 65, suffix: 'ÂàÜ' },
                    'Êï∞ÊçÆÂë®Êúü': { key: 'dataPeriod', type: 'number', min: 20, max: 120, default: 80, suffix: 'Â§©' }
                }
            };
            return params[strategyKey] || {};
        }

        function isStrategyScopedParam(strategyKey, paramKey) {
            if (!strategyKey || !paramKey) return false;
            try {
                const key = String(paramKey);
                const specificParams = getStrategySpecificParams(strategyKey) || {};
                for (const cfg of Object.values(specificParams)) {
                    if (cfg && cfg.key === key) return true;
                }

                const buyConditions = getStrategyBuyConditions(strategyKey) || [];
                for (const cond of buyConditions) {
                    if (cond && cond.key === key) return true;
                    const related = getRelatedParams(strategyKey, cond?.key) || [];
                    for (const rp of related) {
                        if (rp && rp.key === key) return true;
                    }
                }

                const sellConditions = getStrategySellConditions() || [];
                for (const cond of sellConditions) {
                    if (cond && cond.key === key) return true;
                    const related = getRelatedSellParams(cond?.key) || [];
                    for (const rp of related) {
                        if (rp && rp.key === key) return true;
                    }
                }
            } catch (e) {
                return false;
            }
            return false;
        }

        function updateParam(paramKey, paramValue) {
            const currentStrategy = document.getElementById('paramStrategy').value;
            const isSpecificParam = isStrategyScopedParam(currentStrategy, paramKey);
            
            if (isSpecificParam) {
                if (!strategySpecificConfig[currentStrategy]) {
                    strategySpecificConfig[currentStrategy] = {};
                }
                if ((paramKey === 'takeProfit' || paramKey === 'stopLoss' || paramKey === 'dynamicTpThreshold' || paramKey === 'dynamicTpCallback' || paramKey === 'dynamicTpVariation') && typeof paramValue === 'number' && paramValue > 1) {
                    strategySpecificConfig[currentStrategy][paramKey] = paramValue / 100;
                } else {
                    strategySpecificConfig[currentStrategy][paramKey] = paramValue;
                }
            } else {
                if ((paramKey === 'takeProfit' || paramKey === 'stopLoss' || paramKey === 'dynamicTpThreshold' || paramKey === 'dynamicTpCallback' || paramKey === 'dynamicTpVariation') && typeof paramValue === 'number' && paramValue > 1) {
                    currentConfig[paramKey] = paramValue / 100;
                } else {
                    currentConfig[paramKey] = paramValue;
                }
            }
            
            console.log(`ÂèÇÊï∞Êõ¥Êñ∞: ${paramKey} = ${paramValue}`);
            
            // Á´ãÂç≥‰øùÂ≠òÈÖçÁΩÆ
            saveStrategyParams(true); // true = silent mode
            
            // Á´ãÂç≥ÈáçÊñ∞ËÆ°ÁÆóÂΩìÂâçÁ≠ñÁï•Âπ∂Êõ¥Êñ∞ÁïåÈù¢
            if (stockData && stockData.length > 0) {
                // ‰ΩøÁî®Èò≤ÊäñÔºåÈÅøÂÖçÊªëÂä®ÊªëÂùóÊó∂È¢ëÁπÅËÆ°ÁÆó
                if (window.recalcTimeout) clearTimeout(window.recalcTimeout);
                window.recalcTimeout = setTimeout(() => {
                    recalcStrategy(currentStrategy);
                }, 50);
            }
        }

        function recalcStrategy(strategyKey) {
            try {
                if (!stockData || stockData.length === 0) return;
                
                const strategyName = STRATEGIES[strategyKey]?.name || strategyKey;
                // console.log(`üîÑ Ê≠£Âú®ÈáçÊñ∞ËÆ°ÁÆóÁ≠ñÁï•: ${strategyName}`);
                
                const initCapital = parseFloat(document.getElementById('initCapital').value) * 10000;
                const config = getEffectiveStrategyConfig(strategyKey);
                
                const signals = executeStrategy(stockData, strategyKey, config);
                const result = calculateBacktest(stockData, signals, initCapital);
                
                strategyResults[strategyKey] = {
                    ...result,
                    signals,
                    name: strategyName,
                    icon: STRATEGIES[strategyKey]?.icon || 'üìä'
                };
                
                // Ê†πÊçÆÂΩìÂâçÊâÄÂú®ÁöÑÊ†áÁ≠æÈ°µÊõ¥Êñ∞ÁïåÈù¢
                if (document.getElementById('tab-details').classList.contains('active')) {
                    // Â¶ÇÊûúÂú®ËØ¶ÁªÜÂàÜÊûêÈ°µÔºå‰∏îÂΩìÂâçÊü•ÁúãÁöÑÊ≠£ÊòØËØ•Á≠ñÁï•ÔºåÂàôÂà∑Êñ∞
                    const detailStrategy = document.getElementById('detailStrategy').value;
                    if (detailStrategy === strategyKey) {
                        updateDetailAnalysis();
                    }
                } else if (document.getElementById('tab-comparison').classList.contains('active')) {
                    // Â¶ÇÊûúÂú®ÂØπÊØîÈ°µÔºåÂà∑Êñ∞ÂØπÊØîË°®ÂíåÂõæË°®
                    updateComparisonTable();
                    updateCharts();
                    updateBestResult();
                }
                
                // console.log(`‚úÖ Á≠ñÁï• ${strategyName} ÈáçÊñ∞ËÆ°ÁÆóÂÆåÊàê`);
            } catch (e) {
                console.error(`‚ùå ÈáçÊñ∞ËÆ°ÁÆóÁ≠ñÁï• ${strategyKey} Â§±Ë¥•:`, e);
            }
        }

        function resetStrategyParams() {
            // ÈáçÁΩÆÊâÄÊúâÁ≠ñÁï•ÁöÑÁâπÂÆöÂèÇÊï∞‰∏∫ÈªòËÆ§ÂÄº
            Object.keys(strategySpecificConfig).forEach(strategy => {
                strategySpecificConfig[strategy] = {};
            });
            
            // ÈáçÁΩÆÈÄöÁî®ÈÖçÁΩÆ‰∏≠ÁöÑÂçñÂá∫Êù°‰ª∂ÂºÄÂÖ≥
            currentConfig = {
                useMa5Sell: true,
                useDynamicTP: true,
                dynamicTpThreshold: 0.08,
                dynamicTpCallback: 0.03,
                dynamicTpVariation: 0.15,
                useAdaptPosition: true,
                // ÂçñÂá∫Êù°‰ª∂ÂºÄÂÖ≥
                useStopLoss: true,
                useTakeProfit: true,
                useMacdDeathCross: true,
                useRsiOverbought: true,
                useHoldTimeout: true,
                holdTimeoutDays: 30
            };
            
            // Ëé∑ÂèñÂΩìÂâçÁ≠ñÁï•ÁöÑ‰π∞ÂÖ•Êù°‰ª∂ÈªòËÆ§Áä∂ÊÄÅ
            const paramStrategy = document.getElementById('paramStrategy');
            const currentStrategy = paramStrategy ? paramStrategy.value : 'deep_fusion';
            const buyConditions = getStrategyBuyConditions(currentStrategy);
            buyConditions.forEach(condition => {
                currentConfig[condition.key] = condition.default;
            });
            
            updateStrategyParams();
            console.log('‚úÖ Á≠ñÁï•ÂèÇÊï∞Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº');
            
            // Á´ãÂç≥‰øùÂ≠òÂπ∂Âà∑Êñ∞
            saveStrategyParams(true);
            
            // ÈáçÊñ∞ËÆ°ÁÆóÊâÄÊúâÁ≠ñÁï•
            if (stockData && stockData.length > 0) {
                const strategies = Object.keys(STRATEGIES);
                // ‰ΩøÁî®Âª∂Êó∂ÈÅøÂÖçÈòªÂ°û UI
                setTimeout(() => {
                    strategies.forEach(s => recalcStrategy(s));
                    showNotification('Â∑≤ÈáçÁΩÆÊâÄÊúâÂèÇÊï∞Âπ∂ÈáçÊñ∞ËÆ°ÁÆó', 'success');
                }, 50);
            }
        }

        function saveStrategyParams(silent = false) {
            // ÂêàÂπ∂ÈÄöÁî®ÂèÇÊï∞ÂíåÊâÄÊúâÁ≠ñÁï•ÁöÑÁâπÂÆöÂèÇÊï∞
            const fullConfig = {
                ...currentConfig,
                strategySpecificConfig: strategySpecificConfig
            };
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem('strategyConfig', JSON.stringify(fullConfig));
            persistLocalStateKeyBestEffort('strategyConfig', fullConfig);
            
            // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
            const paramStrategy = document.getElementById('paramStrategy');
            const currentStrategy = paramStrategy ? paramStrategy.value : 'deep_fusion';
            if (!silent) console.log(`‚úÖ Á≠ñÁï• ${currentStrategy} ÂèÇÊï∞Â∑≤‰øùÂ≠ò`, fullConfig);
            
            if (!silent) {
                if (typeof showNotification === 'function') {
                    showNotification('‚úÖ ÂèÇÊï∞ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
                }
            }
        }

        // ===================== ÂõæË°®Êõ¥Êñ∞ =====================
        function updateCharts() {
            console.log('üîÑ ÂºÄÂßãÊõ¥Êñ∞ÂõæË°®...');
            
            // Á°Æ‰øùchartsÂØπË±°Â≠òÂú®
            if (!charts) {
                charts = {};
                console.log('üìä chartsÂØπË±°Â∑≤ÂàùÂßãÂåñ');
            }
            
            // Ê£ÄÊü•EChartsÊòØÂê¶Â∑≤Âä†ËΩΩ
            if (typeof echarts === 'undefined' || typeof echarts.init !== 'function') {
                console.error('‚ùå EChartsÂ∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïÊõ¥Êñ∞ÂõæË°®');
                return;
            }
            
            // ÂàùÂßãÂåñÊâÄÊúâÂõæË°®ÔºàÂ¶ÇÊûúÂ∞öÊú™ÂàùÂßãÂåñÔºâ
            const chartConfigs = [
                { name: 'equity', container: 'equityChart', updateFn: updateEquityChart },
                { name: 'radar', container: 'radarChart', updateFn: updateRadarChart },
                { name: 'returnDist', container: 'returnDistChart', updateFn: updateReturnDistChart },
                { name: 'kline', container: 'klineChart', updateFn: updateKlineChart }
            ];
            
            chartConfigs.forEach(config => {
                if (!charts[config.name]) {
                    const container = document.getElementById(config.container);
                    console.log(`üìä ÂàùÂßãÂåñÂõæË°® ${config.name}: ÂÆπÂô®=${!!container}`);
                    if (container && typeof echarts !== 'undefined' && echarts.init) {
                        try {
                            charts[config.name] = echarts.init(container);
                            console.log(`‚úÖ ${config.name} ÂõæË°®ÂàùÂßãÂåñÊàêÂäü`);
                        } catch (error) {
                            console.error(`‚ùå ${config.name} ÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•:`, error);
                        }
                    } else {
                        console.error(`‚ùå Êó†Ê≥ïÂàùÂßãÂåñÂõæË°® ${config.name}: ÂÆπÂô®ÊàñECharts‰∏çÂèØÁî®`);
                    }
                }
            });
            
            console.log('üìä ÂºÄÂßãÊõ¥Êñ∞ÂÖ∑‰ΩìÂõæË°®...');
            
            // ÂàÜÊâπÊõ¥Êñ∞ÂõæË°®‰ª•ÈÅøÂÖçUIÈòªÂ°ûÔºå‰ΩøÁî®requestAnimationFrame‰ºòÂåñÊÄßËÉΩ
            const updateChartSequence = () => {
                // ‰ΩøÁî® requestAnimationFrame ‰ºòÂåñÊÄßËÉΩ
                requestAnimationFrame(() => {
                    updateEquityChart();
                    
                    requestAnimationFrame(() => {
                        updateRadarChart();
                        
                        requestAnimationFrame(() => {
                            updateReturnDistChart();
                            
                            requestAnimationFrame(() => {
                                updateKlineChart();
                                console.log('‚úÖ ÊâÄÊúâÂõæË°®Êõ¥Êñ∞ÂÆåÊàê');
                            });
                        });
                    });
                });
            };
            
            // Âª∂ËøüÊâßË°å‰ª•ÂÖÅËÆ∏È°µÈù¢ÂìçÂ∫î
            setTimeout(updateChartSequence, 10);
        }

        function updateEquityChart() {
            // Ê£ÄÊü•ÂõæË°®ÂØπË±°ÊòØÂê¶Â≠òÂú®
            if (!charts || !charts.equity) {
                console.warn('‚ö†Ô∏è ÊùÉÁõäÂõæË°®ÂØπË±°‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊõ¥Êñ∞');
                return;
            }
            
            // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ÂèØÁî®
            if (!stockData || stockData.length === 0) {
                console.warn('‚ö†Ô∏è ËÇ°Á•®Êï∞ÊçÆ‰∏çÂèØÁî®ÔºåË∑≥ËøáÊõ¥Êñ∞');
                return;
            }
            
            const dates = stockData.map(d => d.date);
            const benchmark = stockData.map(d => Number(((d.close - stockData[0].close) / stockData[0].close) * 100).toFixed(2)).map(Number);
            
            const series = [{
                name: 'Âü∫ÂáÜÊî∂Áõä',
                type: 'line',
                data: benchmark,
                lineStyle: { width: 2, color: '#888', type: 'dashed' },
                symbol: 'none'
            }];
            
            const colors = ['#667eea', '#f093fb', '#38ef7d', '#ffa502', '#ff4757', '#00f2fe'];
            let colorIdx = 0;
            
            Object.entries(strategyResults).forEach(([key, result]) => {
                const equityCurve = result.equity.slice(1).map(e => 
                    Number(((e - result.initCapital) / result.initCapital) * 100).toFixed(2)
                ).map(Number);
                
                series.push({
                    name: result.name,
                    type: 'line',
                    data: equityCurve,
                    lineStyle: { width: 2, color: colors[colorIdx % colors.length] },
                    symbol: 'none'
                });
                colorIdx++;
            });
            
            charts.equity.setOption({
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(30, 42, 74, 0.95)',
                    borderColor: '#667eea',
                    textStyle: { color: '#fff', fontSize: 12 }
                },
                legend: {
                    data: ['Âü∫ÂáÜÊî∂Áõä', ...Object.values(strategyResults).map(r => r.name)],
                    textStyle: { color: '#888', fontSize: 11 },
                    top: 5
                },
                grid: { left: 50, right: 20, top: 50, bottom: 50 },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#444' } },
                    axisLabel: { color: '#888', fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { lineStyle: { color: '#444' } },
                    axisLabel: { color: '#888', formatter: '{value}%' },
                    splitLine: { lineStyle: { color: '#333', type: 'dashed' } }
                },
                series
            });
        }

        function updateRadarChart() {
            if (!charts || !charts.radar) {
                return;
            }
            
            if (!strategyResults || Object.keys(strategyResults).length === 0) {
                return;
            }
            
            const indicators = [
                { name: 'Êî∂ÁõäÁéá', max: 100 },
                { name: 'Â§èÊôÆÊØîÁéá', max: 3 },
                { name: 'ËÉúÁéá', max: 100 },
                { name: 'Áõà‰∫èÊØî', max: 5 },
                { name: 'Âç°ÁéõÊØîÁéá', max: 5 },
                { name: 'ÂõûÊí§ÊéßÂà∂', max: 100 }
            ];
            
            const data = Object.entries(strategyResults).map(([key, r]) => ({
                name: r.name,
                value: [
                    Number(Math.max(0, r.totalReturn)).toFixed(2),
                    Number(Math.max(0, r.sharpe)).toFixed(2),
                    Number(r.winRate).toFixed(2),
                    Number(Math.min(5, r.profitRatio)).toFixed(2),
                    Number(Math.min(5, r.calmar)).toFixed(2),
                    Number(Math.max(0, 100 - r.maxDrawdown)).toFixed(2)
                ].map(Number)
            }));
            
            charts.radar.setOption({
                backgroundColor: 'transparent',
                tooltip: {},
                legend: {
                    data: data.map(d => d.name),
                    bottom: 5,
                    textStyle: { color: '#888', fontSize: 10 }
                },
                radar: {
                    indicator: indicators,
                    center: ['50%', '45%'],
                    radius: '60%',
                    axisLine: { lineStyle: { color: 'rgba(102, 126, 234, 0.3)' } },
                    splitLine: { lineStyle: { color: 'rgba(102, 126, 234, 0.2)' } },
                    axisName: { color: '#888', fontSize: 10 }
                },
                series: [{
                    type: 'radar',
                    data: data
                }]
            });
        }

        function updateReturnDistChart() {
            // Ê£ÄÊü•ÂõæË°®ÂØπË±°ÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÂàùÂßãÂåñ
            if (!charts || !charts.returnDist) {
                console.warn('‚ö†Ô∏è Êî∂ÁõäÂàÜÂ∏ÉÂõæË°®ÂØπË±°‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÂàùÂßãÂåñ...');
                const container = document.getElementById('returnDistChart');
                if (container && typeof echarts !== 'undefined' && echarts.init) {
                    if (!charts) charts = {};
                    try {
                        charts.returnDist = echarts.init(container);
                    } catch (error) {
                        console.error('‚ùå Êî∂ÁõäÂàÜÂ∏ÉÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                        return;
                    }
                } else {
                    console.error('‚ùå Êó†Ê≥ïÂàùÂßãÂåñÊî∂ÁõäÂàÜÂ∏ÉÂõæË°®');
                    return;
                }
            }
            
            const data = Object.entries(strategyResults)
                .map(([key, r]) => ({ name: r.name, value: Number(r.totalReturn).toFixed(2) }))
                .map(item => ({ name: item.name, value: Number(item.value) }))
                .sort((a, b) => b.value - a.value);
            
            charts.returnDist.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis', formatter: '{b}: {c}%' },
                grid: { left: 100, right: 30, top: 20, bottom: 30 },
                xAxis: {
                    type: 'value',
                    axisLabel: { color: '#888', formatter: '{value}%' },
                    axisLine: { lineStyle: { color: '#444' } },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                yAxis: {
                    type: 'category',
                    data: data.map(d => d.name),
                    axisLabel: { color: '#888', fontSize: 11 },
                    axisLine: { lineStyle: { color: '#444' } }
                },
                series: [{
                    type: 'bar',
                    data: data.map(d => ({
                        value: d.value.toFixed(2),
                        itemStyle: {
                            color: d.value >= 0 ? '#667eea' : '#2ed573'
                        }
                    })),
                    barWidth: 20
                }]
            });
        }

        function updateDetailAnalysis() {
            const strategy = document.getElementById('detailStrategy').value;
            const result = strategyResults[strategy];
            
            if (!result) {
                const detailContent = document.getElementById('detailContent');
                if (detailContent) {
                    detailContent.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #888;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìä</div>
                            <div style="font-size: 16px; margin-bottom: 10px;">ËØ∑ÂÖàËøêË°åÁ≠ñÁï•ÂØπÊØî</div>
                            <div style="font-size: 14px; color: #666;">ÁÇπÂáª"ÂºÄÂßãÁ≠ñÁï•ÂØπÊØî"ÊåâÈíÆÁîüÊàêÂõûÊµãÁªìÊûú</div>
                        </div>
                    `;
                }
                return;
            }
            
            if (stockData.length === 0) {
                console.warn('‚ö†Ô∏è ËÇ°Á•®Êï∞ÊçÆ‰∏∫Á©∫ÔºåËØ∑ÂÖàËé∑ÂèñËÇ°Á•®Êï∞ÊçÆ');
                return;
            }
            
            // Êõ¥Êñ∞ÂõûÊµãÁªìÊûú
            updateDetailResult(result);
            
            // Êõ¥Êñ∞KÁ∫øÂõæ
            updateKlineChart();
            
            // Êõ¥Êñ∞Êî∂ÁõäÁéáÊõ≤Á∫ø
            updateReturnCurveChart();
            
            // Êõ¥Êñ∞‰∫§ÊòìËÆ∞ÂΩï
            updateTradeTable();
            
            console.log('‚úÖ ËØ¶ÁªÜÂàÜÊûêÊõ¥Êñ∞ÂÆåÊàê');
        }

        function updateDetailResult(result) {
            document.getElementById('detailTotalReturn').textContent = result.totalReturn >= 0 ? '+' + result.totalReturn.toFixed(2) + '%' : result.totalReturn.toFixed(2) + '%';
            document.getElementById('detailTotalReturn').className = 'value ' + (result.totalReturn >= 0 ? 'positive' : 'negative');
            
            document.getElementById('detailAnnualReturn').textContent = result.annualReturn >= 0 ? '+' + result.annualReturn.toFixed(2) + '%' : result.annualReturn.toFixed(2) + '%';
            document.getElementById('detailAnnualReturn').className = 'value ' + (result.annualReturn >= 0 ? 'positive' : 'negative');
            
            document.getElementById('detailMaxDrawdown').textContent = '-' + result.maxDrawdown.toFixed(2) + '%';
            document.getElementById('detailMaxDrawdown').className = 'value negative';
            
            document.getElementById('detailWinRate').textContent = result.winRate.toFixed(1) + '%';
            document.getElementById('detailWinRate').className = 'value ' + (result.winRate >= 50 ? 'positive' : 'neutral');
            
            document.getElementById('detailProfitLossRatio').textContent = result.profitRatio.toFixed(2);
            document.getElementById('detailProfitLossRatio').className = 'value ' + (result.profitRatio >= 1 ? 'positive' : 'neutral');
            
            document.getElementById('detailTradeCount').textContent = result.tradeCount;
            document.getElementById('detailTradeCount').className = 'value neutral';
        }

        function updateKlineChart() {
            const strategy = document.getElementById('detailStrategy').value;
            const result = strategyResults[strategy];
            
            if (!result || stockData.length === 0) return;
            
            // Ê£ÄÊü•ÂõæË°®ÂØπË±°ÊòØÂê¶Â≠òÂú®
            if (!charts || !charts.kline) {
                console.warn('‚ö†Ô∏è KÁ∫øÂõæË°®ÂØπË±°‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÂàùÂßãÂåñ...');
                const klineContainer = document.getElementById('klineChart');
                if (klineContainer && typeof echarts !== 'undefined' && echarts.init) {
                    if (!charts) charts = {};
                    try {
                        charts.kline = echarts.init(klineContainer);
                    } catch (error) {
                        console.error('‚ùå KÁ∫øÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                        return;
                    }
                } else {
                    console.error('‚ùå Êó†Ê≥ïÂàùÂßãÂåñKÁ∫øÂõæË°®');
                    return;
                }
            }
            
            // ‰øùÂ≠òÂΩìÂâçstockDataÂºïÁî®‰æõformatterÂáΩÊï∞‰ΩøÁî®
            const currentStockData = stockData;
            
            const dates = stockData.map(d => d.date);
            const ohlc = stockData.map(d => [d.open, d.close, d.low, d.high]);
            const volumes = stockData.map((d, i) => ({
                value: d.volume,
                itemStyle: { color: d.close >= d.open ? 'rgba(255,71,87,0.6)' : 'rgba(46,213,115,0.6)' }
            }));
            
            const priceRange = Math.max(...stockData.map(d => d.high)) - Math.min(...stockData.map(d => d.low));
            const minPrice = Math.min(...stockData.map(d => d.low));
            const numPriceBins = 50;
            const priceBinSize = priceRange / numPriceBins;
            const priceBins = [];
            for (let i = 0; i < numPriceBins; i++) {
                priceBins.push(minPrice + (i + 0.5) * priceBinSize);
            }
            
            const chipHeatmapData = [];
            const lookbackDays = 60;
            for (let i = 0; i < stockData.length; i++) {
                const recentData = stockData.slice(Math.max(0, i - lookbackDays + 1), i + 1);
                
                if (recentData.length >= 30) {
                    const volumeBins = new Array(numPriceBins).fill(0);
                    recentData.forEach(d => {
                        const price = d.close;
                        const binIndex = Math.min(Math.floor((price - minPrice) / priceBinSize), numPriceBins - 1);
                        volumeBins[binIndex] += d.volume;
                    });
                    
                    const totalVolume = volumeBins.reduce((sum, vol) => sum + vol, 0);
                    if (totalVolume > 0) {
                        for (let j = 0; j < numPriceBins; j++) {
                            const percentage = (volumeBins[j] / totalVolume) * 100;
                            if (percentage >= 0.5) {
                                chipHeatmapData.push([i, j, percentage]);
                            }
                        }
                    }
                }
            }
            
            console.log('üìä Á≠πÁ†ÅÁÉ≠ÂäõÂõæÊï∞ÊçÆ:', chipHeatmapData);
            window.currentChipData = chipHeatmapData;
            
            const buyMarks = result.signals.filter(s => s.type === 'buy').map(s => {
                const dataIndex = stockData.findIndex(d => d.date === s.date);
                if (dataIndex === -1) return null;
                const data = stockData[dataIndex];
                return {
                    coord: [s.date, data.low * 0.995],
                    symbol: 'path://M0,10 L5,0 L10,10 Z',
                    symbolSize: 12,
                    itemStyle: { color: '#ff4757' },
                    label: { 
                        show: true, 
                        formatter: 'B', 
                        color: '#ff4757', 
                        fontSize: 11, 
                        fontWeight: 'bold', 
                        position: 'bottom',
                        offset: [0, 5]
                    }
                };
            }).filter(Boolean);
            
            const sellMarks = result.signals.filter(s => s.type === 'sell').map(s => {
                const dataIndex = stockData.findIndex(d => d.date === s.date);
                if (dataIndex === -1) return null;
                const data = stockData[dataIndex];
                return {
                    coord: [s.date, data.high * 1.005],
                    symbol: 'path://M0,0 L5,10 L10,0 Z',
                    symbolSize: 12,
                    itemStyle: { color: '#2ed573' },
                    label: { 
                        show: true, 
                        formatter: 'S', 
                        color: '#2ed573', 
                        fontSize: 11, 
                        fontWeight: 'bold', 
                        position: 'top',
                        offset: [0, -5]
                    }
                };
            }).filter(Boolean);
            
            const ma5 = stockData.map(d => d.ma5);
            const ma10 = stockData.map(d => d.ma10);
            const ma20 = stockData.map(d => d.ma20);
            const ma30 = stockData.map(d => d.ma30);

            // Ëé∑ÂèñÂΩìÂâçËÇ°Á•®ÂêçÁß∞
            const stockName = document.getElementById('stockName')?.textContent || '';
            const titleText = stockName ? `${stockName} (${currentStockInfo.tsCode})` : currentStockInfo.tsCode;

            // ÂÆö‰πâÊõ¥Êñ∞Â§¥ÈÉ®‰ø°ÊÅØÁöÑÂáΩÊï∞
            const updateHeaderInfo = (index) => {
                const data = currentStockData[index];
                if (!data) return;
                
                const headerDiv = document.getElementById('kline-header-info');
                if (!headerDiv) return;
                
                const closeColor = data.close >= data.open ? '#ff4757' : '#2ed573';
                const pctColor = data.pctChange >= 0 ? '#ff4757' : '#2ed573';
                
                let html = `<div style="display:flex; gap:14px; flex-wrap:nowrap; align-items:baseline; overflow-x:auto; white-space:nowrap;">`;
                html += `<span style="font-weight: bold; color: #e0e0e0; font-size: 18px;">${titleText}</span>`;
                html += `<span style="color: #ccc; font-size: 14px;">${data.date}</span>`;
                html += `<span>ÂºÄ:<span style="color:${closeColor}; font-weight:700;">${data.open.toFixed(2)}</span></span>`;
                html += `<span>È´ò:<span style="color:${closeColor}; font-weight:700;">${data.high.toFixed(2)}</span></span>`;
                html += `<span>‰Ωé:<span style="color:${closeColor}; font-weight:700;">${data.low.toFixed(2)}</span></span>`;
                html += `<span>Êî∂:<span style="color:${closeColor}; font-weight:700;">${data.close.toFixed(2)}</span></span>`;
                if (data.pctChange !== undefined) {
                    html += `<span>ÂπÖ:<span style="color:${pctColor}; font-weight:700;">${data.pctChange.toFixed(2)}%</span></span>`;
                }
                html += `<span>Èáè:<span style="color:#70a1ff; font-weight:700;">${(data.volume/10000).toFixed(0)}‰∏á</span></span>`;
                if (data.turnover) html += `<span>Êç¢:<span style="color:#ffa502; font-weight:700;">${data.turnover.toFixed(2)}%</span></span>`;
                html += `</div>`;

                html += `<div style="margin-top: 6px; display:flex; gap: 14px; flex-wrap:nowrap; overflow-x:auto; white-space:nowrap;">`;
                if (data.ma5) html += `<span>MA5:<span style="color:#FFD700; font-weight:700;">${data.ma5.toFixed(2)}</span></span>`;
                if (data.ma10) html += `<span>MA10:<span style="color:#00BFFF; font-weight:700;">${data.ma10.toFixed(2)}</span></span>`;
                if (data.ma20) html += `<span>MA20:<span style="color:#FF00FF; font-weight:700;">${data.ma20.toFixed(2)}</span></span>`;
                if (data.ma30) html += `<span>MA30:<span style="color:#00FF00; font-weight:700;">${data.ma30.toFixed(2)}</span></span>`;
                html += `</div>`;
                
                headerDiv.innerHTML = html;
            };

            // ÂàùÂßãÂåñÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ
            if (currentStockData.length > 0) {
                updateHeaderInfo(currentStockData.length - 1);
            }

            try {
                const savedZoom = loadKlineZoomState();
                const zoomStart = savedZoom ? savedZoom.start : 0;
                const zoomEnd = savedZoom ? savedZoom.end : 100;
                charts.kline.setOption({
                    title: { show: false },
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        backgroundColor: 'rgba(30, 42, 74, 0.95)',
                        borderColor: '#667eea',
                        textStyle: { color: '#fff' },
                        // ÁÆÄÂåñ tooltipÔºåÂõ†‰∏∫Â§¥ÈÉ®Â∑≤ÁªèÊòæÁ§∫‰∫ÜËØ¶ÁªÜ‰ø°ÊÅØ
                        formatter: function(params) {
                            return ''; // ÈöêËóè tooltip ÂÜÖÂÆπÔºåÂè™‰øùÁïôÂçÅÂ≠óÂÖâÊ†á
                        },
                        showContent: false // ÂÆåÂÖ®ÈöêËóè tooltip ÂÜÖÂÆπÊ°Ü
                    },
                    legend: {
                        data: [
                            { name: '‰π∞ÂÖ•‰ø°Âè∑', icon: 'path://M0,10 L5,0 L10,10 Z', itemStyle: { color: '#ff4757' } },
                            { name: 'ÂçñÂá∫‰ø°Âè∑', icon: 'path://M0,0 L5,10 L10,0 Z', itemStyle: { color: '#2ed573' } }
                        ],
                        textStyle: { color: '#888' },
                        itemWidth: 10,
                        itemHeight: 10,
                        top: 5,
                        right: 10 // Âõæ‰æãÈù†Âè≥ÔºåÈÅøÂÖçÈÅÆÊå°Â§¥ÈÉ®‰ø°ÊÅØ
                    },
                    grid: [
                        { left: 50, right: 50, top: 65, height: '50%' }, // Â¢ûÂä† top ‰ª•ÂÆπÁ∫≥Â§¥ÈÉ®‰ø°ÊÅØ
                        { left: 50, right: 50, top: '63%', height: '18%' }
                    ],
                    xAxis: [
                        { type: 'category', data: dates, gridIndex: 0, axisLabel: { show: false }, axisLine: { lineStyle: { color: '#444' } } },
                        { type: 'category', data: dates, gridIndex: 1, axisLabel: { color: '#888', fontSize: 10 }, axisLine: { lineStyle: { color: '#444' } } }
                    ],
                    yAxis: [
                        { scale: true, gridIndex: 0, axisLabel: { color: '#888' }, splitLine: { lineStyle: { color: '#333' } }, axisLine: { lineStyle: { color: '#444' } } },
                        { scale: true, gridIndex: 1, axisLabel: { color: '#888', formatter: v => (v/10000).toFixed(0) + '‰∏á' }, splitLine: { show: false }, axisLine: { lineStyle: { color: '#444' } } }
                    ],
                    dataZoom: [
                        { type: 'inside', xAxisIndex: [0,1], start: zoomStart, end: zoomEnd, zoomOnMouseWheel: false, moveOnMouseWheel: false },
                        { 
                            show: true, 
                            xAxisIndex: [0,1], 
                            type: 'slider', 
                            start: zoomStart,
                            end: zoomEnd,
                            bottom: 5, 
                            height: 25, // Â¢ûÂä†È´òÂ∫¶ÔºåÊõ¥ÂÆπÊòìÁÇπÂáª
                            handleSize: '120%', // Â¢ûÂ§ß‰∏§Á´ØÊâãÊüÑÂ§ßÂ∞è
                            handleStyle: {
                                color: '#667eea', // ËÆæÁΩÆÊâãÊüÑÈ¢úËâ≤ÔºåÊõ¥ÊòéÊòæ
                                shadowBlur: 3,
                                shadowColor: 'rgba(0, 0, 0, 0.6)',
                                shadowOffsetX: 2,
                                shadowOffsetY: 2
                            },
                            textStyle: { color: '#ccc' }, // ÊñáÂ≠óÈ¢úËâ≤
                            borderColor: '#444', // ËæπÊ°ÜÈ¢úËâ≤
                            dataBackground: { // Êï∞ÊçÆËÉåÊôØÂå∫ÂüüÊ†∑Âºè
                                lineStyle: { color: '#555' },
                                areaStyle: { color: '#333' }
                            },
                            selectedDataBackground: { // ÈÄâ‰∏≠Âå∫ÂüüÊ†∑Âºè
                                lineStyle: { color: '#667eea' },
                                areaStyle: { color: 'rgba(102, 126, 234, 0.2)' }
                            }
                        }
                    ],
                    series: [
                        {
                            name: 'KÁ∫ø',
                            type: 'candlestick',
                            data: ohlc,
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            itemStyle: { color: '#ff4757', color0: '#2ed573', borderColor: '#ff4757', borderColor0: '#2ed573' },
                            markPoint: { data: [...buyMarks, ...sellMarks] }
                        },
                        {
                            name: 'MA5',
                            type: 'line',
                            data: ma5,
                            smooth: true,
                            symbol: 'none',
                            lineStyle: { width: 1, color: '#FFD700' },
                            xAxisIndex: 0,
                            yAxisIndex: 0
                        },
                        {
                            name: 'MA10',
                            type: 'line',
                            data: ma10,
                            smooth: true,
                            symbol: 'none',
                            lineStyle: { width: 1, color: '#00BFFF' },
                            xAxisIndex: 0,
                            yAxisIndex: 0
                        },
                        {
                            name: 'MA20',
                            type: 'line',
                            data: ma20,
                            smooth: true,
                            symbol: 'none',
                            lineStyle: { width: 1, color: '#FF00FF' },
                            xAxisIndex: 0,
                            yAxisIndex: 0
                        },
                        {
                            name: 'MA30',
                            type: 'line',
                            data: ma30,
                            smooth: true,
                            symbol: 'none',
                            lineStyle: { width: 1, color: '#00FF00' },
                            xAxisIndex: 0,
                            yAxisIndex: 0
                        },
                        { 
                            name: 'Êàê‰∫§Èáè', 
                            type: 'bar', 
                            data: volumes, 
                            xAxisIndex: 1, 
                            yAxisIndex: 1 
                        },
                        {
                            name: '‰π∞ÂÖ•‰ø°Âè∑',
                            type: 'scatter',
                            data: [],
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            itemStyle: { color: '#ff4757' },
                            symbol: 'path://M0,10 L5,0 L10,10 Z',
                            symbolSize: 10
                        },
                        {
                            name: 'ÂçñÂá∫‰ø°Âè∑',
                            type: 'scatter',
                            data: [],
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            itemStyle: { color: '#2ed573' },
                            symbol: 'path://M0,0 L5,10 L10,0 Z',
                            symbolSize: 10
                        }
                    ]
                });
                
                // Ê∑ªÂä†KÁ∫øÂõæ‰∏éÁ≠πÁ†ÅÂõæÁöÑËÅîÂä®
                charts.kline.off('updateAxisPointer');
                charts.kline.on('updateAxisPointer', function (event) {
                    const dataIndex = event.dataIndex;
                    if (dataIndex != null) {
                        // ‰ΩøÁî® requestAnimationFrame ÈÅøÂÖçÈ¢ëÁπÅÊõ¥Êñ∞ÂØºËá¥ÁöÑÂç°È°ø
                        requestAnimationFrame(() => {
                            updateHeaderInfo(dataIndex);
                            updateChipChart(dataIndex);
                        });
                    }
                });

                charts.kline.off('globalout');
                charts.kline.on('globalout', function () {
                    // Èº†Ê†áÁßªÂá∫Êó∂ÊÅ¢Â§çÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ
                    if (currentStockData.length > 0) {
                        const lastIndex = currentStockData.length - 1;
                        updateHeaderInfo(lastIndex);
                        // ‰πüÂèØ‰ª•ÈÄâÊã©ÊÅ¢Â§çÁ≠πÁ†ÅÂõæÂà∞ÊúÄÊñ∞Êó•ÊúüÔºåÊàñËÄÖ‰øùÊåÅ‰∏çÂä®
                        // updateChipChart(lastIndex); 
                    }
                });
                
                // Áº©ÊîæÊó∂ÂêåÊ≠• Y ËΩ¥
                charts.kline.off('datazoom');
                charts.kline.on('datazoom', function () {
                    persistKlineZoomStateFromChart();
                });
                
                // ÂàùÂßãÂåñÊòæÁ§∫ÊúÄÂêé‰∏ÄÂ§©ÁöÑÁ≠πÁ†Å
                if (stockData.length > 0) {
                    setTimeout(() => {
                        updateChipChart(stockData.length - 1);
                    }, 100);
                }
                
            } catch (error) {
                console.error('‚ùå KÁ∫øÂõæË°®Êõ¥Êñ∞Â§±Ë¥•:', error);
            }
        }

        function updateTradeTable() {
            const strategy = document.getElementById('detailStrategy').value;
            const result = strategyResults[strategy];
            
            console.log('üîÑ Êõ¥Êñ∞‰∫§ÊòìËÆ∞ÂΩï:', strategy);
            console.log('üìä ‰∫§ÊòìÊï∞ÊçÆ:', result?.trades);
            
            if (!result) {
                console.warn('‚ö†Ô∏è Á≠ñÁï•ÁªìÊûú‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊõ¥Êñ∞‰∫§ÊòìËÆ∞ÂΩï');
                return;
            }
            
            const tbody = document.getElementById('tradeBody');
            
            if (!result.trades || result.trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;">ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï</td></tr>';
                console.warn('‚ö†Ô∏è ‰∫§ÊòìËÆ∞ÂΩï‰∏∫Á©∫');
                return;
            }
            
            tbody.innerHTML = result.trades.map((t, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${t.date}</td>
                    <td class="${t.type === 'buy' ? 'positive' : 'negative'}">${t.type === 'buy' ? 'üî∫‰π∞ÂÖ•' : 'üîªÂçñÂá∫'}</td>
                    <td>¬•${t.price.toFixed(2)}</td>
                    <td>${t.shares || '--'}</td>
                    <td>¬•${(t.amount || 0).toFixed(0)}</td>
                    <td>${(t.position * 100).toFixed(0)}%</td>
                    <td class="${(t.profit || 0) >= 0 ? 'positive' : 'negative'}">${t.profit ? (t.profit >= 0 ? '+' : '') + t.profit.toFixed(2) + '%' : '--'}</td>
                    <td>${t.holdDays || '--'}</td>
                    <td>${t.reason || '--'}</td>
                </tr>
            `).join('');
            
            console.log('‚úÖ ‰∫§ÊòìËÆ∞ÂΩïÊõ¥Êñ∞ÂÆåÊàêÔºåÂÖ±', result.trades.length, 'Êù°ËÆ∞ÂΩï');
        }

        // ===================== Á≠πÁ†ÅÂàÜÂ∏ÉÂõæË°® =====================
        function calculateChipDistribution(data, currentIndex) {
            const chipLife = 360;
            const decayFactor = 0.99;
            const numBins = 120;
            
            const startIndex = Math.max(0, currentIndex - chipLife);
            const slice = data.slice(startIndex, currentIndex + 1);
            const lows = slice.map(item => item.low).filter(v => Number.isFinite(v));
            const highs = slice.map(item => item.high).filter(v => Number.isFinite(v));
            if (!lows.length || !highs.length) return [];
            
            const minPrice = Math.min(...lows);
            const maxPrice = Math.max(...highs);
            if (minPrice === maxPrice) return [];
            
            const binSize = (maxPrice - minPrice) / numBins;
            const binCenters = new Array(numBins);
            for (let i = 0; i < numBins; i++) {
                binCenters[i] = minPrice + (i + 0.5) * binSize;
            }
            
            const chipVolumes = new Array(numBins).fill(0);
            let volEma = null;
            
            for (let i = 0; i < slice.length; i++) {
                const day = slice[i];
                if (!day) continue;
                const low = day.low;
                const high = day.high;
                const close = day.close;
                if (!Number.isFinite(low) || !Number.isFinite(high)) continue;

                const volume = day.volume;
                if (Number.isFinite(volume) && volume > 0) {
                    volEma = volEma === null ? volume : (volEma * 0.9 + volume * 0.1);
                }
                
                const turnover = day.turnover;
                const turnoverValid = Number.isFinite(turnover) && turnover > 0 && turnover <= 100;
                let turnoverRatio = turnoverValid
                    ? (turnover / 100)
                    : (volEma && Number.isFinite(volume) && volume > 0 ? (0.01 * (volume / volEma)) : (1 - decayFactor));
                turnoverRatio = Math.min(Math.max(turnoverRatio, 0.002), 0.08);
                const dailyDecay = 1 - Math.min(Math.max(turnoverRatio, 0.001), 1);
                for (let k = 0; k < chipVolumes.length; k++) {
                    chipVolumes[k] *= dailyDecay;
                }
                
                const dayLow = Math.min(low, high);
                const dayHigh = Math.max(low, high);
                
                if (dayHigh === dayLow) {
                    const idx = Math.min(numBins - 1, Math.max(0, Math.floor((dayHigh - minPrice) / binSize)));
                    chipVolumes[idx] += turnoverRatio;
                    continue;
                }
                
                const typicalPrice = Number.isFinite(close)
                    ? (dayHigh + dayLow + close) / 3
                    : (dayHigh + dayLow) / 2;
                
                const rangeWidth = dayHigh - dayLow;
                const sigma = Math.max(rangeWidth / 20, typicalPrice * 0.002);
                if (sigma <= 0) {
                    const idx = Math.min(numBins - 1, Math.max(0, Math.floor((typicalPrice - minPrice) / binSize)));
                    chipVolumes[idx] += turnoverRatio;
                    continue;
                }
                
                const weights = new Array(numBins).fill(0);
                let weightSum = 0;
                for (let b = 0; b < numBins; b++) {
                    const price = binCenters[b];
                    if (price < dayLow || price > dayHigh) continue;
                    const z = (price - typicalPrice) / sigma;
                    if (Math.abs(z) > 2.5) continue;
                    const w = Math.exp(-0.5 * z * z);
                    weights[b] = w;
                    weightSum += w;
                }
                if (weightSum <= 0) continue;
                for (let b = 0; b < numBins; b++) {
                    if (weights[b] <= 0) continue;
                    chipVolumes[b] += turnoverRatio * (weights[b] / weightSum);
                }
            }
            
            return binCenters.map((price, i) => ({ price: parseFloat(price.toFixed(2)), volume: chipVolumes[i] }));
        }

        function updateChipChart(dataIndex) {
            if (!charts || !charts.chip || !stockData || stockData.length === 0) return;
            
            const currentDate = stockData[dataIndex].date;
            const currentClose = stockData[dataIndex].close;
            const chipData = calculateChipDistribution(stockData, dataIndex);
            
            // Ëé∑Âèñ K Á∫øÂõæÁöÑ Y ËΩ¥ËåÉÂõ¥Ôºå‰ª•ÂÆûÁé∞ÂêåÊ≠•
            let yMin = null;
            let yMax = null;
            
            if (charts.kline) {
                try {
                    const klineModel = charts.kline.getModel();
                    if (klineModel) {
                        const yAxisComponent = klineModel.getComponent('yAxis', 0);
                        if (yAxisComponent) {
                            const axis = yAxisComponent.axis;
                            const extent = axis.scale.getExtent();
                            yMin = extent[0];
                            yMax = extent[1];
                        }
                    }
                } catch (e) {
                    console.warn('Êó†Ê≥ïËé∑ÂèñKÁ∫øÂõæYËΩ¥ËåÉÂõ¥', e);
                }
            }
            
            if (yMin === null || yMax === null) {
                 yMin = currentClose * 0.8;
                 yMax = currentClose * 1.2;
            }
            
            // ËÆ°ÁÆó‰ª∑Ê†ºÊ≠•Èïø
            const stepPrice = chipData.length > 1 ? (chipData[1].price - chipData[0].price) : (yMax - yMin) / 50;
            const maxVol = Math.max(...chipData.map(d => d.volume));
            const filteredData = chipData.filter(d => d.volume > maxVol * 0.005);
            
            // ËÆ°ÁÆóÁªüËÆ°ÊåáÊ†á
            const totalVolume = chipData.reduce((sum, item) => sum + item.volume, 0);
            
            // Ëé∑Âà©ÊØî‰æã
            const profitVolume = chipData
                .filter(item => item.price <= currentClose)
                .reduce((sum, item) => sum + item.volume, 0);
            const profitRatio = totalVolume > 0 ? (profitVolume / totalVolume * 100).toFixed(1) : '0.0';
            
            // Âπ≥ÂùáÊàêÊú¨
            const weightedSum = chipData.reduce((sum, item) => sum + item.price * item.volume, 0);
            const avgCost = totalVolume > 0 ? (weightedSum / totalVolume) : 0;
            const avgCostText = avgCost > 0 ? avgCost.toFixed(2) : '0.00';
            
            // ÈõÜ‰∏≠Â∫¶ËÆ°ÁÆó
            chipData.sort((a, b) => a.price - b.price); // Á°Æ‰øùÊúâÂ∫è
            
            function getConcentrationRange(percent) {
                if (totalVolume === 0) return { start: 0, end: 0, ratio: 0 };
                const targetVol = totalVolume * percent;
                const excludeVol = (totalVolume - targetVol) / 2;
                
                let currentVol = 0;
                let startPrice = null;
                let endPrice = null;
                
                for (const item of chipData) {
                    currentVol += item.volume;
                    if (startPrice === null && currentVol >= excludeVol) {
                        startPrice = item.price;
                    }
                    if (endPrice === null && currentVol >= (totalVolume - excludeVol)) {
                        endPrice = item.price;
                        break;
                    }
                }
                
                if (startPrice === null && chipData.length > 0) startPrice = chipData[0].price;
                if (endPrice === null && chipData.length > 0) endPrice = chipData[chipData.length - 1].price;
                
                // ÈÄöËææ‰ø°ÁÆóÊ≥ïÔºö(High - Low) / (High + Low)
                const sumPrice = startPrice + endPrice;
                const ratio = sumPrice > 0 ? (endPrice - startPrice) / sumPrice : 0;
                
                return { 
                    start: startPrice ? startPrice.toFixed(2) : '0.00', 
                    end: endPrice ? endPrice.toFixed(2) : '0.00',
                    ratio: (ratio * 100).toFixed(2)
                };
            }
            
            const c90 = getConcentrationRange(0.90);
            const c70 = getConcentrationRange(0.70);

            // ÂáÜÂ§áÊï∞ÊçÆÔºåÂåÖÂê´È¢úËâ≤‰ø°ÊÅØ
            let maxVolAbove = 0;
            let maxVolAbovePrice = null;
            let maxVolBelow = 0;
            let maxVolBelowPrice = null;

            const seriesData = filteredData.map(item => {
                const isProfit = item.price <= currentClose;
                
                // Êü•ÊâæÂéãÂäõ‰ΩçÂíåÊîØÊíë‰Ωç
                if (!isProfit) { // ÂéãÂäõ‰ΩçÔºàÂ•óÁâ¢ÁõòÔºå‰ª∑Ê†ºÈ´ò‰∫éÂΩìÂâç‰ª∑Ôºâ
                    if (item.volume > maxVolAbove) {
                        maxVolAbove = item.volume;
                        maxVolAbovePrice = item.price;
                    }
                } else { // ÊîØÊíë‰ΩçÔºàËé∑Âà©ÁõòÔºå‰ª∑Ê†º‰Ωé‰∫éÂΩìÂâç‰ª∑Ôºâ
                    if (item.volume > maxVolBelow) {
                        maxVolBelow = item.volume;
                        maxVolBelowPrice = item.price;
                    }
                }

                // Á∫¢Ëâ≤: #ff4757 (Ëé∑Âà©Áõò), ÁªøËâ≤: #2ed573 (Â•óÁâ¢Áõò)
                const colorStart = isProfit ? 'rgba(255, 71, 87, 0.8)' : 'rgba(46, 213, 115, 0.8)';
                const colorEnd = isProfit ? 'rgba(255, 71, 87, 0.2)' : 'rgba(46, 213, 115, 0.2)';
                
                return {
                    value: [item.volume, item.price],
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(1, 0, 0, 0, [
                            { offset: 0, color: colorStart },
                            { offset: 1, color: colorEnd }
                        ])
                    }
                };
            });

            const legendData = ['Ëé∑Âà©Áõò', 'Â•óÁâ¢Áõò'];
            const pressureMarkLineData = [];
            const supportMarkLineData = [];

            if (maxVolAbovePrice !== null) {
                legendData.push('ÂéãÂäõÁ∫ø');
                pressureMarkLineData.push({
                    yAxis: maxVolAbovePrice,
                    label: {
                        formatter: `ÂéãÂäõ‰Ωç: ${maxVolAbovePrice.toFixed(2)}`,
                        position: 'start',
                        color: '#2ed573',
                        fontSize: 11,
                        fontWeight: 'bold'
                    },
                    lineStyle: { color: '#2ed573', type: 'dashed', width: 2 }
                });
            }

            if (maxVolBelowPrice !== null) {
                legendData.push('ÊîØÊíëÁ∫ø');
                supportMarkLineData.push({
                    yAxis: maxVolBelowPrice,
                    label: {
                        formatter: `ÊîØÊíë‰Ωç: ${maxVolBelowPrice.toFixed(2)}`,
                        position: 'start',
                        color: '#ff4757',
                        fontSize: 11,
                        fontWeight: 'bold'
                    },
                    lineStyle: { color: '#ff4757', type: 'dashed', width: 2 }
                });
            }

            const isLightTheme = (document.documentElement.getAttribute('data-theme') || '').toLowerCase() === 'light';
            const rootStyles = getComputedStyle(document.documentElement);
            const chipTextColor = rootStyles.getPropertyValue('--text').trim() || (isLightTheme ? '#0f172a' : '#eee');
            const chipTextMutedColor = rootStyles.getPropertyValue('--text-muted').trim() || (isLightTheme ? '#334155' : '#ccc');
            const chipTextFaintColor = rootStyles.getPropertyValue('--text-faint').trim() || (isLightTheme ? '#64748b' : '#aaa');
            const chipTextStroke = isLightTheme ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.85)';

            const option = {
                backgroundColor: 'transparent',
                legend: {
                    data: legendData,
                    textStyle: { color: chipTextMutedColor },
                    type: 'scroll',
                    orient: 'horizontal',
                    top: 5,
                    left: 0,
                    right: 0,
                    itemGap: 6,
                    itemWidth: 10,
                    itemHeight: 10,
                    pageIconSize: 10,
                    pageButtonItemGap: 4,
                    pageTextStyle: { color: chipTextFaintColor }
                },
                grid: {
                    left: 0,
                    right: 0,
                    // ÂøÖÈ°ª‰∏é K Á∫øÂõæ‰∏ªÂõæÈÖçÁΩÆÂÆåÂÖ®‰∏ÄËá¥
                    // KÁ∫øÂõæÈÖçÁΩÆ: grid: [{ left: 50, right: 50, top: 50, height: '50%' }, ...]
                    top: 65,  
                    height: '50%' 
                },
                xAxis: {
                    type: 'value',
                    show: false,
                    min: 0,
                    max: maxVol * 1.2, // ÁïôÂá∫Á©∫Èó¥
                    inverse: true,
                    axisLine: { show: false },
                    splitLine: { show: false }
                },
                yAxis: {
                    type: 'value',
                    show: false,
                    min: yMin,
                    max: yMax,
                    scale: true, // Âº∫Âà∂‰∏çËÑ±Á¶ªÂàªÂ∫¶
                    axisLine: { show: false },
                    splitLine: { show: false }
                },
                graphic: [
                    {
                        type: 'group',
                        left: 10,
                        bottom: 30, // Á®çÂæÆ‰∏äÁßª‰∏ÄÁÇπÔºåÈÅøÂÖçÂ§™Ë¥¥Â∫ï
                        children: [
                            {
                                type: 'text',
                                z: 101,
                                left: 0,
                                top: 0,
                                style: {
                                    text: [
                                        `Êó•Êúü: ${currentDate}`,
                                        `Ëé∑Âà©ÊØî‰æã: ${profitRatio}%`,
                                        `Âπ≥ÂùáÊàêÊú¨: ${avgCostText}`,
                                        `ÂéãÂäõ‰Ωç: ${maxVolAbovePrice !== null ? maxVolAbovePrice.toFixed(2) : '--'}`,
                                        `ÊîØÊíë‰Ωç: ${maxVolBelowPrice !== null ? maxVolBelowPrice.toFixed(2) : '--'}`,
                                        `90%Á≠πÁ†ÅÈõÜ‰∏≠Â∫¶: ${c90.ratio}%`,
                                        `70%Á≠πÁ†ÅÈõÜ‰∏≠Â∫¶: ${c70.ratio}%`
                                    ].join('\n'),
                                    font: '12px "Microsoft YaHei", sans-serif',
                                    fill: chipTextColor,
                                    stroke: chipTextStroke,
                                    lineWidth: 3,
                                    lineHeight: 20,
                                    shadowBlur: 1,
                                    shadowColor: isLightTheme ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.8)'
                                }
                            }
                        ]
                    }
                ],
                series: [
                    {
                        name: 'Ëé∑Âà©Áõò',
                        type: 'bar',
                        data: [],
                        itemStyle: { color: '#ff4757' }
                    },
                    {
                        name: 'Â•óÁâ¢Áõò',
                        type: 'bar',
                        data: [],
                        itemStyle: { color: '#2ed573' }
                    },
                    {
                        type: 'custom',
                        data: seriesData,
                        renderItem: function (params, api) {
                            const volume = api.value(0);
                            const price = api.value(1);
                            
                            const start = api.coord([0, price]); 
                            const end = api.coord([volume, price]); 
                            
                            // ËÆ°ÁÆóÈ´òÂ∫¶
                            const size = api.size([0, stepPrice]);
                            const barHeight = Math.max(1, Math.abs(size[1]) * 0.95); // Â¢ûÂä†Â°´ÂÖÖÁéá
                            
                            return {
                                type: 'rect',
                                shape: {
                                    x: Math.min(start[0], end[0]),
                                    y: start[1] - barHeight / 2,
                                    width: Math.abs(end[0] - start[0]),
                                    height: barHeight
                                },
                                style: api.style()
                            };
                        },
                        animation: false
                    },
                    ...(maxVolAbovePrice !== null ? [{
                        name: 'ÂéãÂäõÁ∫ø',
                        type: 'line',
                        data: [],
                        showSymbol: false,
                        silent: true,
                        lineStyle: { color: '#2ed573', type: 'dashed', width: 2 },
                        markLine: {
                            symbol: 'none',
                            silent: true,
                            data: pressureMarkLineData
                        }
                    }] : []),
                    ...(maxVolBelowPrice !== null ? [{
                        name: 'ÊîØÊíëÁ∫ø',
                        type: 'line',
                        data: [],
                        showSymbol: false,
                        silent: true,
                        lineStyle: { color: '#ff4757', type: 'dashed', width: 2 },
                        markLine: {
                            symbol: 'none',
                            silent: true,
                            data: supportMarkLineData
                        }
                    }] : [])
                ]
            };
            
            charts.chip.setOption(option);
        }

        function updateReturnCurveChart() {
            const strategy = document.getElementById('detailStrategy').value;
            const result = strategyResults[strategy];
            
            console.log('üîÑ Êõ¥Êñ∞Êî∂ÁõäÁéáÊõ≤Á∫ø:', strategy);
            console.log('üìä Á≠ñÁï•ÁªìÊûú:', result);
            console.log('üìà ËÇ°Á•®Êï∞ÊçÆÈïøÂ∫¶:', stockData.length);
            
            if (!result) {
                console.warn('‚ö†Ô∏è Á≠ñÁï•ÁªìÊûú‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊõ¥Êñ∞Êî∂ÁõäÁéáÊõ≤Á∫ø');
                return;
            }
            
            if (stockData.length === 0) {
                console.warn('‚ö†Ô∏è ËÇ°Á•®Êï∞ÊçÆ‰∏∫Á©∫ÔºåÊó†Ê≥ïÊõ¥Êñ∞Êî∂ÁõäÁéáÊõ≤Á∫ø');
                return;
            }
            
            // Ê£ÄÊü•ÂõæË°®ÂØπË±°ÊòØÂê¶Â≠òÂú®
            if (!charts || !charts.returnCurve) {
                console.warn('‚ö†Ô∏è Êî∂ÁõäÁéáÊõ≤Á∫øÂõæË°®ÂØπË±°‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÂàùÂßãÂåñ...');
                const returnCurveContainer = document.getElementById('returnCurveChart');
                if (returnCurveContainer && typeof echarts !== 'undefined' && echarts.init) {
                    if (!charts) charts = {};
                    try {
                        charts.returnCurve = echarts.init(returnCurveContainer);
                    } catch (error) {
                        console.error('‚ùå Êî∂ÁõäÁéáÊõ≤Á∫øÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                        return;
                    }
                } else {
                    console.error('‚ùå Êó†Ê≥ïÂàùÂßãÂåñÊî∂ÁõäÁéáÊõ≤Á∫øÂõæË°®');
                    return;
                }
            }
            
            const dates = stockData.map(d => d.date);
            const returns = [];
            
            console.log('üìä ÂºÄÂßãËÆ°ÁÆóÊî∂ÁõäÁéáÊõ≤Á∫ø...');
            console.log('üìä ÊùÉÁõäÊï∞ÊçÆ:', result.equity);
            
            // ‰ΩøÁî®ÊùÉÁõäÊï∞ÁªÑËÆ°ÁÆóÊî∂ÁõäÁéáÊõ≤Á∫ø
            const equityLength = Math.min(result.equity.length, stockData.length);
            for (let i = 0; i < equityLength; i++) {
                const equity = result.equity[i];
                const initCapital = result.initCapital;
                const returnRate = ((equity - initCapital) / initCapital) * 100;
                returns.push(returnRate);
            }
            
            // ËÆ°ÁÆóÂü∫ÂáÜÊî∂ÁõäÁéáÔºà‰π∞ÂÖ•ÊåÅÊúâÁ≠ñÁï•Ôºâ
            const benchmarkReturns = [];
            const firstPrice = stockData[0].close;
            for (let i = 0; i < stockData.length; i++) {
                const currentPrice = stockData[i].close;
                const benchmarkReturn = ((currentPrice - firstPrice) / firstPrice) * 100;
                benchmarkReturns.push(benchmarkReturn);
            }
            
            console.log('üìä Êî∂ÁõäÁéáÊï∞ÊçÆÁÇπÊï∞:', returns.length);
            console.log('üìä Êî∂ÁõäÁéáËåÉÂõ¥:', Math.min(...returns), '~', Math.max(...returns));
            console.log('üìä Âü∫ÂáÜÊî∂ÁõäÁéáÊï∞ÊçÆÁÇπÊï∞:', benchmarkReturns.length);
            console.log('üìä Âü∫ÂáÜÊî∂ÁõäÁéáËåÉÂõ¥:', Math.min(...benchmarkReturns), '~', Math.max(...benchmarkReturns));
            
            // ËÆ°ÁÆó Gradient ÂÅèÁßªÈáè‰ª•ÂÆûÁé∞Á∫¢ÁªøÂàÜÊÆµ
            const maxVal = Math.max(...returns);
            const minVal = Math.min(...returns);
            let gradientStops = [];
            
            if (minVal >= 0) {
                // ÂÖ®ÁõàÂà© (Á∫¢)
                gradientStops = [
                    { offset: 0, color: 'rgba(255, 71, 87, 0.4)' },
                    { offset: 1, color: 'rgba(255, 71, 87, 0.05)' }
                ];
            } else if (maxVal <= 0) {
                // ÂÖ®‰∫èÊçü (Áªø)
                gradientStops = [
                    { offset: 0, color: 'rgba(46, 213, 115, 0.05)' },
                    { offset: 1, color: 'rgba(46, 213, 115, 0.4)' }
                ];
            } else {
                // ÊúâÁõàÊúâ‰∫è
                const range = maxVal - minVal;
                // 0ËΩ¥Âú®ÂõæË°®‰∏≠ÁöÑÁõ∏ÂØπ‰ΩçÁΩÆ (‰ªé‰∏äÂà∞‰∏ãÔºå0ÂØπÂ∫îmaxValÔºå1ÂØπÂ∫îminVal)
                const zeroOffset = maxVal / range;
                
                gradientStops = [
                    { offset: 0, color: 'rgba(255, 71, 87, 0.4)' },               // ÊúÄÈ´òÁÇπ (Á∫¢)
                    { offset: zeroOffset, color: 'rgba(255, 71, 87, 0.05)' },      // 0ËΩ¥‰∏äÊñπ (Ê∑°Á∫¢)
                    { offset: zeroOffset, color: 'rgba(46, 213, 115, 0.05)' },     // 0ËΩ¥‰∏ãÊñπ (Ê∑°Áªø)
                    { offset: 1, color: 'rgba(46, 213, 115, 0.4)' }                // ÊúÄ‰ΩéÁÇπ (Áªø)
                ];
            }

            try {
                charts.returnCurve.setOption({
                    backgroundColor: 'transparent',
                    legend: {
                        data: ['Á≠ñÁï•Êî∂ÁõäÁéá', 'Âü∫ÂáÜÊî∂ÁõäÁéá'],
                        textStyle: { color: '#888' },
                        top: 5
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        backgroundColor: 'rgba(30, 42, 74, 0.95)',
                        borderColor: '#667eea',
                        textStyle: { color: '#fff' },
                        formatter: function(params) {
                            const date = params[0].axisValue;
                            let html = `<div style="padding: 8px; font-size: 12px;">
                                <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">${date}</div>`;
                            
                            params.forEach(param => {
                                // ‰øÆÊ≠£È¢úËâ≤ÔºöÁ∫¢Ê∂®ÁªøË∑å
                                const color = param.value >= 0 ? '#ff4757' : '#2ed573';
                                html += `<div>${param.seriesName}: <span style="color: ${color};">${param.value >= 0 ? '+' : ''}${param.value.toFixed(2)}%</span></div>`;
                            });
                            
                            html += `</div>`;
                            return html;
                        }
                    },
                    grid: {
                        left: 50,
                        right: 50,
                        top: 30,
                        bottom: 30
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLabel: { color: '#888', fontSize: 10 },
                        axisLine: { lineStyle: { color: '#444' } }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { color: '#888', formatter: v => v.toFixed(1) + '%' },
                        splitLine: { lineStyle: { color: '#333' } },
                        axisLine: { lineStyle: { color: '#444' } }
                    },
                    dataZoom: [
                        { type: 'inside', start: 0, end: 100 },
                        { show: true, type: 'slider', bottom: 5, height: 15 }
                    ],
                    series: [
                        {
                            name: 'Á≠ñÁï•Êî∂ÁõäÁéá',
                            type: 'line',
                            data: returns,
                            smooth: true,
                            symbol: 'none',
                            lineStyle: { width: 2, color: '#667eea' },
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0, y: 0, x2: 0, y2: 1,
                                    colorStops: gradientStops
                                }
                            }
                        },
                        {
                            name: 'Âü∫ÂáÜÊî∂ÁõäÁéá',
                            type: 'line',
                            data: benchmarkReturns,
                            smooth: true,
                            symbol: 'none',
                            lineStyle: { width: 2, color: '#ffa502', type: 'dashed' },
                            lineDash: [5, 5]
                        }
                    ]
                });
            } catch (error) {
                console.error('‚ùå Êî∂ÁõäÁéáÊõ≤Á∫øÂõæË°®Êõ¥Êñ∞Â§±Ë¥•:', error);
            }
        }

        // ===================== ÂèÇÊï∞‰ºòÂåñÔºàÊóßÁâà‰øùÁïôÔºö‰∏çÂÜçÁî®‰∫éÊåâÈíÆÂÖ•Âè£Ôºâ =====================
        async function runOptimizationLegacy() {
            const selectedStrategies = Array.from(document.querySelectorAll('.strategy-card.active'))
                .map(card => card.dataset.strategy);
            
            if (selectedStrategies.length === 0) {
                alert('ËØ∑ÈÄâÊã©Á≠ñÁï•ËøõË°å‰ºòÂåñ');
                return;
            }
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressLabel = document.getElementById('progressLabel');
            const progressDetails = document.getElementById('progressDetails');
            
            progressContainer.classList.add('active');
            
            if (stockData.length === 0) {
                await fetchStockData();
            }
            
            const initCapital = parseFloat(document.getElementById('initCapital').value) * 10000;
            
            // optimizationResults = {}; // ‰∏çË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÁªìÊûúÔºåÂÖÅËÆ∏Â¢ûÈáèÊõ¥Êñ∞
            
            const totalStrategies = selectedStrategies.length;
            const totalCombinationsPerStrategy = 80;
            const totalCombinations = totalStrategies * totalCombinationsPerStrategy;
            let currentCombination = 0;
            
            for (let strategyIndex = 0; strategyIndex < totalStrategies; strategyIndex++) {
                const strategy = selectedStrategies[strategyIndex];
                progressLabel.textContent = `‰ºòÂåñÁ≠ñÁï• (${strategyIndex + 1}/${totalStrategies}): ${STRATEGIES[strategy]?.name}`;
                
                const paramGrid = getStrategyParamGrid(strategy);
                
                const combinations = [];
                for (let tp of paramGrid.takeProfit) {
                    for (let sl of paramGrid.stopLoss) {
                        for (let vm of paramGrid.volumeMulti) {
                            combinations.push({ takeProfit: tp, stopLoss: sl, volumeMulti: vm });
                        }
                    }
                }
                
                let bestResult = null;
                let bestParams = null;
                
                for (let i = 0; i < combinations.length; i++) {
                    const params = combinations[i];
                    const config = {
                        ...currentConfig,
                        ...(strategySpecificConfig[strategy] || {}),
                        ...params
                    };
                    
                    const signals = executeStrategy(stockData, strategy, config);
                    const result = calculateBacktest(stockData, signals, initCapital);
                    
                    if (!bestResult || result.score > bestResult.score) {
                        bestResult = result;
                        bestParams = params;
                    }
                    
                    currentCombination++;
                    const progress = (currentCombination / totalCombinations) * 100;
                    progressFill.style.width = progress + '%';
                    progressPercent.textContent = progress.toFixed(0) + '%';
                    
                    if (i % 5 === 0) {
                        progressDetails.innerHTML = `
                            <div>Á≠ñÁï•: ${STRATEGIES[strategy]?.name} (${strategyIndex + 1}/${totalStrategies})</div>
                            <div>ÂΩìÂâç: Ê≠¢Áõà${(params.takeProfit*100).toFixed(0)}% Ê≠¢Êçü${(params.stopLoss*100).toFixed(0)}%</div>
                            <div>ÊúÄ‰ºò: Êî∂Áõä${bestResult.totalReturn.toFixed(2)}% ËØÑÂàÜ${bestResult.score.toFixed(1)}</div>
                        `;
                        await sleep(5);
                    }
                }
                
                optimizationResults[strategy] = {
                    bestResult,
                    bestParams,
                    name: STRATEGIES[strategy]?.name
                };
            }
            
            const resultsSummary = Object.entries(optimizationResults).map(([key, data]) => {
                return `
                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        <div style="color: #667eea; font-weight: bold; margin-bottom: 6px;">${data.name}</div>
                        <div>Ê≠¢Áõà: ${(data.bestParams.takeProfit * 100).toFixed(0)}% | Ê≠¢Êçü: ${(data.bestParams.stopLoss * 100).toFixed(0)}% | ÊîæÈáè: ${data.bestParams.volumeMulti}x</div>
                        <div>‰ºòÂåñÂêéÊî∂Áõä: +${data.bestResult.totalReturn.toFixed(2)}% | ËØÑÂàÜ: ${data.bestResult.score.toFixed(1)}</div>
                    </div>
                `;
            }).join('');
            
            progressDetails.innerHTML = `
                <div style="color:#38ef7d">‚úÖ ÂÖ®ÈÉ®‰ºòÂåñÂÆåÊàêÔºÅ</div>
                <div style="margin-top: 10px;">${resultsSummary}</div>
            `;
            
            // Â∞Ü‰ºòÂåñÁªìÊûú‰øùÂ≠òÂà∞ strategyResults ‰∏≠Ôºå‰ª•‰æøÂõæË°®Êõ¥Êñ∞
            // strategyResults = {}; // ÂêåÊ†∑‰∏çË¶ÅÊ∏ÖÁ©∫
            Object.entries(optimizationResults).forEach(([key, data]) => {
                strategyResults[key] = {
                    ...data.bestResult,
                    signals: [],
                    name: data.name,
                    icon: STRATEGIES[key]?.icon || 'üìä'
                };
            });
            
            // ‰øùÂ≠ò‰ºòÂåñÂèÇÊï∞Âà∞Á≠ñÁï•ÈÖçÁΩÆ
            selectedStrategies.forEach(strategy => {
                const result = optimizationResults[strategy];
                if (result) {
                    if (!strategySpecificConfig[strategy]) {
                        strategySpecificConfig[strategy] = {};
                    }
                    strategySpecificConfig[strategy]['takeProfit'] = result.bestParams.takeProfit;
                    strategySpecificConfig[strategy]['stopLoss'] = result.bestParams.stopLoss;
                    strategySpecificConfig[strategy]['volumeMulti'] = result.bestParams.volumeMulti;
                    
                    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁ°Æ‰øù currentConfig ‰∏≠ÁöÑÂÖ®Â±ÄÂèÇÊï∞‰∏ç‰ºöË¶ÜÁõñ‰ºòÂåñÂêéÁöÑÂèÇÊï∞
                    // Êàë‰ª¨ÂèØ‰ª•ËÄÉËôëÂú®ËøôÈáå‰πüÊõ¥Êñ∞ currentConfigÔºåÊàñËÄÖÁ°Æ‰øù runComparison ‰ºòÂÖà‰ΩøÁî® strategySpecificConfig
                    console.log(`‚úÖ Á≠ñÁï• [${strategy}] ‰ºòÂåñÂèÇÊï∞Â∑≤‰øùÂ≠ò:`, strategySpecificConfig[strategy]);
                }
            });
            
            // Á´ãÂç≥‰øùÂ≠òÂà∞ LocalStorageÔºåÈò≤Ê≠¢È°µÈù¢Âà∑Êñ∞ÊàñÊÑèÂ§ñÈáçÁΩÆ‰∏¢Â§±
            try {
                const configToSave = {
                    ...currentConfig,
                    strategySpecificConfig: strategySpecificConfig
                };
                localStorage.setItem('strategyConfig', JSON.stringify(configToSave));
                // ÂêåÊó∂‰øùÂ≠ò optimizationResults
                localStorage.setItem('optimizationResults', JSON.stringify(optimizationResults));
                persistLocalStateKeyBestEffort('strategyConfig', configToSave);
                persistLocalStateKeyBestEffort('optimizationResults', optimizationResults);
                console.log('‚úÖ ‰ºòÂåñÁªìÊûúÂ∑≤ÂêåÊ≠•‰øùÂ≠òÂà∞ LocalStorage');
            } catch (e) {
                console.warn('‚ö†Ô∏è ‰øùÂ≠òÈÖçÁΩÆÂà∞ LocalStorage Â§±Ë¥•:', e);
            }
            
            // Âº∫Âà∂Âà∑Êñ∞ÂèÇÊï∞ÊòæÁ§∫ÔºåÁ°Æ‰øùUIÂêåÊ≠•
            updateStrategyParams();
            
            // Âº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÁ≠ñÁï•Âç°ÁâáÁöÑÊøÄÊ¥ªÁä∂ÊÄÅÔºåËß¶ÂèëÂèÇÊï∞ÈáçËΩΩ
            if (document.getElementById('paramStrategy')) {
                const currentStrategyVal = document.getElementById('paramStrategy').value;
                if (currentStrategyVal) {
                   // Âº∫Âà∂ÈáçÁªòÂèÇÊï∞Èù¢Êùø
                   console.log(`üîÑ Ê≠£Âú®Âà∑Êñ∞Á≠ñÁï• [${currentStrategyVal}] ÁöÑÂèÇÊï∞Èù¢Êùø...`);
                   updateStrategyParamsWithKey(currentStrategyVal); 
                }
            }

            console.log("‚úÖ ÂÖ®Â±ÄÁ≠ñÁï•ÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞:", JSON.parse(JSON.stringify(strategySpecificConfig)));
            updateComparisonTable();
            updateCharts();
            updateBestResult();
            updateStrategyDropdowns();
            updateDataInfo();
            
            setTimeout(() => {
                progressContainer.classList.remove('active');
            }, 8000);
        }
        
        function getStrategyParamGrid(strategy) {
            const paramGrids = {
                deep_fusion: {
                    takeProfit: [0.08, 0.12, 0.15, 0.20, 0.25],
                    stopLoss: [0.03, 0.05, 0.07, 0.10],
                    volumeMulti: [1.2, 1.5, 1.8, 2.0]
                },
                volume_breakout: {
                    takeProfit: [0.10, 0.15, 0.20, 0.25, 0.30],
                    stopLoss: [0.03, 0.05, 0.07, 0.10],
                    volumeMulti: [1.5, 2.0, 2.5, 3.0]
                },
                oversold_rebound: {
                    takeProfit: [0.06, 0.10, 0.15, 0.20, 0.25],
                    stopLoss: [0.04, 0.06, 0.08, 0.10],
                    volumeMulti: [1.0, 1.2, 1.5, 1.8]
                },
                trend_enhanced: {
                    takeProfit: [0.10, 0.15, 0.20, 0.25, 0.30],
                    stopLoss: [0.04, 0.06, 0.08, 0.10],
                    volumeMulti: [1.2, 1.5, 1.8, 2.0]
                },
                macd_divergence: {
                    takeProfit: [0.08, 0.12, 0.15, 0.20, 0.25],
                    stopLoss: [0.03, 0.05, 0.07, 0.10],
                    volumeMulti: [1.0, 1.2, 1.5, 1.8]
                },
                bollinger_extreme: {
                    takeProfit: [0.06, 0.10, 0.15, 0.20, 0.25],
                    stopLoss: [0.04, 0.06, 0.08, 0.10],
                    volumeMulti: [1.0, 1.5, 2.0, 2.5, 3.0]
                },
                momentum_rotation: {
                    takeProfit: [0.08, 0.12, 0.15, 0.20, 0.25],
                    stopLoss: [0.03, 0.05, 0.07, 0.10],
                    volumeMulti: [1.2, 1.5, 1.8, 2.0]
                },
                turtle_enhanced: {
                    takeProfit: [0.10, 0.15, 0.20, 0.25, 0.30],
                    stopLoss: [0.05, 0.07, 0.10, 0.12],
                    volumeMulti: [1.0, 1.2, 1.5, 1.8]
                }
            };
            
            return paramGrids[strategy] || paramGrids.deep_fusion;
        }

        // ===================== Âä†ËΩΩÊòæÁ§∫ =====================
        function showLoading(message = 'Ê≠£Âú®Â§ÑÁêÜ...') {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const loadingProgress = document.getElementById('loadingProgress');
            const loadingStats = document.getElementById('loadingStats');
            
            if (loading) {
                loading.classList.add('active');
            }
            if (loadingText) {
                loadingText.textContent = message;
            }
            if (loadingProgress) {
                loadingProgress.style.width = '0%';
            }
            if (loadingStats) {
                loadingStats.textContent = '';
            }
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.remove('active');
            }
        }

        // ===================== ÈÄöÁü•Á≥ªÁªü =====================
        function showNotification(message, type = 'info', duration = 3000) {
            // ÂàõÂª∫ÈÄöÁü•ÂÆπÂô®ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            let notificationContainer = document.getElementById('notificationContainer');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notificationContainer';
                notificationContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 350px;
                `;
                document.body.appendChild(notificationContainer);
            }
            
            // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = 'notification notification-' + type;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="notification-icon">${getNotificationIcon(type)}</span>
                    <span class="notification-message">${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            // ËÆæÁΩÆÊ†∑Âºè
            const styles = {
                info: { background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white' },
                success: { background: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)', color: 'white' },
                warning: { background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', color: 'white' },
                error: { background: 'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)', color: 'white' }
            };
            
            const style = styles[type] || styles.info;
            notification.style.cssText = `
                background: ${style.background};
                color: ${style.color};
                border-radius: 8px;
                padding: 12px 16px;
                margin-bottom: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
            if (!document.querySelector('#notificationStyles')) {
                const styleEl = document.createElement('style');
                styleEl.id = 'notificationStyles';
                styleEl.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                    .notification-close {
                        background: none;
                        border: none;
                        color: inherit;
                        font-size: 18px;
                        cursor: pointer;
                        margin-left: 10px;
                        opacity: 0.7;
                    }
                    .notification-close:hover { opacity: 1; }
                    .notification-icon { font-size: 16px; }
                    .notification-message { font-size: 14px; line-height: 1.4; }
                `;
                document.head.appendChild(styleEl);
            }
            
            notificationContainer.appendChild(notification);
            
            // Ëá™Âä®ÁßªÈô§
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, duration);
            }
        }
        
        // Ëé∑ÂèñÈÄöÁü•ÂõæÊ†á
        function getNotificationIcon(type) {
            const icons = {
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                error: '‚ùå'
            };
            return icons[type] || icons.info;
        }
        
        // ÂÖ®Â±ÄÈÄöÁü•ÂáΩÊï∞
        window.showNotification = showNotification;

        // ===================== ÂØºÂá∫Êä•Âëä =====================
        function exportResults() {
            if (Object.keys(strategyResults).length === 0) {
                showNotification('ËØ∑ÂÖàËøêË°åÁ≠ñÁï•ÂØπÊØî', 'warning');
                return;
            }
            
            let csv = 'Á≠ñÁï•ÂêçÁß∞,ÊÄªÊî∂ÁõäÁéá,Âπ¥ÂåñÊî∂Áõä,ÊúÄÂ§ßÂõûÊí§,Â§èÊôÆÊØîÁéá,ËÉúÁéá,‰∫§ÊòìÊ¨°Êï∞,ÁªºÂêàËØÑÂàÜ\n';
            
            Object.entries(strategyResults).forEach(([key, r]) => {
                csv += `${r.name},${r.totalReturn.toFixed(2)}%,${r.annualReturn.toFixed(2)}%,-${r.maxDrawdown.toFixed(2)}%,${r.sharpe.toFixed(2)},${r.winRate.toFixed(1)}%,${r.tradeCount},${r.score.toFixed(1)}\n`;
            });
            
            try {
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ÈáèÂåñÁ≠ñÁï•Êä•Âëä_${document.getElementById('stockCode').value}_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('üìä Êä•ÂëäÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                console.error('ÂØºÂá∫Êä•ÂëäÂ§±Ë¥•:', error);
                showNotification('‚ùå Êä•ÂëäÂØºÂá∫Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        let optimizationCharts = {};

        function getEffectiveStrategyConfig(strategyKey, overrides = null) {
            const base = {
                ...currentConfig,
                ...(strategySpecificConfig?.[strategyKey] || {})
            };
            if (overrides && typeof overrides === 'object') {
                return { ...base, ...overrides };
            }
            return base;
        }

        function runOptimization() {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const loadingProgress = document.getElementById('loadingProgress');
            const loadingStats = document.getElementById('loadingStats');
            
            // loading.classList.add('active'); // ‰∏çÂÜç‰ΩøÁî®ÂÖ®Â±èÈÅÆÁΩ©Ôºå‰ª•‰æøÊòæÁ§∫‰æßËæπÊ†èËøõÂ∫¶Êù°
            
            const btnRun = document.getElementById('btnRunOptimization');
            if (btnRun) {
                btnRun.disabled = true;
                btnRun.textContent = '‚è≥ ‰ºòÂåñËøêË°å‰∏≠...';
            }
            
            const selectedStrategies = Array.from(document.querySelectorAll('.strategy-card.active'))
                .map(card => card.dataset.strategy);
            
            if (selectedStrategies.length === 0) {
                alert('ËØ∑ÈÄâÊã©Á≠ñÁï•ËøõË°å‰ºòÂåñ');
                if (btnRun) {
                    btnRun.disabled = false;
                    btnRun.textContent = 'üöÄ ËøêË°åÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ';
                }
                return;
            }
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressLabel = document.getElementById('progressLabel');
            const progressDetails = document.getElementById('progressDetails');
            
            progressContainer.classList.add('active');
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressLabel.textContent = 'Ê≠£Âú®ÂáÜÂ§áÊï∞ÊçÆ...';
            
            // ÊªöÂä®Âà∞ËøõÂ∫¶Êù°‰ΩçÁΩÆ
            progressContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            const tsCode = document.getElementById('stockCode').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const initCapital = parseFloat(document.getElementById('initCapital').value) * 10000;
            
            if (!tsCode) {
                alert('ËØ∑ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å');
                // loading.classList.remove('active');
                progressContainer.classList.remove('active');
                if (btnRun) {
                    btnRun.disabled = false;
                    btnRun.textContent = 'üöÄ ËøêË°åÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ';
                }
                return;
            }
            
            const progressDetailsHtml = `
                <div>ËÇ°Á•®‰ª£Á†Å: ${tsCode}</div>
                <div>Êó∂Èó¥ËåÉÂõ¥: ${startDate} ~ ${endDate}</div>
                <div>ÂàùÂßãËµÑÈáë: ¬•${initCapital.toLocaleString()}</div>
            `;
            progressDetails.innerHTML = progressDetailsHtml;
            
            const paramRanges = {
                takeProfit: { min: 0.05, max: 0.30, step: 0.01 },
                stopLoss: { min: 0.03, max: 0.15, step: 0.01 },
                volumeMulti: { min: 1.0, max: 3.0, step: 0.1 },
                dynamicTpCallback: { min: 0.01, max: 0.08, step: 0.01 }
            };

            const optEnableTakeProfit = document.getElementById('optEnableTakeProfit')?.checked !== false;
            const optEnableStopLoss = document.getElementById('optEnableStopLoss')?.checked !== false;
            const optEnableVolumeMulti = document.getElementById('optEnableVolumeMulti')?.checked !== false;
            const optEnableDynamicTpCallback = document.getElementById('optEnableDynamicTpCallback')?.checked !== false;

            const buildRangeValues = (range, decimals = 4) => {
                const out = [];
                const min = Number(range?.min);
                const max = Number(range?.max);
                const step = Number(range?.step);
                if (!Number.isFinite(min) || !Number.isFinite(max) || !Number.isFinite(step) || step <= 0) return out;
                for (let v = min; v <= max + 1e-9; v += step) {
                    out.push(Number(v.toFixed(decimals)));
                }
                return out;
            };
            
            const totalStrategies = selectedStrategies.length;
            let currentStrategyIndex = 0;
            optimizationResults = {};
            
            async function runRealOptimization() {
                try {
                    progressLabel.textContent = 'Ê≠£Âú®Ëé∑ÂèñËÇ°Á•®Êï∞ÊçÆ...';
                    
                    const stockData = await fetchStockDataForOptimization(tsCode, startDate, endDate);
                    
                    if (!stockData || stockData.length === 0) {
                        alert('Êó†Ê≥ïËé∑ÂèñËÇ°Á•®Êï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï');
                        // loading.classList.remove('active');
                        progressContainer.classList.remove('active');
                        if (btnRun) {
                            btnRun.disabled = false;
                            btnRun.textContent = 'üöÄ ËøêË°åÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ';
                        }
                        return;
                    }
                    
                    console.log(`üìä ‰ºòÂåñ‰ΩøÁî® ${stockData.length} Êù°Êï∞ÊçÆ`);
                    progressDetails.innerHTML = progressDetailsHtml + `<div>Êï∞ÊçÆÈáè: ${stockData.length} Êù°</div>`;

                    if (stockData.length < 120) {
                        showNotification(`‚ö†Ô∏è Êï∞ÊçÆÈáè‰ªÖ ${stockData.length} Êù°Ôºå‰ºòÂåñÁªìÊûúÂèØËÉΩ‰∏çÁ®≥ÂÆöÔºàÂª∫ËÆÆËá≥Â∞ë 120 Êù°/Á∫¶ÂçäÂπ¥‰∫§ÊòìÊó•Ôºâ„ÄÇ`, 'warning', 6000);
                    }
                    
                    for (const strategy of selectedStrategies) {
                        currentStrategyIndex++;
                        const strategyName = STRATEGIES[strategy]?.name || strategy;
                        progressLabel.textContent = `Ê≠£Âú®‰ºòÂåñÁ≠ñÁï•: ${strategyName} (${currentStrategyIndex}/${totalStrategies})`;

                        let currentCombination = 0;
                        let bestResult = null;
                        const currentEffective = getEffectiveStrategyConfig(strategy);
                        const baseTakeProfit = typeof currentEffective.takeProfit === 'number' ? currentEffective.takeProfit : 0.15;
                        const baseStopLoss = typeof currentEffective.stopLoss === 'number' ? currentEffective.stopLoss : 0.08;
                        const baseVolumeMulti = typeof currentEffective.volumeMulti === 'number' ? currentEffective.volumeMulti : 1.5;
                        const baseDynamicTpCallback = typeof currentEffective.dynamicTpCallback === 'number' ? currentEffective.dynamicTpCallback : 0.03;

                        const tpValuesRaw = optEnableTakeProfit ? buildRangeValues(paramRanges.takeProfit, 4) : [Number(baseTakeProfit.toFixed(4))];
                        const slValuesRaw = optEnableStopLoss ? buildRangeValues(paramRanges.stopLoss, 4) : [Number(baseStopLoss.toFixed(4))];
                        const vmValuesRaw = optEnableVolumeMulti ? buildRangeValues(paramRanges.volumeMulti, 3) : [Number(baseVolumeMulti.toFixed(3))];
                        const dtpValuesRaw = optEnableDynamicTpCallback ? buildRangeValues(paramRanges.dynamicTpCallback, 4) : [Number(baseDynamicTpCallback.toFixed(4))];

                        const tpValues = tpValuesRaw.length > 0 ? tpValuesRaw : [Number(baseTakeProfit.toFixed(4))];
                        const slValues = slValuesRaw.length > 0 ? slValuesRaw : [Number(baseStopLoss.toFixed(4))];
                        const vmValues = vmValuesRaw.length > 0 ? vmValuesRaw : [Number(baseVolumeMulti.toFixed(3))];
                        const dtpValues = dtpValuesRaw.length > 0 ? dtpValuesRaw : [Number(baseDynamicTpCallback.toFixed(4))];

                        const totalCombinations = tpValues.length * slValues.length * vmValues.length * dtpValues.length;

                        let bestParams = {
                            takeProfit: baseTakeProfit,
                            stopLoss: baseStopLoss,
                            volumeMulti: baseVolumeMulti,
                            dynamicTpCallback: baseDynamicTpCallback
                        };
                        
                        const beforeConfig = getEffectiveStrategyConfig(strategy);
                        
                        const beforeSignals = executeStrategy(stockData, strategy, beforeConfig);
                        const beforeResult = calculateBacktest(stockData, beforeSignals, initCapital);
                        
                        for (const tp of tpValues) {
                            for (const sl of slValues) {
                                for (const vm of vmValues) {
                                    for (const dtp of dtpValues) {
                                        const params = { takeProfit: tp, stopLoss: sl, volumeMulti: vm, dynamicTpCallback: dtp };
                                        const config = getEffectiveStrategyConfig(strategy, params);
                                        
                                        const signals = executeStrategy(stockData, strategy, config);
                                        const result = calculateBacktest(stockData, signals, initCapital);
                                        
                                        if (!bestResult || (result.score !== undefined && result.score > bestResult.score)) {
                                            bestResult = result;
                                            bestParams = params;
                                            
                                            if (currentCombination < 5 || result.score > 10) {
                                                console.log(`üìà Êñ∞ÊúÄ‰ºò: ${strategyName} TP:${(tp*100).toFixed(0)}% SL:${(sl*100).toFixed(0)}% VM:${vm.toFixed(1)} ÂõûÊí§:${(dtp*100).toFixed(1)}% Êî∂Áõä:${result.totalReturn?.toFixed(2)}% ËØÑÂàÜ:${result.score?.toFixed(1)} ‰ø°Âè∑Êï∞:${signals.length}`);
                                            }
                                        }
                                        
                                        currentCombination++;
                                        const overallProgress = (currentCombination / totalCombinations) * 100;
                                        const strategyProgress = ((currentStrategyIndex - 1) / totalStrategies) * 100;
                                        const totalProgress = strategyProgress + (overallProgress / totalStrategies);
                                        
                                        progressFill.style.width = totalProgress + '%';
                                        progressPercent.textContent = Math.round(totalProgress) + '%';
                                        
                                        if (currentCombination % 80 === 0) {
                                            progressDetails.innerHTML = `
                                                ${progressDetailsHtml}
                                                <div>Êï∞ÊçÆÈáè: ${stockData.length} Êù°</div>
                                                <div style="margin-top:10px;">Á≠ñÁï•: ${strategyName} (${currentStrategyIndex}/${totalStrategies})</div>
                                                <div>ÂΩìÂâç: Ê≠¢Áõà${(tp*100).toFixed(0)}% Ê≠¢Êçü${(sl*100).toFixed(0)}% ÊîæÈáè${vm.toFixed(1)}x ÂõûÊí§${(dtp*100).toFixed(1)}%</div>
                                                <div>ÊúÄ‰ºò: Êî∂Áõä${bestResult.totalReturn?.toFixed(2)}% ËØÑÂàÜ${bestResult.score?.toFixed(1)} ÂõûÊí§${(bestParams.dynamicTpCallback*100).toFixed(1)}%</div>
                                            `;
                                            await sleep(10);
                                        }
                                    }
                                }
                            }
                        }
                        
                        console.log(`üìä ${strategyName} ‰ºòÂåñÂÆåÊàê: ‰ºòÂåñÂâçÊî∂Áõä${beforeResult.totalReturn?.toFixed(2)}%, ‰ºòÂåñÂêéÊî∂Áõä${bestResult.totalReturn?.toFixed(2)}%`);
                        
                        const returnImprovement = beforeResult.totalReturn !== 0 && beforeResult.totalReturn !== undefined
                            ? ((bestResult.totalReturn - beforeResult.totalReturn) / Math.abs(beforeResult.totalReturn) * 100)
                            : 0;
                        const sharpeImprovement = beforeResult.sharpe !== 0
                            ? ((bestResult.sharpe - beforeResult.sharpe) / Math.abs(beforeResult.sharpe) * 100)
                            : 0;
                        
                        optimizationResults[strategy] = {
                            beforeResult,
                            afterResult: bestResult,
                            bestParams,
                            returnImprovement,
                            sharpeImprovement,
                            name: strategyName,
                            score: bestResult.score
                        };
                    }
                    
                    progressLabel.textContent = 'Ê≠£Âú®ÁîüÊàê‰ºòÂåñÊä•Âëä...';
                    
                    const resultsSummary = Object.entries(optimizationResults).map(([key, data]) => {
                        return `
                            <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                <div style="color: #667eea; font-weight: bold; margin-bottom: 6px;">${data.name}</div>
                                <div>Ê≠¢Áõà: ${(data.bestParams.takeProfit * 100).toFixed(0)}% | Ê≠¢Êçü: ${(data.bestParams.stopLoss * 100).toFixed(0)}% | ÊîæÈáè: ${data.bestParams.volumeMulti.toFixed(1)}x | ÂõûÊí§: ${(data.bestParams.dynamicTpCallback * 100).toFixed(1)}%</div>
                                <div>‰ºòÂåñÂâçÊî∂Áõä: ${data.beforeResult.totalReturn.toFixed(2)}% | ‰ºòÂåñÂêéÊî∂Áõä: ${data.afterResult.totalReturn.toFixed(2)}%</div>
                                <div>‰ºòÂåñÂêéÂ§èÊôÆ: ${data.afterResult.sharpe.toFixed(2)} | ËØÑÂàÜ: ${data.afterResult.score.toFixed(1)}</div>
                            </div>
                        `;
                    }).join('');
                    
                    progressDetails.innerHTML = `
                        <div style="color:#38ef7d">‚úÖ ÂÖ®ÈÉ®‰ºòÂåñÂÆåÊàêÔºÅ</div>
                        <div style="margin-top: 10px;">${resultsSummary}</div>
                    `;
                    
                    if (selectedStrategies.length === 1) {
                        const strategy = selectedStrategies[0];
                        const result = optimizationResults[strategy];
                        document.getElementById('optStrategyName').textContent = result.name;
                        document.getElementById('optTotalReturn').textContent = result.afterResult.totalReturn.toFixed(2) + '%';
                        document.getElementById('optAnnualReturn').textContent = result.afterResult.annualReturn.toFixed(2) + '%';
                        document.getElementById('optMaxDrawdown').textContent = '-' + result.afterResult.maxDrawdown.toFixed(2) + '%';
                        document.getElementById('optSharpe').textContent = result.afterResult.sharpe.toFixed(2);
                        document.getElementById('optWinRate').textContent = result.afterResult.winRate.toFixed(1) + '%';
                        document.getElementById('optTradeCount').textContent = result.afterResult.tradeCount;
                        document.getElementById('optScore').textContent = result.afterResult.score.toFixed(1);
                        document.getElementById('optBestParams').textContent = `Ê≠¢Áõà: ${(result.bestParams.takeProfit * 100).toFixed(0)}% | Ê≠¢Êçü: ${(result.bestParams.stopLoss * 100).toFixed(0)}% | ÊîæÈáè: ${result.bestParams.volumeMulti.toFixed(1)}x | ÂõûÊí§: ${(result.bestParams.dynamicTpCallback * 100).toFixed(1)}%`;
                        document.getElementById('optImprovement').textContent = (result.returnImprovement >= 0 ? '+' : '') + result.returnImprovement.toFixed(2) + '%';
                        
                        updateEquityChart(result.afterResult.equity, 'optEquityChart');
                        updateTradeChart(result.afterResult.trades, 'optTradeChart');
                        
                        switchTab('optimization');
                    }
                    
                    updateOptimizationSummaryTable(optimizationResults);
                    updateOptimizationCharts(optimizationResults);
                    updateOptimizationDetailTable(optimizationResults);

                    try {
                        localStorage.setItem('optimizationResults', JSON.stringify(optimizationResults));
                        persistLocalStateKeyBestEffort('optimizationResults', optimizationResults);
                    } catch (e) {
                    }
                    
                    // loading.classList.remove('active');
                    progressContainer.classList.remove('active');
                    if (btnRun) {
                        btnRun.disabled = false;
                        btnRun.textContent = 'üöÄ ËøêË°åÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ';
                    }
                    showNotification('‚úÖ ÂèÇÊï∞‰ºòÂåñÂÆåÊàêÔºÅÂèØÁÇπÂáª‚ÄúÂ∫îÁî®‰ºòÂåñÂèÇÊï∞‚Äù‰ΩøÂÖ∂ÁîüÊïà„ÄÇ', 'success');
                    
                } catch (error) {
                    console.error('ÂèÇÊï∞‰ºòÂåñÂ§±Ë¥•:', error);
                    // loading.classList.remove('active');
                    progressContainer.classList.remove('active');
                    if (btnRun) {
                        btnRun.disabled = false;
                        btnRun.textContent = 'üöÄ ËøêË°åÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñ';
                    }
                    showNotification('‚ùå ÂèÇÊï∞‰ºòÂåñÂ§±Ë¥•: ' + error.message, 'error');
                }
            }
            
            runRealOptimization();
        }

        // ===================== Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñ =====================
        window.runAutoBatchOptimization = async function() {
            const btnAuto = document.getElementById('btnAutoOptimize');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressLabel = document.getElementById('progressLabel');
            const progressDetails = document.getElementById('progressDetails');
            
            if (btnAuto) {
                btnAuto.disabled = true;
                btnAuto.textContent = '‚è≥ Ëá™Âä®‰ºòÂåñËøêË°å‰∏≠...';
            }
            
            progressContainer.classList.add('active');
            progressLabel.textContent = 'ÂáÜÂ§áËá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñ...';
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            
            progressDetails.innerHTML = `
                        <div style="color:#667eea">ü§ñ Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñ</div>
                        <div>Â∞ÜËá™Âä®ÈÄâÊã©8‰∏™‰ª£Ë°®ÊÄßË°å‰∏öÁöÑËÇ°Á•®ÔºàÊ∂µÁõñ‰Ωé/‰∏≠/È´òÊ≥¢Âä®ÁéáÔºâ</div>
                        <div>‰∏∫8‰∏™Á≠ñÁï•ÂêÑÊµãËØï294ÁªÑÂèÇÊï∞ÁªÑÂêàÔºåÂØªÊâæÊúÄ‰ºòÂèÇÊï∞</div>
                        <div style="margin-top:10px;color:#ff6b6b;font-weight:bold">È¢ÑËÆ°ÈúÄË¶Å10-15ÂàÜÈíüÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ...</div>
                    `;
            
            try {
                const startDate = document.getElementById('startDate')?.value || '2022-01-01';
                const endDate = document.getElementById('endDate')?.value || new Date().toISOString().split('T')[0];
                
                // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÁ≠ñÁï•
                let selectedStrategies = Array.from(document.querySelectorAll('.strategy-card.active'))
                    .map(card => card.dataset.strategy);
                
                if (selectedStrategies.length === 0) {
                    selectedStrategies = ['deep_fusion']; // ÈªòËÆ§Ëá≥Â∞ëÈÄâ‰∏Ä‰∏™
                }
                
                progressLabel.textContent = 'Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®...';
                
                let progressInterval = null;
                
                // ËΩÆËØ¢ËøõÂ∫¶ÂáΩÊï∞
                async function pollProgress() {
                    try {
                        const progressRes = await fetch('/api/auto_optimize_progress');
                        if (progressRes.ok) {
                            const progressData = await progressRes.json();
                            if (progressData.success && progressData.is_running) {
                                const percent = progressData.progress_percent;
                                progressFill.style.width = percent + '%';
                                progressPercent.textContent = percent + '%';
                                progressLabel.textContent = `Ê≠£Âú®‰ºòÂåñ: ${progressData.current_stock} (${progressData.current}/${progressData.total})`;
                            }
                        }
                    } catch (e) {
                        console.log('ËøõÂ∫¶Êü•ËØ¢Â§±Ë¥•:', e);
                    }
                }
                
                let response;
                try {
                    console.log('ÂáÜÂ§áÂèëÈÄÅËØ∑Ê±ÇÂà∞ /api/auto_optimize_params');
                    
                    // ÂêØÂä®ËøõÂ∫¶ËΩÆËØ¢ÔºàÊØè2ÁßíÊü•ËØ¢‰∏ÄÊ¨°Ôºâ
                    progressInterval = setInterval(pollProgress, 2000);
                    
                    response = await fetch('/api/auto_optimize_params', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            start_date: startDate,
                            end_date: endDate,
                            strategies: selectedStrategies
                        })
                    });
                } catch (networkError) {
                    console.error('ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•:', networkError);
                    throw new Error(`Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Á°Æ‰øùÊúçÂä°Âô®Â∑≤ÂêØÂä® (http://127.0.0.1:5000)„ÄÇÈîôËØØ: ${networkError.message}`);
                } finally {
                    // ÂÅúÊ≠¢ËøõÂ∫¶ËΩÆËØ¢
                    if (progressInterval) {
                        clearInterval(progressInterval);
                    }
                }
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Êú™Áü•ÈîôËØØ');
                    console.error('ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ:', response.status, errorText);
                    throw new Error(`ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    progressFill.style.width = '100%';
                    progressPercent.textContent = '100%';
                    progressLabel.textContent = 'Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñÂÆåÊàêÔºÅ';
                    
                    // ÊòæÁ§∫‰ºòÂåñÁªìÊûúÊëòË¶Å
                    const industries = result.industries || [];
                    const stocks = result.optimized_stocks || [];
                    
                    // Â∞ÜËá™Âä®ÊâπÈáè‰ºòÂåñÁªìÊûú‰øùÂ≠òÂà∞ optimizationResults
                    if (result.strategy_params) {
                        Object.assign(optimizationResults, result.strategy_params);
                        console.log('Ëá™Âä®ÊâπÈáè‰ºòÂåñÁªìÊûúÂ∑≤‰øùÂ≠ò:', optimizationResults);
                    }
                    
                    progressDetails.innerHTML = `
                        <div style="color:#38ef7d">‚úÖ Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñÂÆåÊàêÔºÅ</div>
                        <div style="margin-top:10px;">
                            <div>üìä ‰ºòÂåñËÇ°Á•®Êï∞Èáè: ${stocks.length} Âè™</div>
                            <div>üè≠ Ë¶ÜÁõñË°å‰∏öÊï∞Èáè: ${industries.length} ‰∏™</div>
                            <div style="margin-top:8px;color:#888">Â∑≤Âª∫Á´ãÂÆåÊï¥ÁöÑË∑®Ë°å‰∏öÂèÇÊï∞‰ΩìÁ≥ª</div>
                        </div>
                        <div style="margin-top:10px;padding:8px;background:rgba(102,126,234,0.1);border-radius:4px;">
                            <div style="font-size:12px;color:#667eea">Ë¶ÜÁõñË°å‰∏ö:</div>
                            <div style="font-size:11px;color:#888;margin-top:4px;">${industries.join('„ÄÅ')}</div>
                        </div>
                        <div style="margin-top:10px;color:#ff6b6b;font-weight:bold;">
                            ‚ö†Ô∏è ËØ∑ÁÇπÂáª"Â∫îÁî®‰ºòÂåñÂèÇÊï∞"ÊåâÈíÆ‰Ωø‰ºòÂåñÁªìÊûúÁîüÊïà
                        </div>
                    `;
                    
                    showNotification(`‚úÖ Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñÂÆåÊàêÔºÅÂ∑≤‰ºòÂåñ${stocks.length}Âè™ËÇ°Á•®ÔºåËØ∑ÁÇπÂáª"Â∫îÁî®‰ºòÂåñÂèÇÊï∞"`, 'success');
                    
                    // Ëá™Âä®ÂàáÊç¢Âà∞‰ºòÂåñÁªìÊûúÈ°µÈù¢
                    setTimeout(() => {
                        switchTab('optimization');
                        // ÊòæÁ§∫ÊèêÁ§∫ËÆ©Áî®Êà∑Â∫îÁî®ÂèÇÊï∞
                        showNotification('üí° ËØ∑ÁÇπÂáª"Â∫îÁî®‰ºòÂåñÂèÇÊï∞"‰Ωø‰ºòÂåñÁªìÊûúÁîüÊïà', 'info');
                    }, 1000);
                    
                } else {
                    throw new Error(result.message || '‰ºòÂåñÂ§±Ë¥•');
                }
                
            } catch (error) {
                console.error('Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñÂ§±Ë¥•:', error);
                progressContainer.classList.remove('active');
                showNotification('‚ùå Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñÂ§±Ë¥•: ' + error.message, 'error');
                
            } finally {
                if (btnAuto) {
                    btnAuto.disabled = false;
                    btnAuto.textContent = 'ü§ñ Ëá™Âä®ÊâπÈáèÂèÇÊï∞‰ºòÂåñ';
                }
            }
        }

        function simulateOptimization(strategy, takeProfit, stopLoss, volumeMulti) {
            const strategySeed = strategy.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const baseSeed = strategySeed * 1000;
            
            const random1 = Math.sin(baseSeed + takeProfit * 1000 + stopLoss * 500 + volumeMulti * 100) * 0.5 + 0.5;
            const random2 = Math.cos(baseSeed + takeProfit * 2000 + stopLoss * 1000 + volumeMulti * 200) * 0.5 + 0.5;
            
            const tpEffect = (takeProfit - 0.15) * 0.6 * random1;
            const slEffect = (stopLoss - 0.08) * -0.4 * random2;
            const vmEffect = (volumeMulti - 1.5) * 0.3 * random1;
            
            const baseReturn = 0.25 + random1 * 0.35;
            const totalReturn = (baseReturn + tpEffect + slEffect + vmEffect) * 100;
            const maxDrawdown = (0.06 + random1 * 0.12) * 100;
            const sharpe = 1.0 + random2 * 2.0;
            const winRate = 40 + random1 * 40;
            const profitLossRatio = 0.9 + random2 * 1.1;
            const tradeCount = Math.floor(12 + random1 * 45);
            
            const calmar = totalReturn / maxDrawdown;
            const score = (totalReturn * 0.3 + sharpe * 0.25 + calmar * 0.2 + winRate / 100 * 0.15 + profitLossRatio * 0.1) * 100;
            
            const days = 365;
            const annualReturn = (Math.pow(1 + totalReturn / 100, 365 / days) - 1) * 100;
            
            return {
                totalReturn,
                annualReturn,
                maxDrawdown,
                sharpe,
                calmar,
                winRate,
                profitLossRatio,
                tradeCount,
                score
            };
        }

        function updateOptimizationSummaryTable(results) {
            const resultsArray = Object.values(results);
            const tbody = document.getElementById('optimizationSummaryBody');
            tbody.innerHTML = resultsArray.map(r => `
                <tr>
                    <td>${r.name}</td>
                    <td class="${r.beforeResult.totalReturn >= 0 ? 'positive' : 'negative'}">${r.beforeResult.totalReturn >= 0 ? '+' : ''}${r.beforeResult.totalReturn.toFixed(2)}%</td>
                    <td class="${r.afterResult.totalReturn >= 0 ? 'positive' : 'negative'}">${r.afterResult.totalReturn >= 0 ? '+' : ''}${r.afterResult.totalReturn.toFixed(2)}%</td>
                    <td class="${r.returnImprovement >= 0 ? 'positive' : 'negative'}">${r.returnImprovement >= 0 ? '+' : ''}${r.returnImprovement.toFixed(2)}%</td>
                    <td>${r.beforeResult.sharpe.toFixed(2)}</td>
                    <td>${r.afterResult.sharpe.toFixed(2)}</td>
                    <td class="${r.sharpeImprovement >= 0 ? 'positive' : 'negative'}">${r.sharpeImprovement >= 0 ? '+' : ''}${r.sharpeImprovement.toFixed(2)}%</td>
                    <td class="positive">${r.bestParams.takeProfit.toFixed(3)}</td>
                    <td class="positive">${r.bestParams.stopLoss.toFixed(3)}</td>
                    <td class="positive">${r.bestParams.volumeMulti.toFixed(2)}</td>
                    <td class="positive">${(Number(r.bestParams.dynamicTpCallback ?? 0.03) * 100).toFixed(1)}%</td>
                    <td><strong>${r.score.toFixed(1)}</strong></td>
                </tr>
            `).join('');
        }

        function updateOptimizationCharts(results) {
            if (!echartsLoaded) {
                setTimeout(() => updateOptimizationCharts(results), 500);
                return;
            }
            
            const resultsArray = Object.values(results);
            const strategyNames = resultsArray.map(r => r.name);
            const beforeReturns = resultsArray.map(r => r.beforeResult.totalReturn.toFixed(2));
            const afterReturns = resultsArray.map(r => r.afterResult.totalReturn.toFixed(2));
            const beforeSharpes = resultsArray.map(r => r.beforeResult.sharpe.toFixed(2));
            const afterSharpes = resultsArray.map(r => r.afterResult.sharpe.toFixed(2));
            
            const optChartContainer = document.getElementById('optimizationChart');
            if (optChartContainer && !optimizationCharts.optimization) {
                // ‰ΩøÁî® requestAnimationFrame ‰ºòÂåñÂàùÂßãÂåñÊÄßËÉΩ
                requestAnimationFrame(() => {
                    try {
                        optimizationCharts.optimization = echarts.init(optChartContainer);
                        console.log('‚úÖ ÂèÇÊï∞‰ºòÂåñÂõæË°®ÂàùÂßãÂåñÊàêÂäü');
                    } catch (error) {
                        console.error('‚ùå ÂèÇÊï∞‰ºòÂåñÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    }
                });
            }
            
            if (optimizationCharts.optimization) {
                optimizationCharts.optimization.setOption({
                    title: { text: '‰ºòÂåñÂâçÂêéÊî∂ÁõäÁéáÂØπÊØî', left: 'center', top: 5, textStyle: { color: '#fff' } },
                    tooltip: { trigger: 'axis' },
                    legend: { data: ['‰ºòÂåñÂâçÊî∂ÁõäÁéá', '‰ºòÂåñÂêéÊî∂ÁõäÁéá'], top: 30, textStyle: { color: '#fff' } },
                    xAxis: { 
                        type: 'category', 
                        data: strategyNames,
                        name: 'Á≠ñÁï•',
                        axisLabel: { color: '#aaa', rotate: 30 }
                    },
                    yAxis: { 
                        type: 'value', 
                        name: 'Êî∂ÁõäÁéá(%)', 
                        axisLabel: { color: '#aaa' } 
                    },
                    series: [
                        { name: '‰ºòÂåñÂâçÊî∂ÁõäÁéá', type: 'bar', data: beforeReturns, itemStyle: { color: '#94a3b8' } },
                        { name: '‰ºòÂåñÂêéÊî∂ÁõäÁéá', type: 'bar', data: afterReturns, itemStyle: { color: '#22c55e' } }
                    ]
                });
            }
            
            const sensitivityContainer = document.getElementById('sensitivityChart');
            if (sensitivityContainer && !optimizationCharts.sensitivity) {
                optimizationCharts.sensitivity = echarts.init(sensitivityContainer);
            }
            
            if (optimizationCharts.sensitivity) {
                optimizationCharts.sensitivity.setOption({
                    title: { text: '‰ºòÂåñÂâçÂêéÂ§èÊôÆÊØîÁéáÂØπÊØî', left: 'center', top: 5, textStyle: { color: '#fff' } },
                    tooltip: { trigger: 'axis' },
                    legend: { data: ['‰ºòÂåñÂâçÂ§èÊôÆ', '‰ºòÂåñÂêéÂ§èÊôÆ'], top: 30, textStyle: { color: '#fff' } },
                    xAxis: { 
                        type: 'category', 
                        data: strategyNames,
                        name: 'Á≠ñÁï•',
                        axisLabel: { color: '#aaa', rotate: 30 }
                    },
                    yAxis: { 
                        type: 'value', 
                        name: 'Â§èÊôÆÊØîÁéá', 
                        axisLabel: { color: '#aaa' } 
                    },
                    series: [
                        { name: '‰ºòÂåñÂâçÂ§èÊôÆ', type: 'bar', data: beforeSharpes, itemStyle: { color: '#94a3b8' } },
                        { name: '‰ºòÂåñÂêéÂ§èÊôÆ', type: 'bar', data: afterSharpes, itemStyle: { color: '#3b82f6' } }
                    ]
                });
            }
            
            const heatmapContainer = document.getElementById('heatmapChart');
            if (heatmapContainer && !optimizationCharts.heatmap) {
                optimizationCharts.heatmap = echarts.init(heatmapContainer);
            }
            
            if (optimizationCharts.heatmap) {
                const heatmapData = resultsArray.map((r, i) => [i, 0, r.returnImprovement.toFixed(2)]);
                
                optimizationCharts.heatmap.setOption({
                    title: { text: 'ÂèÇÊï∞‰ºòÂåñÊïàÊûúÁÉ≠ÂäõÂõæÔºàÊî∂ÁõäÁéáÊèêÂçá%Ôºâ', left: 'center', top: 5, textStyle: { color: '#fff' } },
                    tooltip: { position: 'top' },
                    grid: { height: '70%', top: '10%' },
                    xAxis: { 
                        type: 'category', 
                        data: strategyNames,
                        axisLabel: { color: '#aaa', rotate: 30 }
                    },
                    yAxis: { 
                        type: 'category', 
                        data: ['Êî∂ÁõäÁéáÊèêÂçá'],
                        axisLabel: { color: '#aaa' }
                    },
                    visualMap: {
                        min: Math.min(...resultsArray.map(r => r.returnImprovement)),
                        max: Math.max(...resultsArray.map(r => r.returnImprovement)),
                        calculable: true,
                        orient: 'horizontal',
                        left: 'center',
                        bottom: '0%',
                        textStyle: { color: '#fff' },
                        inRange: { color: ['#ef4444', '#fbbf24', '#22c55e'] }
                    },
                    series: [{
                        name: 'Êî∂ÁõäÁéáÊèêÂçá',
                        type: 'heatmap',
                        data: heatmapData,
                        label: { 
                            show: true, 
                            formatter: function(params) {
                                return Math.round(params.value[2]);
                            },
                            fontSize: 10
                        },
                        emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
                    }]
                });
            }
        }

        function updateOptimizationDetailTable(results) {
            const resultsArray = Object.values(results);
            const tbody = document.getElementById('optimizationBody');
            tbody.innerHTML = resultsArray.map(r => `
                <tr>
                    <td>${r.name}</td>
                    <td class="positive">${r.bestParams.takeProfit.toFixed(3)}</td>
                    <td class="positive">${r.bestParams.stopLoss.toFixed(3)}</td>
                    <td class="positive">${r.bestParams.volumeMulti.toFixed(2)}</td>
                    <td class="positive">${(Number(r.bestParams.dynamicTpCallback ?? 0.03) * 100).toFixed(1)}%</td>
                    <td class="${r.beforeResult.totalReturn >= 0 ? 'positive' : 'negative'}">${r.beforeResult.totalReturn >= 0 ? '+' : ''}${r.beforeResult.totalReturn.toFixed(2)}%</td>
                    <td class="${r.afterResult.totalReturn >= 0 ? 'positive' : 'negative'}">${r.afterResult.totalReturn >= 0 ? '+' : ''}${r.afterResult.totalReturn.toFixed(2)}%</td>
                    <td class="${r.returnImprovement >= 0 ? 'positive' : 'negative'}">${r.returnImprovement >= 0 ? '+' : ''}${r.returnImprovement.toFixed(2)}%</td>
                    <td>${r.beforeResult.sharpe.toFixed(2)}</td>
                    <td>${r.afterResult.sharpe.toFixed(2)}</td>
                    <td class="${r.sharpeImprovement >= 0 ? 'positive' : 'negative'}">${r.sharpeImprovement >= 0 ? '+' : ''}${r.sharpeImprovement.toFixed(2)}%</td>
                    <td><strong>${r.score.toFixed(1)}</strong></td>
                </tr>
            `).join('');
        }

        function exportOptimizationResults() {
            if (!optimizationResults || Object.keys(optimizationResults).length === 0) {
                showNotification('ËØ∑ÂÖàËøêË°åÂèÇÊï∞‰ºòÂåñ', 'warning');
                return;
            }
            
            const resultsArray = Object.values(optimizationResults);
            let csv = 'Á≠ñÁï•ÂêçÁß∞,‰ºòÂåñÂâçÊî∂ÁõäÁéá,‰ºòÂåñÂêéÊî∂ÁõäÁéá,Êî∂ÁõäÁéáÊèêÂçá,‰ºòÂåñÂâçÂ§èÊôÆ,‰ºòÂåñÂêéÂ§èÊôÆ,Â§èÊôÆÊèêÂçá,ÊúÄ‰ºòÊ≠¢Áõà,ÊúÄ‰ºòÊ≠¢Êçü,ÊúÄ‰ºòÈáèËÉΩ,ÁßªÂä®Ê≠¢ÁõàÂõûÊí§,ÁªºÂêàËØÑÂàÜ\n';
            
            resultsArray.forEach(r => {
                const dtpPct = (Number(r.bestParams.dynamicTpCallback ?? 0.03) * 100).toFixed(1) + '%';
                csv += `${r.name},${r.beforeResult.totalReturn.toFixed(2)}%,${r.afterResult.totalReturn.toFixed(2)}%,${r.returnImprovement.toFixed(2)}%,${r.beforeResult.sharpe.toFixed(2)},${r.afterResult.sharpe.toFixed(2)},${r.sharpeImprovement.toFixed(2)}%,${r.bestParams.takeProfit.toFixed(3)},${r.bestParams.stopLoss.toFixed(3)},${r.bestParams.volumeMulti.toFixed(2)},${dtpPct},${r.score.toFixed(1)}\n`;
            });
            
            try {
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ÂÖ®Á≠ñÁï•ÂÖ®ÂèÇÊï∞‰ºòÂåñÁªìÊûú_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('üìä ‰ºòÂåñÁªìÊûúÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                console.error('ÂØºÂá∫‰ºòÂåñÁªìÊûúÂ§±Ë¥•:', error);
                showNotification('‚ùå ÂØºÂá∫‰ºòÂåñÁªìÊûúÂ§±Ë¥•: ' + error.message, 'error');
            }
        }


    </script>
</body>
</html>
